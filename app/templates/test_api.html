{% extends "base.html" %}

{% block title %}APIæµ‹è¯•é¡µé¢{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2>å‰ç«¯å‡ºåº“åˆ°åç«¯ä»“åº“APIæµ‹è¯•</h2>
            <p class="text-muted">æµ‹è¯•adminç”¨æˆ·æƒé™å’ŒAPIåŠŸèƒ½</p>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">æµ‹è¯•ä¿¡æ¯</h5>
                    <p><strong>å½“å‰ç”¨æˆ·:</strong> {{ current_user.username }}</p>
                    <p><strong>æ˜¯å¦ç®¡ç†å‘˜:</strong> {{ current_user.is_super_admin() }}</p>
                    <p><strong>å…³è”ä»“åº“:</strong> {{ current_user.warehouse.warehouse_name if current_user.warehouse else 'æ— ' }}</p>
                    
                    <hr>
                    
                    <h6>æµ‹è¯•APIè°ƒç”¨</h6>
                    <button type="button" class="btn btn-primary" onclick="testAPI()">
                        æµ‹è¯•å‰ç«¯å‡ºåº“åˆ°åç«¯ä»“åº“API
                    </button>
                    
                    <div class="mt-3">
                        <h6>æµ‹è¯•ç»“æœ</h6>
                        <div id="testResult" class="border p-3 bg-light" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                            <!-- æµ‹è¯•ç»“æœè¾“å‡ºåŒºåŸŸ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// æ—¥å¿—è¾“å‡ºå‡½æ•°
function log(message) {
    const testResult = document.getElementById('testResult');
    const timestamp = new Date().toLocaleTimeString();
    testResult.innerHTML += `[${timestamp}] ${message}\n`;
    testResult.scrollTop = testResult.scrollHeight;
    console.log(message);
}

// æµ‹è¯•API
function testAPI() {
    log('ğŸš€ å¼€å§‹æµ‹è¯•å‰ç«¯å‡ºåº“åˆ°åç«¯ä»“åº“API...');
    
    // æ„é€ æµ‹è¯•æ•°æ®
    const testData = {
        commonData: {
            arrivalTime: "2025-07-24 13:19",
            loadingStartTime: "2025-07-24 13:49",
            loadingEndTime: "2025-07-24 15:49",
            departureTime: "2025-07-24 16:04",
            trunkPlate: "æµ‹è¯•è½¦ç‰Œ",
            vehicleType: "45HQ",
            driverName: "æµ‹è¯•å¸æœº",
            driverPhone: "13800138000",
            originWarehouse: "å¹³æ¹–ä»“",
            originContact: "æµ‹è¯•è”ç³»äºº",
            destinationWarehouse: "å‡­ç¥¥åŒ—æŠ•ä»“",
            destinationContact: "æµ‹è¯•æ”¶è´§äºº",
            originAddress: "æµ‹è¯•å‘è´§åœ°å€",
            destinationAddress: "æµ‹è¯•æ”¶è´§åœ°å€",
            largePallet: "1",
            smallPallet: "1",
            cardPallet: "1"
        },
        records: [
            {
                outbound_time: "2025-07-24",
                customer_name: "æµ‹è¯•å®¢æˆ·",
                identification_code: "TEST/æµ‹è¯•/TEST001/20250724/001",
                pallet_count: 1,
                package_count: 0,
                weight: 100,
                volume: 1.5,
                batch_number: "",
                documents: "1",
                remarks: "APIæµ‹è¯•",
                remarks2: "",
                inventory_id: "999",
                inbound_plate: "",
                order_type: "é›¶æ‹…",
                export_mode: "ä¿ç¨",
                customs_broker: "CFW",
                service_staff: "æµ‹è¯•å‘˜",
                document_count: "1"
            }
        ]
    };
    
    log('ğŸ“¦ æµ‹è¯•æ•°æ®æ„é€ å®Œæˆ');
    log('ğŸ” å‘é€APIè¯·æ±‚...');
    
    fetch('/api/frontend/outbound/to_backend', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(testData)
    })
    .then(response => {
        log(`ğŸ“¡ æ”¶åˆ°å“åº”: ${response.status} ${response.statusText}`);
        return response.json();
    })
    .then(data => {
        log('ğŸ“‹ å“åº”æ•°æ®:');
        log(JSON.stringify(data, null, 2));
        
        if (data.success) {
            log('âœ… APIæµ‹è¯•æˆåŠŸï¼');
        } else {
            log('âŒ APIæµ‹è¯•å¤±è´¥: ' + data.message);
        }
    })
    .catch(error => {
        log('âŒ APIè¯·æ±‚å¤±è´¥: ' + error.message);
        console.error('APIè¯·æ±‚é”™è¯¯:', error);
    });
}

// é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
$(document).ready(function() {
    log('ğŸ“„ APIæµ‹è¯•é¡µé¢å·²åŠ è½½');
    log('ğŸ‘¤ å½“å‰ç”¨æˆ·: {{ current_user.username }}');
    log('ğŸ”§ ç®¡ç†å‘˜æƒé™: {{ current_user.is_super_admin() }}');
    log('ğŸ¢ å…³è”ä»“åº“: {{ current_user.warehouse.warehouse_name if current_user.warehouse else "æ— " }}');
});
</script>
{% endblock %}
