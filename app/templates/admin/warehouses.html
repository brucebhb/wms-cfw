{% extends "base.html" %}

{% block title %}仓库管理{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/inventory-table-header-fix.css') }}">
<style>
/* 仓库管理页面特定样式 */
.warehouse-management-page .table-dark th {
    background-color: #212529 !important;
    color: white !important;
    border-color: #32383e !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid warehouse-management-page">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-warehouse me-2"></i>仓库管理
                        <span class="badge bg-light text-primary ms-2">Warehouse Management</span>
                    </h3>
                </div>
                <div class="card-body">
                    <p class="card-text mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        管理系统中的所有仓库信息，包括前端仓库和后端仓库的配置
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 操作按钮 -->
    <div class="row mb-3">
        <div class="col-12">
            <button class="btn btn-primary" onclick="showCreateWarehouseModal()">
                <i class="fas fa-plus me-1"></i>新增仓库
            </button>
            <button class="btn btn-success ms-2" onclick="refreshWarehouseList()">
                <i class="fas fa-sync-alt me-1"></i>刷新列表
            </button>
        </div>
    </div>

    <!-- 仓库列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-list me-2"></i>仓库列表
                        <span class="badge bg-secondary ms-2">{{ warehouses|length }} 个仓库</span>
                    </h5>
                </div>
                <div class="card-body">
                    {% if warehouses %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="text-align: center; width: 80px;">仓库ID</th>
                                    <th style="text-align: center; width: 150px;">仓库名称</th>
                                    <th style="text-align: center; width: 120px;">仓库代码</th>
                                    <th style="text-align: center; width: 110px;">仓库类型</th>
                                    <th style="text-align: center; width: 280px;">地址</th>
                                    <th style="text-align: center; width: 100px;">联系人</th>
                                    <th style="text-align: center; width: 130px;">联系电话</th>
                                    <th style="text-align: center; width: 80px;">状态</th>
                                    <th style="text-align: center; width: 120px;">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for warehouse in warehouses %}
                                <tr data-warehouse-id="{{ warehouse.id }}">
                                    <td style="text-align: center; vertical-align: middle;">{{ warehouse.id }}</td>
                                    <td style="text-align: left; vertical-align: middle; padding-left: 12px;"><strong>{{ warehouse.warehouse_name }}</strong></td>
                                    <td style="text-align: center; vertical-align: middle;"><code>{{ warehouse.warehouse_code }}</code></td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        {% if warehouse.warehouse_type == 'frontend' %}
                                            <span class="badge bg-info">前端仓库</span>
                                        {% elif warehouse.warehouse_type == 'backend' %}
                                            <span class="badge bg-warning">后端仓库</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ warehouse.warehouse_type }}</span>
                                        {% endif %}
                                    </td>
                                    <td style="text-align: left; vertical-align: middle; padding-left: 12px; word-wrap: break-word; max-width: 280px;">{{ warehouse.address or '-' }}</td>
                                    <td style="text-align: center; vertical-align: middle;">{{ warehouse.contact_person or '-' }}</td>
                                    <td style="text-align: center; vertical-align: middle;">{{ warehouse.contact_phone or '-' }}</td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        {% if warehouse.status == 'active' %}
                                            <span class="badge bg-success">活跃</span>
                                        {% else %}
                                            <span class="badge bg-danger">停用</span>
                                        {% endif %}
                                    </td>
                                    <td style="text-align: center; vertical-align: middle;">
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-primary" onclick="editWarehouse({{ warehouse.id }})" title="编辑">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-info" onclick="viewWarehouseDetails({{ warehouse.id }})" title="查看详情">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if warehouse.status == 'active' %}
                                            <button class="btn btn-sm btn-outline-warning" onclick="toggleWarehouseStatus({{ warehouse.id }}, 'inactive')" title="停用">
                                                <i class="fas fa-pause"></i>
                                            </button>
                                            {% else %}
                                            <button class="btn btn-sm btn-outline-success" onclick="toggleWarehouseStatus({{ warehouse.id }}, 'active')" title="启用">
                                                <i class="fas fa-play"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-warehouse fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">暂无仓库数据</h5>
                        <p class="text-muted">点击"新增仓库"按钮添加第一个仓库</p>
                        <button class="btn btn-primary" onclick="showCreateWarehouseModal()">
                            <i class="fas fa-plus me-1"></i>新增仓库
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 仓库统计信息 -->
    <!-- <div class="row mt-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ warehouses|selectattr('warehouse_type', 'equalto', 'frontend')|list|length }}</h4>
                            <p class="mb-0">前端仓库</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-store fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ warehouses|selectattr('warehouse_type', 'equalto', 'backend')|list|length }}</h4>
                            <p class="mb-0">后端仓库</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-warehouse fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ warehouses|selectattr('status', 'equalto', 'active')|list|length }}</h4>
                            <p class="mb-0">活跃仓库</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ warehouses|length }}</h4>
                            <p class="mb-0">总仓库数</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-building fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div> -->

<!-- 新增仓库模态框 -->
<div class="modal fade" id="createWarehouseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus me-2"></i>新增仓库
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createWarehouseForm" class="no-enhance" onsubmit="return false;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">仓库名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="warehouse_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">仓库代码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" name="warehouse_code" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">仓库类型 <span class="text-danger">*</span></label>
                                <select class="form-select" name="warehouse_type" required>
                                    <option value="">请选择仓库类型</option>
                                    <option value="frontend">前端仓库</option>
                                    <option value="backend">后端仓库</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">状态</label>
                                <select class="form-select" name="status">
                                    <option value="active">活跃</option>
                                    <option value="inactive">停用</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">仓库地址</label>
                        <textarea class="form-control" name="address" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">联系人</label>
                                <input type="text" class="form-control" name="contact_person">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">联系电话</label>
                                <input type="text" class="form-control" name="contact_phone">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="createWarehouse()">
                    <i class="fas fa-save me-1"></i>保存
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑仓库模态框 -->
<div class="modal fade" id="editWarehouseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>编辑仓库
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 成功提示 -->
                <div id="editSuccessAlert" class="alert alert-success d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="editSuccessMessage"></span>
                </div>

                <!-- 错误提示 -->
                <div id="editErrorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="editErrorMessage"></span>
                </div>

                <form id="editWarehouseForm" class="no-enhance" onsubmit="return false;">
                    <input type="hidden" id="editWarehouseId" name="warehouse_id">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">仓库名称 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editWarehouseName" name="warehouse_name" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">仓库代码 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="editWarehouseCode" name="warehouse_code" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">仓库类型 <span class="text-danger">*</span></label>
                                <select class="form-select" id="editWarehouseType" name="warehouse_type" required>
                                    <option value="">请选择仓库类型</option>
                                    <option value="frontend">前端仓库</option>
                                    <option value="backend">后端仓库</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">状态</label>
                                <select class="form-select" id="editWarehouseStatus" name="status">
                                    <option value="active">活跃</option>
                                    <option value="inactive">停用</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">仓库地址</label>
                        <textarea class="form-control" id="editWarehouseAddress" name="address" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">联系人</label>
                                <input type="text" class="form-control" id="editContactPerson" name="contact_person">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">联系电话</label>
                                <input type="text" class="form-control" id="editContactPhone" name="contact_phone">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="updateWarehouse()">
                    <i class="fas fa-save me-1"></i>保存更改
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 查看仓库详情模态框 -->
<div class="modal fade" id="viewWarehouseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>仓库详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- 加载提示 -->
                <div id="viewLoadingAlert" class="alert alert-info text-center">
                    <i class="fas fa-spinner fa-spin me-2"></i>正在加载仓库详情...
                </div>

                <!-- 错误提示 -->
                <div id="viewErrorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="viewErrorMessage"></span>
                </div>

                <!-- 仓库详情内容 -->
                <div id="warehouseDetailsContent" class="d-none">
                    <!-- 基本信息卡片 -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>基本信息
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">仓库ID</label>
                                        <div class="fw-bold" id="viewWarehouseId">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">仓库代码</label>
                                        <div class="fw-bold" id="viewWarehouseCode">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">仓库名称</label>
                                        <div class="fw-bold" id="viewWarehouseName">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">仓库类型</label>
                                        <div id="viewWarehouseType">-</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">状态</label>
                                        <div id="viewWarehouseStatus">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">创建时间</label>
                                        <div id="viewCreatedAt">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 联系信息卡片 -->
                    <div class="card mb-3">
                        <div class="card-header bg-info text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-address-book me-2"></i>联系信息
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-muted">仓库地址</label>
                                <div id="viewWarehouseAddress">-</div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">联系人</label>
                                        <div id="viewContactPerson">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label text-muted">联系电话</label>
                                        <div id="viewContactPhone">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 统计信息卡片 -->
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>统计信息
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h4 class="text-primary mb-1" id="viewUserCount">0</h4>
                                        <small class="text-muted">关联用户</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h4 class="text-info mb-1" id="viewInventoryCount">0</h4>
                                        <small class="text-muted">库存记录</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h4 class="text-warning mb-1" id="viewInboundCount">0</h4>
                                        <small class="text-muted">入库记录</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="border rounded p-3">
                                        <h4 class="text-danger mb-1" id="viewOutboundCount">0</h4>
                                        <small class="text-muted">出库记录</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="editWarehouseFromView()">
                    <i class="fas fa-edit me-1"></i>编辑仓库
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* 仓库管理表格优化样式 */
.table-responsive {
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.table {
    margin-bottom: 0;
    table-layout: fixed; /* 固定表格布局，确保列宽生效 */
}

.table th {
    font-weight: 600;
    font-size: 0.875rem;
    border-bottom: 2px solid #dee2e6;
    white-space: nowrap;
}

.table td {
    vertical-align: middle;
    font-size: 0.875rem;
    border-bottom: 1px solid #dee2e6;
}

/* 地址列特殊样式 */
.table td:nth-child(5) {
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.4;
    padding-top: 8px;
    padding-bottom: 8px;
}

/* 仓库名称列样式 */
.table td:nth-child(2) {
    font-weight: 500;
}

/* 操作按钮组样式 */
.btn-group .btn {
    border-radius: 0.25rem;
    margin-right: 2px;
}

.btn-group .btn:last-child {
    margin-right: 0;
}

/* 徽章样式优化 */
.badge {
    font-size: 0.75rem;
    font-weight: 500;
}

/* 代码样式优化 */
code {
    background-color: #f8f9fa;
    color: #e83e8c;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
}

/* 表格行悬停效果 */
.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.05);
}

/* 响应式优化 */
@media (max-width: 1200px) {
    .table td:nth-child(5) {
        max-width: 200px;
    }
}

@media (max-width: 992px) {
    .table td:nth-child(5) {
        max-width: 150px;
    }

    .btn-group .btn {
        padding: 0.25rem 0.4rem;
        font-size: 0.75rem;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// 仓库管理页面 JavaScript - 版本 2.0 (编辑功能已实现)
console.log('仓库管理页面已加载 - 编辑功能已实现');

function showCreateWarehouseModal() {
    document.getElementById('createWarehouseForm').reset();
    new bootstrap.Modal(document.getElementById('createWarehouseModal')).show();
}

function createWarehouse() {
    const formData = new FormData(document.getElementById('createWarehouseForm'));

    // 转换为JSON对象
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });

    console.log('创建仓库数据:', data);

    // 基本验证
    if (!data.warehouse_name || !data.warehouse_code || !data.warehouse_type) {
        alert('请填写所有必填字段');
        return;
    }

    // 发送创建请求
    fetch('/admin/api/warehouses', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 显示成功信息和创建的账号信息
            let accountInfo = '';
            if (data.created_accounts && data.created_accounts.length > 0) {
                accountInfo = '\n\n已自动创建以下账号：\n';
                data.created_accounts.forEach(account => {
                    accountInfo += `• ${account.real_name} (${account.username}) - 密码: ${account.password}\n`;
                });
                accountInfo += '\n请妥善保管账号密码信息！';
            }

            alert(data.message + accountInfo);

            // 关闭模态框并刷新页面（创建新仓库需要刷新以显示新数据）
            bootstrap.Modal.getInstance(document.getElementById('createWarehouseModal')).hide();

            // 对于创建操作，我们仍然需要刷新页面以显示新的仓库
            // 因为需要重新渲染整个表格和统计信息
            location.reload();
        } else {
            alert('创建仓库失败: ' + data.error);
        }
    })
    .catch(error => {
        console.error('创建仓库失败:', error);
        alert('创建仓库失败，请重试');
    });
}

function editWarehouse(warehouseId) {
    console.log('📝 编辑仓库 - 仓库ID:', warehouseId);

    // 确保所有其他模态框都已关闭
    closeAllModals();

    // 隐藏之前的提示
    hideEditAlerts();

    // 获取仓库信息
    fetch(`/admin/api/warehouses/${warehouseId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const warehouse = data.warehouse;

                // 填充表单数据
                document.getElementById('editWarehouseId').value = warehouse.id;
                document.getElementById('editWarehouseName').value = warehouse.warehouse_name || '';
                document.getElementById('editWarehouseCode').value = warehouse.warehouse_code || '';
                document.getElementById('editWarehouseType').value = warehouse.warehouse_type || '';
                document.getElementById('editWarehouseStatus').value = warehouse.status || 'active';
                document.getElementById('editWarehouseAddress').value = warehouse.address || '';
                document.getElementById('editContactPerson').value = warehouse.contact_person || '';
                document.getElementById('editContactPhone').value = warehouse.contact_phone || '';

                // 安全显示编辑模态框
                safeShowModal('editWarehouseModal');
            } else {
                alert('获取仓库信息失败: ' + data.error);
            }
        })
        .catch(error => {
            console.error('获取仓库信息失败:', error);
            alert('获取仓库信息失败，请重试');
        });
}

function updateWarehouse() {
    console.log('🔧 开始更新仓库...');

    try {
        const warehouseId = document.getElementById('editWarehouseId').value;
        console.log('📋 仓库ID:', warehouseId);

        if (!warehouseId) {
            console.error('❌ 仓库ID为空');
            showEditAlert('error', '仓库ID不能为空');
            return;
        }

        const formData = new FormData(document.getElementById('editWarehouseForm'));

        // 转换为JSON对象
        const data = {};
        formData.forEach((value, key) => {
            if (key !== 'warehouse_id') {  // 排除隐藏的ID字段
                data[key] = value;
            }
        });

        console.log('📤 更新仓库数据:', data);

        // 隐藏之前的提示
        hideEditAlerts();

        // 显示加载状态
        const saveButton = document.querySelector('#editWarehouseModal .btn-primary');
        if (!saveButton) {
            console.error('❌ 找不到保存按钮');
            return;
        }

        const originalText = saveButton.innerHTML;
        saveButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>保存中...';
        saveButton.disabled = true;

    // 发送更新请求
    fetch(`/admin/api/warehouses/${warehouseId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('📥 响应状态码:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('📥 响应数据:', data);

        // 恢复按钮状态
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;

        if (data.success) {
            // 显示成功提示
            showEditAlert('success', data.message || '仓库信息更新成功');

            // 2秒后关闭模态框并更新页面内容（不刷新整个页面）
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('editWarehouseModal')).hide();
                updateWarehouseInTable(warehouseId, data.warehouse);
            }, 2000);
        } else {
            // 显示错误提示
            showEditAlert('error', data.error || '更新仓库信息失败');
        }
    })
    .catch(error => {
        console.error('❌ 更新仓库失败:', error);

        // 恢复按钮状态
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;

        showEditAlert('error', `更新仓库信息失败: ${error.message}`);
    });

    } catch (error) {
        console.error('❌ updateWarehouse函数异常:', error);
        showEditAlert('error', '更新仓库时发生异常，请重试');
    }
}

function hideEditAlerts() {
    document.getElementById('editSuccessAlert').classList.add('d-none');
    document.getElementById('editErrorAlert').classList.add('d-none');
}

function showEditAlert(type, message) {
    hideEditAlerts();

    if (type === 'success') {
        document.getElementById('editSuccessMessage').textContent = message;
        document.getElementById('editSuccessAlert').classList.remove('d-none');
    } else {
        document.getElementById('editErrorMessage').textContent = message;
        document.getElementById('editErrorAlert').classList.remove('d-none');
    }
}

function updateWarehouseInTable(warehouseId, warehouseData) {
    // 查找表格中对应的行
    const rows = document.querySelectorAll('tbody tr');

    rows.forEach(row => {
        const firstCell = row.querySelector('td:first-child');
        if (firstCell && firstCell.textContent.trim() === warehouseId.toString()) {
            // 更新仓库名称（左对齐）
            const nameCell = row.querySelector('td:nth-child(2)');
            if (nameCell) {
                nameCell.innerHTML = `<strong>${warehouseData.warehouse_name}</strong>`;
                nameCell.style.textAlign = 'left';
                nameCell.style.paddingLeft = '12px';
            }

            // 更新仓库代码
            const codeCell = row.querySelector('td:nth-child(3)');
            if (codeCell) {
                codeCell.innerHTML = `<code>${warehouseData.warehouse_code}</code>`;
            }

            // 更新仓库类型
            const typeCell = row.querySelector('td:nth-child(4)');
            if (typeCell) {
                let typeBadge = '';
                if (warehouseData.warehouse_type === 'frontend') {
                    typeBadge = '<span class="badge bg-info">前端仓库</span>';
                } else if (warehouseData.warehouse_type === 'backend') {
                    typeBadge = '<span class="badge bg-warning">后端仓库</span>';
                } else {
                    typeBadge = `<span class="badge bg-secondary">${warehouseData.warehouse_type}</span>`;
                }
                typeCell.innerHTML = typeBadge;
            }

            // 更新地址（左对齐，支持换行）
            const addressCell = row.querySelector('td:nth-child(5)');
            if (addressCell) {
                addressCell.textContent = warehouseData.address || '-';
                addressCell.style.textAlign = 'left';
                addressCell.style.paddingLeft = '12px';
                addressCell.style.wordWrap = 'break-word';
                addressCell.style.maxWidth = '280px';
            }

            // 更新联系人
            const contactCell = row.querySelector('td:nth-child(6)');
            if (contactCell) {
                contactCell.textContent = warehouseData.contact_person || '-';
            }

            // 更新联系电话
            const phoneCell = row.querySelector('td:nth-child(7)');
            if (phoneCell) {
                phoneCell.textContent = warehouseData.contact_phone || '-';
            }

            // 更新状态
            const statusCell = row.querySelector('td:nth-child(8)');
            if (statusCell) {
                let statusBadge = '';
                if (warehouseData.status === 'active') {
                    statusBadge = '<span class="badge bg-success">活跃</span>';
                } else {
                    statusBadge = '<span class="badge bg-danger">停用</span>';
                }
                statusCell.innerHTML = statusBadge;
            }

            // 添加更新动画效果
            row.style.backgroundColor = '#d4edda';
            setTimeout(() => {
                row.style.backgroundColor = '';
            }, 2000);
        }
    });
}

function viewWarehouseDetails(warehouseId) {
    console.log('👁️ 查看仓库详情 - 仓库ID:', warehouseId);

    // 安全显示查看详情模态框
    safeShowModal('viewWarehouseModal', () => {
        // 显示加载状态
        showViewLoading();

        // 获取仓库详细信息
        fetchWarehouseDetails(warehouseId);
    });
}

function fetchWarehouseDetails(warehouseId) {
    console.log('📡 获取仓库详细信息:', warehouseId);

    // 获取仓库详细信息
    fetch(`/admin/api/warehouses/${warehouseId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayWarehouseDetails(data.warehouse, data.statistics);
            } else {
                showViewError(data.error || '获取仓库详情失败');
            }
        })
        .catch(error => {
            console.error('获取仓库详情失败:', error);
            showViewError('获取仓库详情失败，请重试');
        });
}

function showViewLoading() {
    document.getElementById('viewLoadingAlert').classList.remove('d-none');
    document.getElementById('viewErrorAlert').classList.add('d-none');
    document.getElementById('warehouseDetailsContent').classList.add('d-none');
}

function showViewError(message) {
    document.getElementById('viewLoadingAlert').classList.add('d-none');
    document.getElementById('viewErrorAlert').classList.remove('d-none');
    document.getElementById('warehouseDetailsContent').classList.add('d-none');
    document.getElementById('viewErrorMessage').textContent = message;
}

function displayWarehouseDetails(warehouse, statistics) {
    // 隐藏加载和错误提示
    document.getElementById('viewLoadingAlert').classList.add('d-none');
    document.getElementById('viewErrorAlert').classList.add('d-none');
    document.getElementById('warehouseDetailsContent').classList.remove('d-none');

    // 填充基本信息
    document.getElementById('viewWarehouseId').textContent = warehouse.id || '-';
    document.getElementById('viewWarehouseCode').innerHTML = warehouse.warehouse_code ?
        `<code class="bg-light px-2 py-1 rounded">${warehouse.warehouse_code}</code>` : '-';
    document.getElementById('viewWarehouseName').textContent = warehouse.warehouse_name || '-';

    // 仓库类型
    const typeElement = document.getElementById('viewWarehouseType');
    if (warehouse.warehouse_type === 'frontend') {
        typeElement.innerHTML = '<span class="badge bg-info">前端仓库</span>';
    } else if (warehouse.warehouse_type === 'backend') {
        typeElement.innerHTML = '<span class="badge bg-warning">后端仓库</span>';
    } else {
        typeElement.innerHTML = `<span class="badge bg-secondary">${warehouse.warehouse_type || '-'}</span>`;
    }

    // 状态
    const statusElement = document.getElementById('viewWarehouseStatus');
    if (warehouse.status === 'active') {
        statusElement.innerHTML = '<span class="badge bg-success">活跃</span>';
    } else {
        statusElement.innerHTML = '<span class="badge bg-danger">停用</span>';
    }

    // 时间信息
    document.getElementById('viewCreatedAt').textContent = warehouse.created_at || '-';

    // 联系信息
    document.getElementById('viewWarehouseAddress').textContent = warehouse.address || '-';
    document.getElementById('viewContactPerson').textContent = warehouse.contact_person || '-';
    document.getElementById('viewContactPhone').textContent = warehouse.contact_phone || '-';

    // 统计信息
    document.getElementById('viewUserCount').textContent = statistics.user_count || 0;
    document.getElementById('viewInventoryCount').textContent = statistics.inventory_count || 0;
    document.getElementById('viewInboundCount').textContent = statistics.inbound_count || 0;
    document.getElementById('viewOutboundCount').textContent = statistics.outbound_count || 0;

    // 保存当前仓库ID，用于编辑功能
    window.currentViewWarehouseId = warehouse.id;
}

function editWarehouseFromView() {
    console.log('🔄 从查看详情切换到编辑模式');

    // 获取当前仓库ID
    const warehouseId = window.currentViewWarehouseId;
    if (!warehouseId) {
        console.error('❌ 没有找到当前仓库ID');
        alert('无法获取仓库信息，请重试');
        return;
    }

    // 直接调用编辑函数，它会自动关闭所有模态框并打开编辑模态框
    editWarehouse(warehouseId);
}

function toggleWarehouseStatus(warehouseId, newStatus) {
    const statusText = newStatus === 'active' ? '启用' : '停用';
    const confirmText = newStatus === 'active' ?
        '确定要启用这个仓库吗？启用后该仓库的用户将可以正常使用系统。' :
        '确定要停用这个仓库吗？停用后该仓库的所有用户将无法登录系统。';

    if (confirm(confirmText)) {
        // 显示加载状态
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;

        // 发送API请求
        fetch(`/admin/api/warehouses/${warehouseId}/toggle-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
            },
            body: JSON.stringify({
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示成功消息
                showStatusAlert('success', data.message);

                // 更新表格中的状态显示
                updateWarehouseStatusInTable(warehouseId, data.warehouse);

                // 2秒后隐藏提示
                setTimeout(() => {
                    hideStatusAlerts();
                }, 3000);
            } else {
                // 显示错误消息
                showStatusAlert('error', data.error);

                // 恢复按钮状态
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('切换仓库状态失败:', error);
            showStatusAlert('error', '操作失败，请重试');

            // 恢复按钮状态
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

function updateWarehouseStatusInTable(warehouseId, warehouseData) {
    // 找到对应的表格行
    const row = document.querySelector(`tr[data-warehouse-id="${warehouseId}"]`);
    if (!row) {
        console.warn('未找到仓库行:', warehouseId);
        return;
    }

    // 更新状态列
    const statusCell = row.querySelector('td:nth-child(7)'); // 状态是第7列
    if (statusCell) {
        if (warehouseData.status === 'active') {
            statusCell.innerHTML = '<span class="badge bg-success">活跃</span>';
        } else {
            statusCell.innerHTML = '<span class="badge bg-danger">停用</span>';
        }
    }

    // 更新操作按钮
    const actionCell = row.querySelector('td:nth-child(8)'); // 操作是第8列
    if (actionCell) {
        const buttonGroup = actionCell.querySelector('.btn-group');
        if (buttonGroup) {
            // 重新生成操作按钮
            let actionButtons = `
                <button class="btn btn-sm btn-outline-primary" onclick="editWarehouse(${warehouseData.id})" title="编辑">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-info" onclick="viewWarehouseDetails(${warehouseData.id})" title="查看详情">
                    <i class="fas fa-eye"></i>
                </button>
            `;

            if (warehouseData.status === 'active') {
                actionButtons += `
                    <button class="btn btn-sm btn-outline-warning" onclick="toggleWarehouseStatus(${warehouseData.id}, 'inactive')" title="停用">
                        <i class="fas fa-pause"></i>
                    </button>
                `;
            } else {
                actionButtons += `
                    <button class="btn btn-sm btn-outline-success" onclick="toggleWarehouseStatus(${warehouseData.id}, 'active')" title="启用">
                        <i class="fas fa-play"></i>
                    </button>
                `;
            }

            buttonGroup.innerHTML = actionButtons;
        }
    }

    console.log('仓库状态已更新:', warehouseData);
}

function showStatusAlert(type, message) {
    // 创建或更新状态提示
    let alertContainer = document.getElementById('status-alert-container');
    if (!alertContainer) {
        alertContainer = document.createElement('div');
        alertContainer.id = 'status-alert-container';
        alertContainer.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        `;
        document.body.appendChild(alertContainer);
    }

    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';

    alertContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            <i class="fas ${icon} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
}

function hideStatusAlerts() {
    const alertContainer = document.getElementById('status-alert-container');
    if (alertContainer) {
        alertContainer.innerHTML = '';
    }
}

function refreshWarehouseList() {
    location.reload();
}

// 关闭所有模态框的函数
function closeAllModals() {
    console.log('🔒 关闭所有模态框');

    const modalIds = ['createWarehouseModal', 'editWarehouseModal', 'viewWarehouseModal'];

    modalIds.forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                console.log(`🔒 关闭模态框: ${modalId}`);
                modalInstance.hide();
            }
        }
    });
}

// 防止模态框事件冲突的函数
function safeShowModal(modalId, callback) {
    console.log(`🔓 安全显示模态框: ${modalId}`);

    // 先关闭所有其他模态框
    closeAllModals();

    // 等待一段时间确保模态框完全关闭
    setTimeout(() => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();

            if (callback) {
                callback();
            }
        }
    }, 200);
}

// 强制设置表头样式
function forceWarehouseTableHeaderStyle() {
    const tableHeaders = document.querySelectorAll('.table-dark th, .table thead th');
    tableHeaders.forEach(th => {
        th.style.setProperty('background-color', '#212529', 'important');
        th.style.setProperty('background', '#212529', 'important');
        th.style.setProperty('color', 'white', 'important');
        th.style.setProperty('border-color', '#32383e', 'important');
    });
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
    console.log('仓库管理页面初始化完成');

    // 测试函数是否存在
    console.log('🔍 函数检查:');
    console.log('- editWarehouse:', typeof editWarehouse);
    console.log('- updateWarehouse:', typeof updateWarehouse);
    console.log('- toggleWarehouseStatus:', typeof toggleWarehouseStatus);

    // 强制设置表头样式
    setTimeout(forceWarehouseTableHeaderStyle, 100);

    // 防止表单意外提交
    const forms = document.querySelectorAll('#createWarehouseForm, #editWarehouseForm');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('表单提交被阻止:', form.id);
            return false;
        });

        // 防止回车键提交表单
        form.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                console.log('回车键提交被阻止:', form.id);
                return false;
            }
        });
    });

    // 定期检查表头样式
    setInterval(forceWarehouseTableHeaderStyle, 30000);

    // 添加模态框事件监听器，防止冲突
    setupModalEventListeners();
});

// 设置模态框事件监听器
function setupModalEventListeners() {
    console.log('🎭 设置模态框事件监听器');

    const modalIds = ['createWarehouseModal', 'editWarehouseModal', 'viewWarehouseModal'];

    modalIds.forEach(modalId => {
        const modalElement = document.getElementById(modalId);
        if (modalElement) {
            // 监听模态框显示事件
            modalElement.addEventListener('show.bs.modal', function(e) {
                console.log(`🔓 模态框即将显示: ${modalId}`);

                // 确保其他模态框都已关闭
                modalIds.forEach(otherId => {
                    if (otherId !== modalId) {
                        const otherElement = document.getElementById(otherId);
                        if (otherElement) {
                            const otherInstance = bootstrap.Modal.getInstance(otherElement);
                            if (otherInstance) {
                                console.log(`🔒 关闭其他模态框: ${otherId}`);
                                otherInstance.hide();
                            }
                        }
                    }
                });
            });

            // 监听模态框隐藏事件
            modalElement.addEventListener('hidden.bs.modal', function(e) {
                console.log(`🔒 模态框已隐藏: ${modalId}`);

                // 清理可能的全局状态
                if (modalId === 'viewWarehouseModal') {
                    window.currentViewWarehouseId = null;
                }
            });
        }
    });
}
</script>
{% endblock %}
