{% extends "base.html" %}

{% block title %}æ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>ğŸš€ ç³»ç»Ÿæ€§èƒ½ç›‘æ§ä»ªè¡¨æ¿</h2>
            <p class="text-muted">å®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡ï¼Œæä¾›ä¼˜åŒ–å»ºè®®</p>
        </div>
    </div>

    <!-- å¿«é€ŸçŠ¶æ€å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">ç¼“å­˜å‘½ä¸­ç‡</h5>
                    <h2 class="mb-0">{{ quick_status.cache_hit_rate or 0 }}%</h2>
                    <small>{% if quick_status.cache_hit_rate and quick_status.cache_hit_rate < 70 %}âš ï¸ åä½{% else %}âœ… æ­£å¸¸{% endif %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">å¹³å‡æŸ¥è¯¢æ—¶é—´</h5>
                    <h2 class="mb-0">{{ "%.3f"|format(quick_status.avg_query_time or 0) }}s</h2>
                    <small>{% if quick_status.avg_query_time and quick_status.avg_query_time > 2 %}âš ï¸ åæ…¢{% else %}âœ… æ­£å¸¸{% endif %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">æ…¢æŸ¥è¯¢æ•°é‡</h5>
                    <h2 class="mb-0">{{ quick_status.slow_queries_count or 0 }}</h2>
                    <small>{% if quick_status.slow_queries_count and quick_status.slow_queries_count > 5 %}âš ï¸ è¿‡å¤š{% else %}âœ… æ­£å¸¸{% endif %}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">å†…å­˜ä½¿ç”¨ç‡</h5>
                    <h2 class="mb-0">{{ quick_status.system_memory_percent or 0 }}%</h2>
                    <small>{% if quick_status.system_memory_percent and quick_status.system_memory_percent > 85 %}âš ï¸ åé«˜{% else %}âœ… æ­£å¸¸{% endif %}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">æ€§èƒ½ä¼˜åŒ–æ“ä½œ</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-primary me-2" onclick="runOptimization('quick')">
                        <i class="fas fa-bolt"></i> å¿«é€Ÿä¼˜åŒ–
                    </button>
                    <button type="button" class="btn btn-success me-2" onclick="runOptimization('comprehensive')">
                        <i class="fas fa-cogs"></i> ç»¼åˆä¼˜åŒ–
                    </button>
                    <button type="button" class="btn btn-info me-2" onclick="refreshStatus()">
                        <i class="fas fa-sync"></i> åˆ·æ–°çŠ¶æ€
                    </button>
                    <small class="text-muted ms-3">
                        å¿«é€Ÿä¼˜åŒ–ï¼šæ¸…ç†ç¼“å­˜ | ç»¼åˆä¼˜åŒ–ï¼šæ•°æ®åº“+ç¼“å­˜+æ—¥å¿—å…¨é¢ä¼˜åŒ–
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Redisç¼“å­˜çŠ¶æ€ -->
    {% if performance_summary and performance_summary.redis_stats %}
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Redisç¼“å­˜çŠ¶æ€</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <strong>Redisç‰ˆæœ¬:</strong> {{ performance_summary.redis_stats.redis_version or 'N/A' }}<br>
                            <strong>å†…å­˜ä½¿ç”¨:</strong> {{ performance_summary.redis_stats.used_memory or 'N/A' }}<br>
                            <strong>è¿æ¥æ•°:</strong> {{ performance_summary.redis_stats.connected_clients or 0 }}
                        </div>
                        <div class="col-6">
                            <strong>å‘½ä¸­ç‡:</strong> {{ performance_summary.redis_stats.hit_rate or 0 }}%<br>
                            <strong>ç¼“å­˜é”®æ•°:</strong> {{ performance_summary.redis_stats.our_cache_keys or 0 }}<br>
                            <strong>Rediså¯ç”¨:</strong> {% if quick_status.redis_available %}âœ… æ˜¯{% else %}âŒ å¦{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">åº”ç”¨ç¼“å­˜ç»Ÿè®¡</h5>
                </div>
                <div class="card-body">
                    <strong>å‘½ä¸­æ¬¡æ•°:</strong> {{ performance_summary.app_cache_hits or 0 }}<br>
                    <strong>æœªå‘½ä¸­æ¬¡æ•°:</strong> {{ performance_summary.app_cache_misses or 0 }}<br>
                    <strong>å‘½ä¸­ç‡:</strong> {{ performance_summary.app_cache_hit_rate or 0 }}%<br>
                    <strong>æ›´æ–°æ—¶é—´:</strong> {{ performance_summary.timestamp or 'N/A' }}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ…¢æŸ¥è¯¢åˆ—è¡¨ -->
    {% if slow_queries %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">æœ€è¿‘æ…¢æŸ¥è¯¢ (æ‰§è¡Œæ—¶é—´ > 1ç§’)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>æŸ¥è¯¢ç±»å‹</th>
                                    <th>æ‰§è¡Œæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for query in slow_queries %}
                                <tr>
                                    <td>{{ query.datetime }}</td>
                                    <td><code>{{ query.query_type }}</code></td>
                                    <td>
                                        <span class="badge bg-warning">{{ "%.3f"|format(query.execution_time) }}s</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ä¼˜åŒ–å»ºè®® -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">ğŸ’¡ æ€§èƒ½ä¼˜åŒ–å»ºè®®</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6>æŒç»­ä¼˜åŒ–ç­–ç•¥ï¼š</h6>
                        <ul class="mb-0">
                            <li><strong>è‡ªåŠ¨ä¼˜åŒ–ï¼š</strong>ç³»ç»Ÿæ¯15åˆ†é’Ÿè‡ªåŠ¨æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡ï¼Œå¿…è¦æ—¶æ‰§è¡Œè½»é‡çº§ä¼˜åŒ–</li>
                            <li><strong>å®šæœŸä¼˜åŒ–ï¼š</strong>æ¯å¤©å‡Œæ™¨4ç‚¹æ‰§è¡Œç»¼åˆæ€§èƒ½ä¼˜åŒ–</li>
                            <li><strong>ç›‘æ§å‘Šè­¦ï¼š</strong>ç¼“å­˜å‘½ä¸­ç‡ä½äº60%ã€æŸ¥è¯¢æ—¶é—´è¶…è¿‡2ç§’æ—¶ä¼šè‡ªåŠ¨ä¼˜åŒ–</li>
                            <li><strong>æ‰‹åŠ¨ä¼˜åŒ–ï¼š</strong>å¯éšæ—¶ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰§è¡Œä¼˜åŒ–æ“ä½œ</li>
                        </ul>
                    </div>
                    
                    {% if quick_status.cache_hit_rate and quick_status.cache_hit_rate < 70 %}
                    <div class="alert alert-warning">
                        <strong>âš ï¸ ç¼“å­˜å‘½ä¸­ç‡åä½</strong><br>
                        å»ºè®®ï¼šæ‰§è¡Œå¿«é€Ÿä¼˜åŒ–æ¸…ç†è¿‡æœŸç¼“å­˜ï¼Œæˆ–æ£€æŸ¥ç¼“å­˜ç­–ç•¥é…ç½®
                    </div>
                    {% endif %}
                    
                    {% if quick_status.avg_query_time and quick_status.avg_query_time > 2 %}
                    <div class="alert alert-warning">
                        <strong>âš ï¸ æŸ¥è¯¢é€Ÿåº¦åæ…¢</strong><br>
                        å»ºè®®ï¼šæ‰§è¡Œç»¼åˆä¼˜åŒ–è¿›è¡Œæ•°æ®åº“ç´¢å¼•ä¼˜åŒ–ï¼Œæˆ–æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—
                    </div>
                    {% endif %}
                    
                    {% if quick_status.system_memory_percent and quick_status.system_memory_percent > 85 %}
                    <div class="alert alert-danger">
                        <strong>ğŸš¨ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜</strong><br>
                        å»ºè®®ï¼šé‡å¯åº”ç”¨é‡Šæ”¾å†…å­˜ï¼Œæˆ–å¢åŠ æœåŠ¡å™¨å†…å­˜é…ç½®
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ“ä½œç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ“ä½œç»“æœ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="resultContent">
                <!-- ç»“æœå†…å®¹ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script>
function runOptimization(type) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¼˜åŒ–ä¸­...';
    button.disabled = true;
    
    fetch('{{ url_for("admin.run_performance_optimization") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({type: type})
    })
    .then(response => response.json())
    .then(data => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
        
        // æ˜¾ç¤ºç»“æœ
        showResult(data, type);
        
        // å¦‚æœæˆåŠŸï¼Œåˆ·æ–°é¡µé¢çŠ¶æ€
        if (data.success) {
            setTimeout(() => {
                location.reload();
            }, 2000);
        }
    })
    .catch(error => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        button.innerHTML = originalText;
        button.disabled = false;
        
        console.error('ä¼˜åŒ–å¤±è´¥:', error);
        showResult({success: false, message: 'ç½‘ç»œé”™è¯¯: ' + error.message}, type);
    });
}

function showResult(data, type) {
    const modal = new bootstrap.Modal(document.getElementById('resultModal'));
    const content = document.getElementById('resultContent');
    
    let html = '';
    if (data.success) {
        html = `<div class="alert alert-success">
            <h6>âœ… ${type === 'quick' ? 'å¿«é€Ÿ' : 'ç»¼åˆ'}ä¼˜åŒ–æˆåŠŸ</h6>
            <p>${data.message || 'ä¼˜åŒ–å®Œæˆ'}</p>
        </div>`;
        
        if (data.type === 'comprehensive' && data.database_optimization) {
            html += `<div class="mt-3">
                <h6>ä¼˜åŒ–è¯¦æƒ…ï¼š</h6>
                <ul>
                    <li>æ•°æ®åº“ä¼˜åŒ–: ${data.database_optimization.status}</li>
                    <li>ç¼“å­˜ä¼˜åŒ–: ${data.cache_optimization ? data.cache_optimization.status : 'N/A'}</li>
                    <li>æ—¥å¿—ä¼˜åŒ–: ${data.log_optimization ? data.log_optimization.status : 'N/A'}</li>
                </ul>
            </div>`;
        }
    } else {
        html = `<div class="alert alert-danger">
            <h6>âŒ ä¼˜åŒ–å¤±è´¥</h6>
            <p>${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
        </div>`;
    }
    
    content.innerHTML = html;
    modal.show();
}

function refreshStatus() {
    location.reload();
}

// æ¯30ç§’è‡ªåŠ¨åˆ·æ–°çŠ¶æ€
setInterval(() => {
    fetch('{{ url_for("admin.get_performance_status") }}')
    .then(response => response.json())
    .then(data => {
        // æ›´æ–°é¡µé¢ä¸Šçš„å…³é”®æŒ‡æ ‡
        if (data.cache_hit_rate !== undefined) {
            // è¿™é‡Œå¯ä»¥æ›´æ–°é¡µé¢ä¸Šçš„æ•°å€¼ï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬æš‚æ—¶ä¸å®ç°
        }
    })
    .catch(error => {
        console.log('çŠ¶æ€åˆ·æ–°å¤±è´¥:', error);
    });
}, 30000);
</script>
{% endblock %}
