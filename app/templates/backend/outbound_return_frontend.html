{% extends "base.html" %}

{% block title %}åç«¯ä»“è¿”å›å‰ç«¯ä»“{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/simple-table.css') }}" type="text/css" />
<style>
    .batch-options {
        margin-bottom: 1rem;
    }
    #hot-container {
        height: 600px;
        overflow: visible;
        margin-bottom: 20px;
        margin-left: auto;
        margin-right: auto;
        position: relative;
    }
    .handsontable td {
        height: 32px !important;
        line-height: 28px !important;
        padding: 4px 6px !important;
        font-size: 14px !important;
        text-align: center !important;
        vertical-align: middle !important;
    }
    .handsontable th {
        height: 36px !important;
        padding: 6px 6px !important;
        font-size: 14px !important;
        font-weight: bold !important;
        text-align: center !important;
        vertical-align: middle !important;
    }
    .handsontable .required {
        color: #ff0000;
    }
    .required {
        color: #dc3545 !important;
        font-weight: bold;
    }
    .btn-action {
        margin-right: 8px;
    }
    .card-body {
        text-align: center;
    }
    .destination-info {
        background-color: #fff3cd;
    }

    /* åº“å­˜æ¨¡æ€æ¡†è¯†åˆ«ç¼–ç åˆ—ç‰¹æ®Šæ ·å¼ */
    #inventoryTable .identification-code {
        font-size: 15px !important;
        font-weight: 600 !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        line-height: 1.3 !important;
        max-width: 200px !important;
        min-width: 180px !important;
    }

    /* å…¨å‡ºæŒ‰é’®æ ·å¼ */
    #inventoryTable .full-out-btn {
        font-size: 12px !important;
        padding: 0.25rem 0.5rem !important;
        white-space: nowrap !important;
    }
    .return-reason {
        margin-bottom: 20px;
    }

    /* å¼ºåˆ¶æ¨¡æ€æ¡†å…¨å±æ ·å¼ */
    #inventoryModal .modal-dialog {
        max-width: none !important;
        width: 95vw !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
    }

    #inventoryModal .modal-content {
        height: 95vh !important;
        max-height: 95vh !important;
        width: 100% !important;
        max-width: none !important;
    }

    #inventoryModal .modal-body {
        height: calc(95vh - 120px) !important;
        max-height: calc(95vh - 120px) !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
    }

    #inventoryModal .table-responsive {
        flex: 1 !important;
        overflow-y: auto !important;
        min-height: 0 !important;
    }

    #inventoryModal table {
        min-width: 1520px !important;
        font-size: 12px !important;
    }

    #inventoryModal th, #inventoryModal td {
        padding: 4px 6px !important;
        white-space: nowrap !important;
    }

    #inventoryModal .identification-code {
        font-size: 15px !important;
        font-weight: 600 !important;
        max-width: 200px !important;
        word-break: break-all !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        line-height: 1.3 !important;
    }

    /* å¤‡æ³¨è¾“å…¥æ¡†æ ·å¼ */
    #inventoryModal .inventory-remarks {
        border: 1px solid #ddd !important;
        border-radius: 3px !important;
        padding: 2px 4px !important;
        font-size: 11px !important;
        line-height: 1.2 !important;
        height: 24px !important;
    }

    #inventoryModal .inventory-remarks:focus {
        border-color: #007bff !important;
        box-shadow: 0 0 0 0.1rem rgba(0, 123, 255, 0.25) !important;
        outline: none !important;
    }

    /* æ›´å¼ºåŠ›çš„æ ·å¼è¦†ç›– */
    .modal#inventoryModal .modal-dialog {
        max-width: none !important;
        width: 95vw !important;
        height: 95vh !important;
        margin: 2.5vh auto !important;
    }

    .modal#inventoryModal .modal-content {
        height: 95vh !important;
        max-height: 95vh !important;
        width: 100% !important;
        max-width: none !important;
    }

    .modal#inventoryModal .modal-body {
        height: calc(95vh - 120px) !important;
        max-height: calc(95vh - 120px) !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-undo me-2"></i>åç«¯ä»“è¿”å›å‰ç«¯ä»“
                        <span class="badge bg-dark text-warning ms-2">Return to Frontend</span>
                    </h3>
                    <div class="mt-2">
                        <a href="{{ url_for('main.backend_outbound') }}" class="btn btn-sm btn-outline-dark">
                            <i class="fas fa-arrow-left me-1"></i>è¿”å›é€‰æ‹©é¡µé¢
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¬å…±æ•°æ®åŒºåŸŸ -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>å…¬å…±ä¿¡æ¯
                        <small class="ms-2">ï¼ˆé€‚ç”¨äºæœ¬æ¬¡è¿”å›çš„æ‰€æœ‰è´§ç‰©ï¼‰</small>
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ç¬¬ä¸€è¡Œï¼šå‡ºåº“è½¦ç‰Œã€å¸æœºå§“åã€å¸æœºè”ç³»æ–¹å¼ -->
                    <div class="row">
                        <!-- è¿è¾“è½¦ç‰Œ -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="commonPlateNumber" class="form-label">
                                    <span class="required">å‡ºåº“è½¦ç‰Œ *</span>
                                </label>
                                <input type="text" class="form-control" id="commonPlateNumber"
                                       placeholder="è¯·è¾“å…¥å‡ºåº“è½¦ç‰Œå·" required>
                                <div class="form-text">è´§ç‰©å‡ºåº“è¿”å›ä½¿ç”¨çš„è½¦ç‰Œå·</div>
                            </div>
                        </div>

                        <!-- å¸æœºå§“å -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="driverName" class="form-label">
                                    <span class="required">å¸æœºå§“å *</span>
                                </label>
                                <input type="text" class="form-control" id="driverName"
                                       placeholder="è¯·è¾“å…¥å¸æœºå§“å" required>
                                <div class="form-text">è´Ÿè´£è¿è¾“çš„å¸æœºå§“å</div>
                            </div>
                        </div>

                        <!-- å¸æœºè”ç³»æ–¹å¼ -->
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="driverContact" class="form-label">
                                    <span class="required">å¸æœºè”ç³»æ–¹å¼ *</span>
                                </label>
                                <input type="tel" class="form-control" id="driverContact"
                                       placeholder="è¯·è¾“å…¥å¸æœºæ‰‹æœºå·" required
                                       pattern="^1[3-9]\d{9}$" maxlength="11">
                                <div class="form-text">å¸æœºçš„è”ç³»ç”µè¯ï¼ˆ11ä½æ‰‹æœºå·ï¼‰</div>
                            </div>
                        </div>
                    </div>

                    <!-- ç¬¬äºŒè¡Œï¼šç›®çš„ä»“ã€ç›®çš„ä»“åœ°å€ã€ç›®çš„ä»“è”ç³»äºº -->
                    <div class="row">
                        <!-- ç›®çš„ä»“é€‰æ‹© -->
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="targetWarehouse" class="form-label">
                                    <span class="required">ç›®çš„ä»“ *</span>
                                </label>
                                <select class="form-select" id="targetWarehouse" required>
                                    <option value="">è¯·é€‰æ‹©ç›®çš„ä»“</option>
                                    <option value="å¹³æ¹–ä»“">å¹³æ¹–ä»“</option>
                                    <option value="æ˜†å±±ä»“">æ˜†å±±ä»“</option>
                                    <option value="æˆéƒ½ä»“">æˆéƒ½ä»“</option>
                                </select>
                                <div class="form-text">é€‰æ‹©è´§ç‰©è¿”å›çš„å‰ç«¯ä»“</div>
                            </div>
                        </div>

                        <!-- è¿”å›æ—¶é—´ -->
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="returnTime" class="form-label">
                                    <span class="required">è¿”å›æ—¶é—´ *</span>
                                </label>
                                <input type="date" class="form-control" id="returnTime" required>
                                <div class="form-text">è´§ç‰©è¿”å›çš„å…·ä½“æ—¶é—´</div>
                            </div>
                        </div>

                        <!-- ç›®çš„ä»“åœ°å€ -->
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="warehouseAddress" class="form-label">ç›®çš„ä»“åœ°å€</label>
                                <input type="text" class="form-control" id="warehouseAddress"
                                       placeholder="è‡ªåŠ¨è·å–åœ°å€" readonly>
                                <div class="form-text">æ ¹æ®é€‰æ‹©çš„ä»“åº“è‡ªåŠ¨å¡«å……</div>
                            </div>
                        </div>

                        <!-- ç›®çš„ä»“è”ç³»äºº -->
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="warehouseContact" class="form-label">ç›®çš„ä»“è”ç³»äºº</label>
                                <input type="text" class="form-control" id="warehouseContact"
                                       placeholder="è‡ªåŠ¨è·å–è”ç³»äºº" readonly>
                                <div class="form-text">æ ¹æ®é€‰æ‹©çš„ä»“åº“è‡ªåŠ¨å¡«å……</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="batch-options d-flex flex-wrap align-items-center justify-content-between">
                        <div class="d-flex flex-wrap align-items-center">
                            <button type="button" class="btn btn-success btn-action" id="addRowBtn">
                                <i class="fas fa-plus"></i> æ·»åŠ è¡Œ
                            </button>
                            <button type="button" class="btn btn-danger btn-action" id="deleteRowBtn">
                                <i class="fas fa-trash"></i> åˆ é™¤è¡Œ
                            </button>
                            <button type="button" class="btn btn-info btn-action" id="loadInventoryBtn">
                                <i class="fas fa-download"></i> åŠ è½½åº“å­˜
                            </button>

                        </div>
                        <div class="d-flex flex-wrap align-items-center">
                            <button type="button" class="btn btn-primary btn-action" id="saveAllBtn">
                                <i class="fas fa-save"></i> ä¿å­˜å…¨éƒ¨
                            </button>
                            <button type="button" class="btn btn-secondary btn-action" id="clearAllBtn">
                                <i class="fas fa-eraser"></i> æ¸…ç©º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®å½•å…¥åŒºåŸŸ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-table me-2"></i>è´§ç‰©æ˜ç»†å½•å…¥
                        <small class="text-muted">ï¼ˆæ ‡æœ‰ <span class="required">*</span> çš„å­—æ®µä¸ºå¿…å¡«é¡¹ï¼Œå­—æ®µä¸å…¥åº“è®°å½•ä¿æŒä¸€è‡´ï¼‰</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="hot-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œè¯´æ˜ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-question-circle me-1"></i>æ“ä½œè¯´æ˜
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">å…¬å…±ä¿¡æ¯è¯´æ˜</h6>
                            <ul class="small">
                                <li><span class="required">å‡ºåº“è½¦ç‰Œ*</span>ï¼šè´§ç‰©å‡ºåº“è¿”å›ä½¿ç”¨çš„è½¦ç‰Œå·ï¼Œé€‚ç”¨äºæ‰€æœ‰è´§ç‰©</li>
                                <li><span class="required">å¸æœºå§“å*</span>ï¼šè´Ÿè´£è¿è¾“çš„å¸æœºå§“å</li>
                                <li><span class="required">å¸æœºè”ç³»æ–¹å¼*</span>ï¼šå¸æœºçš„è”ç³»ç”µè¯</li>
                                <li><span class="required">ç›®çš„ä»“*</span>ï¼šé€‰æ‹©è´§ç‰©è¿”å›çš„å‰ç«¯ä»“åº“</li>
                                <li><span class="required">è¿”å›æ—¶é—´*</span>ï¼šè´§ç‰©è¿”å›çš„å…·ä½“æ—¶é—´ï¼Œé€‚ç”¨äºæ‰€æœ‰è´§ç‰©</li>
                                <li><span class="text-muted">ç›®çš„ä»“åœ°å€</span>ï¼šæ ¹æ®é€‰æ‹©çš„ä»“åº“è‡ªåŠ¨å¡«å……</li>
                                <li><span class="text-muted">ç›®çš„ä»“è”ç³»äºº</span>ï¼šæ ¹æ®é€‰æ‹©çš„ä»“åº“è‡ªåŠ¨å¡«å……</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">è´§ç‰©æ˜ç»†è¯´æ˜</h6>
                            <ul class="small">
                                <li><span class="required">å®¢æˆ·åç§°*</span>ï¼šè´§ç‰©æ‰€å±å®¢æˆ·ï¼Œä¸å…¥åº“è®°å½•ä¸€è‡´</li>
                                <li><span class="text-muted">è¯†åˆ«ç¼–ç </span>ï¼šç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œä¿æŒå”¯ä¸€æ€§</li>
                                <li><span class="text-muted">æ¿æ•°/ä»¶æ•°</span>ï¼šè‡³å°‘å¡«å†™ä¸€é¡¹ï¼Œä¸å…¥åº“å­—æ®µä¸€è‡´</li>
                                <li><span class="text-muted">é‡é‡/ä½“ç§¯</span>ï¼šè´§ç‰©çš„ç‰©ç†å±æ€§</li>
                                <li><span class="text-muted">å…¥åº“è½¦ç‰Œ</span>ï¼šè´§ç‰©åŸå…¥åº“æ—¶çš„è½¦ç‰Œå·</li>
                            </ul>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-warning mb-0">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>æ³¨æ„ï¼š</strong>
                                å…¬å…±ä¿¡æ¯åŒºåŸŸçš„å‡ºåº“è½¦ç‰Œã€å¸æœºä¿¡æ¯ã€ç›®çš„ä»“ä¿¡æ¯å’Œè¿”å›æ—¶é—´å°†è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰è´§ç‰©æ˜ç»†ä¸­ï¼Œè´§ç‰©æ˜ç»†å­—æ®µä¸å…¥åº“è®°å½•ä¿æŒä¸€è‡´ï¼Œç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§å’Œå‡†ç¡®æ€§ã€‚
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åº“å­˜é€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="inventoryModal" tabindex="-1" aria-labelledby="inventoryModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: none !important; width: 95vw !important; height: 95vh !important; margin: 2.5vh auto !important;">
        <div class="modal-content" style="height: 95vh !important; max-height: 95vh !important; width: 100% !important; max-width: none !important;">
            <div class="modal-header">
                <h5 class="modal-title" id="inventoryModalLabel">
                    <i class="fas fa-warehouse me-2"></i>é€‰æ‹©åº“å­˜è®°å½•
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="height: calc(95vh - 120px) !important; max-height: calc(95vh - 120px) !important; overflow: hidden !important; display: flex !important; flex-direction: column !important;">
                <!-- æœç´¢åŒºåŸŸ -->
                <div class="row mb-3 flex-shrink-0">
                    <div class="col-md-6">
                        <label for="searchCustomer" class="form-label">å®¢æˆ·åç§°</label>
                        <input type="text" class="form-control" id="searchCustomer" placeholder="è¾“å…¥å®¢æˆ·åç§°æœç´¢">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="button" class="btn btn-primary" onclick="searchInventory()">
                                <i class="fas fa-search"></i> æœç´¢
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="resetInventorySearch()">
                                <i class="fas fa-refresh"></i> é‡ç½®
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åº“å­˜åˆ—è¡¨ -->
                <div class="table-responsive flex-grow-1" style="flex: 1 !important; overflow-y: auto !important; min-height: 0 !important;">
                    <table class="table table-striped table-hover" id="inventoryTable" style="min-width: 1400px !important; font-size: 14px !important;">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th width="50">é€‰æ‹©</th>
                                <th width="120">å®¢æˆ·åç§°</th>
                                <th width="200">è¯†åˆ«ç¼–ç </th>
                                <th width="100">å…¥åº“è½¦ç‰Œ</th>
                                <th width="60">æ¿æ•°</th>
                                <th width="60">ä»¶æ•°</th>
                                <th width="60">å…¨å‡º</th>
                                <th width="80">å‡ºåº“æ¿æ•°</th>
                                <th width="80">å‡ºåº“ä»¶æ•°</th>
                                <th width="80">é‡é‡(kg)</th>
                                <th width="80">ä½“ç§¯(mÂ³)</th>
                                <th width="60">å•æ®</th>
                                <th width="100">è·Ÿå•å®¢æœ</th>
                                <th width="120">å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody">
                            <tr>
                                <td colspan="14" class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                    </div>
                                    <div class="mt-2">æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- é€‰ä¸­çš„åº“å­˜ä¿¡æ¯ -->
                <div id="selectedInventoryInfo" class="mt-3" style="display: none;">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>å·²é€‰æ‹©çš„åº“å­˜</h6>
                        <div id="selectedInventoryDetails"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="confirmInventorySelection()">
                    <i class="fas fa-check"></i> ç¡®è®¤é€‰æ‹©
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>
<script>
// ç­‰å¾…Handsontableåº“åŠ è½½å®Œæˆ
function waitForHandsontable(callback, maxAttempts = 50) {
    let attempts = 0;

    function check() {
        attempts++;
        if (typeof Handsontable !== 'undefined') {
            console.log('âœ… Handsontableåº“å·²åŠ è½½');
            callback();
        } else if (attempts < maxAttempts) {
            console.log(`â³ ç­‰å¾…HandsontableåŠ è½½... (${attempts}/${maxAttempts})`);
            setTimeout(check, 100);
        } else {
            console.error('âŒ Handsontableåº“åŠ è½½å¤±è´¥');
            if (typeof showMessage !== 'undefined') {
                showMessage('error', 'Handsontableåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
    }

    check();
}

$(document).ready(function() {
    console.log('åç«¯ä»“è¿”å›å‰ç«¯ä»“é¡µé¢å·²åŠ è½½');

    // é¡µé¢ç¯å¢ƒè°ƒè¯•ä¿¡æ¯
    console.log('ğŸ” é¡µé¢ç¯å¢ƒè°ƒè¯•ä¿¡æ¯:');
    console.log('- è§†çª—å°ºå¯¸:', window.innerWidth + 'x' + window.innerHeight);
    console.log('- è®¾å¤‡åƒç´ æ¯”:', window.devicePixelRatio);
    console.log('- ç”¨æˆ·ä»£ç†:', navigator.userAgent.substring(0, 100) + '...');
    console.log('- jQueryç‰ˆæœ¬:', $.fn.jquery);
    console.log('- Bootstrapå¯ç”¨:', typeof bootstrap !== 'undefined');

    // æ£€æŸ¥æ¨¡æ€æ¡†å…ƒç´ æ˜¯å¦å­˜åœ¨
    const modalElement = document.getElementById('inventoryModal');
    console.log('- æ¨¡æ€æ¡†å…ƒç´ å­˜åœ¨:', !!modalElement);
    if (modalElement) {
        console.log('- æ¨¡æ€æ¡†åˆå§‹display:', window.getComputedStyle(modalElement).display);
    }

    // ç®€å•çš„æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°ï¼ˆå¤‡ç”¨ï¼‰
    if (typeof showMessage === 'undefined') {
        window.showMessage = function(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            // ä½¿ç”¨æ›´è½»é‡çš„æç¤ºæ–¹å¼
            const toast = document.createElement('div');
            toast.className = 'alert alert-' + (type === 'error' ? 'danger' : type === 'success' ? 'success' : 'warning');
            toast.style.cssText = 'position:fixed;top:20px;right:20px;z-index:9999;min-width:300px;';
            toast.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };
    }

    // å…ˆç»‘å®šåŸºæœ¬çš„æŒ‰é’®äº‹ä»¶ï¼Œä¸ä¾èµ–Handsontable
    bindBasicEvents();

    // æ·»åŠ CSSæ ·å¼æ£€æŸ¥
    checkModalStyles();

    // ç­‰å¾…HandsontableåŠ è½½å®Œæˆåå†åˆå§‹åŒ–è¡¨æ ¼
    waitForHandsontable(function() {
        initializePage();
    });
});

// CSSæ ·å¼æ£€æŸ¥å‡½æ•°
function checkModalStyles() {
    console.log('ğŸ” æ£€æŸ¥æ¨¡æ€æ¡†CSSæ ·å¼:');

    // æ£€æŸ¥è‡ªå®šä¹‰æ ·å¼æ˜¯å¦ç”Ÿæ•ˆ
    const testElement = document.createElement('div');
    testElement.id = 'inventoryModal';
    testElement.innerHTML = '<div class="modal-dialog"><div class="modal-content"><div class="modal-body"></div></div></div>';
    testElement.style.display = 'none';
    document.body.appendChild(testElement);

    const dialog = testElement.querySelector('.modal-dialog');
    const content = testElement.querySelector('.modal-content');
    const body = testElement.querySelector('.modal-body');

    if (dialog) {
        const styles = window.getComputedStyle(dialog);
        console.log('- æµ‹è¯•modal-dialogæ ·å¼:');
        console.log('  - width:', styles.width);
        console.log('  - max-width:', styles.maxWidth);
        console.log('  - height:', styles.height);
    }

    // æ¸…ç†æµ‹è¯•å…ƒç´ 
    document.body.removeChild(testElement);

    // æ£€æŸ¥é¡µé¢ä¸­çš„æ ·å¼è¡¨
    const styleSheets = Array.from(document.styleSheets);
    console.log('- æ ·å¼è¡¨æ•°é‡:', styleSheets.length);

    styleSheets.forEach((sheet, index) => {
        try {
            console.log(`- æ ·å¼è¡¨${index}:`, sheet.href || 'å†…è”æ ·å¼');
        } catch (e) {
            console.log(`- æ ·å¼è¡¨${index}: æ— æ³•è®¿é—® (CORSé™åˆ¶)`);
        }
    });
}

// åŠ è½½åº“å­˜æ•°æ®ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function loadInventoryData() {
    console.log('ğŸ”„ å¼€å§‹åŠ è½½åç«¯ä»“åº“å­˜æ•°æ®...');
    showMessage('info', 'æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...');

    $.ajax({
        url: '/api/inventory/backend',
        method: 'GET',
        timeout: 10000, // 10ç§’è¶…æ—¶
        success: function(response) {
            console.log('âœ… åº“å­˜æ•°æ®åŠ è½½æˆåŠŸ:', response);
            if (response.success) {
                if (response.data && response.data.length > 0) {
                    showMessage('success', `åŠ è½½åˆ° ${response.data.length} æ¡åº“å­˜è®°å½•`);
                    showInventorySelector(response.data);
                } else if (response.inventory && response.inventory.length > 0) {
                    showMessage('success', `åŠ è½½åˆ° ${response.inventory.length} æ¡åº“å­˜è®°å½•`);
                    showInventorySelector(response.inventory);
                } else {
                    showMessage('warning', 'å½“å‰æ²¡æœ‰å¯ç”¨çš„åº“å­˜æ•°æ®');
                }
            } else {
                showMessage('error', 'åŠ è½½åº“å­˜æ•°æ®å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'));
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ åº“å­˜æ•°æ®åŠ è½½å¤±è´¥:', {xhr, status, error});
            let errorMsg = 'åŠ è½½åº“å­˜æ•°æ®å¤±è´¥';
            if (status === 'timeout') {
                errorMsg = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            } else if (xhr.status === 404) {
                errorMsg = 'APIç«¯ç‚¹ä¸å­˜åœ¨';
            } else if (xhr.status === 500) {
                errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
            }
            showMessage('error', errorMsg);
        }
    });
}

// æ˜¾ç¤ºåº“å­˜é€‰æ‹©å™¨ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function showInventorySelector(inventoryData) {
    console.log('æ˜¾ç¤ºåº“å­˜é€‰æ‹©å™¨:', inventoryData);

    // å­˜å‚¨åŸå§‹æ•°æ®
    window.currentInventoryData = inventoryData;
    window.selectedInventoryItems = [];

    // æ¸²æŸ“åº“å­˜è¡¨æ ¼
    renderInventoryTable(inventoryData);

    // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
    bindInventoryModalEvents();

    // æ˜¾ç¤ºæ¨¡æ€æ¡†å‰çš„è°ƒè¯•ä¿¡æ¯
    const modalElement = document.getElementById('inventoryModal');
    const modalDialog = modalElement.querySelector('.modal-dialog');
    const modalContent = modalElement.querySelector('.modal-content');
    const modalBody = modalElement.querySelector('.modal-body');

    console.log('ğŸ” æ¨¡æ€æ¡†å…ƒç´ è°ƒè¯•ä¿¡æ¯:');
    console.log('- è§†çª—å°ºå¯¸:', window.innerWidth + 'x' + window.innerHeight);
    console.log('- modalElementå­˜åœ¨:', !!modalElement);
    console.log('- modalDialogå­˜åœ¨:', !!modalDialog);
    console.log('- modalContentå­˜åœ¨:', !!modalContent);
    console.log('- modalBodyå­˜åœ¨:', !!modalBody);

    if (modalDialog) {
        const dialogStyles = window.getComputedStyle(modalDialog);
        console.log('- modalDialogå½“å‰æ ·å¼:');
        console.log('  - width:', dialogStyles.width);
        console.log('  - height:', dialogStyles.height);
        console.log('  - max-width:', dialogStyles.maxWidth);
        console.log('  - margin:', dialogStyles.margin);
    }

    if (modalContent) {
        const contentStyles = window.getComputedStyle(modalContent);
        console.log('- modalContentå½“å‰æ ·å¼:');
        console.log('  - width:', contentStyles.width);
        console.log('  - height:', contentStyles.height);
        console.log('  - max-height:', contentStyles.maxHeight);
    }

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
    modal.show();

    // æ¨¡æ€æ¡†æ˜¾ç¤ºåçš„è°ƒè¯•ä¿¡æ¯
    setTimeout(() => {
        console.log('ğŸ” æ¨¡æ€æ¡†æ˜¾ç¤ºåçš„å°ºå¯¸:');
        if (modalDialog) {
            const rect = modalDialog.getBoundingClientRect();
            console.log('- modalDialogå®é™…å°ºå¯¸:', rect.width + 'x' + rect.height);
            console.log('- modalDialogä½ç½®:', 'left:' + rect.left + ', top:' + rect.top);
        }

        if (modalContent) {
            const rect = modalContent.getBoundingClientRect();
            console.log('- modalContentå®é™…å°ºå¯¸:', rect.width + 'x' + rect.height);
        }

        if (modalBody) {
            const rect = modalBody.getBoundingClientRect();
            console.log('- modalBodyå®é™…å°ºå¯¸:', rect.width + 'x' + rect.height);
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰CSSå†²çª
        const allStyles = document.querySelectorAll('style, link[rel="stylesheet"]');
        console.log('- é¡µé¢ä¸­çš„æ ·å¼è¡¨æ•°é‡:', allStyles.length);

        // æ£€æŸ¥Bootstrapç‰ˆæœ¬
        if (typeof bootstrap !== 'undefined') {
            console.log('- Bootstrapç‰ˆæœ¬å¯ç”¨');
        } else {
            console.log('- âš ï¸ BootstrapæœªåŠ è½½');
        }
    }, 500);
}

// æ¸²æŸ“åº“å­˜è¡¨æ ¼
function renderInventoryTable(data) {
    const tbody = document.getElementById('inventoryTableBody');
    tbody.innerHTML = '';

    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">æš‚æ— åº“å­˜æ•°æ®</td></tr>';
        return;
    }

    // è°ƒè¯•ï¼šæ‰“å°æ‰€æœ‰æ•°æ®çš„å…³é”®å­—æ®µ
    if (data.length > 0) {
        console.log('ğŸ” æ‰€æœ‰åº“å­˜æ•°æ®çš„å…³é”®å­—æ®µ:');
        data.forEach((item, index) => {
            console.log(`è®°å½• ${index + 1}:`);
            console.log(`  - ID: ${item.id}`);
            console.log(`  - å®¢æˆ·: ${item.customer_name}`);
            console.log(`  - æ¿æ•°: ${item.pallet_count} (ç±»å‹: ${typeof item.pallet_count})`);
            console.log(`  - ä»¶æ•°: ${item.package_count} (ç±»å‹: ${typeof item.package_count})`);
            console.log(`  - é‡é‡: ${item.weight} (ç±»å‹: ${typeof item.weight})`);
            console.log(`  - ä½“ç§¯: ${item.volume} (ç±»å‹: ${typeof item.volume})`);
            console.log(`  - åº“ä½: ${item.location} (ç±»å‹: ${typeof item.location})`);
            console.log(`  - å•æ®: ${item.documents} (ç±»å‹: ${typeof item.documents})`);
            console.log('---');
        });
    }

    data.forEach((item, index) => {
        const row = document.createElement('tr');
        row.style.cursor = 'pointer';
        row.innerHTML = `
            <td class="text-center">
                <input type="checkbox" class="form-check-input inventory-checkbox"
                       value="${item.id}" data-index="${index}">
            </td>
            <td class="text-truncate" title="${item.customer_name || ''}">
                ${item.customer_name || ''}
            </td>
            <td class="text-truncate identification-code" title="${item.identification_code || ''}">
                ${item.identification_code || ''}
            </td>
            <td>${item.plate_number || ''}</td>
            <td class="text-center">${item.pallet_count || ''}</td>
            <td class="text-center">${item.package_count || ''}</td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-primary full-out-btn"
                        onclick="setFullOut(this)" data-pallets="${item.pallet_count || 0}"
                        data-packages="${item.package_count || 0}">å…¨å‡º</button>
            </td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm outbound-pallets"
                       min="0" max="${item.pallet_count || 0}" value="0" style="width:70px;"
                       onchange="validateOutboundQuantity(this, ${item.pallet_count || 0})">
            </td>
            <td class="text-center">
                <input type="number" class="form-control form-control-sm outbound-packages"
                       min="0" max="${item.package_count || 0}" value="0" style="width:70px;"
                       onchange="validateOutboundQuantity(this, ${item.package_count || 0})">
            </td>
            <td class="text-end">${item.weight || ''}</td>
            <td class="text-end">${item.volume || ''}</td>
            <td class="text-center">${item.documents || ''}</td>
            <td class="text-truncate" title="${item.service_staff || ''}">
                ${item.service_staff || ''}
            </td>
            <td>
                <input type="text" class="form-control form-control-sm inventory-remarks"
                       value="${item.remarks || ''}"
                       placeholder="è¾“å…¥å¤‡æ³¨"
                       style="width: 110px; font-size: 11px;"
                       data-inventory-id="${item.id}">
            </td>
        `;

        // åŒå‡»è¡Œé€‰æ‹©
        row.addEventListener('dblclick', function() {
            const checkbox = row.querySelector('.inventory-checkbox');
            checkbox.checked = !checkbox.checked;
            updateSelectedCount();
        });

        tbody.appendChild(row);
    });

    updateSelectedCount();
}

// ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
function bindInventoryModalEvents() {
    // é¿å…é‡å¤ç»‘å®š
    $('#inventoryModal').off('click.inventory');

    // å•ä¸ªå¤é€‰æ¡†å˜åŒ–
    $('#inventoryModal').on('click.inventory', '.inventory-checkbox', function() {
        updateSelectedCount();
    });

    // å…¨é€‰
    $('#selectAllInventory').off('click').on('click', function() {
        $('.inventory-checkbox').prop('checked', true);
        updateSelectedCount();
    });

    // æ¸…ç©ºé€‰æ‹©
    $('#clearAllSelection').off('click').on('click', function() {
        $('.inventory-checkbox').prop('checked', false);
        updateSelectedCount();
    });

    // ç¡®è®¤é€‰æ‹©
    $('#confirmSelection').off('click').on('click', function() {
        confirmInventorySelection();
    });

    // æœç´¢åŠŸèƒ½
    $('#searchInventory').off('click').on('click', function() {
        const customerName = $('#searchCustomer').val().trim();

        let filteredData = window.currentInventoryData;

        if (customerName) {
            filteredData = filteredData.filter(item =>
                item.customer_name && item.customer_name.includes(customerName)
            );
        }

        renderInventoryTable(filteredData);
    });

    // æ¸…ç©ºæœç´¢
    $('#clearSearch').off('click').on('click', function() {
        $('#searchCustomer').val('');
        renderInventoryTable(window.currentInventoryData);
    });
}

// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    const count = $('.inventory-checkbox:checked').length;
    // ç”±äºæ¨¡æ€æ¡†ä¸­æ²¡æœ‰selectedCountå…ƒç´ ï¼Œè¿™é‡Œåªè®°å½•æ—¥å¿—
    console.log(`å·²é€‰æ‹© ${count} æ¡åº“å­˜è®°å½•`);
}

// å°†é€‰ä¸­çš„åº“å­˜æ•°æ®å¡«å……åˆ°è¡¨æ ¼
function fillInventoryToTable(selectedItems) {
    console.log('ğŸ” fillInventoryToTable è°ƒç”¨ï¼Œwindow.hot çŠ¶æ€:', !!window.hot);
    console.log('ğŸ” selectedItems æ•°é‡:', selectedItems.length);

    if (!window.hot) {
        console.error('âŒ è¡¨æ ¼æœªåˆå§‹åŒ–ï¼Œwindow.hot ä¸º:', window.hot);
        showMessage('error', 'è¡¨æ ¼æœªåˆå§‹åŒ–');
        return;
    }

    // æ¸…ç©ºç°æœ‰æ•°æ®
    window.hot.loadData([]);

    // å¡«å……é€‰ä¸­çš„åº“å­˜æ•°æ®
    const tableData = selectedItems.map(item => ({
        plate_number: item.plate_number || '',
        customer_name: item.customer_name || '',
        identification_code: item.identification_code || '',
        pallet_count: item.outbound_pallet_count || item.pallet_count || '',
        package_count: item.outbound_package_count || item.package_count || '',
        weight: item.weight || '',
        volume: item.volume || '',
        documents: item.documents || '',
        service_staff: item.service_staff || '',
        remarks: item.remarks || '' // ä½¿ç”¨ä»æ¨¡æ€æ¡†è·å–çš„å¤‡æ³¨
    }));

    window.hot.loadData(tableData);
    console.log('âœ… åº“å­˜æ•°æ®å·²å¡«å……åˆ°è¡¨æ ¼');
}

// ä¿å­˜æ•°æ®ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function saveAllData() {
    // éªŒè¯å…¬å…±ä¿¡æ¯
    const commonPlateNumber = $('#commonPlateNumber').val();
    const driverName = $('#driverName').val();
    const driverContact = $('#driverContact').val();
    const targetWarehouse = $('#targetWarehouse').val();
    const returnTime = $('#returnTime').val();

    if (!commonPlateNumber) {
        showMessage('error', 'è¯·å¡«å†™å‡ºåº“è½¦ç‰Œ');
        return;
    }

    if (!driverName) {
        showMessage('error', 'è¯·å¡«å†™å¸æœºå§“å');
        return;
    }

    if (!driverContact) {
        showMessage('error', 'è¯·å¡«å†™å¸æœºè”ç³»æ–¹å¼');
        return;
    }

    // éªŒè¯æ‰‹æœºå·æ ¼å¼
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(driverContact)) {
        showMessage('error', 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼');
        return;
    }

    if (!targetWarehouse) {
        showMessage('error', 'è¯·é€‰æ‹©ç›®çš„ä»“');
        return;
    }

    if (!returnTime) {
        showMessage('error', 'è¯·é€‰æ‹©è¿”å›æ—¶é—´');
        return;
    }

    if (!window.hot) {
        showMessage('error', 'è¡¨æ ¼æœªåˆå§‹åŒ–');
        return;
    }

    const data = window.hot.getData();
    const warehouseAddress = $('#warehouseAddress').val();
    const warehouseContact = $('#warehouseContact').val();

    console.log('ä¿å­˜åç«¯ä»“è¿”å›å‰ç«¯ä»“æ•°æ®:', data);
    console.log('ğŸ” å‘é€çš„æ•°æ®ç»“æ„è¯¦æƒ…:');
    console.log('- recordsæ•°é‡:', data.length);
    console.log('- ç¬¬ä¸€æ¡è®°å½•ç¤ºä¾‹:', data[0]);

    // å‘é€åˆ°ä¸“é—¨çš„APIç«¯ç‚¹
    $.ajax({
        url: '/api/backend/outbound/return_frontend',
        method: 'POST',
        data: JSON.stringify({
            records: data,
            common_data: {
                plate_number: commonPlateNumber,
                driver_name: driverName,
                driver_contact: driverContact,
                target_warehouse: targetWarehouse,
                warehouse_address: warehouseAddress,
                warehouse_contact: warehouseContact,
                return_time: returnTime
            },
            destination: 'return_frontend',
            warehouse_type: 'backend'
        }),
        contentType: 'application/json',
        success: function(response) {
            console.log('âœ… APIå“åº”:', response);
            console.log('ğŸ” å“åº”è¯¦æƒ…:');
            console.log('- success:', response.success);
            console.log('- message:', response.message);
            console.log('- success_count:', response.success_count);
            console.log('- total_count:', response.total_count);
            console.log('- errors:', response.errors);
            if (response.success) {
                showMessage('success', `ä¿å­˜æˆåŠŸï¼å…±å¤„ç† ${response.total_count} æ¡è®°å½•ï¼ŒæˆåŠŸ ${response.success_count} æ¡`);

                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                if (response.errors && response.errors.length > 0) {
                    console.warn('âš ï¸ éƒ¨åˆ†è®°å½•å¤„ç†å¤±è´¥:', response.errors);
                    showMessage('warning', `éƒ¨åˆ†è®°å½•å¤„ç†å¤±è´¥ï¼š${response.errors.slice(0, 3).join('; ')}`);
                }

                // æ¸…ç©ºè¡¨æ ¼
                if (window.hot) {
                    window.hot.loadData([{}]);
                }

                // æ¸…ç©ºå…¬å…±ä¿¡æ¯
                $('#commonPlateNumber').val('');
                $('#driverName').val('');
                $('#driverContact').val('');
                $('#targetWarehouse').val('');
                $('#returnTime').val('');
                $('#warehouseAddress').val('');
                $('#warehouseContact').val('');
            } else {
                console.error('âŒ ä¿å­˜å¤±è´¥:', response.message);
                showMessage('error', 'ä¿å­˜å¤±è´¥ï¼š' + response.message);
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', {xhr, status, error});
            let errorMsg = 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMsg = 'ä¿å­˜å¤±è´¥ï¼š' + xhr.responseJSON.message;
            } else if (xhr.status === 403) {
                errorMsg = 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ';
            } else if (xhr.status === 500) {
                errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
            }

            showMessage('error', errorMsg);
        }
    });
}

// ç»‘å®šåŸºæœ¬äº‹ä»¶ï¼ˆä¸ä¾èµ–Handsontableï¼‰
function bindBasicEvents() {
    // åŠ è½½åº“å­˜
    $('#loadInventoryBtn').click(function() {
        console.log('åŠ è½½åº“å­˜æŒ‰é’®è¢«ç‚¹å‡»');
        loadInventoryData();
    });

    // æ¸…ç©ºè¡¨æ ¼
    $('#clearAllBtn').click(function() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
            if (window.hot) {
                window.hot.loadData([{}]);
            } else {
                console.log('è¡¨æ ¼æœªåˆå§‹åŒ–ï¼Œæ— æ³•æ¸…ç©º');
            }
        }
    });

    // ä¿å­˜å…¨éƒ¨
    $('#saveAllBtn').click(function() {
        saveAllData();
    });

    console.log('âœ… åŸºæœ¬äº‹ä»¶å·²ç»‘å®š');
}

function initializePage() {
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–é¡µé¢...');

    // åˆå§‹åŒ–Handsontable
    const container = document.getElementById('hot-container');
    console.log('ğŸ” å®¹å™¨å…ƒç´ :', !!container);
    let hot;
    
    // è¡¨æ ¼åˆ—å®šä¹‰ - ä¸å…¥åº“å­—æ®µä¿æŒä¸€è‡´
    const columns = [
        {
            data: 'plate_number',
            title: '<span class="required">å…¥åº“è½¦ç‰Œ*</span>',
            type: 'text',
            width: 120
        },
        {
            data: 'customer_name',
            title: '<span class="required">å®¢æˆ·åç§°*</span>',
            type: 'text',
            width: 150
        },
        {
            data: 'identification_code',
            title: 'è¯†åˆ«ç¼–ç ',
            type: 'text',
            readOnly: true,
            width: 180
        },
        {
            data: 'pallet_count',
            title: 'æ¿æ•°',
            type: 'numeric',
            numericFormat: {
                pattern: '0'
            },
            width: 80
        },
        {
            data: 'package_count',
            title: 'ä»¶æ•°',
            type: 'numeric',
            numericFormat: {
                pattern: '0'
            },
            width: 80
        },
        {
            data: 'weight',
            title: 'é‡é‡(kg)',
            type: 'numeric',
            numericFormat: {
                pattern: '0.00'
            },
            width: 100
        },
        {
            data: 'volume',
            title: 'ä½“ç§¯(mÂ³)',
            type: 'numeric',
            numericFormat: {
                pattern: '0.00'
            },
            width: 100
        },

        {
            data: 'documents',
            title: 'å•æ®',
            type: 'text',
            width: 80
        },
        {
            data: 'service_staff',
            title: 'è·Ÿå•å®¢æœ',
            type: 'text',
            width: 100
        },

        {
            data: 'remarks',
            title: 'å¤‡æ³¨',
            type: 'text',
            width: 200
        }
    ];
    
    // åˆå§‹åŒ–è¡¨æ ¼
    hot = new Handsontable(container, {
        data: [{}], // åˆå§‹ä¸€è¡Œç©ºæ•°æ®
        columns: columns,
        rowHeaders: true,
        colHeaders: true,
        contextMenu: true,
        manualRowResize: true,
        manualColumnResize: true,
        stretchH: 'all',
        autoWrapRow: true,
        autoWrapCol: true,
        licenseKey: 'non-commercial-and-evaluation',
        afterChange: function(changes, source) {
            // é¿å…åœ¨ç¨‹åºåŒ–æ›´æ–°æ—¶è§¦å‘å¾ªç¯è°ƒç”¨
            if (source === 'edit' && changes) {
                // åªåœ¨ç”¨æˆ·æ‰‹åŠ¨ç¼–è¾‘æ—¶è¿›è¡Œå¤„ç†ï¼Œé¿å…å¾ªç¯è°ƒç”¨
                console.log('ç”¨æˆ·ç¼–è¾‘äº†æ•°æ®:', changes);
            }
        }
    });

    // å°†è¡¨æ ¼å®ä¾‹è®¾ç½®ä¸ºå…¨å±€å˜é‡ï¼Œä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
    window.hot = hot;
    console.log('âœ… Handsontable å·²åˆå§‹åŒ–å¹¶è®¾ç½®ä¸º window.hot:', !!window.hot);
    
    // ä»“åº“ä¿¡æ¯æ˜ å°„ï¼ˆä»APIåŠ¨æ€åŠ è½½ï¼‰
    let warehouseInfo = {};

    // ä»æœåŠ¡å™¨ç«¯æ•°æ®åŠ è½½æ”¶è´§äººä¿¡æ¯
    function loadWarehouseData() {
        console.log('ğŸ”„ å¼€å§‹åŠ è½½æ”¶è´§äººä¿¡æ¯...');

        // ä½¿ç”¨æœåŠ¡å™¨ç«¯ä¼ é€’çš„æ•°æ®
        const receiversData = {{ receivers_data | tojson | safe }};
        console.log('ğŸ“‹ æœåŠ¡å™¨ç«¯æ”¶è´§äººæ•°æ®:', receiversData);

        // è½¬æ¢ä¸ºå‰ç«¯éœ€è¦çš„æ ¼å¼
        warehouseInfo = {};
        if (receiversData && Array.isArray(receiversData)) {
            receiversData.forEach(receiver => {
                warehouseInfo[receiver.warehouse_name] = {
                    contact: receiver.contact,
                    address: receiver.address
                };
                console.log(`âœ… åŠ è½½æ”¶è´§äºº: ${receiver.warehouse_name}`);
            });
            console.log('ğŸ‰ æ”¶è´§äººæ•°æ®åŠ è½½æˆåŠŸ:', Object.keys(warehouseInfo));

            // å¦‚æœå½“å‰å·²é€‰æ‹©ç›®çš„ä»“ï¼Œç«‹å³æ›´æ–°åœ°å€å’Œè”ç³»äºº
            const selectedWarehouse = $('#targetWarehouse').val();
            if (selectedWarehouse && warehouseInfo[selectedWarehouse]) {
                $('#warehouseAddress').val(warehouseInfo[selectedWarehouse].address);
                $('#warehouseContact').val(warehouseInfo[selectedWarehouse].contact);
                console.log(`ğŸ”„ è‡ªåŠ¨æ›´æ–° ${selectedWarehouse} çš„ä¿¡æ¯`);
            }
        } else {
            console.error('âŒ æ”¶è´§äººæ•°æ®æ ¼å¼é”™è¯¯:', receiversData);
            showMessage('error', 'æ”¶è´§äººä¿¡æ¯æ ¼å¼é”™è¯¯');
        }
    }

    // ç›‘å¬ç›®çš„ä»“é€‰æ‹©å˜åŒ–
    $('#targetWarehouse').change(function() {
        const selectedWarehouse = $(this).val();
        console.log('ğŸ­ ç›®çš„ä»“é€‰æ‹©å˜åŒ–:', selectedWarehouse);
        console.log('ğŸ“‹ å½“å‰æ”¶è´§äººæ•°æ®:', warehouseInfo);

        if (selectedWarehouse && warehouseInfo[selectedWarehouse]) {
            const receiverInfo = warehouseInfo[selectedWarehouse];
            $('#warehouseAddress').val(receiverInfo.address);
            $('#warehouseContact').val(receiverInfo.contact);
            console.log(`âœ… å·²æ›´æ–° ${selectedWarehouse} çš„ä¿¡æ¯:`);
            console.log(`   åœ°å€: ${receiverInfo.address}`);
            console.log(`   è”ç³»äºº: ${receiverInfo.contact}`);
        } else {
            $('#warehouseAddress').val('');
            $('#warehouseContact').val('');
            if (selectedWarehouse) {
                console.warn(`âš ï¸ æœªæ‰¾åˆ° ${selectedWarehouse} çš„æ”¶è´§äººä¿¡æ¯`);
                console.log('å¯ç”¨çš„æ”¶è´§äºº:', Object.keys(warehouseInfo));
            } else {
                console.log('ğŸ”„ æ¸…ç©ºåœ°å€å’Œè”ç³»äººå­—æ®µ');
            }
        }
    });

    // ç›‘å¬å…¬å…±è½¦ç‰Œå·å˜åŒ–
    $('#commonPlateNumber').on('input', function() {
        updateCommonDataInTable();
    });



    // æ·»åŠ è¡Œ
    $('#addRowBtn').click(function() {
        window.hot.alter('insert_row_above', window.hot.countRows());
        updateCommonDataInTable();
    });

    // åˆ é™¤è¡Œ
    $('#deleteRowBtn').click(function() {
        const selected = window.hot.getSelected();
        if (selected && selected.length > 0) {
            window.hot.alter('remove_row', selected[0][0]);
        }
    });



    // æ³¨æ„ï¼šåŸºæœ¬äº‹ä»¶å·²åœ¨bindBasicEvents()ä¸­ç»‘å®šï¼Œè¿™é‡Œä¸éœ€è¦é‡å¤ç»‘å®š
    
    // æ›´æ–°è¡¨æ ¼ä¸­çš„å…¬å…±æ•°æ®
    function updateCommonDataInTable() {
        if (!window.hot) return; // ç¡®ä¿è¡¨æ ¼å·²åˆå§‹åŒ–

        // æ³¨æ„ï¼šå…¥åº“è½¦ç‰Œæ¥è‡ªåº“å­˜è®°å½•ï¼Œä¸åº”è¯¥è¢«å…¬å…±åŒºåŸŸçš„å‡ºåº“è½¦ç‰Œè¦†ç›–
        // è¿™é‡Œæš‚æ—¶ä¸éœ€è¦æ›´æ–°ä»»ä½•è¡¨æ ¼æ•°æ®ï¼Œå› ä¸ºï¼š
        // 1. å…¥åº“è½¦ç‰Œåº”è¯¥ä»åº“å­˜æ•°æ®åŠ è½½
        // 2. å‡ºåº“è½¦ç‰Œåœ¨å…¬å…±åŒºåŸŸå•ç‹¬ç®¡ç†
        // 3. å…¶ä»–å­—æ®µç”¨æˆ·æ‰‹åŠ¨å¡«å†™æˆ–ä»åº“å­˜åŠ è½½

        console.log('å…¬å…±æ•°æ®åŒºåŸŸå·²æ›´æ–°ï¼Œå…¥åº“è½¦ç‰Œä¿æŒä¸å˜');
    }





    // ä¿å­˜æ•°æ®
    function saveAllData() {
        // éªŒè¯å…¬å…±ä¿¡æ¯
        const commonPlateNumber = $('#commonPlateNumber').val();
        const driverName = $('#driverName').val();
        const driverContact = $('#driverContact').val();
        const targetWarehouse = $('#targetWarehouse').val();
        const returnTime = $('#returnTime').val();

        if (!commonPlateNumber) {
            showMessage('error', 'è¯·å¡«å†™å‡ºåº“è½¦ç‰Œ');
            return;
        }

        if (!driverName) {
            showMessage('error', 'è¯·å¡«å†™å¸æœºå§“å');
            return;
        }

        if (!driverContact) {
            showMessage('error', 'è¯·å¡«å†™å¸æœºè”ç³»æ–¹å¼');
            return;
        }

        // éªŒè¯æ‰‹æœºå·æ ¼å¼
        const phoneRegex = /^1[3-9]\d{9}$/;
        if (!phoneRegex.test(driverContact)) {
            showMessage('error', 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼');
            return;
        }

        if (!targetWarehouse) {
            showMessage('error', 'è¯·é€‰æ‹©ç›®çš„ä»“');
            return;
        }

        if (!returnTime) {
            showMessage('error', 'è¯·é€‰æ‹©è¿”å›æ—¶é—´');
            return;
        }

        const data = window.hot.getData();
        const warehouseAddress = $('#warehouseAddress').val();
        const warehouseContact = $('#warehouseContact').val();

        console.log('ä¿å­˜åç«¯ä»“è¿”å›å‰ç«¯ä»“æ•°æ®:', data);
        console.log('ğŸ” å‘é€çš„æ•°æ®ç»“æ„è¯¦æƒ…:');
        console.log('- recordsæ•°é‡:', data.length);
        console.log('- ç¬¬ä¸€æ¡è®°å½•ç¤ºä¾‹:', data[0]);

        // å‘é€åˆ°ä¸“é—¨çš„APIç«¯ç‚¹
        $.ajax({
            url: '/api/backend/outbound/return_frontend',
            method: 'POST',
            data: JSON.stringify({
                records: data,
                common_data: {
                    plate_number: commonPlateNumber,
                    driver_name: driverName,
                    driver_contact: driverContact,
                    target_warehouse: targetWarehouse,
                    warehouse_address: warehouseAddress,
                    warehouse_contact: warehouseContact,
                    return_time: returnTime
                },
                destination: 'return_frontend',
                warehouse_type: 'backend'
            }),
            contentType: 'application/json',
            success: function(response) {
                console.log('âœ… APIå“åº”:', response);
                if (response.success) {
                    showMessage('success', `ä¿å­˜æˆåŠŸï¼å…±å¤„ç† ${response.total_count} æ¡è®°å½•ï¼ŒæˆåŠŸ ${response.success_count} æ¡`);

                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (response.errors && response.errors.length > 0) {
                        console.warn('âš ï¸ éƒ¨åˆ†è®°å½•å¤„ç†å¤±è´¥:', response.errors);
                        showMessage('warning', `éƒ¨åˆ†è®°å½•å¤„ç†å¤±è´¥ï¼š${response.errors.slice(0, 3).join('; ')}`);
                    }

                    // æ¸…ç©ºè¡¨æ ¼
                    if (window.hot) {
                        window.hot.loadData([{}]);
                    }

                    // æ¸…ç©ºå…¬å…±ä¿¡æ¯
                    $('#commonPlateNumber').val('');
                    $('#driverName').val('');
                    $('#driverContact').val('');
                    $('#targetWarehouse').val('');
                    $('#returnTime').val('');
                    $('#warehouseAddress').val('');
                    $('#warehouseContact').val('');
                } else {
                    console.error('âŒ ä¿å­˜å¤±è´¥:', response.message);
                    showMessage('error', 'ä¿å­˜å¤±è´¥ï¼š' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥:', {xhr, status, error});
                let errorMsg = 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';

                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = 'ä¿å­˜å¤±è´¥ï¼š' + xhr.responseJSON.message;
                } else if (xhr.status === 403) {
                    errorMsg = 'æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œ';
                } else if (xhr.status === 500) {
                    errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜';
                }

                showMessage('error', errorMsg);
            }
        });
    }
    


    // é¡µé¢åˆå§‹åŒ–
    loadWarehouseData(); // åŠ è½½ä»“åº“æ•°æ®
    updateCommonDataInTable(); // åˆå§‹åŒ–æ—¶è®¾ç½®é»˜è®¤æ•°æ®ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰

    // è®¾ç½®è¿”å›æ—¶é—´é»˜è®¤å€¼ä¸ºä»Šå¤©
    $('#returnTime').val(new Date().toISOString().split('T')[0]);

    console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œwindow.hot çŠ¶æ€:', !!window.hot);

    // ç¡®ä¿æ¨¡æ€æ¡†äº‹ä»¶ç»‘å®š
    bindInventoryModalEvents();
}

// ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
function bindInventoryModalEvents() {
    // é¿å…é‡å¤ç»‘å®š
    $('#inventoryModal').off('click.inventory');

    // å•ä¸ªå¤é€‰æ¡†å˜åŒ–
    $('#inventoryModal').on('click.inventory', '.inventory-checkbox', function() {
        updateSelectedCount();
    });

    // å…¨é€‰
    $('#selectAllInventory').off('click').on('click', function() {
        $('.inventory-checkbox').prop('checked', true);
        updateSelectedCount();
    });

    // æ¸…ç©ºé€‰æ‹©
    $('#clearAllSelection').off('click').on('click', function() {
        $('.inventory-checkbox').prop('checked', false);
        updateSelectedCount();
    });

    // ç¡®è®¤é€‰æ‹©
    $('#confirmSelection').off('click').on('click', function() {
        confirmInventorySelection();
    });


}





// æœç´¢åº“å­˜
function searchInventory() {
    const customerName = document.getElementById('searchCustomer').value.trim();

    if (!window.currentInventoryData) {
        return;
    }

    let filteredData = window.currentInventoryData;

    if (customerName) {
        filteredData = filteredData.filter(item =>
            item.customer_name && item.customer_name.includes(customerName)
        );
    }

    renderInventoryTable(filteredData);
}

// é‡ç½®æœç´¢
function resetInventorySearch() {
    document.getElementById('searchCustomer').value = '';

    if (window.currentInventoryData) {
        renderInventoryTable(window.currentInventoryData);
    }
}

// ç¡®è®¤é€‰æ‹©åº“å­˜
function confirmInventorySelection() {
    const selectedCheckboxes = document.querySelectorAll('.inventory-checkbox:checked');
    const selectedItems = [];

    selectedCheckboxes.forEach(checkbox => {
        const index = parseInt(checkbox.dataset.index);
        if (window.currentInventoryData && window.currentInventoryData[index]) {
            const item = { ...window.currentInventoryData[index] };

            // è·å–è¯¥è¡Œçš„å‡ºåº“æ•°é‡å’Œå¤‡æ³¨
            const row = checkbox.closest('tr');
            const outboundPallets = row.querySelector('.outbound-pallets');
            const outboundPackages = row.querySelector('.outbound-packages');
            const remarksInput = row.querySelector('.inventory-remarks');

            if (outboundPallets && outboundPackages) {
                item.outbound_pallet_count = parseInt(outboundPallets.value) || 0;
                item.outbound_package_count = parseInt(outboundPackages.value) || 0;
            }

            // è·å–ç”¨æˆ·è¾“å…¥çš„å¤‡æ³¨
            if (remarksInput) {
                item.remarks = remarksInput.value.trim();
            }

            selectedItems.push(item);
        }
    });

    if (selectedItems.length === 0) {
        showMessage('warning', 'è¯·é€‰æ‹©è‡³å°‘ä¸€æ¡åº“å­˜è®°å½•');
        return;
    }

    // éªŒè¯æ‰€æœ‰é€‰ä¸­é¡¹ç›®éƒ½æœ‰å‡ºåº“æ•°é‡
    for (let item of selectedItems) {
        if ((item.outbound_pallet_count === 0 || !item.outbound_pallet_count) &&
            (item.outbound_package_count === 0 || !item.outbound_package_count)) {
            showMessage('warning', `è¯·ä¸º ${item.customer_name} è®¾ç½®å‡ºåº“æ•°é‡`);
            return;
        }
    }

    console.log('é€‰ä¸­çš„åº“å­˜é¡¹ç›®:', selectedItems);

    // å°†é€‰ä¸­çš„åº“å­˜æ•°æ®å¡«å……åˆ°è¡¨æ ¼
    fillInventoryToTable(selectedItems);

    // å…³é—­æ¨¡æ€æ¡†
    bootstrap.Modal.getInstance(document.getElementById('inventoryModal')).hide();

    showMessage('success', `å·²é€‰æ‹© ${selectedItems.length} æ¡åº“å­˜è®°å½•`);
}

// å…¨å‡ºæŒ‰é’®åŠŸèƒ½
function setFullOut(button) {
    var row = button.closest('tr');
    var palletsInput = row.querySelector('.outbound-pallets');
    var packagesInput = row.querySelector('.outbound-packages');
    var maxPallets = parseInt(button.getAttribute('data-pallets'));
    var maxPackages = parseInt(button.getAttribute('data-packages'));

    palletsInput.value = maxPallets;
    packagesInput.value = maxPackages;

    // è‡ªåŠ¨å‹¾é€‰è¯¥è¡Œ
    var checkbox = row.querySelector('.inventory-checkbox');
    if (!checkbox.checked) {
        checkbox.checked = true;
    }

    console.log('è®¾ç½®å…¨å‡º:', maxPallets + 'æ¿', maxPackages + 'ä»¶');
}

// éªŒè¯å‡ºåº“æ•°é‡
function validateOutboundQuantity(input, maxValue) {
    var value = parseInt(input.value);
    if (isNaN(value) || value < 0) {
        input.value = 0;
        return;
    }
    if (value > maxValue) {
        input.value = maxValue;
        showMessage('warning', `å‡ºåº“æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜æ•°é‡ ${maxValue}`);
    }
}

</script>
{% endblock %}
