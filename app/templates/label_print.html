{% extends 'base.html' %}

{% block styles %}
{{ super() }}
<style>
    /* å…¥åº“è®°å½•è¡Œæ ·å¼ */
    .inbound-record-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .inbound-record-row:hover {
        background-color: #f8f9fa !important;
    }

    .inbound-record-row:active {
        background-color: #e9ecef !important;
    }

    /* é€‰ä¸­çŠ¶æ€çš„è¡Œ */
    .inbound-record-row.selected {
        background-color: #d1ecf1 !important;
    }

    /* å…¥åº“é€‰æ‹©è¡¨æ ¼ä¼˜åŒ– */
    .table-responsive table {
        font-size: 12px;
    }

    .table-responsive th {
        font-size: 13px;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        padding: 8px 4px;
        white-space: nowrap;
    }

    .table-responsive td {
        vertical-align: middle;
        padding: 6px 4px;
        max-width: 0; /* é…åˆtable-layout: fixedä½¿ç”¨ */
        overflow: hidden;
    }

    /* è¯†åˆ«ç¼–ç åˆ—ç‰¹æ®Šå¤„ç† */
    .table-responsive td:nth-child(2) {
        font-family: 'Courier New', monospace;
        font-size: 11px;
    }

    /* æ•°å­—åˆ—å±…ä¸­ */
    .table-responsive td:nth-child(6),
    .table-responsive td:nth-child(7) {
        text-align: center;
        font-weight: 500;
    }
    .card-body {
        padding: 1.5rem;
    }
    .form-section {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
    }
    .form-section-title {
        margin-bottom: 1rem;
        font-weight: 500;
    }
    .print-preview {
        border: 1px solid #ddd;
        padding: 20px;
        margin: 20px 0;
        min-height: 200px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .preview-label {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 5px;
    }
    .preview-content {
        font-size: 16px;
        margin-bottom: 15px;
    }
    .preview-heading {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        border-bottom: 1px dashed #ddd;
        padding-bottom: 8px;
    }
    .nav-tabs .nav-link.active {
        background-color: #f0f0f0;
    }
    /* æ›´æ–°é¢„è§ˆåŒºåŸŸæ ·å¼ï¼Œå‚è€ƒPyQT5é£æ ¼ */
    #previewSection {
        display: none;
    }
    .labels-list-container {
        max-height: 300px;
        overflow-y: auto;
    }
    .preview-container {
        height: 400px;
        overflow-y: auto;
    }
    .label-list-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .label-list-item:hover {
        background-color: #f0f0f0;
    }
    .label-list-item.active {
        background-color: #e7f1ff;
        border-color: #b8daff;
    }
    /* æ·»åŠ è‡ªå®šä¹‰å°ºå¯¸ç¼–è¾‘æ ·å¼ */
    .custom-size-inputs {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }
    .custom-size-inputs input {
        width: 80px;
        margin: 0 5px;
    }
    .custom-size-inputs span {
        margin: 0 5px;
    }

    /* æ‰“å°æœºè®¾ç½®å¯¹è¯æ¡†æ ·å¼ */
    #printerSettingsModal .card {
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: all 0.3s ease;
    }

    #printerSettingsModal .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        font-weight: 600;
        color: #5a5c69;
    }

    #printerSettingsModal .badge {
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }

    #printerSettingsModal .form-control:focus,
    #printerSettingsModal .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #printerSettingsModal .btn-outline-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.2s ease;
    }

    /* æ‰“å°ä¿¡æ¯æ‘˜è¦æ ·å¼ */
    #printerSettingsModal .fw-bold {
        color: #5a5c69;
        font-size: 0.9rem;
    }

    #printerSettingsModal .text-muted {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* æ‰“å°æœºçŠ¶æ€æŒ‡ç¤ºå™¨ */
    #printerSettingsModal .badge.bg-success {
        background-color: #1cc88a !important;
    }

    #printerSettingsModal .badge.bg-danger {
        background-color: #e74a3b !important;
    }

    /* æ¨¡æ€æ¡†åŠ¨ç”» */
    #printerSettingsModal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translate(0, -50px);
    }

    #printerSettingsModal.show .modal-dialog {
        transform: none;
    }

    /* çº¸å¼ è®¾ç½®å’Œé¡µè¾¹è·æ ·å¼ */
    #printerSettingsModal .btn-group .btn-check:checked + .btn {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    #printerSettingsModal .btn-outline-primary {
        border-color: #dee2e6;
        color: #6c757d;
    }

    #printerSettingsModal .btn-outline-primary:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
        color: #495057;
    }

    /* è‡ªå®šä¹‰è¾“å…¥æ¡†æ ·å¼ */
    #customPaperSize, #customMargins {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
    }

    #customPaperSize .form-label, #customMargins .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="card-title"><i class="fas fa-tag me-2"></i>æ ‡ç­¾æ‰“å°</h4>
                <small class="text-muted"><i class="fas fa-grip-lines-vertical me-1"></i>ç”Ÿæˆå’Œæ‰“å°å…¥åº“è´§ç‰©æ ‡ç­¾</small>
            </div>
            <div>
                <a href="{{ url_for('main.inbound_list') }}" class="btn btn-outline-secondary btn-sm me-2">
                    <i class="fas fa-arrow-left"></i> è¿”å›å…¥åº“è®°å½•
                </a>
            </div>
        </div>
        
        <div class="card-body">
            <!-- æ ‡ç­¾é¡µ -->
            <ul class="nav nav-tabs" id="labelTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="whole-tab" data-bs-toggle="tab" href="#whole" role="tab" aria-controls="whole" aria-selected="true">æ•´æ¿è´§ç‰©æ ‡ç­¾</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="split-tab" data-bs-toggle="tab" href="#split" role="tab" aria-controls="split" aria-selected="false">æ‹†æ¿è´§ç‰©æ ‡ç­¾</a>
                </li>
            </ul>
            
            <div class="tab-content" id="labelTabsContent">
                <!-- æ•´æ¿è´§ç‰©æ ‡ç­¾ -->
                <div class="tab-pane fade show active" id="whole" role="tabpanel" aria-labelledby="whole-tab">
                    <div class="form-section mt-3">
                        <h5 class="form-section-title">æ•´æ¿æ ‡ç­¾ä¿¡æ¯</h5>
                        <form id="wholeBoardForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <!-- è¯†åˆ«ç¼–ç é€‰æ‹© -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">è¯†åˆ«ç¼–ç  <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="wholeIdentificationCode" name="identification_code" readonly placeholder="è¯·é€‰æ‹©è¯†åˆ«ç¼–ç ">
                                            <button type="button" class="btn btn-outline-secondary" id="wholeSelectCodeBtn">
                                                <i class="fas fa-search"></i> é€‰æ‹©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">å…¥åº“è½¦ç‰Œ</label>
                                        <input type="text" class="form-control" id="wholePlateNumber" name="plate_number" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">å®¢æˆ·åç§°</label>
                                        <input type="text" class="form-control" id="wholeCustomerName" name="customer_name" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">æ¿æ•°</label>
                                        <input type="number" class="form-control" id="wholeBoardCount" name="pallet_count" min="0" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">ä»¶æ•°</label>
                                        <input type="number" class="form-control" id="wholePieceCount" name="package_count" min="0" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">è®¢å•ç±»å‹</label>
                                        <input type="text" class="form-control" id="wholeOrderType" name="order_type" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- å¯ä»¥ç•™ç»™æœªæ¥æ·»åŠ å…¶ä»–å­—æ®µ -->
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">æ ‡ç­¾å°ºå¯¸</label>
                                        <select class="form-select" id="wholeLabelSize">
                                            <option value="40x60" selected>40Ã—60mmï¼ˆé»˜è®¤ï¼‰</option>
                                            <option value="50x70">50Ã—70mm</option>
                                            <option value="60x90">60Ã—90mm</option>
                                            <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
                                        </select>
                                        <!-- æ·»åŠ è‡ªå®šä¹‰å°ºå¯¸è¾“å…¥æ¡† -->
                                        <div id="wholeCustomSizeInputs" class="custom-size-inputs" style="display: none;">
                                            <input type="number" class="form-control" id="wholeCustomWidth" value="40" min="10" max="200"> 
                                            <span>Ã—</span> 
                                            <input type="number" class="form-control" id="wholeCustomHeight" value="60" min="10" max="300">
                                            <span>mm</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">è‡ªå®šä¹‰æ ¼å¼</label>
                                        <select class="form-select" id="wholeLabelFormat">
                                            <option value="standard" selected>æ ‡å‡†æ ¼å¼ï¼ˆé»˜è®¤ï¼‰</option>
                                            <option value="compact">ç´§å‡‘æ ¼å¼</option>
                                            <option value="detailed">è¯¦ç»†æ ¼å¼</option>
                                            <option value="custom">è‡ªå®šä¹‰æ ¼å¼</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" id="wholePreviewBtn" class="btn btn-primary">ç”Ÿæˆæ ‡ç­¾</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- æ‹†æ¿è´§ç‰©æ ‡ç­¾ -->
                <div class="tab-pane fade" id="split" role="tabpanel" aria-labelledby="split-tab">
                    <div class="form-section mt-3">
                        <h5 class="form-section-title">æ‹†æ¿æ ‡ç­¾ä¿¡æ¯</h5>
                        <form id="splitBoardForm">
                            <!-- è¯†åˆ«ç¼–ç é€‰æ‹© -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">è¯†åˆ«ç¼–ç  <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="splitIdentificationCode" name="identification_code" readonly placeholder="è¯·é€‰æ‹©è¯†åˆ«ç¼–ç ">
                                            <button type="button" class="btn btn-outline-secondary" id="splitSelectCodeBtn">
                                                <i class="fas fa-search"></i> é€‰æ‹©
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">å…¥åº“è½¦ç‰Œ</label>
                                        <input type="text" class="form-control" id="splitPlateNumber" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">å®¢æˆ·åç§°</label>
                                        <input type="text" class="form-control" id="splitCustomerName" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">æ€»æ¿æ•°</label>
                                        <input type="number" class="form-control" id="splitTotalBoards" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">æ‹†ç¬¬å‡ æ¿</label>
                                        <input type="number" class="form-control" id="splitBoardNum" name="board_num" min="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">æ‹†æ¿æ•°é‡</label>
                                        <input type="number" class="form-control" id="splitQuantity" name="quantity" min="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">æ­¤æ¿å±‚æ•°</label>
                                        <input type="number" class="form-control" id="boardTiers" name="board_tiers" min="1">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">æ ‡ç­¾å°ºå¯¸</label>
                                        <select class="form-select" id="splitLabelSize">
                                            <option value="40x60" selected>40Ã—60mmï¼ˆé»˜è®¤ï¼‰</option>
                                            <option value="50x70">50Ã—70mm</option>
                                            <option value="60x90">60Ã—90mm</option>
                                            <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
                                        </select>
                                        <!-- æ·»åŠ è‡ªå®šä¹‰å°ºå¯¸è¾“å…¥æ¡† -->
                                        <div id="splitCustomSizeInputs" class="custom-size-inputs" style="display: none;">
                                            <input type="number" class="form-control" id="splitCustomWidth" value="40" min="10" max="200"> 
                                            <span>Ã—</span> 
                                            <input type="number" class="form-control" id="splitCustomHeight" value="60" min="10" max="300">
                                            <span>mm</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">è‡ªå®šä¹‰æ ¼å¼</label>
                                        <select class="form-select" id="splitLabelFormat">
                                            <option value="standard" selected>æ ‡å‡†æ ¼å¼ï¼ˆé»˜è®¤ï¼‰</option>
                                            <option value="compact">ç´§å‡‘æ ¼å¼</option>
                                            <option value="detailed">è¯¦ç»†æ ¼å¼</option>
                                            <option value="custom">è‡ªå®šä¹‰æ ¼å¼</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" id="splitPreviewBtn" class="btn btn-primary">ç”Ÿæˆæ ‡ç­¾</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- é¢„è§ˆåŒºåŸŸ - å‚è€ƒPyQT5é£æ ¼æ”¹é€ ä¸ºåˆ†æ å¼ -->
            <div id="previewSection" class="mt-4">
                <h5 class="mb-3" id="previewTitle">æ ‡ç­¾é¢„è§ˆ</h5>
                <div class="row">
                    <div class="col-md-4">
                        <!-- æ ‡ç­¾åˆ—è¡¨ï¼Œç±»ä¼¼PyQT5ç‰ˆæœ¬çš„å·¦ä¾§åˆ—è¡¨ -->
                        <div class="card mb-3">
                            <div class="card-header">æ ‡ç­¾åˆ—è¡¨</div>
                            <div class="card-body p-2 labels-list-container">
                                <ul id="labelsList" class="list-group"></ul>
                            </div>
                        </div>
                        <!-- æ‰“å°è®¾ç½®éƒ¨åˆ† -->
                        <div class="card">
                            <div class="card-header">æ‰“å°è®¾ç½®</div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label class="form-label">æ ‡é¢˜å­—å·</label>
                                    <input type="number" class="form-control" id="headerFontSize" value="12" min="8" max="72">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="headerBold" checked>
                                    <label class="form-check-label" for="headerBold">
                                        æ ‡é¢˜åŠ ç²—
                                    </label>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">å†…å®¹å­—å·</label>
                                    <input type="number" class="form-control" id="contentFontSize" value="12" min="8" max="72">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="contentBold" checked>
                                    <label class="form-check-label" for="contentBold">
                                        å†…å®¹åŠ ç²—
                                    </label>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">æ‰“å°æœºé€‰æ‹©</label>
                                    <select class="form-select" id="printerSelect">
                                        <option value="default">é»˜è®¤æ‰“å°æœº</option>
                                        <!-- æ‰“å°æœºåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                    </select>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" id="printAllBtn" class="btn btn-success">
                                        <i class="fas fa-print me-1"></i> æ‰“å°å…¨éƒ¨æ ‡ç­¾
                                    </button>
                                    <button type="button" id="cancelPreviewBtn" class="btn btn-outline-secondary">
                                        å–æ¶ˆ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <!-- é¢„è§ˆå†…å®¹åŒºåŸŸï¼Œç±»ä¼¼PyQT5ç‰ˆæœ¬çš„å³ä¾§é¢„è§ˆ -->
                        <div class="card">
                            <div class="card-header">é¢„è§ˆ</div>
                            <div class="card-body print-preview preview-container" id="previewContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å…¥åº“è®°å½•é€‰æ‹©æ¨¡æ€æ¡† -->
<div class="modal fade" id="inboundRecordModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    é€‰æ‹©å…¥åº“è®°å½•
                    <small class="text-muted ms-2">ğŸ’¡ æç¤ºï¼šåŒå‡»è¡Œå¯å¿«é€Ÿé€‰æ‹©</small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- æœç´¢åŒºåŸŸ -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="æœç´¢è¯†åˆ«ç¼–ç ã€è½¦ç‰Œå·æˆ–å®¢æˆ·åç§°">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="searchStartDate">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="searchEndDate">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary w-100" id="searchInboundBtn">
                            <i class="fas fa-search"></i> æœç´¢
                        </button>
                    </div>
                </div>

                <!-- å…¥åº“è®°å½•è¡¨æ ¼ -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover" style="table-layout: fixed; width: 100%;">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 8%;">é€‰æ‹©</th>
                                <th style="width: 28%;">è¯†åˆ«ç¼–ç </th>
                                <th style="width: 12%;">å…¥åº“æ—¶é—´</th>
                                <th style="width: 12%;">å…¥åº“è½¦ç‰Œ</th>
                                <th style="width: 15%;">å®¢æˆ·åç§°</th>
                                <th style="width: 8%;">æ¿æ•°</th>
                                <th style="width: 8%;">ä»¶æ•°</th>
                                <th style="width: 9%;">è®¢å•ç±»å‹</th>
                            </tr>
                        </thead>
                        <tbody id="inboundRecordsTable">
                            <tr>
                                <td colspan="8" class="text-center">æ­£åœ¨åŠ è½½...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmSelectBtn" disabled>ç¡®è®¤é€‰æ‹©</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‰“å°æœºè®¾ç½®å¯¹è¯æ¡† -->
<div class="modal fade" id="printerSettingsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-print me-2"></i>æ‰“å°è®¾ç½®
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- æ‰“å°æœºé€‰æ‹© -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-printer me-1"></i>æ‰“å°æœº</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dialogPrinterSelect" class="form-label">é€‰æ‹©æ‰“å°æœº</label>
                                    <select class="form-select" id="dialogPrinterSelect">
                                        <option value="">é€‰æ‹©æ‰“å°æœº...</option>
                                        <!-- æ‰“å°æœºåˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ‰“å°æœºçŠ¶æ€</label>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-circle me-1"></i>å°±ç»ª
                                        </span>
                                        <small class="text-muted">æ‰“å°æœºå·²è¿æ¥å¹¶å‡†å¤‡å°±ç»ª</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshPrinters()">
                                        <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ‰“å°é€‰é¡¹ -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-1"></i>æ‰“å°é€‰é¡¹</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dialogCopies" class="form-label">æ‰“å°ä»½æ•°</label>
                                    <input type="number" class="form-control" id="dialogCopies" value="1" min="1" max="99">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">æ‰“å°è´¨é‡</label>
                                    <select class="form-select" id="dialogPrintQuality">
                                        <option value="normal">æ™®é€š</option>
                                        <option value="high" selected>é«˜è´¨é‡</option>
                                        <option value="draft">è‰ç¨¿</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dialogCollate" checked>
                                        <label class="form-check-label" for="dialogCollate">
                                            é€ä»½æ‰“å°
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dialogPrintPreview">
                                        <label class="form-check-label" for="dialogPrintPreview">
                                            æ‰“å°å‰é¢„è§ˆ
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- çº¸å¼ è®¾ç½® -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-file-alt me-1"></i>çº¸å¼ è®¾ç½®</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">çº¸å¼ å¤§å°</label>
                                    <select class="form-select" id="dialogPaperSize">
                                        <option value="A4">A4 (210Ã—297mm)</option>
                                        <option value="A5">A5 (148Ã—210mm)</option>
                                        <option value="Letter">Letter (216Ã—279mm)</option>
                                        <option value="Legal">Legal (216Ã—356mm)</option>
                                        <option value="40x60" selected>æ ‡ç­¾çº¸ 40Ã—60mm</option>
                                        <option value="50x70">æ ‡ç­¾çº¸ 50Ã—70mm</option>
                                        <option value="60x90">æ ‡ç­¾çº¸ 60Ã—90mm</option>
                                        <option value="custom">è‡ªå®šä¹‰å°ºå¯¸</option>
                                    </select>
                                </div>
                                <div id="customPaperSize" class="mb-3" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">å®½åº¦ (mm)</label>
                                            <input type="number" class="form-control" id="dialogPaperWidth" value="60" min="10" max="500">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">é«˜åº¦ (mm)</label>
                                            <input type="number" class="form-control" id="dialogPaperHeight" value="40" min="10" max="500">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">çº¸å¼ æ–¹å‘</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="paperOrientation" id="orientationPortrait" value="portrait" checked>
                                        <label class="btn btn-outline-primary" for="orientationPortrait">
                                            <i class="fas fa-mobile-alt me-1"></i>çºµå‘
                                        </label>
                                        <input type="radio" class="btn-check" name="paperOrientation" id="orientationLandscape" value="landscape">
                                        <label class="btn btn-outline-primary" for="orientationLandscape">
                                            <i class="fas fa-mobile-alt fa-rotate-90 me-1"></i>æ¨ªå‘
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é¡µè¾¹è·è®¾ç½® -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-expand-arrows-alt me-1"></i>é¡µè¾¹è·è®¾ç½®</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">é¡µè¾¹è·é¢„è®¾</label>
                                    <select class="form-select" id="dialogMarginPreset">
                                        <option value="none" selected>æ— è¾¹è·</option>
                                        <option value="narrow">çª„è¾¹è· (2mm)</option>
                                        <option value="normal">æ™®é€šè¾¹è· (5mm)</option>
                                        <option value="wide">å®½è¾¹è· (10mm)</option>
                                        <option value="custom">è‡ªå®šä¹‰è¾¹è·</option>
                                    </select>
                                </div>
                                <div id="customMargins" class="mb-3" style="display: none;">
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <label class="form-label">ä¸Šè¾¹è· (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginTop" value="0" min="0" max="50" step="0.5">
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">ä¸‹è¾¹è· (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginBottom" value="0" min="0" max="50" step="0.5">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">å·¦è¾¹è· (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginLeft" value="0" min="0" max="50" step="0.5">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">å³è¾¹è· (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginRight" value="0" min="0" max="50" step="0.5">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dialogAutoCenter">
                                        <label class="form-check-label" for="dialogAutoCenter">
                                            è‡ªåŠ¨å±…ä¸­å†…å®¹
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ‰“å°ä¿¡æ¯æ‘˜è¦ -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>æ‰“å°ä¿¡æ¯</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">æ ‡ç­¾æ•°é‡</small>
                                        <div class="fw-bold" id="dialogLabelCount">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">å®¢æˆ·åç§°</small>
                                        <div class="fw-bold" id="dialogCustomerName">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">è½¦ç‰Œå·</small>
                                        <div class="fw-bold" id="dialogPlateNumber">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">è¯†åˆ«ç¼–ç </small>
                                        <div class="fw-bold" id="dialogIdentificationCode">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmPrint()">
                    <i class="fas fa-print me-1"></i>å¼€å§‹æ‰“å°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDFé¢„è§ˆæ¨¡æ€æ¡† -->
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-pdf me-2"></i>PDFé¢„è§ˆ
                </h5>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-outline-primary me-2" onclick="downloadPDF()">
                        <i class="fas fa-download me-1"></i>ä¸‹è½½PDF
                    </button>
                    <button type="button" class="btn btn-primary me-2" onclick="printFromPreview()">
                        <i class="fas fa-print me-1"></i>ç¡®è®¤æ‰“å°
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div id="pdfViewerContainer" style="height: calc(100vh - 120px); width: 100%;">
                    <iframe id="pdfViewer" style="width: 100%; height: 100%; border: none;" src=""></iframe>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div class="d-flex align-items-center">
                        <small class="text-muted" id="pdfInfo">æ­£åœ¨åŠ è½½PDFé¢„è§ˆ...</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>å…³é—­
                        </button>
                        <button type="button" class="btn btn-success" onclick="printFromPreview()">
                            <i class="fas fa-print me-1"></i>æ‰“å°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ‰“å°è¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="printModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ‰“å°è¿›åº¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>æ­£åœ¨å‡†å¤‡æ‰“å°æ ‡ç­¾ï¼Œè¯·ç¨å€™...</p>
                <div class="progress">
                    <div class="progress-bar" id="printProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // å…¨å±€å‡½æ•°å®šä¹‰
    function confirmPrint() {
        // éªŒè¯æ‰“å°æœºé€‰æ‹©
        const printerName = document.getElementById('dialogPrinterSelect').value;
        if (!printerName) {
            alert('è¯·é€‰æ‹©æ‰“å°æœº');
            return;
        }

        // è·å–æ‰“å°è®¾ç½®
        const copies = parseInt(document.getElementById('dialogCopies').value) || 1;
        const printQuality = document.getElementById('dialogPrintQuality').value;
        const collate = document.getElementById('dialogCollate').checked;
        const printPreview = document.getElementById('dialogPrintPreview').checked;

        // è·å–çº¸å¼ è®¾ç½®
        const paperSize = document.getElementById('dialogPaperSize').value;
        const paperWidth = parseFloat(document.getElementById('dialogPaperWidth').value) || 60;
        const paperHeight = parseFloat(document.getElementById('dialogPaperHeight').value) || 40;
        const paperOrientation = document.querySelector('input[name="paperOrientation"]:checked').value;

        // è·å–é¡µè¾¹è·è®¾ç½®
        const marginPreset = document.getElementById('dialogMarginPreset').value;
        const marginTop = parseFloat(document.getElementById('dialogMarginTop').value) || 0;
        const marginBottom = parseFloat(document.getElementById('dialogMarginBottom').value) || 0;
        const marginLeft = parseFloat(document.getElementById('dialogMarginLeft').value) || 0;
        const marginRight = parseFloat(document.getElementById('dialogMarginRight').value) || 0;
        const autoCenter = document.getElementById('dialogAutoCenter').checked;

        // å¦‚æœé€‰æ‹©äº†æ‰“å°é¢„è§ˆï¼Œç”ŸæˆPDFé¢„è§ˆ
        if (printPreview) {
            // éšè—æ‰“å°æœºè®¾ç½®å¯¹è¯æ¡†
            const printerSettingsModal = bootstrap.Modal.getInstance(document.getElementById('printerSettingsModal'));
            printerSettingsModal.hide();

            // ç”ŸæˆPDFé¢„è§ˆ
            generatePDFPreview();
            return;
        }

        // éšè—æ‰“å°æœºè®¾ç½®å¯¹è¯æ¡†
        const printerSettingsModal = bootstrap.Modal.getInstance(document.getElementById('printerSettingsModal'));
        printerSettingsModal.hide();

        // æ˜¾ç¤ºæ‰“å°è¿›åº¦æ¨¡æ€æ¡†
        const printModal = new bootstrap.Modal(document.getElementById('printModal'));
        printModal.show();

        // è·å–å­—ä½“è®¾ç½®
        const headerFontSize = document.getElementById('headerFontSize').value;
        const contentFontSize = document.getElementById('contentFontSize').value;
        const headerBold = document.getElementById('headerBold').checked;
        const contentBold = document.getElementById('contentBold').checked;

        // å‡†å¤‡æ‰“å°æ•°æ®
        const printData = {
            isWhole: window.previewData.isWhole,
            identificationCode: window.previewData.identificationCode,
            plateNumber: window.previewData.plateNumber,
            customerName: window.previewData.customerName,
            boardCount: window.previewData.boardCount,
            pieceCount: window.previewData.pieceCount,
            orderType: window.previewData.orderType,
            splitBoardNum: window.previewData.splitBoardNum,
            splitQuantity: window.previewData.splitQuantity,
            boardTiers: window.previewData.boardTiers,
            headerFontSize: headerFontSize,
            contentFontSize: contentFontSize,
            headerBold: headerBold,
            contentBold: contentBold,
            printer: printerName,
            labelSize: window.previewData.labelSize,
            customWidth: window.previewData.customWidth,
            customHeight: window.previewData.customHeight,
            // æ–°å¢çš„æ‰“å°è®¾ç½®
            copies: copies,
            printQuality: printQuality,
            collate: collate,
            // çº¸å¼ è®¾ç½®
            paperSize: paperSize,
            paperWidth: paperWidth,
            paperHeight: paperHeight,
            paperOrientation: paperOrientation,
            // é¡µè¾¹è·è®¾ç½®
            marginPreset: marginPreset,
            marginTop: marginTop,
            marginBottom: marginBottom,
            marginLeft: marginLeft,
            marginRight: marginRight,
            autoCenter: autoCenter
        };

        // å‘é€æ‰“å°è¯·æ±‚
        fetch('/api/print_labels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(printData)
        })
        .then(response => response.json())
        .then(data => {
            printModal.hide();
            if (data.status === 'success') {
                // æ˜¾ç¤ºè¯¦ç»†çš„æˆåŠŸä¿¡æ¯
                const details = data.details || {};
                const printType = data.print_type || details.print_status || 'æœªçŸ¥';
                const isRealPrint = printType.includes('çœŸå®æ‰“å°');

                const successMessage = `âœ… æ‰“å°ä»»åŠ¡æäº¤æˆåŠŸï¼

ğŸ“‹ ä»»åŠ¡è¯¦æƒ…ï¼š
â€¢ ä»»åŠ¡ID: ${data.job_id || 'N/A'}
â€¢ æ‰“å°ç±»å‹: ${printType}
â€¢ æ‰“å°æœº: ${details.printer || 'N/A'}
â€¢ å®¢æˆ·: ${details.customer || 'N/A'}
â€¢ è½¦ç‰Œ: ${details.plate_number || 'N/A'}
â€¢ æ ‡ç­¾æ•°é‡: ${details.labels_count || 'N/A'} ä¸ª
â€¢ æ‰“å°ä»½æ•°: ${details.copies || 1} ä»½
â€¢ çº¸å¼ å¤§å°: ${details.paper_size || 'N/A'}
â€¢ æ€»é¡µæ•°: ${details.total_pages || 'N/A'} é¡µ

${isRealPrint ?
    'âœ… çœŸå®æ‰“å°ï¼šPDFå·²ç”Ÿæˆå¹¶å‘é€åˆ°æ‰“å°æœº' :
    'âš ï¸ æ¨¡æ‹Ÿæ‰“å°ï¼šéœ€è¦å®‰è£…reportlabåº“æ‰èƒ½è¿›è¡ŒçœŸå®æ‰“å°'
}`;

                alert(successMessage);

                // æ˜¾ç¤ºæ“ä½œæç¤º
                if (window.showMessage) {
                    window.showMessage('æ‰“å°ä»»åŠ¡å·²æäº¤åˆ° ' + (details.printer || 'é»˜è®¤æ‰“å°æœº'), 'success');
                }

                // ä¿å­˜æ‰“å°è®°å½•
                if (window.printHistory) {
                    window.printHistory.add(data);
                }

                // å¯åŠ¨æ‰“å°çŠ¶æ€æ¨¡æ‹Ÿ
                if (data.job_id && window.checkPrintStatus) {
                    setTimeout(() => {
                        window.checkPrintStatus(data.job_id);
                    }, 1000); // 1ç§’åå¼€å§‹çŠ¶æ€æ£€æŸ¥
                }
            } else {
                alert('âŒ æ‰“å°å¤±è´¥: ' + data.message);
                if (window.showMessage) {
                    window.showMessage('æ‰“å°å¤±è´¥: ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            printModal.hide();
            alert('âŒ å‘é€æ‰“å°è¯·æ±‚æ—¶å‡ºé”™: ' + error);
            if (window.showMessage) {
                window.showMessage('æ‰“å°è¯·æ±‚å‘é€å¤±è´¥: ' + error, 'error');
            }
        });
    }

    // æµ‹è¯•å‡½æ•°æ˜¯å¦æ­£ç¡®å®šä¹‰
    console.log('confirmPrintå‡½æ•°å·²å®šä¹‰:', typeof confirmPrint === 'function');

    // å°†å‡½æ•°æ·»åŠ åˆ°windowå¯¹è±¡ä»¥ç¡®ä¿å…¨å±€è®¿é—®
    window.confirmPrint = confirmPrint;

    // å…¶ä»–å…¨å±€å‡½æ•°å£°æ˜
    window.generatePDFPreview = function() {
        console.log('generatePDFPreview called');

        // æ˜¾ç¤ºæ¨¡æ‹Ÿçš„PDFé¢„è§ˆå¯¹è¯æ¡†
        const previewMessage = `ğŸ“„ PDFé¢„è§ˆåŠŸèƒ½

âš ï¸ å½“å‰çŠ¶æ€ï¼šPDFé¢„è§ˆåŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨
ğŸ”§ åŸå› ï¼šéœ€è¦å®‰è£…reportlabåº“

ğŸ“‹ é¢„è§ˆå†…å®¹ï¼š
â€¢ å®¢æˆ·ï¼š${window.previewData.customerName || 'N/A'}
â€¢ è½¦ç‰Œï¼š${window.previewData.plateNumber || 'N/A'}
â€¢ æ ‡ç­¾æ•°é‡ï¼š${window.previewData.isWhole ?
    (window.previewData.boardCount + window.previewData.pieceCount) :
    window.previewData.splitQuantity} ä¸ª

ğŸ’¡ è§£å†³æ–¹æ¡ˆï¼š
1. å®‰è£…reportlabåº“ï¼špip install reportlab
2. é‡å¯åº”ç”¨æœåŠ¡å™¨
3. é‡æ–°å°è¯•PDFé¢„è§ˆåŠŸèƒ½

æ˜¯å¦ç›´æ¥è¿›è¡Œæ‰“å°ï¼Ÿ`;

        if (confirm(previewMessage)) {
            // ç”¨æˆ·é€‰æ‹©ç›´æ¥æ‰“å°
            console.log('ç”¨æˆ·é€‰æ‹©ç›´æ¥æ‰“å°');

            // æ˜¾ç¤ºæ‰“å°æœºè®¾ç½®å¯¹è¯æ¡†
            const printerSettingsModal = new bootstrap.Modal(document.getElementById('printerSettingsModal'));
            printerSettingsModal.show();
        }
    };

    window.downloadPDF = function() {
        console.log('downloadPDF called');
        alert('ä¸‹è½½åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
    };

    window.printFromPreview = function() {
        console.log('printFromPreview called');
        // éšè—PDFé¢„è§ˆæ¨¡æ€æ¡†
        const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfPreviewModal'));
        if (pdfModal) {
            pdfModal.hide();
        }

        // è°ƒç”¨confirmPrintå‡½æ•°
        if (window.confirmPrint) {
            window.confirmPrint();
        } else {
            alert('æ‰“å°åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
        }
    };

    // æ¨¡æ‹Ÿæ‰“å°çŠ¶æ€æ£€æŸ¥åŠŸèƒ½
    window.checkPrintStatus = function(jobId) {
        console.log('æ£€æŸ¥æ‰“å°çŠ¶æ€:', jobId);

        // æ¨¡æ‹Ÿæ‰“å°çŠ¶æ€
        const statuses = ['æ’é˜Ÿä¸­', 'æ­£åœ¨æ‰“å°', 'æ‰“å°å®Œæˆ'];
        let currentStatus = 0;

        const statusInterval = setInterval(() => {
            if (currentStatus < statuses.length) {
                console.log(`æ‰“å°ä»»åŠ¡ ${jobId}: ${statuses[currentStatus]}`);
                if (window.showMessage) {
                    window.showMessage(`æ‰“å°ä»»åŠ¡ ${jobId}: ${statuses[currentStatus]}`, 'info');
                }
                currentStatus++;
            } else {
                clearInterval(statusInterval);
                if (window.showMessage) {
                    window.showMessage(`æ‰“å°ä»»åŠ¡ ${jobId} å·²å®Œæˆ`, 'success');
                }
            }
        }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡çŠ¶æ€
    };

    // æ‰“å°å†å²è®°å½•ç®¡ç†
    window.printHistory = {
        records: JSON.parse(localStorage.getItem('printHistory') || '[]'),

        add: function(jobData) {
            const record = {
                id: jobData.job_id,
                timestamp: new Date().toISOString(),
                customer: jobData.details?.customer || 'N/A',
                plateNumber: jobData.details?.plate_number || 'N/A',
                printer: jobData.details?.printer || 'N/A',
                labelsCount: jobData.details?.labels_count || 0,
                copies: jobData.details?.copies || 1,
                status: 'å·²æäº¤'
            };

            this.records.unshift(record); // æ·»åŠ åˆ°å¼€å¤´
            if (this.records.length > 50) { // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
                this.records = this.records.slice(0, 50);
            }

            localStorage.setItem('printHistory', JSON.stringify(this.records));
            console.log('æ‰“å°è®°å½•å·²ä¿å­˜:', record);
        },

        getRecords: function() {
            return this.records;
        },

        clear: function() {
            this.records = [];
            localStorage.removeItem('printHistory');
            console.log('æ‰“å°å†å²å·²æ¸…ç©º');
        }
    };

    // å…¨å±€é¢„è§ˆæ•°æ®å¯¹è±¡
    window.previewData = {
        isWhole: true,
        identificationCode: '',
        plateNumber: '',
        customerName: '',
        boardCount: 0,
        pieceCount: 0,
        orderType: '',
        splitBoardNum: 1,
        splitQuantity: 1,
        boardTiers: '',
        labelSize: 'small',
        customWidth: 40,
        customHeight: 60
    };

    document.addEventListener('DOMContentLoaded', function() {

        // é˜²æ­¢äº‹ä»¶è¢«æ¸…ç†çš„ä¿æŠ¤æœºåˆ¶ - å·²ç”±æ•´åˆæ€§èƒ½ç®¡ç†å™¨æ¥ç®¡
        function protectEventListeners() {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ•´åˆæ€§èƒ½ç®¡ç†å™¨
            if (window.integratedPM) {
                console.log('âœ… äº‹ä»¶ä¿æŠ¤å·²ç”±æ•´åˆæ€§èƒ½ç®¡ç†å™¨æ¥ç®¡');
                return;
            }

            // å¤‡ç”¨æ–¹æ¡ˆï¼šç®€åŒ–çš„äº‹ä»¶ä¿æŠ¤
            rebindSelectButtons();

            // åªæ£€æŸ¥ä¸€æ¬¡ï¼Œé¿å…é¢‘ç¹æ£€æŸ¥
            setTimeout(function() {
                const wholeBtn = document.getElementById('wholeSelectCodeBtn');
                const splitBtn = document.getElementById('splitSelectCodeBtn');

                if (wholeBtn && splitBtn) {
                    const hasWholeEvent = hasEventListener(wholeBtn, 'click') || wholeBtn.onclick;
                    const hasSplitEvent = hasEventListener(splitBtn, 'click') || splitBtn.onclick;

                    if (!hasWholeEvent || !hasSplitEvent) {
                        console.warn('å¤‡ç”¨äº‹ä»¶ä¿æŠ¤ï¼šé‡æ–°ç»‘å®šé€‰æ‹©æŒ‰é’®');
                        rebindSelectButtons();
                    } else {
                        console.log('âœ… é€‰æ‹©æŒ‰é’®äº‹ä»¶æ­£å¸¸');
                    }
                }
            }, 2000); // åªæ£€æŸ¥ä¸€æ¬¡
        }

        // æ£€æŸ¥å…ƒç´ æ˜¯å¦æœ‰äº‹ä»¶ç›‘å¬å™¨ - æ”¹è¿›ç‰ˆæœ¬
        function hasEventListener(element, eventType) {
            if (!element) return false;

            // æ£€æŸ¥jQueryäº‹ä»¶
            try {
                const events = $._data(element, 'events');
                if (events && events[eventType] && events[eventType].length > 0) {
                    return true;
                }
            } catch (e) {
                // jQueryæ£€æŸ¥å¤±è´¥ï¼Œç»§ç»­æ£€æŸ¥åŸç”Ÿäº‹ä»¶
            }

            // æ£€æŸ¥åŸç”Ÿäº‹ä»¶ç›‘å¬å™¨
            if (element.onclick || element['on' + eventType]) {
                return true;
            }

            // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ ‡è®°
            return element.hasAttribute('data-event-bound');
        }

        // å½“å‰é€‰æ‹©çš„å…¥åº“è®°å½•
        let selectedInboundRecord = null;

        // æ¨¡æ€æ¡†å®ä¾‹
        let inboundRecordModal = null;


        // è·å–æˆ–åˆå§‹åŒ–æ¨¡æ€æ¡†å®ä¾‹
        function getInboundRecordModal() {
            if (!inboundRecordModal) {
                const modalElement = document.getElementById('inboundRecordModal');
                if (modalElement) {
                    inboundRecordModal = new bootstrap.Modal(modalElement);
                }
            }
            return inboundRecordModal;
        }

        // æ—¥æœŸæ ¼å¼åŒ–å‡½æ•°
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // åŠ è½½å…¥åº“è®°å½•
        function loadInboundRecords(keyword = '', startDate = '', endDate = '') {
            const tableBody = document.getElementById('inboundRecordsTable');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">æ­£åœ¨åŠ è½½...</td></tr>';

            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            fetch(`/api/inbound_records?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.records) {
                        renderInboundRecords(data.records);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°å…¥åº“è®°å½•</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½å…¥åº“è®°å½•å¤±è´¥:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
                });
        }

        // æ¸²æŸ“å…¥åº“è®°å½•è¡¨æ ¼
        function renderInboundRecords(records) {
            const tableBody = document.getElementById('inboundRecordsTable');

            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°å…¥åº“è®°å½•</td></tr>';
                return;
            }

            tableBody.innerHTML = records.map(record => `
                <tr data-record='${JSON.stringify(record)}' class="inbound-record-row">
                    <td style="text-align: center; vertical-align: middle;">
                        <input type="radio" name="selectedRecord" value="${record.id}"
                               data-record='${JSON.stringify(record)}' class="form-check-input">
                    </td>
                    <td style="word-wrap: break-word; word-break: break-all; font-size: 12px; line-height: 1.3;" title="${record.identification_code || '-'}">${record.identification_code || '-'}</td>
                    <td style="white-space: nowrap; font-size: 12px;">${record.inbound_time || '-'}</td>
                    <td style="white-space: nowrap; font-size: 12px;">${record.plate_number || '-'}</td>
                    <td style="word-wrap: break-word; font-size: 12px; line-height: 1.3;" title="${record.customer_name || '-'}">${record.customer_name || '-'}</td>
                    <td style="text-align: center; font-size: 12px;">${record.pallet_count || 0}</td>
                    <td style="text-align: center; font-size: 12px;">${record.package_count || 0}</td>
                    <td style="word-wrap: break-word; font-size: 12px; line-height: 1.3;" title="${record.order_type || '-'}">${record.order_type || '-'}</td>
                </tr>
            `).join('');

            // æ·»åŠ é€‰æ‹©äº‹ä»¶ç›‘å¬
            document.querySelectorAll('input[name="selectedRecord"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('confirmSelectBtn').disabled = false;

                    // æ›´æ–°è¡Œçš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.inbound-record-row').forEach(row => {
                        row.classList.remove('selected');
                    });

                    if (this.checked) {
                        const row = this.closest('.inbound-record-row');
                        if (row) {
                            row.classList.add('selected');
                        }
                    }
                });
            });

            // æ·»åŠ åŒå‡»é€‰ä¸­åŠŸèƒ½
            document.querySelectorAll('.inbound-record-row').forEach(row => {
                // æ·»åŠ é¼ æ ‡æ‚¬åœæ•ˆæœ
                row.style.cursor = 'pointer';

                // åŒå‡»äº‹ä»¶
                row.addEventListener('dblclick', function() {
                    // é€‰ä¸­å¯¹åº”çš„å•é€‰æŒ‰é’®
                    const radio = this.querySelector('input[name="selectedRecord"]');
                    if (radio) {
                        radio.checked = true;
                        // è§¦å‘changeäº‹ä»¶ä»¥å¯ç”¨ç¡®è®¤æŒ‰é’®
                        radio.dispatchEvent(new Event('change'));

                        // ç›´æ¥æ‰§è¡Œé€‰æ‹©é€»è¾‘
                        selectInboundRecord(radio);
                    }
                });

                // å•å‡»è¡Œé€‰ä¸­å•é€‰æŒ‰é’®ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
                row.addEventListener('click', function(e) {
                    // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯å•é€‰æŒ‰é’®æœ¬èº«ï¼Œåˆ™é€‰ä¸­å•é€‰æŒ‰é’®
                    if (e.target.type !== 'radio') {
                        const radio = this.querySelector('input[name="selectedRecord"]');
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });
        }

        // é€‰æ‹©å…¥åº“è®°å½•çš„é€šç”¨å‡½æ•°
        function selectInboundRecord(radioElement) {
            if (!radioElement || !radioElement.checked) {
                return;
            }

            selectedInboundRecord = JSON.parse(radioElement.dataset.record);

            // æ ¹æ®å½“å‰æ ‡ç­¾é¡µå¡«å……æ•°æ®
            const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
            if (activeTab === '#whole') {
                // å¡«å……æ•´æ¿æ ‡ç­¾æ•°æ®
                document.getElementById('wholeIdentificationCode').value = selectedInboundRecord.identification_code || '';
                document.getElementById('wholePlateNumber').value = selectedInboundRecord.plate_number || '';
                document.getElementById('wholeCustomerName').value = selectedInboundRecord.customer_name || '';
                document.getElementById('wholeBoardCount').value = selectedInboundRecord.pallet_count || 0;
                document.getElementById('wholePieceCount').value = selectedInboundRecord.package_count || 0;
                document.getElementById('wholeOrderType').value = selectedInboundRecord.order_type || '';
            } else {
                // å¡«å……æ‹†æ¿æ ‡ç­¾æ•°æ®
                document.getElementById('splitIdentificationCode').value = selectedInboundRecord.identification_code || '';
                document.getElementById('splitPlateNumber').value = selectedInboundRecord.plate_number || '';
                document.getElementById('splitCustomerName').value = selectedInboundRecord.customer_name || '';
                document.getElementById('splitTotalBoards').value = selectedInboundRecord.pallet_count || 0;
            }

            // å…³é—­æ¨¡æ€æ¡†
            const modal = getInboundRecordModal();
            if (modal) {
                modal.hide();
            }

            // æ˜¾ç¤ºæˆåŠŸæç¤º
            if (window.showMessage) {
                window.showMessage(`å·²é€‰æ‹©å…¥åº“è®°å½•: ${selectedInboundRecord.identification_code}`, 'success');
            }
        }

        // é‡æ–°ç»‘å®šé€‰æ‹©æŒ‰é’®äº‹ä»¶çš„å‡½æ•° - ä¼˜åŒ–ç‰ˆæœ¬
        function rebindSelectButtons() {
            const wholeBtn = document.getElementById('wholeSelectCodeBtn');
            const splitBtn = document.getElementById('splitSelectCodeBtn');

            // æ£€æŸ¥æ˜¯å¦å·²ç»ç»‘å®šè¿‡äº‹ä»¶ï¼Œé¿å…é‡å¤ç»‘å®š
            if (wholeBtn && !wholeBtn.hasAttribute('data-event-bound')) {
                // å…‹éš†æŒ‰é’®ä»¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                const newWholeBtn = wholeBtn.cloneNode(true);
                wholeBtn.parentNode.replaceChild(newWholeBtn, wholeBtn);

                // é‡æ–°ç»‘å®šæ•´æ¿é€‰æ‹©æŒ‰é’®äº‹ä»¶
                newWholeBtn.addEventListener('click', function() {
                    console.log('æ•´æ¿é€‰æ‹©æŒ‰é’®è¢«ç‚¹å‡»');
                    // è®¾ç½®é»˜è®¤æœç´¢æ—¥æœŸä¸ºæœ€è¿‘7å¤©
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    document.getElementById('searchStartDate').value = formatDate(startDate);
                    document.getElementById('searchEndDate').value = formatDate(endDate);

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶åŠ è½½æ•°æ®
                    const modal = getInboundRecordModal();
                    if (modal) {
                        modal.show();
                        loadInboundRecords();
                    } else {
                        alert('æ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                });

                // æ ‡è®°å·²ç»‘å®šäº‹ä»¶
                newWholeBtn.setAttribute('data-event-bound', 'true');
            }

            if (splitBtn && !splitBtn.hasAttribute('data-event-bound')) {
                // å…‹éš†æŒ‰é’®ä»¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                const newSplitBtn = splitBtn.cloneNode(true);
                splitBtn.parentNode.replaceChild(newSplitBtn, splitBtn);

                // é‡æ–°ç»‘å®šæ‹†æ¿é€‰æ‹©æŒ‰é’®äº‹ä»¶
                newSplitBtn.addEventListener('click', function() {
                    console.log('æ‹†æ¿é€‰æ‹©æŒ‰é’®è¢«ç‚¹å‡»');
                    // è®¾ç½®é»˜è®¤æœç´¢æ—¥æœŸä¸ºæœ€è¿‘7å¤©
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    document.getElementById('searchStartDate').value = formatDate(startDate);
                    document.getElementById('searchEndDate').value = formatDate(endDate);

                    // æ˜¾ç¤ºæ¨¡æ€æ¡†å¹¶åŠ è½½æ•°æ®
                    const modal = getInboundRecordModal();
                    if (modal) {
                        modal.show();
                        loadInboundRecords();
                    } else {
                        alert('æ¨¡æ€æ¡†åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    }
                });

                // æ ‡è®°å·²ç»‘å®šäº‹ä»¶
                newSplitBtn.setAttribute('data-event-bound', 'true');
            }

            // åªåœ¨å®é™…ç»‘å®šäº†äº‹ä»¶æ—¶æ‰è¾“å‡ºæ—¥å¿—
            const wholeBound = document.getElementById('wholeSelectCodeBtn')?.hasAttribute('data-event-bound');
            const splitBound = document.getElementById('splitSelectCodeBtn')?.hasAttribute('data-event-bound');

            if (wholeBound || splitBound) {
                console.log('é€‰æ‹©æŒ‰é’®äº‹ä»¶å·²é‡æ–°ç»‘å®š');
            }
        }

        // åˆå§‹ç»‘å®šé€‰æ‹©æŒ‰é’®äº‹ä»¶
        rebindSelectButtons();

        // æœç´¢æŒ‰é’®äº‹ä»¶
        document.getElementById('searchInboundBtn').addEventListener('click', function() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const startDate = document.getElementById('searchStartDate').value;
            const endDate = document.getElementById('searchEndDate').value;

            loadInboundRecords(keyword, startDate, endDate);
        });

        // ç¡®è®¤é€‰æ‹©æŒ‰é’®äº‹ä»¶
        document.getElementById('confirmSelectBtn').addEventListener('click', function() {
            const selectedRadio = document.querySelector('input[name="selectedRecord"]:checked');
            if (!selectedRadio) {
                alert('è¯·é€‰æ‹©ä¸€æ¡å…¥åº“è®°å½•');
                return;
            }

            // ä½¿ç”¨é€šç”¨é€‰æ‹©å‡½æ•°
            selectInboundRecord(selectedRadio);
        });

        // æ›´æ–°é¢„è§ˆå†…å®¹çš„å‡½æ•°
        function updatePreviewContent(index) {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = ''; // æ¸…ç©ºé¢„è§ˆå†…å®¹

            // è®¡ç®—å½“å‰æ ‡ç­¾æ–‡æœ¬
            let headerText = '';
            if (window.previewData.isWhole) {
                if (index < window.previewData.boardCount) {
                    headerText = `å…±è®¡${window.previewData.boardCount}æ¿${window.previewData.pieceCount}ä»¶-ç¬¬${index + 1}æ¿`;
                } else {
                    headerText = `å…±è®¡${window.previewData.boardCount}æ¿${window.previewData.pieceCount}ä»¶-ç¬¬${index - window.previewData.boardCount + 1}ä»¶`;
                }
            } else {
                headerText = `å…±è®¡${window.previewData.boardCount}æ¿-æ‹†ç¬¬${window.previewData.splitBoardNum}æ¿-${index + 1}/${window.previewData.splitQuantity}`;
            }

            // åˆ›å»ºå¹¶æ·»åŠ æ ‡é¢˜å…ƒç´ 
            const headerElement = document.createElement('div');
            headerElement.className = 'preview-heading';
            headerElement.textContent = headerText;
            previewContent.appendChild(headerElement);

            // åˆ›å»ºå†…å®¹å®¹å™¨
            const contentContainer = document.createElement('div');
            contentContainer.className = 'preview-content';

            // æ˜¾ç¤ºè¯†åˆ«ç¼–ç 
            if (window.previewData.identificationCode) {
                const codeElem = document.createElement('div');
                codeElem.className = 'preview-label';
                codeElem.style.fontWeight = 'bold';
                codeElem.textContent = window.previewData.identificationCode;
                contentContainer.appendChild(codeElem);
            }

            // æ·»åŠ åŸºæœ¬ä¿¡æ¯
            const infoItems = [
                {label: 'å…¥åº“è½¦ç‰Œ', value: window.previewData.plateNumber},
                {label: 'å®¢æˆ·', value: window.previewData.customerName}
            ];

            // å¦‚æœæ˜¯æ‹†æ¿ï¼Œæ·»åŠ æ­¤æ¿å±‚æ•°
            if (!window.previewData.isWhole) {
                infoItems.push({label: 'æ­¤æ¿å±‚æ•°', value: window.previewData.boardTiers});
            } else {
                // å¦‚æœæ˜¯æ•´æ¿ï¼Œæ·»åŠ è®¢å•ç±»å‹
                infoItems.push({label: 'è®¢å•ç±»å‹', value: window.previewData.orderType});
            }

            // æ·»åŠ æ‰“å°æ—¥æœŸ
            infoItems.push({label: 'æ‰“å°æ—¥æœŸ', value: formatDate(new Date())});

            // åˆ›å»ºå¹¶æ·»åŠ æ¯ä¸ªä¿¡æ¯é¡¹
            infoItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'preview-label';
                itemElement.textContent = `${item.label}: ${item.value}`;
                contentContainer.appendChild(itemElement);
            });

            previewContent.appendChild(contentContainer);
        }
        
        // ç”Ÿæˆæ ‡ç­¾åˆ—è¡¨å¹¶æ˜¾ç¤ºé¢„è§ˆ
        function showPreviewSection() {
            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            document.getElementById('previewSection').style.display = 'block';
            
            // æ¸…ç©ºæ ‡ç­¾åˆ—è¡¨
            const labelsList = document.getElementById('labelsList');
            labelsList.innerHTML = '';
            
            // è®¡ç®—æ ‡ç­¾æ€»æ•°
            const totalLabels = window.previewData.isWhole ?
                (window.previewData.boardCount + window.previewData.pieceCount) :
                window.previewData.splitQuantity;
            
            // åˆ›å»ºæ ‡ç­¾åˆ—è¡¨é¡¹
            for (let i = 0; i < totalLabels; i++) {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item label-list-item';
                listItem.dataset.index = i;
                
                if (window.previewData.isWhole) {
                    if (i < window.previewData.boardCount) {
                        listItem.textContent = `æ¿ ${i + 1}/${window.previewData.boardCount}`;
                    } else {
                        listItem.textContent = `ä»¶ ${i - window.previewData.boardCount + 1}/${window.previewData.pieceCount}`;
                    }
                } else {
                    listItem.textContent = `æ‹†æ¿ ${i + 1}/${totalLabels}`;
                }
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                listItem.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰åˆ—è¡¨é¡¹çš„activeç±»
                    document.querySelectorAll('.label-list-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é¡¹
                    this.classList.add('active');
                    
                    // æ›´æ–°é¢„è§ˆå†…å®¹
                    updatePreviewContent(parseInt(this.dataset.index));
                });
                
                labelsList.appendChild(listItem);
            }
            
            // é€‰æ‹©å¹¶æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ ‡ç­¾
            if (totalLabels > 0) {
                labelsList.firstChild.classList.add('active');
                updatePreviewContent(0);
            }
        }
        
        // æ•´æ¿é¢„è§ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
        document.getElementById('wholePreviewBtn').addEventListener('click', function() {
            // æ”¶é›†æ•´æ¿è¡¨å•æ•°æ®
            const identificationCode = document.getElementById('wholeIdentificationCode').value.trim();
            const plateNumber = document.getElementById('wholePlateNumber').value.trim();
            const customerName = document.getElementById('wholeCustomerName').value.trim();
            const boardCount = parseInt(document.getElementById('wholeBoardCount').value) || 0;
            const pieceCount = parseInt(document.getElementById('wholePieceCount').value) || 0;
            const orderType = document.getElementById('wholeOrderType').value;

            if (!identificationCode) {
                alert('è¯·å…ˆé€‰æ‹©è¯†åˆ«ç¼–ç ');
                return;
            }

            if (!plateNumber || !customerName || (boardCount <= 0 && pieceCount <= 0)) {
                alert('è¯·ç¡®ä¿å·²é€‰æ‹©æœ‰æ•ˆçš„å…¥åº“è®°å½•');
                return;
            }

            // æ›´æ–°é¢„è§ˆæ•°æ®
            window.previewData.isWhole = true;
            window.previewData.identificationCode = identificationCode;
            window.previewData.plateNumber = plateNumber;
            window.previewData.customerName = customerName;
            window.previewData.boardCount = boardCount;
            window.previewData.pieceCount = pieceCount;
            window.previewData.orderType = orderType;

            // è·å–è‡ªå®šä¹‰å°ºå¯¸
            if (document.getElementById('wholeLabelSize').value === 'custom') {
                window.previewData.customWidth = parseInt(document.getElementById('wholeCustomWidth').value) || 40;
                window.previewData.customHeight = parseInt(document.getElementById('wholeCustomHeight').value) || 60;
                window.previewData.labelSize = 'custom';
            } else {
                window.previewData.labelSize = document.getElementById('wholeLabelSize').value;
            }

            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            showPreviewSection();
        });
        
        // æ‹†æ¿é¢„è§ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
        document.getElementById('splitPreviewBtn').addEventListener('click', function() {
            // æ”¶é›†æ‹†æ¿è¡¨å•æ•°æ®
            const identificationCode = document.getElementById('splitIdentificationCode').value.trim();
            const plateNumber = document.getElementById('splitPlateNumber').value.trim();
            const customerName = document.getElementById('splitCustomerName').value.trim();
            const boardCount = parseInt(document.getElementById('splitTotalBoards').value) || 0;
            const splitBoardNum = parseInt(document.getElementById('splitBoardNum').value) || 0;
            const splitQuantity = parseInt(document.getElementById('splitQuantity').value) || 0;
            const boardTiers = parseInt(document.getElementById('boardTiers').value) || 0;

            if (!identificationCode) {
                alert('è¯·å…ˆé€‰æ‹©è¯†åˆ«ç¼–ç ');
                return;
            }

            if (!plateNumber || !customerName || boardCount <= 0 || splitBoardNum <= 0 || splitQuantity <= 0 || boardTiers <= 0) {
                alert('è¯·å¡«å†™æ‰€æœ‰å¿…è¦çš„ä¿¡æ¯');
                return;
            }

            // æ›´æ–°é¢„è§ˆæ•°æ®
            window.previewData.isWhole = false;
            window.previewData.identificationCode = identificationCode;
            window.previewData.plateNumber = plateNumber;
            window.previewData.customerName = customerName;
            window.previewData.boardCount = boardCount;
            window.previewData.splitBoardNum = splitBoardNum;
            window.previewData.splitQuantity = splitQuantity;
            window.previewData.boardTiers = boardTiers;

            // è·å–è‡ªå®šä¹‰å°ºå¯¸
            if (document.getElementById('splitLabelSize').value === 'custom') {
                window.previewData.customWidth = parseInt(document.getElementById('splitCustomWidth').value) || 40;
                window.previewData.customHeight = parseInt(document.getElementById('splitCustomHeight').value) || 60;
                window.previewData.labelSize = 'custom';
            } else {
                window.previewData.labelSize = document.getElementById('splitLabelSize').value;
            }

            // æ˜¾ç¤ºé¢„è§ˆåŒºåŸŸ
            showPreviewSection();
        });

        
        // æ‰“å°å…¨éƒ¨æ ‡ç­¾æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('printAllBtn').addEventListener('click', function() {
            // ç›´æ¥ç”ŸæˆPDFå¹¶æ‰“å¼€ï¼Œè·³è¿‡æ‰“å°æœºè®¾ç½®å¯¹è¯æ¡†
            directPrintToPDF();
        });

        // ç›´æ¥ç”ŸæˆPDFå¹¶æ‰“å¼€
        function directPrintToPDF() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é¢„è§ˆæ•°æ®
            if (!window.previewData) {
                alert('è¯·å…ˆç”Ÿæˆæ ‡ç­¾é¢„è§ˆ');
                return;
            }

            // ä½¿ç”¨é»˜è®¤è®¾ç½®ç”ŸæˆPDF
            const headerFontSize = document.getElementById('headerFontSize').value || 12;
            const contentFontSize = document.getElementById('contentFontSize').value || 10;
            const headerBold = document.getElementById('headerBold').checked;
            const contentBold = document.getElementById('contentBold').checked;

            // å‡†å¤‡PDFç”Ÿæˆæ•°æ®ï¼ˆä½¿ç”¨é»˜è®¤è®¾ç½®ï¼‰
            const pdfData = {
                isWhole: window.previewData.isWhole,
                identificationCode: window.previewData.identificationCode,
                customerName: window.previewData.customerName,
                plateNumber: window.previewData.plateNumber,
                boardCount: window.previewData.boardCount,
                pieceCount: window.previewData.pieceCount,
                orderType: window.previewData.orderType,
                splitBoardNum: window.previewData.splitBoardNum,
                splitQuantity: window.previewData.splitQuantity,
                boardTiers: window.previewData.boardTiers,
                labelSize: window.previewData.labelSize,
                customWidth: window.previewData.customWidth,
                customHeight: window.previewData.customHeight,
                headerFontSize: headerFontSize,
                contentFontSize: contentFontSize,
                headerBold: headerBold,
                contentBold: contentBold,
                // ä½¿ç”¨é»˜è®¤çº¸å¼ è®¾ç½®
                paperSize: '40x60',
                paperWidth: 60,
                paperHeight: 40,
                paperOrientation: 'portrait',
                // ä½¿ç”¨é»˜è®¤é¡µè¾¹è·è®¾ç½®
                marginPreset: 'none',
                marginTop: 0,
                marginBottom: 0,
                marginLeft: 0,
                marginRight: 0,
                autoCenter: false
            };

            // æ˜¾ç¤ºPDFé¢„è§ˆæ¨¡æ€æ¡†
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
            pdfModal.show();

            document.getElementById('pdfInfo').textContent = 'æ­£åœ¨ç”ŸæˆPDF...';
            document.getElementById('pdfViewer').src = '';

            // å‘é€PDFç”Ÿæˆè¯·æ±‚
            fetch('/api/generate_pdf_preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success === true) {
                    // æ˜¾ç¤ºPDFé¢„è§ˆ
                    const pdfUrl = data.pdf_url + '?t=' + new Date().getTime();
                    document.getElementById('pdfViewer').src = pdfUrl;
                    document.getElementById('pdfInfo').textContent = `PDFç”ŸæˆæˆåŠŸ - ${data.label_count || window.previewData.splitQuantity}ä¸ªæ ‡ç­¾`;

                    // è‡ªåŠ¨ä¸‹è½½PDFï¼ˆå¯é€‰ï¼‰
                    if (data.pdf_url) {
                        // åˆ›å»ºä¸‹è½½é“¾æ¥
                        const downloadLink = document.createElement('a');
                        downloadLink.href = data.pdf_url;
                        downloadLink.download = `æ ‡ç­¾_${window.previewData.identificationCode}_${new Date().getTime()}.pdf`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    }
                } else {
                    document.getElementById('pdfInfo').textContent = 'PDFç”Ÿæˆå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯');
                    alert('PDFç”Ÿæˆæš‚æ—¶ä¸å¯ç”¨: ' + (data.message || 'è¯·è”ç³»ç®¡ç†å‘˜'));
                }
            })
            .catch(error => {
                console.error('PDFç”Ÿæˆé”™è¯¯:', error);
                document.getElementById('pdfInfo').textContent = 'PDFç”Ÿæˆå‡ºé”™';
                alert('PDFç”Ÿæˆå‡ºé”™: ' + error);
            });
        }

        // æ˜¾ç¤ºæ‰“å°æœºè®¾ç½®å¯¹è¯æ¡†
        function showPrinterSettingsDialog() {
            // æ›´æ–°æ‰“å°ä¿¡æ¯æ‘˜è¦
            updatePrintSummary();

            // åŒæ­¥æ‰“å°æœºåˆ—è¡¨
            syncPrinterList();

            // åˆå§‹åŒ–çº¸å¼ å’Œé¡µè¾¹è·è®¾ç½®
            initializePaperSettings();

            // æ˜¾ç¤ºå¯¹è¯æ¡†
            const printerSettingsModal = new bootstrap.Modal(document.getElementById('printerSettingsModal'));
            printerSettingsModal.show();
        }

        // åˆå§‹åŒ–çº¸å¼ å’Œé¡µè¾¹è·è®¾ç½®
        function initializePaperSettings() {
            // çº¸å¼ å¤§å°å˜åŒ–äº‹ä»¶
            document.getElementById('dialogPaperSize').addEventListener('change', function() {
                const customDiv = document.getElementById('customPaperSize');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                    // æ ¹æ®é¢„è®¾è®¾ç½®çº¸å¼ å°ºå¯¸
                    setPaperSizeFromPreset(this.value);
                }
            });

            // é¡µè¾¹è·é¢„è®¾å˜åŒ–äº‹ä»¶
            document.getElementById('dialogMarginPreset').addEventListener('change', function() {
                const customDiv = document.getElementById('customMargins');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                    // æ ¹æ®é¢„è®¾è®¾ç½®é¡µè¾¹è·
                    setMarginsFromPreset(this.value);
                }
            });
        }

        // æ ¹æ®é¢„è®¾è®¾ç½®çº¸å¼ å°ºå¯¸
        function setPaperSizeFromPreset(preset) {
            const widthInput = document.getElementById('dialogPaperWidth');
            const heightInput = document.getElementById('dialogPaperHeight');

            switch(preset) {
                case 'A4':
                    widthInput.value = 210;
                    heightInput.value = 297;
                    break;
                case 'A5':
                    widthInput.value = 148;
                    heightInput.value = 210;
                    break;
                case 'Letter':
                    widthInput.value = 216;
                    heightInput.value = 279;
                    break;
                case 'Legal':
                    widthInput.value = 216;
                    heightInput.value = 356;
                    break;
                case '40x60':
                    widthInput.value = 40;
                    heightInput.value = 60;
                    break;
                case '50x70':
                    widthInput.value = 50;
                    heightInput.value = 70;
                    break;
                case '60x90':
                    widthInput.value = 60;
                    heightInput.value = 90;
                    break;
            }
        }

        // æ ¹æ®é¢„è®¾è®¾ç½®é¡µè¾¹è·
        function setMarginsFromPreset(preset) {
            const topInput = document.getElementById('dialogMarginTop');
            const bottomInput = document.getElementById('dialogMarginBottom');
            const leftInput = document.getElementById('dialogMarginLeft');
            const rightInput = document.getElementById('dialogMarginRight');

            switch(preset) {
                case 'none':
                    topInput.value = 0;
                    bottomInput.value = 0;
                    leftInput.value = 0;
                    rightInput.value = 0;
                    break;
                case 'narrow':
                    topInput.value = 2;
                    bottomInput.value = 2;
                    leftInput.value = 2;
                    rightInput.value = 2;
                    break;
                case 'normal':
                    topInput.value = 5;
                    bottomInput.value = 5;
                    leftInput.value = 5;
                    rightInput.value = 5;
                    break;
                case 'wide':
                    topInput.value = 10;
                    bottomInput.value = 10;
                    leftInput.value = 10;
                    rightInput.value = 10;
                    break;
            }
        }

        // æ›´æ–°æ‰“å°ä¿¡æ¯æ‘˜è¦
        function updatePrintSummary() {
            if (previewData) {
                document.getElementById('dialogLabelCount').textContent = window.previewData.splitQuantity || '1';
                document.getElementById('dialogCustomerName').textContent = window.previewData.customerName || '-';
                document.getElementById('dialogPlateNumber').textContent = window.previewData.plateNumber || '-';
                document.getElementById('dialogIdentificationCode').textContent = window.previewData.identificationCode || '-';
            }
        }

        // åŒæ­¥æ‰“å°æœºåˆ—è¡¨åˆ°å¯¹è¯æ¡†
        function syncPrinterList() {
            const originalSelect = document.getElementById('printerSelect');
            const dialogSelect = document.getElementById('dialogPrinterSelect');

            // æ¸…ç©ºå¯¹è¯æ¡†ä¸­çš„é€‰é¡¹
            dialogSelect.innerHTML = '<option value="">é€‰æ‹©æ‰“å°æœº...</option>';

            // å¤åˆ¶åŸå§‹é€‰æ‹©æ¡†çš„é€‰é¡¹
            for (let i = 1; i < originalSelect.options.length; i++) {
                const option = originalSelect.options[i];
                const newOption = new Option(option.text, option.value);
                dialogSelect.add(newOption);
            }

            // è®¾ç½®å½“å‰é€‰ä¸­çš„æ‰“å°æœº
            dialogSelect.value = originalSelect.value;
        }

        // åˆ·æ–°æ‰“å°æœºåˆ—è¡¨
        function refreshPrinters() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ·æ–°ä¸­...';
            refreshBtn.disabled = true;

            // è°ƒç”¨åŠ è½½æ‰“å°æœºå‡½æ•°
            loadPrinters().then(() => {
                // åŒæ­¥åˆ°å¯¹è¯æ¡†
                syncPrinterList();

                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;

            }).catch(error => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;

                console.error('åˆ·æ–°æ‰“å°æœºå¤±è´¥:', error);
                alert('åˆ·æ–°æ‰“å°æœºåˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }

        // ç”ŸæˆPDFé¢„è§ˆ
        function generatePDFPreview() {
            // è·å–å­—ä½“è®¾ç½®
            const headerFontSize = document.getElementById('headerFontSize').value;
            const contentFontSize = document.getElementById('contentFontSize').value;
            const headerBold = document.getElementById('headerBold').checked;
            const contentBold = document.getElementById('contentBold').checked;

            // è·å–çº¸å¼ è®¾ç½®
            const paperSize = document.getElementById('dialogPaperSize').value;
            const paperWidth = parseFloat(document.getElementById('dialogPaperWidth').value) || 60;
            const paperHeight = parseFloat(document.getElementById('dialogPaperHeight').value) || 40;
            const paperOrientation = document.querySelector('input[name="paperOrientation"]:checked').value;

            // è·å–é¡µè¾¹è·è®¾ç½®
            const marginPreset = document.getElementById('dialogMarginPreset').value;
            const marginTop = parseFloat(document.getElementById('dialogMarginTop').value) || 0;
            const marginBottom = parseFloat(document.getElementById('dialogMarginBottom').value) || 0;
            const marginLeft = parseFloat(document.getElementById('dialogMarginLeft').value) || 0;
            const marginRight = parseFloat(document.getElementById('dialogMarginRight').value) || 0;
            const autoCenter = document.getElementById('dialogAutoCenter').checked;

            // å‡†å¤‡PDFç”Ÿæˆæ•°æ®
            const pdfData = {
                isWhole: window.previewData.isWhole,
                identificationCode: window.previewData.identificationCode,
                plateNumber: window.previewData.plateNumber,
                customerName: window.previewData.customerName,
                boardCount: window.previewData.boardCount,
                pieceCount: window.previewData.pieceCount,
                orderType: window.previewData.orderType,
                splitBoardNum: window.previewData.splitBoardNum,
                splitQuantity: window.previewData.splitQuantity,
                boardTiers: window.previewData.boardTiers,
                headerFontSize: headerFontSize,
                contentFontSize: contentFontSize,
                headerBold: headerBold,
                contentBold: contentBold,
                labelSize: window.previewData.labelSize,
                customWidth: window.previewData.customWidth,
                customHeight: window.previewData.customHeight,
                // çº¸å¼ è®¾ç½®
                paperSize: paperSize,
                paperWidth: paperWidth,
                paperHeight: paperHeight,
                paperOrientation: paperOrientation,
                // é¡µè¾¹è·è®¾ç½®
                marginPreset: marginPreset,
                marginTop: marginTop,
                marginBottom: marginBottom,
                marginLeft: marginLeft,
                marginRight: marginRight,
                autoCenter: autoCenter
            };

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
            pdfModal.show();

            document.getElementById('pdfInfo').textContent = 'æ­£åœ¨ç”ŸæˆPDFé¢„è§ˆ...';
            document.getElementById('pdfViewer').src = '';

            // å‘é€PDFç”Ÿæˆè¯·æ±‚
            fetch('/api/generate_pdf_preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // åˆ›å»ºPDF blob URL
                    const pdfBlob = base64ToBlob(data.pdf_data, 'application/pdf');
                    const pdfUrl = URL.createObjectURL(pdfBlob);

                    // æ˜¾ç¤ºPDF
                    document.getElementById('pdfViewer').src = pdfUrl;
                    document.getElementById('pdfInfo').textContent = `PDFé¢„è§ˆå·²ç”Ÿæˆ - ${data.filename}`;

                    // ä¿å­˜PDFæ•°æ®ä¾›ä¸‹è½½ä½¿ç”¨
                    window.currentPdfData = data.pdf_data;
                    window.currentPdfFilename = data.filename;
                } else {
                    document.getElementById('pdfInfo').textContent = `PDFç”Ÿæˆå¤±è´¥: ${data.message}`;
                    alert('PDFç”Ÿæˆå¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                document.getElementById('pdfInfo').textContent = 'PDFç”Ÿæˆå‡ºé”™';
                alert('PDFç”Ÿæˆå‡ºé”™: ' + error);
            });
        }

        // Base64è½¬Blob
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], {type: mimeType});
        }

        // ä¸‹è½½PDF
        function downloadPDF() {
            if (window.currentPdfData && window.currentPdfFilename) {
                const pdfBlob = base64ToBlob(window.currentPdfData, 'application/pdf');
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.currentPdfFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„PDFæ–‡ä»¶');
            }
        }

        // ä»é¢„è§ˆç•Œé¢æ‰“å°
        function printFromPreview() {
            // éšè—PDFé¢„è§ˆæ¨¡æ€æ¡†
            const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfPreviewModal'));
            pdfModal.hide();

            // è°ƒç”¨å…¨å±€çš„confirmPrintå‡½æ•°
            if (window.confirmPrint) {
                window.confirmPrint();
            } else {
                alert('æ‰“å°åŠŸèƒ½æš‚æ—¶ä¸å¯ç”¨');
            }
        }



        // å–æ¶ˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('cancelPreviewBtn').addEventListener('click', function() {
            document.getElementById('previewSection').style.display = 'none';
        });
        
        // åŠ è½½æ‰“å°æœºåˆ—è¡¨
        function loadPrinters() {
            // è°ƒç”¨APIè·å–æ‰“å°æœºåˆ—è¡¨ï¼Œè¿”å›Promise
            return fetch('/api/printers')
                .then(response => response.json())
                .then(data => {
                    const printerSelect = document.getElementById('printerSelect');
                    printerSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

                    if (data.success && data.printers && data.printers.length > 0) {
                        console.log(`æˆåŠŸåŠ è½½ ${data.printers.length} å°æ‰“å°æœº`);

                        // æ·»åŠ è·å–åˆ°çš„æ‰“å°æœº
                        data.printers.forEach(printer => {
                            const option = document.createElement('option');
                            option.value = printer.name;
                            option.textContent = printer.name + (printer.isDefault ? ' (é»˜è®¤)' : '');
                            printerSelect.appendChild(option);
                        });
                    } else {
                        console.warn('æœªè·å–åˆ°æ‰“å°æœºæˆ–APIè¿”å›é”™è¯¯:', data);
                        // æ·»åŠ é»˜è®¤é€‰é¡¹
                        const option = document.createElement('option');
                        option.value = 'default';
                        option.textContent = 'é»˜è®¤æ‰“å°æœº';
                        printerSelect.appendChild(option);
                    }
                    return data; // è¿”å›æ•°æ®ä¾›åç»­ä½¿ç”¨
                })
                .catch(error => {
                    console.error('è·å–æ‰“å°æœºåˆ—è¡¨å¤±è´¥:', error);
                    // æ·»åŠ é»˜è®¤é€‰é¡¹
                    const printerSelect = document.getElementById('printerSelect');
                    printerSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
                    const option = document.createElement('option');
                    option.value = 'default';
                    option.textContent = 'é»˜è®¤æ‰“å°æœº';
                    printerSelect.appendChild(option);
                    throw error; // é‡æ–°æŠ›å‡ºé”™è¯¯ä¾›è°ƒç”¨è€…å¤„ç†
                });
        }
        
        // é¡µé¢åŠ è½½æ—¶åŠ è½½æ‰“å°æœºåˆ—è¡¨
        loadPrinters();

        // å¯åŠ¨äº‹ä»¶ä¿æŠ¤æœºåˆ¶
        protectEventListeners();

        // æ·»åŠ æ ‡ç­¾å°ºå¯¸é€‰æ‹©äº‹ä»¶ç›‘å¬
        document.getElementById('wholeLabelSize').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('wholeCustomSizeInputs').style.display = 'flex';
            } else {
                document.getElementById('wholeCustomSizeInputs').style.display = 'none';
            }
        });

        document.getElementById('splitLabelSize').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('splitCustomSizeInputs').style.display = 'flex';
            } else {
                document.getElementById('splitCustomSizeInputs').style.display = 'none';
            }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬ - å·²ç”±æ•´åˆæ€§èƒ½ç®¡ç†å™¨æ¥ç®¡
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !window.integratedPM) {
                // åªæœ‰åœ¨æ²¡æœ‰æ•´åˆæ€§èƒ½ç®¡ç†å™¨æ—¶æ‰æ‰§è¡Œå¤‡ç”¨é€»è¾‘
                setTimeout(function() {
                    const wholeBtn = document.getElementById('wholeSelectCodeBtn');
                    const splitBtn = document.getElementById('splitSelectCodeBtn');

                    if (wholeBtn && splitBtn) {
                        const hasWholeEvent = hasEventListener(wholeBtn, 'click') || wholeBtn.onclick;
                        const hasSplitEvent = hasEventListener(splitBtn, 'click') || splitBtn.onclick;

                        if (!hasWholeEvent || !hasSplitEvent) {
                            console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°ç»‘å®šäº‹ä»¶');
                            rebindSelectButtons();
                        }
                    }
                }, 1000);
            }
        });
    });
</script>
{% endblock %} 