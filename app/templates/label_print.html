{% extends 'base.html' %}

{% block styles %}
{{ super() }}
<style>
    /* 入库记录行样式 */
    .inbound-record-row {
        cursor: pointer;
        transition: background-color 0.2s ease;
    }

    .inbound-record-row:hover {
        background-color: #f8f9fa !important;
    }

    .inbound-record-row:active {
        background-color: #e9ecef !important;
    }

    /* 选中状态的行 */
    .inbound-record-row.selected {
        background-color: #d1ecf1 !important;
    }

    /* 入库选择表格优化 */
    .table-responsive table {
        font-size: 12px;
    }

    .table-responsive th {
        font-size: 13px;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        padding: 8px 4px;
        white-space: nowrap;
    }

    .table-responsive td {
        vertical-align: middle;
        padding: 6px 4px;
        max-width: 0; /* 配合table-layout: fixed使用 */
        overflow: hidden;
    }

    /* 识别编码列特殊处理 */
    .table-responsive td:nth-child(2) {
        font-family: 'Courier New', monospace;
        font-size: 11px;
    }

    /* 数字列居中 */
    .table-responsive td:nth-child(6),
    .table-responsive td:nth-child(7) {
        text-align: center;
        font-weight: 500;
    }
    .card-body {
        padding: 1.5rem;
    }
    .form-section {
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
    }
    .form-section-title {
        margin-bottom: 1rem;
        font-weight: 500;
    }
    .print-preview {
        border: 1px solid #ddd;
        padding: 20px;
        margin: 20px 0;
        min-height: 200px;
        border-radius: 5px;
        background-color: #f9f9f9;
    }
    .preview-label {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 5px;
    }
    .preview-content {
        font-size: 16px;
        margin-bottom: 15px;
    }
    .preview-heading {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        border-bottom: 1px dashed #ddd;
        padding-bottom: 8px;
    }
    .nav-tabs .nav-link.active {
        background-color: #f0f0f0;
    }
    /* 更新预览区域样式，参考PyQT5风格 */
    #previewSection {
        display: none;
    }
    .labels-list-container {
        max-height: 300px;
        overflow-y: auto;
    }
    .preview-container {
        height: 400px;
        overflow-y: auto;
    }
    .label-list-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .label-list-item:hover {
        background-color: #f0f0f0;
    }
    .label-list-item.active {
        background-color: #e7f1ff;
        border-color: #b8daff;
    }
    /* 添加自定义尺寸编辑样式 */
    .custom-size-inputs {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }
    .custom-size-inputs input {
        width: 80px;
        margin: 0 5px;
    }
    .custom-size-inputs span {
        margin: 0 5px;
    }

    /* 打印机设置对话框样式 */
    #printerSettingsModal .card {
        border: 1px solid #e3e6f0;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        transition: all 0.3s ease;
    }

    #printerSettingsModal .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        font-weight: 600;
        color: #5a5c69;
    }

    #printerSettingsModal .badge {
        font-size: 0.75rem;
        transition: all 0.3s ease;
    }

    #printerSettingsModal .form-control:focus,
    #printerSettingsModal .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    #printerSettingsModal .btn-outline-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: all 0.2s ease;
    }

    /* 打印信息摘要样式 */
    #printerSettingsModal .fw-bold {
        color: #5a5c69;
        font-size: 0.9rem;
    }

    #printerSettingsModal .text-muted {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* 打印机状态指示器 */
    #printerSettingsModal .badge.bg-success {
        background-color: #1cc88a !important;
    }

    #printerSettingsModal .badge.bg-danger {
        background-color: #e74a3b !important;
    }

    /* 模态框动画 */
    #printerSettingsModal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translate(0, -50px);
    }

    #printerSettingsModal.show .modal-dialog {
        transform: none;
    }

    /* 纸张设置和页边距样式 */
    #printerSettingsModal .btn-group .btn-check:checked + .btn {
        background-color: #0d6efd;
        border-color: #0d6efd;
        color: white;
    }

    #printerSettingsModal .btn-outline-primary {
        border-color: #dee2e6;
        color: #6c757d;
    }

    #printerSettingsModal .btn-outline-primary:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
        color: #495057;
    }

    /* 自定义输入框样式 */
    #customPaperSize, #customMargins {
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.375rem;
        padding: 0.75rem;
        margin-top: 0.5rem;
    }

    #customPaperSize .form-label, #customMargins .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #495057;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="card-title"><i class="fas fa-tag me-2"></i>标签打印</h4>
                <small class="text-muted"><i class="fas fa-grip-lines-vertical me-1"></i>生成和打印入库货物标签</small>
            </div>
            <div>
                <a href="{{ url_for('main.inbound_list') }}" class="btn btn-outline-secondary btn-sm me-2">
                    <i class="fas fa-arrow-left"></i> 返回入库记录
                </a>
            </div>
        </div>
        
        <div class="card-body">
            <!-- 标签页 -->
            <ul class="nav nav-tabs" id="labelTabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="whole-tab" data-bs-toggle="tab" href="#whole" role="tab" aria-controls="whole" aria-selected="true">整板货物标签</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="split-tab" data-bs-toggle="tab" href="#split" role="tab" aria-controls="split" aria-selected="false">拆板货物标签</a>
                </li>
            </ul>
            
            <div class="tab-content" id="labelTabsContent">
                <!-- 整板货物标签 -->
                <div class="tab-pane fade show active" id="whole" role="tabpanel" aria-labelledby="whole-tab">
                    <div class="form-section mt-3">
                        <h5 class="form-section-title">整板标签信息</h5>
                        <form id="wholeBoardForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <!-- 识别编码选择 -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">识别编码 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="wholeIdentificationCode" name="identification_code" readonly placeholder="请选择识别编码">
                                            <button type="button" class="btn btn-outline-secondary" id="wholeSelectCodeBtn">
                                                <i class="fas fa-search"></i> 选择
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">入库车牌</label>
                                        <input type="text" class="form-control" id="wholePlateNumber" name="plate_number" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">客户名称</label>
                                        <input type="text" class="form-control" id="wholeCustomerName" name="customer_name" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">板数</label>
                                        <input type="number" class="form-control" id="wholeBoardCount" name="pallet_count" min="0" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">件数</label>
                                        <input type="number" class="form-control" id="wholePieceCount" name="package_count" min="0" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">订单类型</label>
                                        <input type="text" class="form-control" id="wholeOrderType" name="order_type" readonly>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <!-- 可以留给未来添加其他字段 -->
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">标签尺寸</label>
                                        <select class="form-select" id="wholeLabelSize">
                                            <option value="40x60" selected>40×60mm（默认）</option>
                                            <option value="50x70">50×70mm</option>
                                            <option value="60x90">60×90mm</option>
                                            <option value="custom">自定义尺寸</option>
                                        </select>
                                        <!-- 添加自定义尺寸输入框 -->
                                        <div id="wholeCustomSizeInputs" class="custom-size-inputs" style="display: none;">
                                            <input type="number" class="form-control" id="wholeCustomWidth" value="40" min="10" max="200"> 
                                            <span>×</span> 
                                            <input type="number" class="form-control" id="wholeCustomHeight" value="60" min="10" max="300">
                                            <span>mm</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">自定义格式</label>
                                        <select class="form-select" id="wholeLabelFormat">
                                            <option value="standard" selected>标准格式（默认）</option>
                                            <option value="compact">紧凑格式</option>
                                            <option value="detailed">详细格式</option>
                                            <option value="custom">自定义格式</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" id="wholePreviewBtn" class="btn btn-primary">生成标签</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- 拆板货物标签 -->
                <div class="tab-pane fade" id="split" role="tabpanel" aria-labelledby="split-tab">
                    <div class="form-section mt-3">
                        <h5 class="form-section-title">拆板标签信息</h5>
                        <form id="splitBoardForm">
                            <!-- 识别编码选择 -->
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="form-label">识别编码 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="splitIdentificationCode" name="identification_code" readonly placeholder="请选择识别编码">
                                            <button type="button" class="btn btn-outline-secondary" id="splitSelectCodeBtn">
                                                <i class="fas fa-search"></i> 选择
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">入库车牌</label>
                                        <input type="text" class="form-control" id="splitPlateNumber" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">客户名称</label>
                                        <input type="text" class="form-control" id="splitCustomerName" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">总板数</label>
                                        <input type="number" class="form-control" id="splitTotalBoards" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">拆第几板</label>
                                        <input type="number" class="form-control" id="splitBoardNum" name="board_num" min="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">拆板数量</label>
                                        <input type="number" class="form-control" id="splitQuantity" name="quantity" min="1">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label class="form-label">此板层数</label>
                                        <input type="number" class="form-control" id="boardTiers" name="board_tiers" min="1">
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">标签尺寸</label>
                                        <select class="form-select" id="splitLabelSize">
                                            <option value="40x60" selected>40×60mm（默认）</option>
                                            <option value="50x70">50×70mm</option>
                                            <option value="60x90">60×90mm</option>
                                            <option value="custom">自定义尺寸</option>
                                        </select>
                                        <!-- 添加自定义尺寸输入框 -->
                                        <div id="splitCustomSizeInputs" class="custom-size-inputs" style="display: none;">
                                            <input type="number" class="form-control" id="splitCustomWidth" value="40" min="10" max="200"> 
                                            <span>×</span> 
                                            <input type="number" class="form-control" id="splitCustomHeight" value="60" min="10" max="300">
                                            <span>mm</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label">自定义格式</label>
                                        <select class="form-select" id="splitLabelFormat">
                                            <option value="standard" selected>标准格式（默认）</option>
                                            <option value="compact">紧凑格式</option>
                                            <option value="detailed">详细格式</option>
                                            <option value="custom">自定义格式</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" id="splitPreviewBtn" class="btn btn-primary">生成标签</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 预览区域 - 参考PyQT5风格改造为分栏式 -->
            <div id="previewSection" class="mt-4">
                <h5 class="mb-3" id="previewTitle">标签预览</h5>
                <div class="row">
                    <div class="col-md-4">
                        <!-- 标签列表，类似PyQT5版本的左侧列表 -->
                        <div class="card mb-3">
                            <div class="card-header">标签列表</div>
                            <div class="card-body p-2 labels-list-container">
                                <ul id="labelsList" class="list-group"></ul>
                            </div>
                        </div>
                        <!-- 打印设置部分 -->
                        <div class="card">
                            <div class="card-header">打印设置</div>
                            <div class="card-body">
                                <div class="form-group mb-3">
                                    <label class="form-label">标题字号</label>
                                    <input type="number" class="form-control" id="headerFontSize" value="12" min="8" max="72">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="headerBold" checked>
                                    <label class="form-check-label" for="headerBold">
                                        标题加粗
                                    </label>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">内容字号</label>
                                    <input type="number" class="form-control" id="contentFontSize" value="12" min="8" max="72">
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" value="" id="contentBold" checked>
                                    <label class="form-check-label" for="contentBold">
                                        内容加粗
                                    </label>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">打印机选择</label>
                                    <select class="form-select" id="printerSelect">
                                        <option value="default">默认打印机</option>
                                        <!-- 打印机列表将通过JavaScript动态添加 -->
                                    </select>
                                </div>
                                <div class="d-grid gap-2">
                                    <button type="button" id="printAllBtn" class="btn btn-success">
                                        <i class="fas fa-print me-1"></i> 打印全部标签
                                    </button>
                                    <button type="button" id="cancelPreviewBtn" class="btn btn-outline-secondary">
                                        取消
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <!-- 预览内容区域，类似PyQT5版本的右侧预览 -->
                        <div class="card">
                            <div class="card-header">预览</div>
                            <div class="card-body print-preview preview-container" id="previewContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 入库记录选择模态框 -->
<div class="modal fade" id="inboundRecordModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    选择入库记录
                    <small class="text-muted ms-2">💡 提示：双击行可快速选择</small>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- 搜索区域 -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchKeyword" placeholder="搜索识别编码、车牌号或客户名称">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="searchStartDate">
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="searchEndDate">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary w-100" id="searchInboundBtn">
                            <i class="fas fa-search"></i> 搜索
                        </button>
                    </div>
                </div>

                <!-- 入库记录表格 -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-striped table-hover" style="table-layout: fixed; width: 100%;">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 8%;">选择</th>
                                <th style="width: 28%;">识别编码</th>
                                <th style="width: 12%;">入库时间</th>
                                <th style="width: 12%;">入库车牌</th>
                                <th style="width: 15%;">客户名称</th>
                                <th style="width: 8%;">板数</th>
                                <th style="width: 8%;">件数</th>
                                <th style="width: 9%;">订单类型</th>
                            </tr>
                        </thead>
                        <tbody id="inboundRecordsTable">
                            <tr>
                                <td colspan="8" class="text-center">正在加载...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmSelectBtn" disabled>确认选择</button>
            </div>
        </div>
    </div>
</div>

<!-- 打印机设置对话框 -->
<div class="modal fade" id="printerSettingsModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-print me-2"></i>打印设置
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- 打印机选择 -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-printer me-1"></i>打印机</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dialogPrinterSelect" class="form-label">选择打印机</label>
                                    <select class="form-select" id="dialogPrinterSelect">
                                        <option value="">选择打印机...</option>
                                        <!-- 打印机列表将通过JavaScript动态添加 -->
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">打印机状态</label>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">
                                            <i class="fas fa-circle me-1"></i>就绪
                                        </span>
                                        <small class="text-muted">打印机已连接并准备就绪</small>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshPrinters()">
                                        <i class="fas fa-sync-alt me-1"></i>刷新打印机列表
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 打印选项 -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-cog me-1"></i>打印选项</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="dialogCopies" class="form-label">打印份数</label>
                                    <input type="number" class="form-control" id="dialogCopies" value="1" min="1" max="99">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">打印质量</label>
                                    <select class="form-select" id="dialogPrintQuality">
                                        <option value="normal">普通</option>
                                        <option value="high" selected>高质量</option>
                                        <option value="draft">草稿</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dialogCollate" checked>
                                        <label class="form-check-label" for="dialogCollate">
                                            逐份打印
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dialogPrintPreview">
                                        <label class="form-check-label" for="dialogPrintPreview">
                                            打印前预览
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 纸张设置 -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-file-alt me-1"></i>纸张设置</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">纸张大小</label>
                                    <select class="form-select" id="dialogPaperSize">
                                        <option value="A4">A4 (210×297mm)</option>
                                        <option value="A5">A5 (148×210mm)</option>
                                        <option value="Letter">Letter (216×279mm)</option>
                                        <option value="Legal">Legal (216×356mm)</option>
                                        <option value="40x60" selected>标签纸 40×60mm</option>
                                        <option value="50x70">标签纸 50×70mm</option>
                                        <option value="60x90">标签纸 60×90mm</option>
                                        <option value="custom">自定义尺寸</option>
                                    </select>
                                </div>
                                <div id="customPaperSize" class="mb-3" style="display: none;">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">宽度 (mm)</label>
                                            <input type="number" class="form-control" id="dialogPaperWidth" value="60" min="10" max="500">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">高度 (mm)</label>
                                            <input type="number" class="form-control" id="dialogPaperHeight" value="40" min="10" max="500">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">纸张方向</label>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="paperOrientation" id="orientationPortrait" value="portrait" checked>
                                        <label class="btn btn-outline-primary" for="orientationPortrait">
                                            <i class="fas fa-mobile-alt me-1"></i>纵向
                                        </label>
                                        <input type="radio" class="btn-check" name="paperOrientation" id="orientationLandscape" value="landscape">
                                        <label class="btn btn-outline-primary" for="orientationLandscape">
                                            <i class="fas fa-mobile-alt fa-rotate-90 me-1"></i>横向
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 页边距设置 -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-expand-arrows-alt me-1"></i>页边距设置</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">页边距预设</label>
                                    <select class="form-select" id="dialogMarginPreset">
                                        <option value="none" selected>无边距</option>
                                        <option value="narrow">窄边距 (2mm)</option>
                                        <option value="normal">普通边距 (5mm)</option>
                                        <option value="wide">宽边距 (10mm)</option>
                                        <option value="custom">自定义边距</option>
                                    </select>
                                </div>
                                <div id="customMargins" class="mb-3" style="display: none;">
                                    <div class="row">
                                        <div class="col-6 mb-2">
                                            <label class="form-label">上边距 (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginTop" value="0" min="0" max="50" step="0.5">
                                        </div>
                                        <div class="col-6 mb-2">
                                            <label class="form-label">下边距 (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginBottom" value="0" min="0" max="50" step="0.5">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">左边距 (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginLeft" value="0" min="0" max="50" step="0.5">
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">右边距 (mm)</label>
                                            <input type="number" class="form-control" id="dialogMarginRight" value="0" min="0" max="50" step="0.5">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dialogAutoCenter">
                                        <label class="form-check-label" for="dialogAutoCenter">
                                            自动居中内容
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 打印信息摘要 -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info-circle me-1"></i>打印信息</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">标签数量</small>
                                        <div class="fw-bold" id="dialogLabelCount">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">客户名称</small>
                                        <div class="fw-bold" id="dialogCustomerName">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">车牌号</small>
                                        <div class="fw-bold" id="dialogPlateNumber">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">识别编码</small>
                                        <div class="fw-bold" id="dialogIdentificationCode">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmPrint()">
                    <i class="fas fa-print me-1"></i>开始打印
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDF预览模态框 -->
<div class="modal fade" id="pdfPreviewModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-pdf me-2"></i>PDF预览
                </h5>
                <div class="d-flex align-items-center">
                    <button type="button" class="btn btn-outline-primary me-2" onclick="downloadPDF()">
                        <i class="fas fa-download me-1"></i>下载PDF
                    </button>
                    <button type="button" class="btn btn-primary me-2" onclick="printFromPreview()">
                        <i class="fas fa-print me-1"></i>确认打印
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div id="pdfViewerContainer" style="height: calc(100vh - 120px); width: 100%;">
                    <iframe id="pdfViewer" style="width: 100%; height: 100%; border: none;" src=""></iframe>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div class="d-flex align-items-center">
                        <small class="text-muted" id="pdfInfo">正在加载PDF预览...</small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>关闭
                        </button>
                        <button type="button" class="btn btn-success" onclick="printFromPreview()">
                            <i class="fas fa-print me-1"></i>打印
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 打印进度模态框 -->
<div class="modal fade" id="printModal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">打印进度</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>正在准备打印标签，请稍候...</p>
                <div class="progress">
                    <div class="progress-bar" id="printProgress" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // 全局函数定义
    function confirmPrint() {
        // 验证打印机选择
        const printerName = document.getElementById('dialogPrinterSelect').value;
        if (!printerName) {
            alert('请选择打印机');
            return;
        }

        // 获取打印设置
        const copies = parseInt(document.getElementById('dialogCopies').value) || 1;
        const printQuality = document.getElementById('dialogPrintQuality').value;
        const collate = document.getElementById('dialogCollate').checked;
        const printPreview = document.getElementById('dialogPrintPreview').checked;

        // 获取纸张设置
        const paperSize = document.getElementById('dialogPaperSize').value;
        const paperWidth = parseFloat(document.getElementById('dialogPaperWidth').value) || 60;
        const paperHeight = parseFloat(document.getElementById('dialogPaperHeight').value) || 40;
        const paperOrientation = document.querySelector('input[name="paperOrientation"]:checked').value;

        // 获取页边距设置
        const marginPreset = document.getElementById('dialogMarginPreset').value;
        const marginTop = parseFloat(document.getElementById('dialogMarginTop').value) || 0;
        const marginBottom = parseFloat(document.getElementById('dialogMarginBottom').value) || 0;
        const marginLeft = parseFloat(document.getElementById('dialogMarginLeft').value) || 0;
        const marginRight = parseFloat(document.getElementById('dialogMarginRight').value) || 0;
        const autoCenter = document.getElementById('dialogAutoCenter').checked;

        // 如果选择了打印预览，生成PDF预览
        if (printPreview) {
            // 隐藏打印机设置对话框
            const printerSettingsModal = bootstrap.Modal.getInstance(document.getElementById('printerSettingsModal'));
            printerSettingsModal.hide();

            // 生成PDF预览
            generatePDFPreview();
            return;
        }

        // 隐藏打印机设置对话框
        const printerSettingsModal = bootstrap.Modal.getInstance(document.getElementById('printerSettingsModal'));
        printerSettingsModal.hide();

        // 显示打印进度模态框
        const printModal = new bootstrap.Modal(document.getElementById('printModal'));
        printModal.show();

        // 获取字体设置
        const headerFontSize = document.getElementById('headerFontSize').value;
        const contentFontSize = document.getElementById('contentFontSize').value;
        const headerBold = document.getElementById('headerBold').checked;
        const contentBold = document.getElementById('contentBold').checked;

        // 准备打印数据
        const printData = {
            isWhole: window.previewData.isWhole,
            identificationCode: window.previewData.identificationCode,
            plateNumber: window.previewData.plateNumber,
            customerName: window.previewData.customerName,
            boardCount: window.previewData.boardCount,
            pieceCount: window.previewData.pieceCount,
            orderType: window.previewData.orderType,
            splitBoardNum: window.previewData.splitBoardNum,
            splitQuantity: window.previewData.splitQuantity,
            boardTiers: window.previewData.boardTiers,
            headerFontSize: headerFontSize,
            contentFontSize: contentFontSize,
            headerBold: headerBold,
            contentBold: contentBold,
            printer: printerName,
            labelSize: window.previewData.labelSize,
            customWidth: window.previewData.customWidth,
            customHeight: window.previewData.customHeight,
            // 新增的打印设置
            copies: copies,
            printQuality: printQuality,
            collate: collate,
            // 纸张设置
            paperSize: paperSize,
            paperWidth: paperWidth,
            paperHeight: paperHeight,
            paperOrientation: paperOrientation,
            // 页边距设置
            marginPreset: marginPreset,
            marginTop: marginTop,
            marginBottom: marginBottom,
            marginLeft: marginLeft,
            marginRight: marginRight,
            autoCenter: autoCenter
        };

        // 发送打印请求
        fetch('/api/print_labels', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(printData)
        })
        .then(response => response.json())
        .then(data => {
            printModal.hide();
            if (data.status === 'success') {
                // 显示详细的成功信息
                const details = data.details || {};
                const printType = data.print_type || details.print_status || '未知';
                const isRealPrint = printType.includes('真实打印');

                const successMessage = `✅ 打印任务提交成功！

📋 任务详情：
• 任务ID: ${data.job_id || 'N/A'}
• 打印类型: ${printType}
• 打印机: ${details.printer || 'N/A'}
• 客户: ${details.customer || 'N/A'}
• 车牌: ${details.plate_number || 'N/A'}
• 标签数量: ${details.labels_count || 'N/A'} 个
• 打印份数: ${details.copies || 1} 份
• 纸张大小: ${details.paper_size || 'N/A'}
• 总页数: ${details.total_pages || 'N/A'} 页

${isRealPrint ?
    '✅ 真实打印：PDF已生成并发送到打印机' :
    '⚠️ 模拟打印：需要安装reportlab库才能进行真实打印'
}`;

                alert(successMessage);

                // 显示操作提示
                if (window.showMessage) {
                    window.showMessage('打印任务已提交到 ' + (details.printer || '默认打印机'), 'success');
                }

                // 保存打印记录
                if (window.printHistory) {
                    window.printHistory.add(data);
                }

                // 启动打印状态模拟
                if (data.job_id && window.checkPrintStatus) {
                    setTimeout(() => {
                        window.checkPrintStatus(data.job_id);
                    }, 1000); // 1秒后开始状态检查
                }
            } else {
                alert('❌ 打印失败: ' + data.message);
                if (window.showMessage) {
                    window.showMessage('打印失败: ' + data.message, 'error');
                }
            }
        })
        .catch(error => {
            printModal.hide();
            alert('❌ 发送打印请求时出错: ' + error);
            if (window.showMessage) {
                window.showMessage('打印请求发送失败: ' + error, 'error');
            }
        });
    }

    // 测试函数是否正确定义
    console.log('confirmPrint函数已定义:', typeof confirmPrint === 'function');

    // 将函数添加到window对象以确保全局访问
    window.confirmPrint = confirmPrint;

    // 其他全局函数声明
    window.generatePDFPreview = function() {
        console.log('generatePDFPreview called');

        // 显示模拟的PDF预览对话框
        const previewMessage = `📄 PDF预览功能

⚠️ 当前状态：PDF预览功能暂时不可用
🔧 原因：需要安装reportlab库

📋 预览内容：
• 客户：${window.previewData.customerName || 'N/A'}
• 车牌：${window.previewData.plateNumber || 'N/A'}
• 标签数量：${window.previewData.isWhole ?
    (window.previewData.boardCount + window.previewData.pieceCount) :
    window.previewData.splitQuantity} 个

💡 解决方案：
1. 安装reportlab库：pip install reportlab
2. 重启应用服务器
3. 重新尝试PDF预览功能

是否直接进行打印？`;

        if (confirm(previewMessage)) {
            // 用户选择直接打印
            console.log('用户选择直接打印');

            // 显示打印机设置对话框
            const printerSettingsModal = new bootstrap.Modal(document.getElementById('printerSettingsModal'));
            printerSettingsModal.show();
        }
    };

    window.downloadPDF = function() {
        console.log('downloadPDF called');
        alert('下载功能暂时不可用');
    };

    window.printFromPreview = function() {
        console.log('printFromPreview called');
        // 隐藏PDF预览模态框
        const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfPreviewModal'));
        if (pdfModal) {
            pdfModal.hide();
        }

        // 调用confirmPrint函数
        if (window.confirmPrint) {
            window.confirmPrint();
        } else {
            alert('打印功能暂时不可用');
        }
    };

    // 模拟打印状态检查功能
    window.checkPrintStatus = function(jobId) {
        console.log('检查打印状态:', jobId);

        // 模拟打印状态
        const statuses = ['排队中', '正在打印', '打印完成'];
        let currentStatus = 0;

        const statusInterval = setInterval(() => {
            if (currentStatus < statuses.length) {
                console.log(`打印任务 ${jobId}: ${statuses[currentStatus]}`);
                if (window.showMessage) {
                    window.showMessage(`打印任务 ${jobId}: ${statuses[currentStatus]}`, 'info');
                }
                currentStatus++;
            } else {
                clearInterval(statusInterval);
                if (window.showMessage) {
                    window.showMessage(`打印任务 ${jobId} 已完成`, 'success');
                }
            }
        }, 2000); // 每2秒更新一次状态
    };

    // 打印历史记录管理
    window.printHistory = {
        records: JSON.parse(localStorage.getItem('printHistory') || '[]'),

        add: function(jobData) {
            const record = {
                id: jobData.job_id,
                timestamp: new Date().toISOString(),
                customer: jobData.details?.customer || 'N/A',
                plateNumber: jobData.details?.plate_number || 'N/A',
                printer: jobData.details?.printer || 'N/A',
                labelsCount: jobData.details?.labels_count || 0,
                copies: jobData.details?.copies || 1,
                status: '已提交'
            };

            this.records.unshift(record); // 添加到开头
            if (this.records.length > 50) { // 只保留最近50条记录
                this.records = this.records.slice(0, 50);
            }

            localStorage.setItem('printHistory', JSON.stringify(this.records));
            console.log('打印记录已保存:', record);
        },

        getRecords: function() {
            return this.records;
        },

        clear: function() {
            this.records = [];
            localStorage.removeItem('printHistory');
            console.log('打印历史已清空');
        }
    };

    // 全局预览数据对象
    window.previewData = {
        isWhole: true,
        identificationCode: '',
        plateNumber: '',
        customerName: '',
        boardCount: 0,
        pieceCount: 0,
        orderType: '',
        splitBoardNum: 1,
        splitQuantity: 1,
        boardTiers: '',
        labelSize: 'small',
        customWidth: 40,
        customHeight: 60
    };

    document.addEventListener('DOMContentLoaded', function() {

        // 防止事件被清理的保护机制 - 已由整合性能管理器接管
        function protectEventListeners() {
            // 检查是否有整合性能管理器
            if (window.integratedPM) {
                console.log('✅ 事件保护已由整合性能管理器接管');
                return;
            }

            // 备用方案：简化的事件保护
            rebindSelectButtons();

            // 只检查一次，避免频繁检查
            setTimeout(function() {
                const wholeBtn = document.getElementById('wholeSelectCodeBtn');
                const splitBtn = document.getElementById('splitSelectCodeBtn');

                if (wholeBtn && splitBtn) {
                    const hasWholeEvent = hasEventListener(wholeBtn, 'click') || wholeBtn.onclick;
                    const hasSplitEvent = hasEventListener(splitBtn, 'click') || splitBtn.onclick;

                    if (!hasWholeEvent || !hasSplitEvent) {
                        console.warn('备用事件保护：重新绑定选择按钮');
                        rebindSelectButtons();
                    } else {
                        console.log('✅ 选择按钮事件正常');
                    }
                }
            }, 2000); // 只检查一次
        }

        // 检查元素是否有事件监听器 - 改进版本
        function hasEventListener(element, eventType) {
            if (!element) return false;

            // 检查jQuery事件
            try {
                const events = $._data(element, 'events');
                if (events && events[eventType] && events[eventType].length > 0) {
                    return true;
                }
            } catch (e) {
                // jQuery检查失败，继续检查原生事件
            }

            // 检查原生事件监听器
            if (element.onclick || element['on' + eventType]) {
                return true;
            }

            // 检查是否有自定义标记
            return element.hasAttribute('data-event-bound');
        }

        // 当前选择的入库记录
        let selectedInboundRecord = null;

        // 模态框实例
        let inboundRecordModal = null;


        // 获取或初始化模态框实例
        function getInboundRecordModal() {
            if (!inboundRecordModal) {
                const modalElement = document.getElementById('inboundRecordModal');
                if (modalElement) {
                    inboundRecordModal = new bootstrap.Modal(modalElement);
                }
            }
            return inboundRecordModal;
        }

        // 日期格式化函数
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 加载入库记录
        function loadInboundRecords(keyword = '', startDate = '', endDate = '') {
            const tableBody = document.getElementById('inboundRecordsTable');
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center">正在加载...</td></tr>';

            // 构建查询参数
            const params = new URLSearchParams();
            if (keyword) params.append('keyword', keyword);
            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            fetch(`/api/inbound_records?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.records) {
                        renderInboundRecords(data.records);
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">没有找到入库记录</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('加载入库记录失败:', error);
                    tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">加载失败，请重试</td></tr>';
                });
        }

        // 渲染入库记录表格
        function renderInboundRecords(records) {
            const tableBody = document.getElementById('inboundRecordsTable');

            if (records.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">没有找到入库记录</td></tr>';
                return;
            }

            tableBody.innerHTML = records.map(record => `
                <tr data-record='${JSON.stringify(record)}' class="inbound-record-row">
                    <td style="text-align: center; vertical-align: middle;">
                        <input type="radio" name="selectedRecord" value="${record.id}"
                               data-record='${JSON.stringify(record)}' class="form-check-input">
                    </td>
                    <td style="word-wrap: break-word; word-break: break-all; font-size: 12px; line-height: 1.3;" title="${record.identification_code || '-'}">${record.identification_code || '-'}</td>
                    <td style="white-space: nowrap; font-size: 12px;">${record.inbound_time || '-'}</td>
                    <td style="white-space: nowrap; font-size: 12px;">${record.plate_number || '-'}</td>
                    <td style="word-wrap: break-word; font-size: 12px; line-height: 1.3;" title="${record.customer_name || '-'}">${record.customer_name || '-'}</td>
                    <td style="text-align: center; font-size: 12px;">${record.pallet_count || 0}</td>
                    <td style="text-align: center; font-size: 12px;">${record.package_count || 0}</td>
                    <td style="word-wrap: break-word; font-size: 12px; line-height: 1.3;" title="${record.order_type || '-'}">${record.order_type || '-'}</td>
                </tr>
            `).join('');

            // 添加选择事件监听
            document.querySelectorAll('input[name="selectedRecord"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('confirmSelectBtn').disabled = false;

                    // 更新行的选中状态
                    document.querySelectorAll('.inbound-record-row').forEach(row => {
                        row.classList.remove('selected');
                    });

                    if (this.checked) {
                        const row = this.closest('.inbound-record-row');
                        if (row) {
                            row.classList.add('selected');
                        }
                    }
                });
            });

            // 添加双击选中功能
            document.querySelectorAll('.inbound-record-row').forEach(row => {
                // 添加鼠标悬停效果
                row.style.cursor = 'pointer';

                // 双击事件
                row.addEventListener('dblclick', function() {
                    // 选中对应的单选按钮
                    const radio = this.querySelector('input[name="selectedRecord"]');
                    if (radio) {
                        radio.checked = true;
                        // 触发change事件以启用确认按钮
                        radio.dispatchEvent(new Event('change'));

                        // 直接执行选择逻辑
                        selectInboundRecord(radio);
                    }
                });

                // 单击行选中单选按钮（可选功能）
                row.addEventListener('click', function(e) {
                    // 如果点击的不是单选按钮本身，则选中单选按钮
                    if (e.target.type !== 'radio') {
                        const radio = this.querySelector('input[name="selectedRecord"]');
                        if (radio) {
                            radio.checked = true;
                            radio.dispatchEvent(new Event('change'));
                        }
                    }
                });
            });
        }

        // 选择入库记录的通用函数
        function selectInboundRecord(radioElement) {
            if (!radioElement || !radioElement.checked) {
                return;
            }

            selectedInboundRecord = JSON.parse(radioElement.dataset.record);

            // 根据当前标签页填充数据
            const activeTab = document.querySelector('.nav-link.active').getAttribute('href');
            if (activeTab === '#whole') {
                // 填充整板标签数据
                document.getElementById('wholeIdentificationCode').value = selectedInboundRecord.identification_code || '';
                document.getElementById('wholePlateNumber').value = selectedInboundRecord.plate_number || '';
                document.getElementById('wholeCustomerName').value = selectedInboundRecord.customer_name || '';
                document.getElementById('wholeBoardCount').value = selectedInboundRecord.pallet_count || 0;
                document.getElementById('wholePieceCount').value = selectedInboundRecord.package_count || 0;
                document.getElementById('wholeOrderType').value = selectedInboundRecord.order_type || '';
            } else {
                // 填充拆板标签数据
                document.getElementById('splitIdentificationCode').value = selectedInboundRecord.identification_code || '';
                document.getElementById('splitPlateNumber').value = selectedInboundRecord.plate_number || '';
                document.getElementById('splitCustomerName').value = selectedInboundRecord.customer_name || '';
                document.getElementById('splitTotalBoards').value = selectedInboundRecord.pallet_count || 0;
            }

            // 关闭模态框
            const modal = getInboundRecordModal();
            if (modal) {
                modal.hide();
            }

            // 显示成功提示
            if (window.showMessage) {
                window.showMessage(`已选择入库记录: ${selectedInboundRecord.identification_code}`, 'success');
            }
        }

        // 重新绑定选择按钮事件的函数 - 优化版本
        function rebindSelectButtons() {
            const wholeBtn = document.getElementById('wholeSelectCodeBtn');
            const splitBtn = document.getElementById('splitSelectCodeBtn');

            // 检查是否已经绑定过事件，避免重复绑定
            if (wholeBtn && !wholeBtn.hasAttribute('data-event-bound')) {
                // 克隆按钮以移除所有事件监听器
                const newWholeBtn = wholeBtn.cloneNode(true);
                wholeBtn.parentNode.replaceChild(newWholeBtn, wholeBtn);

                // 重新绑定整板选择按钮事件
                newWholeBtn.addEventListener('click', function() {
                    console.log('整板选择按钮被点击');
                    // 设置默认搜索日期为最近7天
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    document.getElementById('searchStartDate').value = formatDate(startDate);
                    document.getElementById('searchEndDate').value = formatDate(endDate);

                    // 显示模态框并加载数据
                    const modal = getInboundRecordModal();
                    if (modal) {
                        modal.show();
                        loadInboundRecords();
                    } else {
                        alert('模态框初始化失败，请刷新页面重试');
                    }
                });

                // 标记已绑定事件
                newWholeBtn.setAttribute('data-event-bound', 'true');
            }

            if (splitBtn && !splitBtn.hasAttribute('data-event-bound')) {
                // 克隆按钮以移除所有事件监听器
                const newSplitBtn = splitBtn.cloneNode(true);
                splitBtn.parentNode.replaceChild(newSplitBtn, splitBtn);

                // 重新绑定拆板选择按钮事件
                newSplitBtn.addEventListener('click', function() {
                    console.log('拆板选择按钮被点击');
                    // 设置默认搜索日期为最近7天
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);

                    document.getElementById('searchStartDate').value = formatDate(startDate);
                    document.getElementById('searchEndDate').value = formatDate(endDate);

                    // 显示模态框并加载数据
                    const modal = getInboundRecordModal();
                    if (modal) {
                        modal.show();
                        loadInboundRecords();
                    } else {
                        alert('模态框初始化失败，请刷新页面重试');
                    }
                });

                // 标记已绑定事件
                newSplitBtn.setAttribute('data-event-bound', 'true');
            }

            // 只在实际绑定了事件时才输出日志
            const wholeBound = document.getElementById('wholeSelectCodeBtn')?.hasAttribute('data-event-bound');
            const splitBound = document.getElementById('splitSelectCodeBtn')?.hasAttribute('data-event-bound');

            if (wholeBound || splitBound) {
                console.log('选择按钮事件已重新绑定');
            }
        }

        // 初始绑定选择按钮事件
        rebindSelectButtons();

        // 搜索按钮事件
        document.getElementById('searchInboundBtn').addEventListener('click', function() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const startDate = document.getElementById('searchStartDate').value;
            const endDate = document.getElementById('searchEndDate').value;

            loadInboundRecords(keyword, startDate, endDate);
        });

        // 确认选择按钮事件
        document.getElementById('confirmSelectBtn').addEventListener('click', function() {
            const selectedRadio = document.querySelector('input[name="selectedRecord"]:checked');
            if (!selectedRadio) {
                alert('请选择一条入库记录');
                return;
            }

            // 使用通用选择函数
            selectInboundRecord(selectedRadio);
        });

        // 更新预览内容的函数
        function updatePreviewContent(index) {
            const previewContent = document.getElementById('previewContent');
            previewContent.innerHTML = ''; // 清空预览内容

            // 计算当前标签文本
            let headerText = '';
            if (window.previewData.isWhole) {
                if (index < window.previewData.boardCount) {
                    headerText = `共计${window.previewData.boardCount}板${window.previewData.pieceCount}件-第${index + 1}板`;
                } else {
                    headerText = `共计${window.previewData.boardCount}板${window.previewData.pieceCount}件-第${index - window.previewData.boardCount + 1}件`;
                }
            } else {
                headerText = `共计${window.previewData.boardCount}板-拆第${window.previewData.splitBoardNum}板-${index + 1}/${window.previewData.splitQuantity}`;
            }

            // 创建并添加标题元素
            const headerElement = document.createElement('div');
            headerElement.className = 'preview-heading';
            headerElement.textContent = headerText;
            previewContent.appendChild(headerElement);

            // 创建内容容器
            const contentContainer = document.createElement('div');
            contentContainer.className = 'preview-content';

            // 显示识别编码
            if (window.previewData.identificationCode) {
                const codeElem = document.createElement('div');
                codeElem.className = 'preview-label';
                codeElem.style.fontWeight = 'bold';
                codeElem.textContent = window.previewData.identificationCode;
                contentContainer.appendChild(codeElem);
            }

            // 添加基本信息
            const infoItems = [
                {label: '入库车牌', value: window.previewData.plateNumber},
                {label: '客户', value: window.previewData.customerName}
            ];

            // 如果是拆板，添加此板层数
            if (!window.previewData.isWhole) {
                infoItems.push({label: '此板层数', value: window.previewData.boardTiers});
            } else {
                // 如果是整板，添加订单类型
                infoItems.push({label: '订单类型', value: window.previewData.orderType});
            }

            // 添加打印日期
            infoItems.push({label: '打印日期', value: formatDate(new Date())});

            // 创建并添加每个信息项
            infoItems.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'preview-label';
                itemElement.textContent = `${item.label}: ${item.value}`;
                contentContainer.appendChild(itemElement);
            });

            previewContent.appendChild(contentContainer);
        }
        
        // 生成标签列表并显示预览
        function showPreviewSection() {
            // 显示预览区域
            document.getElementById('previewSection').style.display = 'block';
            
            // 清空标签列表
            const labelsList = document.getElementById('labelsList');
            labelsList.innerHTML = '';
            
            // 计算标签总数
            const totalLabels = window.previewData.isWhole ?
                (window.previewData.boardCount + window.previewData.pieceCount) :
                window.previewData.splitQuantity;
            
            // 创建标签列表项
            for (let i = 0; i < totalLabels; i++) {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item label-list-item';
                listItem.dataset.index = i;
                
                if (window.previewData.isWhole) {
                    if (i < window.previewData.boardCount) {
                        listItem.textContent = `板 ${i + 1}/${window.previewData.boardCount}`;
                    } else {
                        listItem.textContent = `件 ${i - window.previewData.boardCount + 1}/${window.previewData.pieceCount}`;
                    }
                } else {
                    listItem.textContent = `拆板 ${i + 1}/${totalLabels}`;
                }
                
                // 添加点击事件
                listItem.addEventListener('click', function() {
                    // 移除所有列表项的active类
                    document.querySelectorAll('.label-list-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // 添加active类到当前点击的项
                    this.classList.add('active');
                    
                    // 更新预览内容
                    updatePreviewContent(parseInt(this.dataset.index));
                });
                
                labelsList.appendChild(listItem);
            }
            
            // 选择并显示第一个标签
            if (totalLabels > 0) {
                labelsList.firstChild.classList.add('active');
                updatePreviewContent(0);
            }
        }
        
        // 整板预览按钮点击事件处理
        document.getElementById('wholePreviewBtn').addEventListener('click', function() {
            // 收集整板表单数据
            const identificationCode = document.getElementById('wholeIdentificationCode').value.trim();
            const plateNumber = document.getElementById('wholePlateNumber').value.trim();
            const customerName = document.getElementById('wholeCustomerName').value.trim();
            const boardCount = parseInt(document.getElementById('wholeBoardCount').value) || 0;
            const pieceCount = parseInt(document.getElementById('wholePieceCount').value) || 0;
            const orderType = document.getElementById('wholeOrderType').value;

            if (!identificationCode) {
                alert('请先选择识别编码');
                return;
            }

            if (!plateNumber || !customerName || (boardCount <= 0 && pieceCount <= 0)) {
                alert('请确保已选择有效的入库记录');
                return;
            }

            // 更新预览数据
            window.previewData.isWhole = true;
            window.previewData.identificationCode = identificationCode;
            window.previewData.plateNumber = plateNumber;
            window.previewData.customerName = customerName;
            window.previewData.boardCount = boardCount;
            window.previewData.pieceCount = pieceCount;
            window.previewData.orderType = orderType;

            // 获取自定义尺寸
            if (document.getElementById('wholeLabelSize').value === 'custom') {
                window.previewData.customWidth = parseInt(document.getElementById('wholeCustomWidth').value) || 40;
                window.previewData.customHeight = parseInt(document.getElementById('wholeCustomHeight').value) || 60;
                window.previewData.labelSize = 'custom';
            } else {
                window.previewData.labelSize = document.getElementById('wholeLabelSize').value;
            }

            // 显示预览区域
            showPreviewSection();
        });
        
        // 拆板预览按钮点击事件处理
        document.getElementById('splitPreviewBtn').addEventListener('click', function() {
            // 收集拆板表单数据
            const identificationCode = document.getElementById('splitIdentificationCode').value.trim();
            const plateNumber = document.getElementById('splitPlateNumber').value.trim();
            const customerName = document.getElementById('splitCustomerName').value.trim();
            const boardCount = parseInt(document.getElementById('splitTotalBoards').value) || 0;
            const splitBoardNum = parseInt(document.getElementById('splitBoardNum').value) || 0;
            const splitQuantity = parseInt(document.getElementById('splitQuantity').value) || 0;
            const boardTiers = parseInt(document.getElementById('boardTiers').value) || 0;

            if (!identificationCode) {
                alert('请先选择识别编码');
                return;
            }

            if (!plateNumber || !customerName || boardCount <= 0 || splitBoardNum <= 0 || splitQuantity <= 0 || boardTiers <= 0) {
                alert('请填写所有必要的信息');
                return;
            }

            // 更新预览数据
            window.previewData.isWhole = false;
            window.previewData.identificationCode = identificationCode;
            window.previewData.plateNumber = plateNumber;
            window.previewData.customerName = customerName;
            window.previewData.boardCount = boardCount;
            window.previewData.splitBoardNum = splitBoardNum;
            window.previewData.splitQuantity = splitQuantity;
            window.previewData.boardTiers = boardTiers;

            // 获取自定义尺寸
            if (document.getElementById('splitLabelSize').value === 'custom') {
                window.previewData.customWidth = parseInt(document.getElementById('splitCustomWidth').value) || 40;
                window.previewData.customHeight = parseInt(document.getElementById('splitCustomHeight').value) || 60;
                window.previewData.labelSize = 'custom';
            } else {
                window.previewData.labelSize = document.getElementById('splitLabelSize').value;
            }

            // 显示预览区域
            showPreviewSection();
        });

        
        // 打印全部标签按钮点击事件
        document.getElementById('printAllBtn').addEventListener('click', function() {
            // 直接生成PDF并打开，跳过打印机设置对话框
            directPrintToPDF();
        });

        // 直接生成PDF并打开
        function directPrintToPDF() {
            // 检查是否有预览数据
            if (!window.previewData) {
                alert('请先生成标签预览');
                return;
            }

            // 使用默认设置生成PDF
            const headerFontSize = document.getElementById('headerFontSize').value || 12;
            const contentFontSize = document.getElementById('contentFontSize').value || 10;
            const headerBold = document.getElementById('headerBold').checked;
            const contentBold = document.getElementById('contentBold').checked;

            // 准备PDF生成数据（使用默认设置）
            const pdfData = {
                isWhole: window.previewData.isWhole,
                identificationCode: window.previewData.identificationCode,
                customerName: window.previewData.customerName,
                plateNumber: window.previewData.plateNumber,
                boardCount: window.previewData.boardCount,
                pieceCount: window.previewData.pieceCount,
                orderType: window.previewData.orderType,
                splitBoardNum: window.previewData.splitBoardNum,
                splitQuantity: window.previewData.splitQuantity,
                boardTiers: window.previewData.boardTiers,
                labelSize: window.previewData.labelSize,
                customWidth: window.previewData.customWidth,
                customHeight: window.previewData.customHeight,
                headerFontSize: headerFontSize,
                contentFontSize: contentFontSize,
                headerBold: headerBold,
                contentBold: contentBold,
                // 使用默认纸张设置
                paperSize: '40x60',
                paperWidth: 60,
                paperHeight: 40,
                paperOrientation: 'portrait',
                // 使用默认页边距设置
                marginPreset: 'none',
                marginTop: 0,
                marginBottom: 0,
                marginLeft: 0,
                marginRight: 0,
                autoCenter: false
            };

            // 显示PDF预览模态框
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
            pdfModal.show();

            document.getElementById('pdfInfo').textContent = '正在生成PDF...';
            document.getElementById('pdfViewer').src = '';

            // 发送PDF生成请求
            fetch('/api/generate_pdf_preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success === true) {
                    // 显示PDF预览
                    const pdfUrl = data.pdf_url + '?t=' + new Date().getTime();
                    document.getElementById('pdfViewer').src = pdfUrl;
                    document.getElementById('pdfInfo').textContent = `PDF生成成功 - ${data.label_count || window.previewData.splitQuantity}个标签`;

                    // 自动下载PDF（可选）
                    if (data.pdf_url) {
                        // 创建下载链接
                        const downloadLink = document.createElement('a');
                        downloadLink.href = data.pdf_url;
                        downloadLink.download = `标签_${window.previewData.identificationCode}_${new Date().getTime()}.pdf`;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                    }
                } else {
                    document.getElementById('pdfInfo').textContent = 'PDF生成失败: ' + (data.message || '未知错误');
                    alert('PDF生成暂时不可用: ' + (data.message || '请联系管理员'));
                }
            })
            .catch(error => {
                console.error('PDF生成错误:', error);
                document.getElementById('pdfInfo').textContent = 'PDF生成出错';
                alert('PDF生成出错: ' + error);
            });
        }

        // 显示打印机设置对话框
        function showPrinterSettingsDialog() {
            // 更新打印信息摘要
            updatePrintSummary();

            // 同步打印机列表
            syncPrinterList();

            // 初始化纸张和页边距设置
            initializePaperSettings();

            // 显示对话框
            const printerSettingsModal = new bootstrap.Modal(document.getElementById('printerSettingsModal'));
            printerSettingsModal.show();
        }

        // 初始化纸张和页边距设置
        function initializePaperSettings() {
            // 纸张大小变化事件
            document.getElementById('dialogPaperSize').addEventListener('change', function() {
                const customDiv = document.getElementById('customPaperSize');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                    // 根据预设设置纸张尺寸
                    setPaperSizeFromPreset(this.value);
                }
            });

            // 页边距预设变化事件
            document.getElementById('dialogMarginPreset').addEventListener('change', function() {
                const customDiv = document.getElementById('customMargins');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                    // 根据预设设置页边距
                    setMarginsFromPreset(this.value);
                }
            });
        }

        // 根据预设设置纸张尺寸
        function setPaperSizeFromPreset(preset) {
            const widthInput = document.getElementById('dialogPaperWidth');
            const heightInput = document.getElementById('dialogPaperHeight');

            switch(preset) {
                case 'A4':
                    widthInput.value = 210;
                    heightInput.value = 297;
                    break;
                case 'A5':
                    widthInput.value = 148;
                    heightInput.value = 210;
                    break;
                case 'Letter':
                    widthInput.value = 216;
                    heightInput.value = 279;
                    break;
                case 'Legal':
                    widthInput.value = 216;
                    heightInput.value = 356;
                    break;
                case '40x60':
                    widthInput.value = 40;
                    heightInput.value = 60;
                    break;
                case '50x70':
                    widthInput.value = 50;
                    heightInput.value = 70;
                    break;
                case '60x90':
                    widthInput.value = 60;
                    heightInput.value = 90;
                    break;
            }
        }

        // 根据预设设置页边距
        function setMarginsFromPreset(preset) {
            const topInput = document.getElementById('dialogMarginTop');
            const bottomInput = document.getElementById('dialogMarginBottom');
            const leftInput = document.getElementById('dialogMarginLeft');
            const rightInput = document.getElementById('dialogMarginRight');

            switch(preset) {
                case 'none':
                    topInput.value = 0;
                    bottomInput.value = 0;
                    leftInput.value = 0;
                    rightInput.value = 0;
                    break;
                case 'narrow':
                    topInput.value = 2;
                    bottomInput.value = 2;
                    leftInput.value = 2;
                    rightInput.value = 2;
                    break;
                case 'normal':
                    topInput.value = 5;
                    bottomInput.value = 5;
                    leftInput.value = 5;
                    rightInput.value = 5;
                    break;
                case 'wide':
                    topInput.value = 10;
                    bottomInput.value = 10;
                    leftInput.value = 10;
                    rightInput.value = 10;
                    break;
            }
        }

        // 更新打印信息摘要
        function updatePrintSummary() {
            if (previewData) {
                document.getElementById('dialogLabelCount').textContent = window.previewData.splitQuantity || '1';
                document.getElementById('dialogCustomerName').textContent = window.previewData.customerName || '-';
                document.getElementById('dialogPlateNumber').textContent = window.previewData.plateNumber || '-';
                document.getElementById('dialogIdentificationCode').textContent = window.previewData.identificationCode || '-';
            }
        }

        // 同步打印机列表到对话框
        function syncPrinterList() {
            const originalSelect = document.getElementById('printerSelect');
            const dialogSelect = document.getElementById('dialogPrinterSelect');

            // 清空对话框中的选项
            dialogSelect.innerHTML = '<option value="">选择打印机...</option>';

            // 复制原始选择框的选项
            for (let i = 1; i < originalSelect.options.length; i++) {
                const option = originalSelect.options[i];
                const newOption = new Option(option.text, option.value);
                dialogSelect.add(newOption);
            }

            // 设置当前选中的打印机
            dialogSelect.value = originalSelect.value;
        }

        // 刷新打印机列表
        function refreshPrinters() {
            const refreshBtn = event.target;
            const originalText = refreshBtn.innerHTML;

            // 显示加载状态
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>刷新中...';
            refreshBtn.disabled = true;

            // 调用加载打印机函数
            loadPrinters().then(() => {
                // 同步到对话框
                syncPrinterList();

                // 恢复按钮状态
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;

            }).catch(error => {
                // 恢复按钮状态
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;

                console.error('刷新打印机失败:', error);
                alert('刷新打印机列表失败，请检查网络连接');
            });
        }

        // 生成PDF预览
        function generatePDFPreview() {
            // 获取字体设置
            const headerFontSize = document.getElementById('headerFontSize').value;
            const contentFontSize = document.getElementById('contentFontSize').value;
            const headerBold = document.getElementById('headerBold').checked;
            const contentBold = document.getElementById('contentBold').checked;

            // 获取纸张设置
            const paperSize = document.getElementById('dialogPaperSize').value;
            const paperWidth = parseFloat(document.getElementById('dialogPaperWidth').value) || 60;
            const paperHeight = parseFloat(document.getElementById('dialogPaperHeight').value) || 40;
            const paperOrientation = document.querySelector('input[name="paperOrientation"]:checked').value;

            // 获取页边距设置
            const marginPreset = document.getElementById('dialogMarginPreset').value;
            const marginTop = parseFloat(document.getElementById('dialogMarginTop').value) || 0;
            const marginBottom = parseFloat(document.getElementById('dialogMarginBottom').value) || 0;
            const marginLeft = parseFloat(document.getElementById('dialogMarginLeft').value) || 0;
            const marginRight = parseFloat(document.getElementById('dialogMarginRight').value) || 0;
            const autoCenter = document.getElementById('dialogAutoCenter').checked;

            // 准备PDF生成数据
            const pdfData = {
                isWhole: window.previewData.isWhole,
                identificationCode: window.previewData.identificationCode,
                plateNumber: window.previewData.plateNumber,
                customerName: window.previewData.customerName,
                boardCount: window.previewData.boardCount,
                pieceCount: window.previewData.pieceCount,
                orderType: window.previewData.orderType,
                splitBoardNum: window.previewData.splitBoardNum,
                splitQuantity: window.previewData.splitQuantity,
                boardTiers: window.previewData.boardTiers,
                headerFontSize: headerFontSize,
                contentFontSize: contentFontSize,
                headerBold: headerBold,
                contentBold: contentBold,
                labelSize: window.previewData.labelSize,
                customWidth: window.previewData.customWidth,
                customHeight: window.previewData.customHeight,
                // 纸张设置
                paperSize: paperSize,
                paperWidth: paperWidth,
                paperHeight: paperHeight,
                paperOrientation: paperOrientation,
                // 页边距设置
                marginPreset: marginPreset,
                marginTop: marginTop,
                marginBottom: marginBottom,
                marginLeft: marginLeft,
                marginRight: marginRight,
                autoCenter: autoCenter
            };

            // 显示加载状态
            const pdfModal = new bootstrap.Modal(document.getElementById('pdfPreviewModal'));
            pdfModal.show();

            document.getElementById('pdfInfo').textContent = '正在生成PDF预览...';
            document.getElementById('pdfViewer').src = '';

            // 发送PDF生成请求
            fetch('/api/generate_pdf_preview', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(pdfData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 创建PDF blob URL
                    const pdfBlob = base64ToBlob(data.pdf_data, 'application/pdf');
                    const pdfUrl = URL.createObjectURL(pdfBlob);

                    // 显示PDF
                    document.getElementById('pdfViewer').src = pdfUrl;
                    document.getElementById('pdfInfo').textContent = `PDF预览已生成 - ${data.filename}`;

                    // 保存PDF数据供下载使用
                    window.currentPdfData = data.pdf_data;
                    window.currentPdfFilename = data.filename;
                } else {
                    document.getElementById('pdfInfo').textContent = `PDF生成失败: ${data.message}`;
                    alert('PDF生成失败: ' + data.message);
                }
            })
            .catch(error => {
                document.getElementById('pdfInfo').textContent = 'PDF生成出错';
                alert('PDF生成出错: ' + error);
            });
        }

        // Base64转Blob
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], {type: mimeType});
        }

        // 下载PDF
        function downloadPDF() {
            if (window.currentPdfData && window.currentPdfFilename) {
                const pdfBlob = base64ToBlob(window.currentPdfData, 'application/pdf');
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = window.currentPdfFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                alert('没有可下载的PDF文件');
            }
        }

        // 从预览界面打印
        function printFromPreview() {
            // 隐藏PDF预览模态框
            const pdfModal = bootstrap.Modal.getInstance(document.getElementById('pdfPreviewModal'));
            pdfModal.hide();

            // 调用全局的confirmPrint函数
            if (window.confirmPrint) {
                window.confirmPrint();
            } else {
                alert('打印功能暂时不可用');
            }
        }



        // 取消按钮点击事件
        document.getElementById('cancelPreviewBtn').addEventListener('click', function() {
            document.getElementById('previewSection').style.display = 'none';
        });
        
        // 加载打印机列表
        function loadPrinters() {
            // 调用API获取打印机列表，返回Promise
            return fetch('/api/printers')
                .then(response => response.json())
                .then(data => {
                    const printerSelect = document.getElementById('printerSelect');
                    printerSelect.innerHTML = ''; // 清空现有选项

                    if (data.success && data.printers && data.printers.length > 0) {
                        console.log(`成功加载 ${data.printers.length} 台打印机`);

                        // 添加获取到的打印机
                        data.printers.forEach(printer => {
                            const option = document.createElement('option');
                            option.value = printer.name;
                            option.textContent = printer.name + (printer.isDefault ? ' (默认)' : '');
                            printerSelect.appendChild(option);
                        });
                    } else {
                        console.warn('未获取到打印机或API返回错误:', data);
                        // 添加默认选项
                        const option = document.createElement('option');
                        option.value = 'default';
                        option.textContent = '默认打印机';
                        printerSelect.appendChild(option);
                    }
                    return data; // 返回数据供后续使用
                })
                .catch(error => {
                    console.error('获取打印机列表失败:', error);
                    // 添加默认选项
                    const printerSelect = document.getElementById('printerSelect');
                    printerSelect.innerHTML = ''; // 清空现有选项
                    const option = document.createElement('option');
                    option.value = 'default';
                    option.textContent = '默认打印机';
                    printerSelect.appendChild(option);
                    throw error; // 重新抛出错误供调用者处理
                });
        }
        
        // 页面加载时加载打印机列表
        loadPrinters();

        // 启动事件保护机制
        protectEventListeners();

        // 添加标签尺寸选择事件监听
        document.getElementById('wholeLabelSize').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('wholeCustomSizeInputs').style.display = 'flex';
            } else {
                document.getElementById('wholeCustomSizeInputs').style.display = 'none';
            }
        });

        document.getElementById('splitLabelSize').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('splitCustomSizeInputs').style.display = 'flex';
            } else {
                document.getElementById('splitCustomSizeInputs').style.display = 'none';
            }
        });

        // 页面可见性变化监听 - 已由整合性能管理器接管
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && !window.integratedPM) {
                // 只有在没有整合性能管理器时才执行备用逻辑
                setTimeout(function() {
                    const wholeBtn = document.getElementById('wholeSelectCodeBtn');
                    const splitBtn = document.getElementById('splitSelectCodeBtn');

                    if (wholeBtn && splitBtn) {
                        const hasWholeEvent = hasEventListener(wholeBtn, 'click') || wholeBtn.onclick;
                        const hasSplitEvent = hasEventListener(splitBtn, 'click') || splitBtn.onclick;

                        if (!hasWholeEvent || !hasSplitEvent) {
                            console.log('页面重新可见，重新绑定事件');
                            rebindSelectButtons();
                        }
                    }
                }, 1000);
            }
        });
    });
</script>
{% endblock %} 