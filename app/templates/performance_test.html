{% extends "base.html" %}
{% set title = "æ€§èƒ½æµ‹è¯•é¡µé¢" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-rocket text-primary me-2"></i>
                        æ€§èƒ½ä¼˜åŒ–æµ‹è¯•é¡µé¢
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>æ€§èƒ½ç›‘æ§è¯´æ˜</h6>
                        <ul class="mb-0">
                            <li>æŒ‰ <kbd>Ctrl+Shift+P</kbd> æ‰“å¼€æ€§èƒ½ç›‘æ§é¢æ¿</li>
                            <li>ç‚¹å‡»å³ä¸Šè§’çš„ <i class="fas fa-tachometer-alt text-info"></i> æŒ‰é’®ä¹Ÿå¯ä»¥æ‰“å¼€é¢æ¿</li>
                            <li>ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å’Œä¿®å¤æ€§èƒ½é—®é¢˜</li>
                            <li>é¡µé¢åŠ è½½æ—¶é—´è¶…è¿‡3ç§’ä¼šè‡ªåŠ¨è§¦å‘ä¼˜åŒ–</li>
                        </ul>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">âœ… å·²å¯ç”¨çš„ä¼˜åŒ–åŠŸèƒ½</h6>
                                </div>
                                <div class="card-body">
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>è‡ªåŠ¨æ€§èƒ½æ£€æµ‹</li>
                                        <li><i class="fas fa-check text-success me-2"></i>é¢„é˜²æ€§ä¼˜åŒ–</li>
                                        <li><i class="fas fa-check text-success me-2"></i>DOMå¤æ‚åº¦ç›‘æ§</li>
                                        <li><i class="fas fa-check text-success me-2"></i>å†…å­˜ä½¿ç”¨ç›‘æ§</li>
                                        <li><i class="fas fa-check text-success me-2"></i>èµ„æºåŠ è½½ä¼˜åŒ–</li>
                                        <li><i class="fas fa-check text-success me-2"></i>å›¾ç‰‡æ‡’åŠ è½½</li>
                                        <li><i class="fas fa-check text-success me-2"></i>è„šæœ¬å»¶è¿ŸåŠ è½½</li>
                                        <li><i class="fas fa-check text-success me-2"></i>CSSä¼˜åŒ–</li>
                                        <li><i class="fas fa-check text-success me-2"></i>å­—ä½“ä¼˜åŒ–</li>
                                        <li><i class="fas fa-check text-success me-2"></i>ç½‘ç»œçŠ¶æ€é€‚é…</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">ğŸ“Š æ€§èƒ½æŒ‡æ ‡</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6 mb-3">
                                            <h4 id="load-time-display" class="text-primary">-</h4>
                                            <small class="text-muted">é¡µé¢åŠ è½½æ—¶é—´</small>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <h4 id="dom-count-display" class="text-info">-</h4>
                                            <small class="text-muted">DOMå…ƒç´ æ•°é‡</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 id="memory-usage-display" class="text-warning">-</h4>
                                            <small class="text-muted">å†…å­˜ä½¿ç”¨</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 id="performance-score-display" class="text-success">-</h4>
                                            <small class="text-muted">æ€§èƒ½è¯„åˆ†</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">ğŸ”§ æ‰‹åŠ¨æµ‹è¯•åŠŸèƒ½</h6>
                                </div>
                                <div class="card-body">
                                    <div class="btn-group mb-3" role="group">
                                        <button type="button" class="btn btn-primary" id="force-check-btn">
                                            <i class="fas fa-search me-2"></i>å¼ºåˆ¶æ€§èƒ½æ£€æŸ¥
                                        </button>
                                        <button type="button" class="btn btn-success" id="trigger-optimization-btn">
                                            <i class="fas fa-magic me-2"></i>è§¦å‘ä¼˜åŒ–
                                        </button>
                                        <button type="button" class="btn btn-warning" id="simulate-slow-btn">
                                            <i class="fas fa-hourglass-half me-2"></i>æ¨¡æ‹Ÿæ…¢é€ŸåŠ è½½
                                        </button>
                                        <button type="button" class="btn btn-info" id="memory-test-btn">
                                            <i class="fas fa-memory me-2"></i>å†…å­˜å‹åŠ›æµ‹è¯•
                                        </button>
                                    </div>
                                    
                                    <div id="test-results" class="mt-3">
                                        <!-- æµ‹è¯•ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="card border-secondary">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">ğŸ“ ä¼˜åŒ–æ—¥å¿—</h6>
                                </div>
                                <div class="card-body">
                                    <div id="optimization-log" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                                        <div class="text-muted">ç­‰å¾…ä¼˜åŒ–æ—¥å¿—...</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class PerformanceTestPage {
    constructor() {
        this.logContainer = document.getElementById('optimization-log');
        this.init();
    }
    
    init() {
        this.bindEvents();
        this.startMonitoring();
        this.log('æ€§èƒ½æµ‹è¯•é¡µé¢å·²åŠ è½½');
    }
    
    bindEvents() {
        // å¼ºåˆ¶æ€§èƒ½æ£€æŸ¥
        document.getElementById('force-check-btn').addEventListener('click', () => {
            this.log('æ‰§è¡Œå¼ºåˆ¶æ€§èƒ½æ£€æŸ¥...');
            if (window.autoPerformanceFixer) {
                window.autoPerformanceFixer.forceCheck();
                this.log('âœ… æ€§èƒ½æ£€æŸ¥å®Œæˆ');
            } else {
                this.log('âŒ æ€§èƒ½ä¿®å¤ç³»ç»ŸæœªåŠ è½½');
            }
        });
        
        // è§¦å‘ä¼˜åŒ–
        document.getElementById('trigger-optimization-btn').addEventListener('click', () => {
            this.log('è§¦å‘æ‰‹åŠ¨ä¼˜åŒ–...');
            if (window.PerformanceAutoStart) {
                window.PerformanceAutoStart.triggerDeepOptimization();
                this.log('âœ… æ·±åº¦ä¼˜åŒ–å®Œæˆ');
            } else {
                this.log('âŒ è‡ªåŠ¨ä¼˜åŒ–ç³»ç»ŸæœªåŠ è½½');
            }
        });
        
        // æ¨¡æ‹Ÿæ…¢é€ŸåŠ è½½
        document.getElementById('simulate-slow-btn').addEventListener('click', () => {
            this.simulateSlowLoading();
        });
        
        // å†…å­˜å‹åŠ›æµ‹è¯•
        document.getElementById('memory-test-btn').addEventListener('click', () => {
            this.memoryStressTest();
        });
    }
    
    startMonitoring() {
        // æ›´æ–°æ€§èƒ½æŒ‡æ ‡
        this.updateMetrics();
        
        // å®šæœŸæ›´æ–°
        setInterval(() => {
            this.updateMetrics();
        }, 5000);
        
        // ç›‘å¬æ€§èƒ½ä¿®å¤äº‹ä»¶
        document.addEventListener('performanceConfigChanged', (e) => {
            this.log('ğŸ“Š æ€§èƒ½é…ç½®å·²æ›´æ–°');
        });
    }
    
    updateMetrics() {
        // é¡µé¢åŠ è½½æ—¶é—´
        const navigation = performance.getEntriesByType('navigation')[0];
        if (navigation) {
            const loadTime = navigation.loadEventEnd - navigation.fetchStart;
            document.getElementById('load-time-display').textContent = `${(loadTime/1000).toFixed(2)}s`;
        }
        
        // DOMå…ƒç´ æ•°é‡
        const domCount = document.querySelectorAll('*').length;
        document.getElementById('dom-count-display').textContent = domCount.toLocaleString();
        
        // å†…å­˜ä½¿ç”¨
        if ('memory' in performance) {
            const memory = performance.memory;
            const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
            document.getElementById('memory-usage-display').textContent = `${usedMB}MB`;
        }
        
        // æ€§èƒ½è¯„åˆ†ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
        const score = this.calculatePerformanceScore();
        document.getElementById('performance-score-display').textContent = score;
    }
    
    calculatePerformanceScore() {
        let score = 100;
        
        // æ£€æŸ¥åŠ è½½æ—¶é—´
        const navigation = performance.getEntriesByType('navigation')[0];
        if (navigation) {
            const loadTime = navigation.loadEventEnd - navigation.fetchStart;
            if (loadTime > 5000) score -= 30;
            else if (loadTime > 3000) score -= 20;
            else if (loadTime > 1000) score -= 10;
        }
        
        // æ£€æŸ¥DOMå¤æ‚åº¦
        const domCount = document.querySelectorAll('*').length;
        if (domCount > 3000) score -= 20;
        else if (domCount > 2000) score -= 10;
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨
        if ('memory' in performance) {
            const memory = performance.memory;
            const usedMB = memory.usedJSHeapSize / 1024 / 1024;
            if (usedMB > 100) score -= 20;
            else if (usedMB > 50) score -= 10;
        }
        
        return Math.max(0, score);
    }
    
    simulateSlowLoading() {
        this.log('ğŸŒ æ¨¡æ‹Ÿæ…¢é€ŸåŠ è½½...');
        
        // åˆ›å»ºå¤§é‡DOMå…ƒç´ 
        const container = document.createElement('div');
        container.style.display = 'none';
        
        for (let i = 0; i < 1000; i++) {
            const div = document.createElement('div');
            div.innerHTML = `<span>æµ‹è¯•å…ƒç´  ${i}</span><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="test">`;
            container.appendChild(div);
        }
        
        document.body.appendChild(container);
        
        this.log('âœ… å·²æ·»åŠ 1000ä¸ªæµ‹è¯•å…ƒç´ ');
        
        // 5ç§’åæ¸…ç†
        setTimeout(() => {
            container.remove();
            this.log('ğŸ§¹ å·²æ¸…ç†æµ‹è¯•å…ƒç´ ');
        }, 5000);
    }
    
    memoryStressTest() {
        this.log('ğŸ’¾ å¼€å§‹å†…å­˜å‹åŠ›æµ‹è¯•...');
        
        // åˆ›å»ºå¤§å‹æ•°ç»„
        const largeArray = [];
        for (let i = 0; i < 100000; i++) {
            largeArray.push({
                id: i,
                data: 'x'.repeat(100),
                timestamp: Date.now()
            });
        }
        
        this.log(`ğŸ“ˆ å·²åˆ›å»ºåŒ…å«${largeArray.length}ä¸ªå¯¹è±¡çš„å¤§å‹æ•°ç»„`);
        
        // æ£€æŸ¥å†…å­˜ä½¿ç”¨
        if ('memory' in performance) {
            const memory = performance.memory;
            const usedMB = (memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
            this.log(`ğŸ’¾ å½“å‰å†…å­˜ä½¿ç”¨: ${usedMB}MB`);
        }
        
        // 5ç§’åæ¸…ç†
        setTimeout(() => {
            largeArray.length = 0;
            if (window.gc) {
                window.gc();
                this.log('ğŸ—‘ï¸ å·²å¼ºåˆ¶åƒåœ¾å›æ”¶');
            } else {
                this.log('ğŸ—‘ï¸ å·²æ¸…ç†å¤§å‹æ•°ç»„');
            }
        }, 5000);
    }
    
    log(message) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${message}`;
        
        this.logContainer.appendChild(logEntry);
        this.logContainer.scrollTop = this.logContainer.scrollHeight;
        
        // é™åˆ¶æ—¥å¿—æ¡æ•°
        const logs = this.logContainer.children;
        if (logs.length > 100) {
            this.logContainer.removeChild(logs[0]);
        }
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const testPage = new PerformanceTestPage();
});
</script>
{% endblock %}
