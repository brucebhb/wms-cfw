{% extends "base.html" %}

{% block styles %}
<!-- ä½¿ç”¨æœ¬åœ°CSSèµ„æº -->
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/jexcel.css') }}" type="text/css" />
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/jsuites.css') }}" type="text/css" />
<!-- æ·»åŠ è‡ªå®šä¹‰è¡¨æ ¼æ ·å¼ -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/simple-table.css') }}" type="text/css" />
<!-- æ·»åŠ å¤‡ç”¨CSSåŠ è½½æ–¹æ³• -->
<script>
    // ç¡®ä¿CSSæ–‡ä»¶åŠ è½½
    function loadCSS(url) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = url;
        document.head.appendChild(link);
        return new Promise((resolve, reject) => {
            link.onload = resolve;
            link.onerror = reject;
        });
    }

    // æ£€æŸ¥CSSæ˜¯å¦å·²åŠ è½½ï¼Œå¦‚æœæ²¡æœ‰åˆ™åŠ è½½
    window.addEventListener('DOMContentLoaded', function() {
        const cssUrls = [
            '{{ url_for("static", filename="vendor/css/jexcel.css") }}',
            '{{ url_for("static", filename="vendor/css/jsuites.css") }}'
        ];
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åŠ è½½CSS
        const loadedLinks = Array.from(document.getElementsByTagName('link'))
                               .map(link => link.href);
        
        cssUrls.forEach(url => {
            if (!loadedLinks.some(href => href === url)) {
                console.log('åŠ è½½CSS:', url);
                loadCSS(url).catch(err => console.error('CSSåŠ è½½å¤±è´¥:', url, err));
            }
        });
    });
</script>
<style>
    .batch-options {
        margin-bottom: 0.6rem;
    }
    #spreadsheet {
        min-height: 250px;
        max-height: none;
        height: auto;
        width: 100%;
        overflow-x: auto;
        overflow-y: visible;
        margin-bottom: 10px;
        margin-left: 0;
        margin-right: auto;
        padding-left: 0;
    }
    
    /* è¡¨æ ¼å®¹å™¨è°ƒæ•´ - ä¸è¶…å‡ºç™½è‰²èƒŒæ™¯ */
    #spreadsheet-container {
        justify-content: flex-start !important;
        padding-left: 0;
        margin-left: 0; /* ä¸å‘å·¦ç§»åŠ¨ï¼Œä¿æŒåœ¨ç™½è‰²èƒŒæ™¯å†… */
        width: 100%; /* æ­£å¸¸å®½åº¦ */
        overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨æ¡ */
    }
    
    /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ */
    .loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }
    .required {
        color: #ff0000;
    }
    .btn-action {
        margin-right: 8px;
    }
    .file-upload {
        display: none;
    }
    
    /* jExcel æ ·å¼ä¼˜åŒ– */
    .jexcel > thead > tr > td {
        font-weight: bold;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
    }
    
    .jexcel > tbody > tr > td {
        padding: 6px 4px;
    }
    
    /* å¢åŠ è¡¨å¤´å³ä¾§æ‹–åŠ¨æŒ‡ç¤º */
    .jexcel_column_width {
        background-color: #f1f1f1 !important;
    }
    
    .jexcel_column_width:hover {
        background-color: #2196F3 !important;
    }
    
    /* è°ƒæ•´åˆ—å®½æŒ‡å¼•æ ·å¼ */
    .resize-guide {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: #2196F3;
        color: #fff;
        padding: 10px 15px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 9999;
        font-size: 13px;
        max-width: 200px;
    }
    
    /* å†…å®¹åŒºåŸŸå±…ä¸­ */
    .card-body {
        text-align: center;
        padding: 0.8rem 0.2rem 0.8rem 0; /* å‡å°‘å·¦è¾¹è·ä¸º0 */
    }
    
    /* æŒ‰é’®ç»„é å·¦ */
    .action-buttons {
        display: flex;
        justify-content: flex-start;
        margin-bottom: 0.6rem;
        margin-left: 10px; /* å¢åŠ å·¦è¾¹è· */
    }
    
    /* åº•éƒ¨æŒ‰é’®å±…å·¦ */
    .bottom-buttons {
        display: flex;
        justify-content: flex-start;
        gap: 0.8rem;
        margin-top: 0.6rem;
        margin-bottom: 0.5rem;
        margin-left: 10px; /* å¢åŠ å·¦è¾¹è· */
    }
    
    /* å¼¹çª—æ ·å¼ */
    .custom-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 10000;
        justify-content: center;
        align-items: center;
    }
    
    .modal-content {
        background-color: white;
        padding: 20px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        max-width: 500px;
        width: 90%;
        text-align: center;
        position: relative;
    }
    
    .modal-close {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 20px;
        cursor: pointer;
        color: #aaa;
    }
    
    .modal-close:hover {
        color: #333;
    }
    
    .modal-success .modal-header {
        color: #28a745;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .modal-error .modal-header {
        color: #dc3545;
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .modal-header i {
        font-size: 1.5em;
        margin-right: 10px;
    }
    
    .modal-footer {
        padding-top: 15px;
        margin-top: 15px;
        border-top: 1px solid #e9ecef;
        text-align: right;
    }
    
    /* é”™è¯¯æç¤ºæ ·å¼ */
    .alert-warning {
        color: #856404;
        background-color: #fff3cd;
        border-color: #ffeeba;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }
    
    .alert-danger {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: 0.75rem 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid transparent;
        border-radius: 0.25rem;
    }
    
    /* è¡¨æ ¼æ³¨é‡Šæ ·å¼ */
    .table-note {
        margin-bottom: 0.4rem;
        font-size: 0.9rem;
    }
    
    /* ä¼˜åŒ–è¡¨æ ¼æ ·å¼ï¼Œæ”¯æŒå¤§é‡æ•°æ® */
    .jexcel_content {
        max-height: none !important; /* ç§»é™¤å†…å®¹åŒºåŸŸçš„é«˜åº¦é™åˆ¶ */
        height: auto !important; /* é«˜åº¦è‡ªåŠ¨è°ƒæ•´ */
    }
    
    /* ç¡®ä¿è¡¨å¤´å›ºå®šåœ¨é¡¶éƒ¨ */
    .jexcel_container {
        position: relative;
    }
    
    /* è®¾ç½®è¡¨æ ¼æ»šåŠ¨åŒºåŸŸ */
    .card-body {
        padding: 0.8rem 0.2rem 0.8rem 0; /* ä¿æŒåŸæœ‰çš„å†…è¾¹è· */
        overflow: visible; /* å…è®¸å†…å®¹æº¢å‡º */
        height: auto; /* è‡ªåŠ¨è°ƒæ•´é«˜åº¦ */
    }
    
    /* ç¡®ä¿åº•éƒ¨æŒ‰é’®åŒºåŸŸä¸å—è¡¨æ ¼æ»šåŠ¨å½±å“ */
    .bottom-buttons {
        position: sticky; 
        bottom: 0;
        background-color: white;
        padding-top: 10px;
        z-index: 10;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mx-0 px-0" style="max-width: 100%;">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
        <div>
            <h4 class="card-title mb-0"><i class="fas fa-truck-loading me-2"></i>{{ title or 'å…¥åº“æ“ä½œï¼ˆæ‰¹é‡å½•å…¥ï¼‰' }}</h4>
            <small class="text-muted"><i class="fas fa-grip-lines-vertical me-1"></i>æç¤ºï¼šæ‹–åŠ¨è¡¨å¤´è¾¹ç¼˜å¯è°ƒæ•´åˆ—å®½</small>
        </div>
        <div>
            <button type="button" class="btn btn-outline-secondary btn-sm me-1" id="downloadTemplateBtn">
                <i class="fas fa-download me-1"></i> ä¸‹è½½æ¨¡æ¿
            </button>
            <button type="button" class="btn btn-outline-info btn-sm" id="importExcelBtn">
                <i class="fas fa-file-excel me-1"></i> Excelå¯¼å…¥
            </button>
            <button type="button" class="btn btn-outline-warning btn-sm" id="resetImportBtn" style="display: none;" title="é‡ç½®å¯¼å…¥çŠ¶æ€">
                <i class="fas fa-redo me-1"></i> é‡ç½®å¯¼å…¥
            </button>
            <input type="file" id="fileUpload" class="file-upload" accept=".xlsx, .xls, .csv">
        </div>
    </div>
    <div class="card-body">
        <div class="batch-options mb-2">
            <div class="row align-items-center g-2 justify-content-start">
                <div class="col-md-3 d-flex justify-content-start ms-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text">é»˜è®¤å…¥åº“æ—¶é—´</span>
                        <input type="date" class="form-control" id="defaultInboundTime">
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="action-buttons">
                        <button type="button" class="btn btn-success btn-sm btn-action" id="addRowBtn">
                            <i class="fas fa-plus"></i> æ·»åŠ è¡Œ
                        </button>
                        <button type="button" class="btn btn-danger btn-sm btn-action" id="removeRowBtn">
                            <i class="fas fa-trash"></i> åˆ é™¤é€‰ä¸­è¡Œ
                        </button>
                        <button type="button" class="btn btn-warning btn-sm btn-action" id="clearDataBtn">
                            <i class="fas fa-eraser"></i> æ¸…ç©ºæ•°æ®
                        </button>
                        <button type="button" class="btn btn-info btn-sm btn-action" id="fixDropdownBtn" style="display: none;">
                            <i class="fas fa-wrench"></i> ä¿®å¤ä¸‹æ‹‰æ¡†
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm btn-action" id="validateMappingBtn">
                            <i class="fas fa-check-circle"></i> éªŒè¯å­—æ®µæ˜ å°„
                        </button>
                        <span class="ms-2 text-secondary small"><i class="fas fa-info-circle"></i> æ”¯æŒæ‹–åŠ¨è°ƒæ•´åˆ—å®½å’Œå¤åˆ¶ç²˜è´´Excelæ•°æ®</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ çº¢è‰²æç¤ºä¿¡æ¯æ¡† -->
        <div class="alert alert-danger p-2 mb-2" style="background-color: #fff3cd; color: #856404; border-color: #ffeeba; text-align: left;">
            <i class="fas fa-info-circle me-1"></i> <span class="required">*</span> ä¸ºå¿…å¡«é¡¹ï¼Œ<span class="required">æ¿æ•°</span>ä¸<span class="required">ä»¶æ•°</span>è‡³å°‘å¡«å†™ä¸€é¡¹
            <br><strong>å¿…å¡«é¡¹åŒ…æ‹¬ï¼š</strong>å…¥åº“æ—¶é—´ã€å…¥åº“è½¦ç‰Œã€å®¢æˆ·åç§°ã€å‡ºå¢ƒæ¨¡å¼ã€è®¢å•ç±»å‹ã€æŠ¥å…³è¡Œã€è·Ÿå•å®¢æœ
        </div>

        <!-- å°†åº•éƒ¨æŒ‰é’®ç§»åˆ°è¿™é‡Œï¼Œè¡¨æ ¼ä¹‹å‰ -->
        <div class="d-flex justify-content-center mb-3">
            <button type="button" class="btn btn-secondary me-3" id="resetBtn">
                <i class="fas fa-undo"></i> é‡ç½®
            </button>
            <button type="button" class="btn btn-primary" id="saveBtn">
                <i class="fas fa-save"></i> æ‰¹é‡ä¿å­˜
            </button>
        </div>

        <div id="spreadsheet-container" class="d-flex justify-content-start">
            <div id="spreadsheet" class="mx-0">
                <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">è¡¨æ ¼åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æˆåŠŸæç¤ºå¼¹çª— -->
<div id="successModal" class="custom-modal modal-success">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div class="modal-header">
            <i class="fas fa-check-circle"></i> æ“ä½œæˆåŠŸ
        </div>
        <div class="modal-body" id="successMessage"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-success close-modal">ç¡®å®š</button>
        </div>
    </div>
</div>

<!-- é”™è¯¯æç¤ºå¼¹çª— -->
<div id="errorModal" class="custom-modal modal-error">
    <div class="modal-content">
        <span class="modal-close">&times;</span>
        <div class="modal-header">
            <i class="fas fa-exclamation-circle"></i> æ“ä½œå¤±è´¥
        </div>
        <div class="modal-body" id="errorMessage"></div>
        <div class="modal-footer">
            <button type="button" class="btn btn-danger close-modal">ç¡®å®š</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- é¢„åŠ è½½æ‰€æœ‰å¿…è¦çš„åº“ï¼Œä½¿ç”¨æ¨¡å—åŒ–åŠ è½½ -->
<script>
    // å®šä¹‰åŠ è½½è„šæœ¬çš„é€šç”¨å‡½æ•°
    function loadScript(url) {
        return new Promise((resolve, reject) => {
            console.log(`å¼€å§‹åŠ è½½åº“: ${url}`);
            const script = document.createElement('script');
            script.src = url;
            script.async = false; // ç¡®ä¿æŒ‰é¡ºåºåŠ è½½
            script.onload = () => {
                console.log(`åº“åŠ è½½æˆåŠŸ: ${url}`);
                resolve();
            };
            script.onerror = (e) => {
                console.error(`åº“åŠ è½½å¤±è´¥: ${url}`, e);
                reject(new Error(`åŠ è½½å¤±è´¥: ${url}`));
            };
            document.head.appendChild(script);
        });
    }

    // å®šä¹‰æ‰€æœ‰éœ€è¦çš„åº“
    const requiredLibraries = [
        { name: 'XLSX', url: '{{ url_for("static", filename="vendor/js/xlsx.full.min.js") }}' },
        { name: 'jSuites', url: '{{ url_for("static", filename="vendor/js/jsuites.js") }}' },
        { name: 'jspreadsheet', url: '{{ url_for("static", filename="vendor/js/jexcel.js") }}' }
    ];

    // æŒ‰é¡ºåºåŠ è½½æ‰€æœ‰åº“
    window.addEventListener('DOMContentLoaded', function() {
        console.log('DOMå†…å®¹åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½å¿…è¦çš„åº“...');
        
        // æ£€æŸ¥å“ªäº›åº“éœ€è¦åŠ è½½
        const missingLibraries = requiredLibraries.filter(lib => {
            return typeof window[lib.name] === 'undefined';
        });
        
        if (missingLibraries.length > 0) {
            console.log('éœ€è¦åŠ è½½çš„åº“:', missingLibraries.map(lib => lib.name).join(', '));
            
            // æŒ‰é¡ºåºåŠ è½½ç¼ºå¤±çš„åº“
            missingLibraries.reduce((chain, lib) => {
                return chain.then(() => loadScript(lib.url));
            }, Promise.resolve())
            .then(() => {
                console.log('æ‰€æœ‰åº“åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–è¡¨æ ¼...');
                // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿åº“å·²å®Œå…¨åˆå§‹åŒ–
                setTimeout(() => {
                    setDefaultTime();
                    initSpreadsheet();
                }, 500);
            })
            .catch(error => {
                console.error('åº“åŠ è½½å¤±è´¥:', error);
                                    document.getElementById('spreadsheet').innerHTML = `
                        <div class="alert alert-danger p-2 m-1">
                            <i class="fas fa-exclamation-circle"></i> è¡¨æ ¼ç»„ä»¶åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•
                            <button class="btn btn-primary btn-sm ms-2" onclick="location.reload()">
                                <i class="fas fa-sync"></i> åˆ·æ–°é¡µé¢
                            </button>
                        </div>
                    `;
            });
        } else {
            console.log('æ‰€æœ‰åº“å·²é¢„å…ˆåŠ è½½');
            // è®¾ç½®é»˜è®¤å…¥åº“æ—¶é—´
            setDefaultTime();
            
            // å»¶è¿ŸåŠ è½½è¡¨æ ¼ï¼Œç»™ç”¨æˆ·æ›´å¥½çš„åŠ è½½ä½“éªŒ
            setTimeout(function() {
                try {
                    initSpreadsheet();
                } catch (error) {
                    console.error('è¡¨æ ¼åˆå§‹åŒ–å¤±è´¥:', error);
                    document.getElementById('spreadsheet').innerHTML = `
                        <div class="alert alert-danger p-2 m-1">
                            <i class="fas fa-exclamation-circle"></i> è¡¨æ ¼åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•
                            <button class="btn btn-primary btn-sm ms-2" onclick="location.reload()">
                                <i class="fas fa-sync"></i> åˆ·æ–°é¡µé¢
                            </button>
                        </div>
                    `;
                }
            }, 300);
        }
        
        // ä½¿ç”¨åŠ¨æ€å¯¼å…¥åŠ è½½Excelå¤„ç†åº“
        document.getElementById('importExcelBtn').addEventListener('click', function() {
            document.getElementById('fileUpload').click();
        });
        
        // ä¸‹è½½æ¨¡æ¿
        document.getElementById('downloadTemplateBtn').addEventListener('click', function() {
            downloadTemplate();
        });
    });

    // ç¡®ä¿XLSXåº“å·²åŠ è½½çš„è¾…åŠ©å‡½æ•°
    function ensureXLSXLoaded() {
        return new Promise((resolve, reject) => {
            if (typeof XLSX !== 'undefined') {
                resolve();
                return;
            }
            
            console.log('XLSXåº“å°šæœªåŠ è½½ï¼Œæ­£åœ¨åŠ è½½...');
            loadScript('{{ url_for("static", filename="vendor/js/xlsx.full.min.js") }}')
                .then(resolve)
                .catch(reject);
        });
    }
</script>

<!-- é™æ€æ ‡ç­¾åŠ è½½ä½œä¸ºåå¤‡æ–¹æ¡ˆ -->
<script src="{{ url_for('static', filename='vendor/js/xlsx.full.min.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/jsuites.js') }}"></script>
<script src="{{ url_for('static', filename='vendor/js/jexcel.js') }}"></script>

<!-- ç¡®ä¿åº“å…¨å±€å¯ç”¨ -->
<script>
    // å…¼å®¹æ€§ä¿®å¤ - ç¡®ä¿jexcelå’ŒjSuiteså…¨å±€å¯ç”¨
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof window.jspreadsheet === 'function' && typeof window.jexcel === 'undefined') {
            window.jexcel = window.jspreadsheet;
            console.log('jexcelå…¨å±€å…¼å®¹æ€§ä¿®å¤å·²åº”ç”¨');
        }
        
        if (typeof window.jsuites !== 'undefined' && typeof window.jSuites === 'undefined') {
            window.jSuites = window.jsuites;
            console.log('jSuiteså…¨å±€å…¼å®¹æ€§ä¿®å¤å·²åº”ç”¨');
        }
    });
</script>

<script>
    // è®¾ç½®é»˜è®¤æ—¶é—´
    function setDefaultTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const localDatetime = `${year}-${month}-${day}`;
        document.getElementById('defaultInboundTime').value = localDatetime;
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´
    function formatDatetime(date) {
        if (!date) return '';
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // åˆå§‹åŒ–è¡¨æ ¼
    function initSpreadsheet() {
        console.time('è¡¨æ ¼åˆå§‹åŒ–æ—¶é—´');
        
        try {
            // æ£€æŸ¥åº“æ˜¯å¦å·²åŠ è½½ï¼Œjexcelå¯èƒ½ä»¥jexcelæˆ–jspreadsheetå½¢å¼å­˜åœ¨
            const jexcelObj = window.jexcel || window.jspreadsheet;
            
            // jSuitesé¦–å­—æ¯å¤§å†™ä¿®æ­£
            if (typeof window.jSuites === 'undefined' && typeof window.jsuites !== 'undefined') {
                window.jSuites = window.jsuites;
            }
            
            if (typeof jexcelObj === 'undefined') {
                console.error('jexcelæ£€æµ‹:', {
                    jexcel: typeof window.jexcel,
                    jspreadsheet: typeof window.jspreadsheet,
                    jSuites: typeof window.jSuites,
                    jsuites: typeof window.jsuites
                });
                throw new Error('jexcelåº“æœªåŠ è½½');
            }
            
            // æ¸…é™¤åŠ è½½æŒ‡ç¤ºå™¨
            document.getElementById('spreadsheet').innerHTML = '';
            
            // åˆ—æ ‡é¢˜å®šä¹‰
            const headers = [
                'å…¥åº“æ—¶é—´ *',
                'å…¥åº“è½¦ç‰Œ *',
                'å®¢æˆ·åç§° *',
                'æ¿æ•° *',
                'ä»¶æ•° *',
                'é‡é‡(kg)',
                'ä½“ç§¯(mÂ³)',
                'å‡ºå¢ƒæ¨¡å¼ *',
                'è®¢å•ç±»å‹ *',
                'æŠ¥å…³è¡Œ *',
                'åº“ä½',
                'å•æ®',
                'è·Ÿå•å®¢æœ *'
            ];
            
            // è·å–ä¿å­˜çš„åˆ—å®½
            const columnWidths = getColumnWidths();
            
            // åˆ›å»ºåˆå§‹æ•°æ®ï¼ˆ10è¡Œï¼‰
            const initialData = createInitialData(10);
            
            console.log('å¼€å§‹åˆ›å»ºè¡¨æ ¼...');
            
            // ç¡®ä¿jexcelå¯¹è±¡å¯ç”¨
            const jexcelFn = window.jexcel || window.jspreadsheet;
            console.log('jexcelå¯¹è±¡ç±»å‹:', typeof jexcelFn);
            
            // è°ƒè¯•æ¯ä¸ªå¯èƒ½çš„æ–¹å¼
            console.log('jexcelå¯èƒ½æ€§æ£€æŸ¥:', {
                'window.jexcel': typeof window.jexcel, 
                'window.jspreadsheet': typeof window.jspreadsheet,
                'jexcel': typeof jexcel,
                'jspreadsheet': typeof jspreadsheet
            });
            
            if (typeof jexcelFn !== 'function') {
                throw new Error(`jexcelä¸æ˜¯å‡½æ•°: ${typeof jexcelFn}`);
            }
            
            // ç¡®ä¿jSuiteså¯ç”¨
            if (typeof window.jSuites === 'undefined' && typeof window.jsuites !== 'undefined') {
                window.jSuites = window.jsuites;
            }

            // åˆå§‹åŒ–è¡¨æ ¼
            const spreadsheet = jexcelFn(document.getElementById('spreadsheet'), {
                data: initialData,
                columns: [
                    { type: 'calendar', title: headers[0], width: columnWidths[0], align: 'center', options: { format: 'YYYY-MM-DD' } },
                    { type: 'text', title: headers[1], width: columnWidths[1], align: 'center' },
                    { type: 'text', title: headers[2], width: columnWidths[2], align: 'center' },
                    { type: 'numeric', title: headers[3], width: columnWidths[3], align: 'center' },
                    { type: 'numeric', title: headers[4], width: columnWidths[4], align: 'center' },
                    { type: 'numeric', title: headers[5], width: columnWidths[5], align: 'center' },
                    { type: 'numeric', title: headers[6], width: columnWidths[6], align: 'center' },
                    {
                        type: 'text',
                        title: headers[7],
                        width: columnWidths[7],
                        align: 'center'
                    },
                    {
                        type: 'text',
                        title: headers[8],
                        width: columnWidths[8] || 100,
                        align: 'center'
                    },
                    { type: 'text', title: headers[9], width: columnWidths[9], align: 'center' },
                    { type: 'text', title: headers[10], width: columnWidths[10], align: 'center' },
                    { type: 'text', title: headers[11], width: columnWidths[11], align: 'center' },
                    { type: 'text', title: headers[12], width: columnWidths[12] || 80, align: 'center' }
                ],
                minDimensions: [13, initialData.length],  // æ ¹æ®åˆå§‹æ•°æ®è¡Œæ•°è®¾ç½®æœ€å°è¡Œæ•°
                columnDrag: true,  // å¯ç”¨åˆ—æ‹–åŠ¨
                allowInsertRow: true,
                allowManualInsertRow: true,
                allowDeleteRow: true,
                columnResize: true, // å¯ç”¨åˆ—å®½è°ƒæ•´
                lazyLoading: false, // ç¦ç”¨å»¶è¿ŸåŠ è½½ï¼Œç¡®ä¿æ‰€æœ‰æ•°æ®ç«‹å³æ˜¾ç¤º
                tableOverflow: true, // å…è®¸è¡¨æ ¼æº¢å‡º
                tableHeight: "auto", // è¡¨æ ¼é«˜åº¦è‡ªåŠ¨è°ƒæ•´
                pagination: false,  // ç¦ç”¨åˆ†é¡µåŠŸèƒ½
                search: true, // å¯ç”¨æœç´¢åŠŸèƒ½
                oncolumnresize: function(el, column, width) {
                    // ä¿å­˜åˆ—å®½è®¾ç½®
                    saveColumnWidth(column, width);
                },
                // è®¾ç½®è¡¨æ ¼æ ·å¼
                style: {
                    // è¡¨å¤´å’Œå•å…ƒæ ¼å±…ä¸­
                    tableOverflow: true,
                    textAlign: 'center'
                }
            });

            console.log('è¡¨æ ¼åˆ›å»ºæˆåŠŸ');

            // æ·»åŠ è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŠŸèƒ½
            setTimeout(() => {
                console.log('æ·»åŠ è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŠŸèƒ½...');
                addCustomDropdowns();
            }, 1000);

            // æ·»åŠ å³é”®èœå•
            spreadsheet.contextMenu = function(obj, x, y, e) {
                const items = [];

                items.push({
                    title: 'æ’å…¥è¡Œ',
                    onclick: function() {
                        spreadsheet.insertRow(1, parseInt(y));
                    }
                });

                items.push({
                    title: 'åˆ é™¤è¡Œ',
                    onclick: function() {
                        spreadsheet.deleteRow(y);
                    }
                });

                return items;
            }

            console.timeEnd('è¡¨æ ¼åˆå§‹åŒ–æ—¶é—´');
            console.log('è¡¨æ ¼åˆå§‹åŒ–å®Œæˆ');
            
            // å…¨å±€ä¿å­˜è¡¨æ ¼å¯¹è±¡
            window.spreadsheet = spreadsheet;
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // æ˜¾ç¤ºåˆ—å®½æ‹–åŠ¨å¼•å¯¼
            showResizeGuide();
            
            return spreadsheet;
        } catch (error) {
            console.error('è¡¨æ ¼åˆå§‹åŒ–å¤±è´¥:', error);
            throw error; // å‘ä¸ŠæŠ›å‡ºé”™è¯¯ï¼Œè®©è°ƒç”¨è€…å¤„ç†
        }
    }

    // æ·»åŠ è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŠŸèƒ½
    function addCustomDropdowns() {
        if (!window.spreadsheet) {
            console.log('è¡¨æ ¼å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•æ·»åŠ ä¸‹æ‹‰æ¡†');
            return;
        }

        try {
            console.log('å¼€å§‹æ·»åŠ è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†...');

            // è·å–è¡¨æ ¼å®¹å™¨
            const table = document.querySelector('#spreadsheet table');
            if (!table) {
                console.log('æœªæ‰¾åˆ°è¡¨æ ¼å…ƒç´ ');
                return;
            }

            // æ ¹æ®ä»“åº“ç±»å‹è®¾ç½®ä¸‹æ‹‰æ¡†é€‰é¡¹
            const warehouseType = '{{ warehouse_type }}';
            let exportModeOptions = [];
            let orderTypeOptions = [];

            if (warehouseType === 'frontend') {
                // å‰ç«¯ä»“éœ€è¦å‡ºå¢ƒæ¨¡å¼å’Œè®¢å•ç±»å‹é€‰é¡¹
                exportModeOptions = ['ä¿ç¨', 'æ¸…å…³'];
                orderTypeOptions = ['åŸè½¦å‡ºå¢ƒ', 'æ¢è½¦å‡ºå¢ƒ', 'é›¶æ‹…', 'TPè®¢å•'];
            } else if (warehouseType === 'backend') {
                // åç«¯ä»“ä¹Ÿéœ€è¦å‡ºå¢ƒæ¨¡å¼å’Œè®¢å•ç±»å‹é€‰é¡¹
                exportModeOptions = ['ä¿ç¨', 'æ¸…å…³'];
                orderTypeOptions = ['åŸè½¦å‡ºå¢ƒ', 'æ¢è½¦å‡ºå¢ƒ', 'é›¶æ‹…', 'TPè®¢å•'];
            } else {
                // é»˜è®¤æƒ…å†µï¼ˆå…¼å®¹æ€§ï¼‰
                exportModeOptions = ['ä¿ç¨', 'æ¸…å…³'];
                orderTypeOptions = ['åŸè½¦å‡ºå¢ƒ', 'æ¢è½¦å‡ºå¢ƒ', 'é›¶æ‹…', 'TPè®¢å•'];
            }

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            table.addEventListener('click', function(e) {
                const cell = e.target.closest('td');
                if (!cell) return;

                const row = cell.parentNode.rowIndex - 1; // å‡å»è¡¨å¤´è¡Œ
                const col = cell.cellIndex;

                // é€šè¿‡è¡¨å¤´æ–‡æœ¬è¯†åˆ«åˆ—ç±»å‹
                const headerRow = table.querySelector('thead tr') || table.querySelector('tr');
                const headerCell = headerRow ? headerRow.cells[col] : null;
                const headerText = headerCell ? headerCell.textContent.trim() : '';

                console.log(`ç‚¹å‡»äº†ç¬¬${row}è¡Œç¬¬${col}åˆ—ï¼Œè¡¨å¤´: "${headerText}"`);

                // è·å–å½“å‰å•å…ƒæ ¼çš„å€¼
                const currentValue = window.spreadsheet.getValue(col, row);
                console.log(`å½“å‰å•å…ƒæ ¼å€¼: "${currentValue}"`);

                // è·å–æ‰€æœ‰è¡¨å¤´
                const allHeaders = window.spreadsheet.getHeaders();
                console.log(`æ‰€æœ‰è¡¨å¤´:`, allHeaders);
                console.log(`ç¬¬${col}åˆ—å¯¹åº”è¡¨å¤´: "${allHeaders[col]}"`);

                // æ£€æŸ¥åˆ—ç´¢å¼•æ˜¯å¦åŒ¹é…
                if (headerText !== allHeaders[col]) {
                    console.error(`âš ï¸ åˆ—ç´¢å¼•ä¸åŒ¹é…ï¼ç‚¹å‡»çš„è¡¨å¤´"${headerText}" != ç¬¬${col}åˆ—è¡¨å¤´"${allHeaders[col]}"`);
                }

                // æ ¹æ®å®é™…ç‚¹å‡»çš„è¡¨å¤´æ–‡æœ¬æ¥ç¡®å®šæ­£ç¡®çš„åˆ—ç´¢å¼•
                // jExcelè¡¨æ ¼æœ‰è¡Œå·åˆ—ï¼Œæ‰€ä»¥å®é™…æ•°æ®åˆ—ä»ç´¢å¼•0å¼€å§‹ï¼Œä½†DOMè¡¨å¤´åŒ…å«è¡Œå·åˆ—
                let actualCol = col;
                if (headerText.includes('å‡ºå¢ƒæ¨¡å¼')) {
                    actualCol = 7; // å‡ºå¢ƒæ¨¡å¼åº”è¯¥åœ¨ç¬¬7åˆ—ï¼ˆç´¢å¼•7ï¼‰
                } else if (headerText.includes('è®¢å•ç±»å‹')) {
                    actualCol = 8; // è®¢å•ç±»å‹åº”è¯¥åœ¨ç¬¬8åˆ—ï¼ˆç´¢å¼•8ï¼‰
                } else if (headerText.includes('æŠ¥å…³è¡Œ')) {
                    actualCol = 9; // æŠ¥å…³è¡Œåº”è¯¥åœ¨ç¬¬9åˆ—ï¼ˆç´¢å¼•9ï¼‰
                }

                console.log(`ğŸ”§ ä¿®æ­£åˆ—ç´¢å¼•: åŸå§‹${col} -> å®é™…${actualCol}`);

                // æ ¹æ®è¡¨å¤´æ–‡æœ¬åˆ¤æ–­æ˜¯å¦æ˜¯ä¸‹æ‹‰æ¡†åˆ—
                let options = null;
                let columnName = '';

                if (headerText.includes('å‡ºå¢ƒæ¨¡å¼')) {
                    options = exportModeOptions;
                    columnName = 'å‡ºå¢ƒæ¨¡å¼';
                } else if (headerText.includes('è®¢å•ç±»å‹')) {
                    options = orderTypeOptions;
                    columnName = 'è®¢å•ç±»å‹';
                }

                // åªæœ‰å½“é€‰é¡¹ä¸ä¸ºç©ºæ—¶æ‰æ˜¾ç¤ºä¸‹æ‹‰æ¡†
                if (options && options.length > 0) {
                    console.log(`æ˜¾ç¤º${columnName}ä¸‹æ‹‰æ¡†ï¼Œé€‰é¡¹:`, options);
                    showDropdownMenu(cell, options, row, actualCol); // ä½¿ç”¨ä¿®æ­£åçš„åˆ—ç´¢å¼•
                } else if (options && options.length === 0) {
                    console.log(`${columnName}åœ¨å½“å‰ä»“åº“ç±»å‹(${warehouseType})ä¸‹ä¸å¯ç”¨`);
                }
            });

            console.log('è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†åŠŸèƒ½æ·»åŠ å®Œæˆ');

        } catch (error) {
            console.error('æ·»åŠ è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ—¶å‡ºé”™:', error);
        }
    }

    // æ˜¾ç¤ºä¸‹æ‹‰èœå•
    function showDropdownMenu(cell, options, row, col) {
        // ç§»é™¤å·²å­˜åœ¨çš„ä¸‹æ‹‰èœå•
        const existingMenu = document.querySelector('.custom-dropdown-menu');
        if (existingMenu) {
            existingMenu.remove();
        }

        // åˆ›å»ºä¸‹æ‹‰èœå•
        const menu = document.createElement('div');
        menu.className = 'custom-dropdown-menu';
        menu.style.cssText = `
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 120px;
            max-height: 200px;
            overflow-y: auto;
        `;

        // æ·»åŠ é€‰é¡¹
        options.forEach(option => {
            const item = document.createElement('div');
            item.textContent = option;
            item.style.cssText = `
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
            `;

            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f5f5f5';
            });

            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'white';
            });

            item.addEventListener('click', function() {
                console.log(`ğŸ”§ è®¾ç½®å•å…ƒæ ¼å€¼: ç¬¬${row}è¡Œç¬¬${col}åˆ— = "${option}"`);

                // æ£€æŸ¥è¡Œå·æ˜¯å¦æœ‰æ•ˆ
                if (row < 0) {
                    console.error(`âŒ æ— æ•ˆçš„è¡Œå·: ${row}ï¼Œæ— æ³•è®¾ç½®å•å…ƒæ ¼å€¼`);
                    hideDropdownMenu();
                    return;
                }

                // è®¾ç½®å•å…ƒæ ¼å€¼ - ä½¿ç”¨å¤šç§æ–¹å¼ç¡®ä¿è®¾ç½®æˆåŠŸ
                let setSuccess = false;

                if (window.spreadsheet && window.spreadsheet.setValueFromCoords) {
                    try {
                        window.spreadsheet.setValueFromCoords(col, row, option);
                        console.log(`âœ… ä½¿ç”¨setValueFromCoordsè®¾ç½®æˆåŠŸ`);
                        setSuccess = true;
                    } catch (error) {
                        console.error(`âŒ setValueFromCoordså¤±è´¥:`, error);
                    }
                }

                // å¦‚æœsetValueFromCoordså¤±è´¥ï¼Œå°è¯•ç›´æ¥ä¿®æ”¹æ•°æ®
                if (!setSuccess && window.spreadsheet && window.spreadsheet.getData) {
                    try {
                        const data = window.spreadsheet.getData();
                        if (data[row] && data[row][col] !== undefined) {
                            data[row][col] = option;
                            window.spreadsheet.setData(data);
                            console.log(`âœ… ä½¿ç”¨setDataè®¾ç½®æˆåŠŸ`);
                            setSuccess = true;
                        }
                    } catch (error) {
                        console.error(`âŒ setDataå¤±è´¥:`, error);
                    }
                }

                // æœ€åé™çº§åˆ°ç›´æ¥ä¿®æ”¹DOM
                if (!setSuccess) {
                    cell.textContent = option;
                    console.log(`âœ… é™çº§ä½¿ç”¨textContentè®¾ç½®`);
                }

                // éªŒè¯è®¾ç½®ç»“æœ
                setTimeout(() => {
                    try {
                        let actualValue = null;

                        // å°è¯•å¤šç§æ–¹å¼è·å–å€¼
                        if (window.spreadsheet && window.spreadsheet.getValue) {
                            actualValue = window.spreadsheet.getValue(col, row);
                        }

                        if (actualValue === null && window.spreadsheet && window.spreadsheet.getData) {
                            const data = window.spreadsheet.getData();
                            if (data[row] && data[row][col] !== undefined) {
                                actualValue = data[row][col];
                            }
                        }

                        console.log(`ğŸ” éªŒè¯è®¾ç½®ç»“æœ: ç¬¬${row}è¡Œç¬¬${col}åˆ—å®é™…å€¼ = "${actualValue}"`);

                        if (actualValue !== option) {
                            console.error(`âŒ è®¾ç½®å¤±è´¥ï¼æœŸæœ›å€¼"${option}"ï¼Œå®é™…å€¼"${actualValue}"`);
                        } else {
                            console.log(`âœ… è®¾ç½®æˆåŠŸï¼å€¼ä¸º"${actualValue}"`);
                        }
                    } catch (error) {
                        console.error(`âŒ éªŒè¯è®¾ç½®ç»“æœæ—¶å‡ºé”™:`, error);
                    }
                }, 100);

                menu.remove();
            });

            menu.appendChild(item);
        });

        // å®šä½èœå•
        const rect = cell.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + window.scrollY) + 'px';

        document.body.appendChild(menu);

        // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 100);
    }

    // æ£€æŸ¥ä¸‹æ‹‰æ¡†åŠŸèƒ½æ˜¯å¦æ­£å¸¸
    function checkDropdownFunctionality() {
        if (!window.spreadsheet) {
            return false;
        }

        try {
            // æ£€æŸ¥è¡¨æ ¼é…ç½®ä¸­çš„ä¸‹æ‹‰æ¡†åˆ—
            const config = window.spreadsheet.getConfig();
            if (!config || !config.columns) {
                return false;
            }

            // æ£€æŸ¥ç¬¬7åˆ—ï¼ˆå‡ºå¢ƒæ¨¡å¼ï¼‰å’Œç¬¬8åˆ—ï¼ˆè®¢å•ç±»å‹ï¼‰æ˜¯å¦ä¸ºä¸‹æ‹‰æ¡†
            const exportModeColumn = config.columns[7];
            const orderTypeColumn = config.columns[8];

            const hasExportModeDropdown = exportModeColumn && exportModeColumn.type === 'dropdown' && exportModeColumn.source;
            const hasOrderTypeDropdown = orderTypeColumn && orderTypeColumn.type === 'dropdown' && orderTypeColumn.source;

            console.log('ä¸‹æ‹‰æ¡†æ£€æŸ¥ç»“æœ:', {
                exportModeColumn: hasExportModeDropdown,
                orderTypeColumn: hasOrderTypeDropdown,
                exportModeSource: exportModeColumn?.source,
                orderTypeSource: orderTypeColumn?.source
            });

            return hasExportModeDropdown && hasOrderTypeDropdown;
        } catch (error) {
            console.error('æ£€æŸ¥ä¸‹æ‹‰æ¡†åŠŸèƒ½æ—¶å‡ºé”™:', error);
            return false;
        }
    }

    // éªŒè¯å­—æ®µæ˜ å°„æ˜¯å¦æ­£ç¡®
    function validateFieldMapping() {
        if (!window.spreadsheet) {
            console.log('è¡¨æ ¼å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•éªŒè¯å­—æ®µæ˜ å°„');
            return false;
        }

        // å°è¯•å¤šç§æ–¹å¼è·å–è¡¨å¤´
        let headers = window.spreadsheet.getHeaders();
        console.log('getHeaders()è¿”å›:', headers);

        // å¦‚æœgetHeaders()æœ‰é—®é¢˜ï¼Œå°è¯•ä»DOMç›´æ¥è·å–
        if (!headers || headers.length !== 13) {
            console.log('getHeaders()ç»“æœå¼‚å¸¸ï¼Œå°è¯•ä»DOMè·å–è¡¨å¤´...');
            const headerRow = document.querySelector('#spreadsheet thead tr') || document.querySelector('#spreadsheet tr');
            if (headerRow) {
                const domHeaders = Array.from(headerRow.cells).map(cell => cell.textContent.trim());
                console.log('ä»DOMè·å–çš„è¡¨å¤´:', domHeaders);

                // DOMè¡¨å¤´åŒ…å«è¡Œå·åˆ—ï¼ˆç¬¬0åˆ—ä¸ºç©ºï¼‰ï¼Œæ‰€ä»¥å®é™…æ•°æ®åˆ—ä»ç´¢å¼•1å¼€å§‹
                headers = domHeaders.slice(1); // å»æ‰ç¬¬0åˆ—çš„è¡Œå·åˆ—
                console.log('å®é™…æ•°æ®è¡¨å¤´ï¼ˆå»æ‰è¡Œå·åˆ—ï¼‰:', headers);
            }
        }

        // æœŸæœ›çš„è¡¨å¤´é¡ºåº
        const expectedHeaders = [
            'å…¥åº“æ—¶é—´ *',
            'å…¥åº“è½¦ç‰Œ *',
            'å®¢æˆ·åç§° *',
            'æ¿æ•° *',
            'ä»¶æ•° *',
            'é‡é‡(kg)',
            'ä½“ç§¯(mÂ³)',
            'å‡ºå¢ƒæ¨¡å¼ *',
            'è®¢å•ç±»å‹ *',
            'æŠ¥å…³è¡Œ *',
            'åº“ä½',
            'å•æ®',
            'è·Ÿå•å®¢æœ *'
        ];

        // æ£€æŸ¥å­—æ®µé¡ºåº
        let mappingCorrect = true;
        for (let i = 0; i < expectedHeaders.length; i++) {
            if (headers[i] !== expectedHeaders[i]) {
                console.error(`å­—æ®µæ˜ å°„é”™è¯¯: ç¬¬${i}åˆ—æœŸæœ›"${expectedHeaders[i]}"ï¼Œå®é™…"${headers[i]}"`);
                mappingCorrect = false;
            }
        }

        if (mappingCorrect) {
            console.log('âœ… å­—æ®µæ˜ å°„éªŒè¯é€šè¿‡');
        } else {
            console.error('âŒ å­—æ®µæ˜ å°„éªŒè¯å¤±è´¥ï¼Œä½†ç¨‹åºä¼šä½¿ç”¨ç¡¬ç¼–ç çš„åˆ—ç´¢å¼•ä¿®æ­£');
            // å³ä½¿éªŒè¯å¤±è´¥ï¼Œæˆ‘ä»¬ä¹Ÿè¿”å›trueï¼Œå› ä¸ºæˆ‘ä»¬æœ‰ä¿®æ­£æœºåˆ¶
            mappingCorrect = true;
        }

        return mappingCorrect;
    }

    // ä¿®å¤ä¸‹æ‹‰æ¡†åŠŸèƒ½
    function fixDropdownColumns() {
        if (!window.spreadsheet) {
            console.log('è¡¨æ ¼å¯¹è±¡ä¸å­˜åœ¨ï¼Œæ— æ³•ä¿®å¤ä¸‹æ‹‰æ¡†');
            return;
        }

        try {
            console.log('å¼€å§‹ä¿®å¤ä¸‹æ‹‰æ¡†...');

            // é¦–å…ˆéªŒè¯å­—æ®µæ˜ å°„
            if (!validateFieldMapping()) {
                showCustomError('å­—æ®µæ˜ å°„é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }

            // é‡æ–°è®¾ç½®ä¸‹æ‹‰æ¡†åˆ—çš„é…ç½®ï¼ˆä½¿ç”¨å‰é¢å®šä¹‰çš„é€‰é¡¹ï¼‰
            // exportModeOptions å’Œ orderTypeOptions å·²åœ¨å‰é¢æ ¹æ®ä»“åº“ç±»å‹å®šä¹‰

            // æ–¹æ³•1: ä½¿ç”¨setDropdownæ–¹æ³•ï¼ˆåªæœ‰å½“é€‰é¡¹å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼‰
            try {
                if (typeof window.spreadsheet.setDropdown === 'function') {
                    if (exportModeOptions.length > 0) {
                        window.spreadsheet.setDropdown(7, exportModeOptions);
                    }
                    if (orderTypeOptions.length > 0) {
                        window.spreadsheet.setDropdown(8, orderTypeOptions);
                    }
                    console.log('ä½¿ç”¨setDropdownæ–¹æ³•ä¿®å¤æˆåŠŸ');
                }
            } catch (e) {
                console.log('setDropdownæ–¹æ³•å¤±è´¥:', e);
            }

            // æ–¹æ³•2: ç›´æ¥ä¿®æ”¹åˆ—é…ç½®ï¼ˆåªæœ‰å½“é€‰é¡¹å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼‰
            try {
                const config = window.spreadsheet.getConfig();
                if (config && config.columns) {
                    if (config.columns[7] && exportModeOptions.length > 0) {
                        config.columns[7].type = 'dropdown';
                        config.columns[7].source = exportModeOptions;
                        config.columns[7].autocomplete = true;
                    }
                    if (config.columns[8] && orderTypeOptions.length > 0) {
                        config.columns[8].type = 'dropdown';
                        config.columns[8].source = orderTypeOptions;
                        config.columns[8].autocomplete = true;
                    }
                    console.log('ç›´æ¥ä¿®æ”¹åˆ—é…ç½®æˆåŠŸ');
                }
            } catch (e) {
                console.log('ç›´æ¥ä¿®æ”¹åˆ—é…ç½®å¤±è´¥:', e);
            }

            // æ–¹æ³•3: é‡æ–°æ¸²æŸ“è¡¨æ ¼
            try {
                if (typeof window.spreadsheet.refresh === 'function') {
                    window.spreadsheet.refresh();
                    console.log('è¡¨æ ¼åˆ·æ–°æˆåŠŸ');
                }
            } catch (e) {
                console.log('è¡¨æ ¼åˆ·æ–°å¤±è´¥:', e);
            }

            console.log('ä¸‹æ‹‰æ¡†ä¿®å¤å®Œæˆ');

            // éšè—ä¿®å¤æŒ‰é’®
            document.getElementById('fixDropdownBtn').style.display = 'none';

        } catch (error) {
            console.error('ä¿®å¤ä¸‹æ‹‰æ¡†æ—¶å‡ºé”™:', error);
        }
    }

    // åˆ›å»ºåˆå§‹æ•°æ®
    function createInitialData(rows) {
        // é»˜è®¤æ˜¾ç¤º10è¡Œ
        rows = rows || 10;
        const data = [];
        const now = new Date();
        const formattedTime = formatDatetime(now);

        for (let i = 0; i < rows; i++) {
            // åªç»™ç¬¬ä¸€è¡Œå¡«å……é»˜è®¤æ—¶é—´ï¼Œå…¶ä»–è¡Œä¿æŒç©ºç™½
            if (i === 0) {
                data.push([formattedTime, '', '', '', '', '', '', '', '', '', '', '', '']);
            } else {
                data.push(['', '', '', '', '', '', '', '', '', '', '', '', '']);
            }
        }

        return data;
    }
    
    // è·å–é»˜è®¤åˆ—å®½è®¾ç½®
    function getDefaultColumnWidths() {
        return [
            130, // å…¥åº“æ—¶é—´
            90,  // å…¥åº“è½¦ç‰Œ
            120, // å®¢æˆ·åç§°
            70,  // æ¿æ•°
            70,  // ä»¶æ•°
            80,  // é‡é‡
            80,  // ä½“ç§¯
            80,  // å‡ºå¢ƒæ¨¡å¼
            100, // è®¢å•ç±»å‹
            80,  // æŠ¥å…³è¡Œ
            80,  // åº“ä½
            80,  // å•æ®
            80   // è·Ÿå•å®¢æœ
        ];
    }
    
    // è·å–ä¿å­˜çš„åˆ—å®½æˆ–é»˜è®¤åˆ—å®½
    function getColumnWidths() {
        const savedWidths = localStorage.getItem('inbound_column_widths');
        if (savedWidths) {
            try {
                return JSON.parse(savedWidths);
            } catch (e) {
                console.error('Error parsing saved column widths', e);
            }
        }
        
        return getDefaultColumnWidths();
    }
    
    // ä¿å­˜å•ä¸ªåˆ—å®½è®¾ç½®
    function saveColumnWidth(column, width) {
        const columnWidths = getColumnWidths();
        columnWidths[column] = width;
        localStorage.setItem('inbound_column_widths', JSON.stringify(columnWidths));
        console.log('åˆ—å®½å·²ä¿å­˜:', column, width);
        showCustomSuccess('åˆ—å®½å·²è‡ªåŠ¨ä¿å­˜');
    }
    
    // æ˜¾ç¤ºå¼•å¯¼æç¤º
    function showResizeGuide() {
        if (localStorage.getItem('resize_guide_shown')) {
            return;
        }
        
        const guide = document.createElement('div');
        guide.className = 'resize-guide';
        guide.innerHTML = '<strong>æç¤º</strong>: é¼ æ ‡æ”¾åœ¨è¡¨å¤´è¾¹ç¼˜ï¼Œå¯ä»¥æ‹–åŠ¨è°ƒæ•´åˆ—å®½<br><i class="fas fa-arrows-alt-h"></i>';
        document.body.appendChild(guide);
        
        setTimeout(function() {
            if (guide.parentNode) {
                guide.style.opacity = '0';
                guide.style.transition = 'opacity 0.5s';
                
                setTimeout(function() {
                    if (guide.parentNode) {
                        guide.parentNode.removeChild(guide);
                    }
                }, 500);
            }
        }, 5000);
        
        localStorage.setItem('resize_guide_shown', 'true');
    }
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // æ·»åŠ è¡ŒæŒ‰é’®
        document.getElementById('addRowBtn').addEventListener('click', function() {
            window.spreadsheet.insertRow(1);
            const newRowIndex = 0; // åœ¨é¡¶éƒ¨æ’å…¥
            window.spreadsheet.setValueFromCoords(0, newRowIndex, formatDatetime(new Date()));
        });
        
        // åˆ é™¤é€‰ä¸­è¡ŒæŒ‰é’®
        document.getElementById('removeRowBtn').addEventListener('click', function() {
            const selectedRows = window.spreadsheet.getSelectedRows();
            if (selectedRows.length === 0) {
                showCustomError('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„è¡Œ');
                return;
            }
            
            // æŒ‰ç…§è¡Œç´¢å¼•ä»å¤§åˆ°å°æ’åºï¼Œè¿™æ ·åˆ é™¤æ—¶ä¸ä¼šå½±å“å…¶ä»–è¡Œçš„ç´¢å¼•
            const indices = selectedRows.map(row => parseInt(row)).sort((a, b) => b - a);
            
            // åˆ é™¤é€‰ä¸­çš„è¡Œ
            indices.forEach(index => {
                window.spreadsheet.deleteRow(index);
            });
            
            showCustomSuccess(`å·²åˆ é™¤ ${indices.length} è¡Œæ•°æ®`);
        });
        
        // æ¸…ç©ºæ•°æ®æŒ‰é’®
        document.getElementById('clearDataBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                const initialData = [[formatDatetime(new Date()), '', '', '', '', '', '', '', '', '', '', '']];
                window.spreadsheet.setData(initialData);
                showCustomSuccess('å·²æ¸…ç©ºæ‰€æœ‰æ•°æ®');
            }
        });

        // ä¿®å¤ä¸‹æ‹‰æ¡†æŒ‰é’®
        document.getElementById('fixDropdownBtn').addEventListener('click', function() {
            fixDropdownColumns();
            showCustomSuccess('ä¸‹æ‹‰æ¡†ä¿®å¤å®Œæˆ');
        });

        // éªŒè¯å­—æ®µæ˜ å°„æŒ‰é’®
        document.getElementById('validateMappingBtn').addEventListener('click', function() {
            if (validateFieldMapping()) {
                showCustomSuccess('å­—æ®µæ˜ å°„éªŒè¯é€šè¿‡ï¼');
            } else {
                showCustomError('å­—æ®µæ˜ å°„éªŒè¯å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });
        
        // é‡ç½®æŒ‰é’®
        document.getElementById('resetBtn').addEventListener('click', function() {
            if (confirm('ç¡®å®šè¦é‡ç½®è¡¨æ ¼å—ï¼Ÿæ‰€æœ‰æœªä¿å­˜çš„æ•°æ®å°†ä¸¢å¤±ã€‚')) {
                const initialData = createInitialData(10);
                window.spreadsheet.setData(initialData);
                showCustomSuccess('è¡¨æ ¼å·²é‡ç½®');
            }
        });
        
        // ä¿å­˜æŒ‰é’®
        document.getElementById('saveBtn').addEventListener('click', validateAndSaveData);
        
        // æ–‡ä»¶ä¸Šä¼ å¤„ç†
        document.getElementById('fileUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // é˜²æ­¢å¤šæ¬¡å¹¶å‘å¯¼å…¥ï¼Œä½†æä¾›å¼ºåˆ¶é‡ç½®é€‰é¡¹
            if (excelImportInProgress) {
                const shouldForceReset = confirm('å·²æœ‰ä¸€ä¸ªå¯¼å…¥æ“ä½œæ­£åœ¨è¿›è¡Œä¸­ã€‚æ˜¯å¦è¦å¼ºåˆ¶é‡ç½®å¹¶å¼€å§‹æ–°çš„å¯¼å…¥ï¼Ÿ\n\nç‚¹å‡»"ç¡®å®š"å¼ºåˆ¶é‡ç½®ï¼Œç‚¹å‡»"å–æ¶ˆ"ç­‰å¾…å½“å‰æ“ä½œå®Œæˆã€‚');
                if (shouldForceReset) {
                    console.log('ç”¨æˆ·é€‰æ‹©å¼ºåˆ¶é‡ç½®å¯¼å…¥çŠ¶æ€');
                    forceResetImportState();
                } else {
                    this.value = ''; // æ¸…é™¤æ–‡ä»¶è¾“å…¥
                    return;
                }
            }
            
            // è®¾ç½®å¯¼å…¥çŠ¶æ€
            excelImportInProgress = true;
            importOperationId = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            console.log(`å¼€å§‹å¯¼å…¥æ“ä½œ [ID: ${importOperationId}]`);

            // æ›´æ–°UIçŠ¶æ€
            updateImportUIState();

            // æ¸…é™¤æ¶ˆæ¯
            hideMessages();
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            const fileTypes = [
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'text/csv'
            ];
            
            if (!fileTypes.includes(file.type) &&
                !file.name.endsWith('.xlsx') &&
                !file.name.endsWith('.xls') &&
                !file.name.endsWith('.csv')) {
                showCustomError('è¯·ä¸Šä¼ Excelæ–‡ä»¶(.xlsx, .xls)æˆ–CSVæ–‡ä»¶(.csv)');
                forceResetImportState();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
            document.getElementById('spreadsheet').innerHTML = `
                <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">æ­£åœ¨è¯»å–æ–‡ä»¶ï¼Œè¯·ç¨å€™...</p>
                </div>
            `;
            // ç¡®ä¿å®¹å™¨æ˜¾ç¤º
            document.getElementById('spreadsheet').style.display = 'block';
            
            // è®¾ç½®å¤„ç†è¶…æ—¶å’Œç»å¯¹è¶…æ—¶å˜é‡
            let processingTimeout = null;
            let absoluteTimeout = null;

            // æ¸…é™¤æ‰€æœ‰è¶…æ—¶è®¡æ—¶å™¨çš„å‡½æ•°
            function clearAllTimeouts() {
                if (processingTimeout) {
                    clearTimeout(processingTimeout);
                    processingTimeout = null;
                }
                if (absoluteTimeout) {
                    clearTimeout(absoluteTimeout);
                    absoluteTimeout = null;
                }
            }

            // åœ¨è®¾ç½®è¶…æ—¶è®¡æ—¶å™¨å‰ï¼Œç¡®ä¿æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
            clearAllTimeouts();

            // è®¾ç½®å¤„ç†è¶…æ—¶
            processingTimeout = setTimeout(() => {
                showCustomError('å¤„ç†è¶…æ—¶ï¼Œè¯·å°è¯•ä½¿ç”¨è¾ƒå°çš„æ–‡ä»¶æˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                forceResetImportState();
            }, 5000); // 5ç§’è¶…æ—¶

            // è®¾ç½®ç»å¯¹è¶…æ—¶ï¼Œæ— è®ºå¦‚ä½•éƒ½ä¼šé‡ç½®è¡¨æ ¼
            absoluteTimeout = setTimeout(() => {
                // ç¡®ä¿åªæ¸…é™¤ä¸€æ¬¡
                if (processingTimeout) {
                    clearTimeout(processingTimeout);
                    processingTimeout = null;
                }
                console.error(`å¯¼å…¥å¤„ç†è¢«å¼ºåˆ¶ç»ˆæ­¢ - ç»å¯¹è¶…æ—¶ [ID: ${importOperationId}]`);
                showCustomError('å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå·²è‡ªåŠ¨ç»ˆæ­¢ã€‚è¯·å°è¯•ä½¿ç”¨è¾ƒå°çš„æ–‡ä»¶æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                forceResetImportState();
                // é¿å…åœ¨è¿™é‡Œè°ƒç”¨console.timeEndï¼Œå¯èƒ½ä¼šå¯¼è‡´é”™è¯¯
            }, 8000); // 8ç§’ç»å¯¹è¶…æ—¶
            
            try {
                // ç¡®ä¿XLSXåº“å·²åŠ è½½
                if (typeof XLSX === 'undefined') {
                    throw new Error('Excelå¤„ç†åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                }
                
                // ä½¿ç”¨FileReader APIè¯»å–æ–‡ä»¶ï¼Œä½†ä¸ä¼šé˜»å¡UI
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        console.time('excel-import');
                        const data = new Uint8Array(e.target.result);
                        
                        // æ›´æ–°çŠ¶æ€æç¤º
                        document.getElementById('spreadsheet').innerHTML = `
                            <div class="text-center my-3">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">æ­£åœ¨å¤„ç†Excelæ•°æ®...</p>
                            </div>
                        `;
                        // ç¡®ä¿å®¹å™¨æ˜¾ç¤º
                        document.getElementById('spreadsheet').style.display = 'block';
                        
                        // ç›´æ¥å¤„ç†Excelæ•°æ®ï¼Œé¿å…å¤šå±‚åµŒå¥—çš„requestAnimationFrame
                        console.log('å¼€å§‹è§£æExcelæ•°æ®...');
                        console.time('excel-parse');
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                        console.timeEnd('excel-parse');
                        console.log(`Excelè§£æå®Œæˆï¼Œå…± ${jsonData.length} è¡Œæ•°æ®`);
                        
                        // éªŒè¯æ•°æ®
                        if (!jsonData || jsonData.length <= 1) {
                            clearAllTimeouts();
                            showCustomError('å¯¼å…¥çš„æ–‡ä»¶æ²¡æœ‰æ•°æ®æˆ–åªæœ‰è¡¨å¤´');
                            excelImportInProgress = false;
                            importOperationId = null;
                            initSpreadsheet();
                            console.timeEnd('excel-import');
                            return;
                        }
                        
                        console.log('å¼€å§‹å¤„ç†æ•°æ®è¡Œ...');
                        console.time('data-processing');
                        const headers = jsonData[0];
                        const dataRows = [];
                        
                        // ä½¿ç”¨æ›´é«˜æ•ˆçš„æ•°æ®å¤„ç†æ–¹å¼
                        for (let i = 1; i < jsonData.length; i++) {
                            const row = jsonData[i];
                            // å¿«é€Ÿè·³è¿‡å®Œå…¨ç©ºè¡Œ
                            if (!row || row.length === 0) continue;
                            
                            // æ£€æŸ¥æ˜¯å¦æ˜¯ç©ºè¡Œï¼ˆæ‰€æœ‰å•å…ƒæ ¼ä¸ºç©ºï¼‰
                            let hasValue = false;
                            for (let j = 0; j < row.length; j++) {
                                if (row[j] != null && row[j] !== '') {
                                    hasValue = true;
                                    break;
                                }
                            }
                            if (!hasValue) continue;
                            
                            // ä½¿ç”¨æ•°ç»„ç›´æ¥åˆ›å»º
                            const processedRow = Array(13).fill('');
                            
                            // å¤„ç†æ—¥æœŸ (å…¥åº“æ—¶é—´) - ç®€åŒ–æ—¥æœŸå¤„ç†é€»è¾‘
                            if (row[0]) {
                                try {
                                    const dateValue = row[0];
                                    if (typeof dateValue === 'number') {
                                        // Excelæ•°å­—æ—¥æœŸè½¬æ¢ - ç®€åŒ–è®¡ç®—
                                        processedRow[0] = formatDatetime(new Date((dateValue - 25569) * 86400 * 1000));
                                    } else {
                                        // å°è¯•ä½œä¸ºæ—¥æœŸå­—ç¬¦ä¸²å¤„ç†
                                        processedRow[0] = formatDatetime(new Date(dateValue));
                                    }
                                } catch (e) {
                                    // æ—¥æœŸè§£æé”™è¯¯ï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
                                    processedRow[0] = formatDatetime(new Date());
                                }
                            } else {
                                // æ²¡æœ‰æ—¥æœŸï¼Œä½¿ç”¨å½“å‰æ—¥æœŸ
                                processedRow[0] = formatDatetime(new Date());
                            }
                            
                            // ç›´æ¥å¡«å……æ–‡æœ¬å­—æ®µ - æ›´ç®€æ´çš„æ–¹å¼
                            if (row[1]) processedRow[1] = String(row[1]); // å…¥åº“è½¦ç‰Œ
                            if (row[2]) processedRow[2] = String(row[2]); // å®¢æˆ·åç§°
                            if (row[7]) processedRow[7] = String(row[7]); // å‡ºå¢ƒæ¨¡å¼
                            if (row[8]) processedRow[8] = String(row[8]); // è®¢å•ç±»å‹
                            if (row[9]) processedRow[9] = String(row[9]); // æŠ¥å…³è¡Œ
                            if (row[10]) processedRow[10] = String(row[10]); // åº“ä½
                            if (row[11]) processedRow[11] = String(row[11]); // å•æ®
                            if (row[12]) processedRow[12] = String(row[12]); // è·Ÿå•å®¢æœ

                            // å¤„ç†æ•°å€¼å­—æ®µ - ç›´æ¥è½¬æ¢
                            for (let j = 3; j <= 6; j++) {
                                if (row[j] != null && row[j] !== '') {
                                    let numValue = row[j];
                                    if (typeof numValue === 'string') {
                                        // åªä¿ç•™æ•°å­—å’Œå°æ•°ç‚¹
                                        numValue = numValue.replace(/[^\d.-]/g, '');
                                    }
                                    processedRow[j] = numValue || '';
                                }
                            }
                            
                            // æ£€æŸ¥å¿…è¦æ•°æ® - ç›´æ¥æµ‹è¯•å­—æ®µ
                            if (processedRow[1] || processedRow[2]) {
                                dataRows.push(processedRow);
                            }
                        }
                        
                        console.timeEnd('data-processing');
                        console.log(`æ•°æ®å¤„ç†å®Œæˆï¼Œæœ‰æ•ˆæ•°æ® ${dataRows.length} è¡Œ`);
                        
                        // ç¡®ä¿è‡³å°‘æœ‰ä¸€è¡Œæœ‰æ•ˆæ•°æ®
                        if (dataRows.length === 0) {
                            clearAllTimeouts();
                            showCustomError('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆæ•°æ®è¡Œï¼Œè¯·ç¡®ä¿è‡³å°‘æœ‰è½¦ç‰Œå·æˆ–å®¢æˆ·åç§°');
                            excelImportInProgress = false;
                            importOperationId = null;
                            initSpreadsheet();
                            console.timeEnd('excel-import');
                            return;
                        }
                        
                                                    // åœ¨è¡¨æ ¼æ•°æ®è®¾ç½®å®Œæˆåï¼Œç¡®ä¿æ¸…é™¤æ‰€æœ‰è¶…æ—¶
                            try {
                                // æ¸…ç©ºè¡¨æ ¼åŒºåŸŸ
                                document.getElementById('spreadsheet').innerHTML = '';
                                
                                // æ¸…é™¤æ‰€æœ‰è¶…æ—¶è®¡æ—¶å™¨
                                clearAllTimeouts();
                                
                                // ç›´æ¥åˆ›å»ºæ–°è¡¨æ ¼
                                console.log('é‡æ–°åˆ›å»ºè¡¨æ ¼...');
                                initSpreadsheet();
                                
                                // å»¶è¿Ÿè®¾ç½®æ•°æ®ï¼Œç¡®ä¿è¡¨æ ¼å·²åˆ›å»ºå®Œæˆ
                                setTimeout(() => {
                                    if (window.spreadsheet) {
                                        console.log('è®¾ç½®è¡¨æ ¼æ•°æ®...');
                                        
                                        // ä½¿ç”¨å¤§æ•°æ®é›†å¤„ç†å‡½æ•°
                                        handleLargeDataset(dataRows).then(() => {
                                            console.log('æ•°æ®è®¾ç½®å®Œæˆï¼Œæ˜¾ç¤ºæˆåŠŸä¿¡æ¯');
                                            
                                            // ç¡®ä¿å¤„ç†çŠ¶æ€å·²é‡ç½®
                                            excelImportInProgress = false;
                                            importOperationId = null;

                                            // æ›´æ–°UIçŠ¶æ€
                                            updateImportUIState();

                                            // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
                                            showCustomSuccess(`æˆåŠŸå¯¼å…¥ ${dataRows.length} è¡Œæ•°æ®`);
                                            // å®‰å…¨åœ°ç»“æŸè®¡æ—¶
                                            try {
                                                console.timeEnd('excel-import');
                                            } catch (e) {
                                                // å¿½ç•¥è®¡æ—¶å™¨ä¸å­˜åœ¨é”™è¯¯
                                            }
                                        });
                                    } else {
                                        console.error('è¡¨æ ¼åˆ›å»ºå¤±è´¥');
                                        showCustomError('è¡¨æ ¼åˆ›å»ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
                                        excelImportInProgress = false;
                                        importOperationId = null;
                                        updateImportUIState();
                                        // å®‰å…¨åœ°ç»“æŸè®¡æ—¶
                                        try {
                                            console.timeEnd('excel-import');
                                        } catch (e) {
                                            // å¿½ç•¥è®¡æ—¶å™¨ä¸å­˜åœ¨é”™è¯¯
                                        }
                                    }
                                }, 500);
                        } catch (error) {
                            console.error('è®¾ç½®è¡¨æ ¼æ•°æ®å‡ºé”™:', error);
                            // æ¸…é™¤è¶…æ—¶
                            clearAllTimeouts();
                            
                            excelImportInProgress = false;
                            importOperationId = null;
                            initSpreadsheet();
                            showCustomError('å¤„ç†æ•°æ®æ—¶å‡ºé”™: ' + error.message);
                            // å®‰å…¨åœ°ç»“æŸè®¡æ—¶
                            try {
                                console.timeEnd('excel-import');
                            } catch (e) {
                                // å¿½ç•¥è®¡æ—¶å™¨ä¸å­˜åœ¨é”™è¯¯
                            }
                        }
                    } catch (error) {
                        clearAllTimeouts();
                        console.error('Excelå¤„ç†é”™è¯¯:', error);
                        showCustomError('å¤„ç†Excelæ•°æ®æ—¶å‡ºé”™: ' + error.message);
                        excelImportInProgress = false;
                        importOperationId = null;
                        initSpreadsheet();
                        console.timeEnd('excel-import');
                    }
                };
                
                reader.onerror = function() {
                    clearAllTimeouts();
                    showCustomError('è¯»å–æ–‡ä»¶æ—¶å‡ºé”™');
                    excelImportInProgress = false;
                    importOperationId = null;
                    initSpreadsheet();
                };
                
                // å¼€å§‹è¯»å–æ–‡ä»¶
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                clearAllTimeouts();
                console.error('Excelå¯¼å…¥é”™è¯¯:', error);
                showCustomError('Excelå¯¼å…¥é”™è¯¯: ' + error.message);
                excelImportInProgress = false;
                importOperationId = null;
                initSpreadsheet();
            } finally {
                // æ¸…é™¤æ–‡ä»¶è¾“å…¥ï¼Œå…è®¸é‡æ–°é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
                this.value = '';
            }
        });
        
        // å¼¹çª—å…³é—­æŒ‰é’®
        document.querySelectorAll('.modal-close, .close-modal').forEach(function(element) {
            element.addEventListener('click', function() {
                hideMessages();
            });
        });
    }
    
            // éªŒè¯å¹¶ä¿å­˜æ•°æ®
    function validateAndSaveData() {
        // éªŒè¯å­—æ®µæ˜ å°„
        if (!validateFieldMapping()) {
            showCustomError('å­—æ®µæ˜ å°„é”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }

        // è·å–è¡¨æ ¼æ•°æ®
        const data = window.spreadsheet.getData();
        
        // è¿‡æ»¤æ‰ç©ºè¡Œ
        const validRows = data.filter(row => {
            return row.some(cell => cell !== null && cell !== undefined && cell !== '');
        });
        
        if (validRows.length === 0) {
            showCustomError('æ²¡æœ‰æ•°æ®å¯ä¿å­˜');
            return;
        }
        
        // éªŒè¯å¿…å¡«å­—æ®µ
        const invalidRows = [];
        validRows.forEach((row, index) => {
            // éªŒè¯å…¥åº“æ—¶é—´ã€å…¥åº“è½¦ç‰Œã€å®¢æˆ·åç§°å¿…å¡«
            if (!row[0] || !row[1] || !row[2]) {
                invalidRows.push({
                    row: index + 1,
                    message: 'å…¥åº“æ—¶é—´ã€å…¥åº“è½¦ç‰Œã€å®¢æˆ·åç§°ä¸ºå¿…å¡«é¡¹'
                });
                return;
            }
            
            // éªŒè¯æ¿æ•°å’Œä»¶æ•°è‡³å°‘å¡«ä¸€é¡¹ï¼Œå¹¶ä¸”å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—
            const palletCount = row[3];
            const packageCount = row[4];
            
            const isPalletValid = palletCount !== null && palletCount !== undefined && palletCount !== '' && !isNaN(Number(palletCount));
            const isPackageValid = packageCount !== null && packageCount !== undefined && packageCount !== '' && !isNaN(Number(packageCount));
            
            if (!isPalletValid && !isPackageValid) {
                invalidRows.push({
                    row: index + 1,
                    message: 'æ¿æ•°å’Œä»¶æ•°è‡³å°‘å¡«å†™ä¸€é¡¹ï¼Œä¸”å¿…é¡»æ˜¯æœ‰æ•ˆæ•°å­—'
                });
                return;
            }
            
            // éªŒè¯å‡ºå¢ƒæ¨¡å¼å¿…å¡«
            if (!row[7]) {
                invalidRows.push({
                    row: index + 1,
                    message: 'å‡ºå¢ƒæ¨¡å¼ä¸ºå¿…å¡«é¡¹'
                });
                return;
            }

            // éªŒè¯è®¢å•ç±»å‹å¿…å¡«
            if (!row[8]) {
                invalidRows.push({
                    row: index + 1,
                    message: 'è®¢å•ç±»å‹ä¸ºå¿…å¡«é¡¹'
                });
                return;
            }

            // éªŒè¯æŠ¥å…³è¡Œå¿…å¡«
            if (!row[9]) {
                invalidRows.push({
                    row: index + 1,
                    message: 'æŠ¥å…³è¡Œä¸ºå¿…å¡«é¡¹'
                });
                return;
            }

            // éªŒè¯è·Ÿå•å®¢æœå¿…å¡«
            if (!row[12]) {
                invalidRows.push({
                    row: index + 1,
                    message: 'è·Ÿå•å®¢æœä¸ºå¿…å¡«é¡¹'
                });
                return;
            }
        });
        
        if (invalidRows.length > 0) {
            const messages = invalidRows.map(item => `ç¬¬ ${item.row} è¡Œ: ${item.message}`);
            showCustomError(`æ•°æ®éªŒè¯å¤±è´¥:\n${messages.join('\n')}`);
            return;
        }
        
        // å°†è¡¨æ ¼æ•°æ®è½¬æ¢ä¸ºAPIè¯·æ±‚æ ¼å¼
        const records = validRows.map(row => {
            // ç¡®ä¿æ•°å€¼å­—æ®µä¸ºæ•°å­—æˆ–0
            const palletCount = row[3] !== null && row[3] !== undefined && row[3] !== '' && !isNaN(Number(row[3])) ? 
                                Number(row[3]) : 0;
            const packageCount = row[4] !== null && row[4] !== undefined && row[4] !== '' && !isNaN(Number(row[4])) ? 
                                Number(row[4]) : 0;
            const weight = row[5] !== null && row[5] !== undefined && row[5] !== '' && !isNaN(Number(row[5])) ? 
                           Number(row[5]) : 0;
            const volume = row[6] !== null && row[6] !== undefined && row[6] !== '' && !isNaN(Number(row[6])) ? 
                           Number(row[6]) : 0;
            
            // å¤„ç†å…¥åº“æ—¶é—´æ ¼å¼ï¼Œç¡®ä¿æ˜¯YYYY-MM-DD HH:MM:SSæ ¼å¼
            let inboundTime = row[0];
            if (inboundTime && typeof inboundTime === 'string' && inboundTime.length <= 10) {
                // å¦‚æœåªæœ‰æ—¥æœŸéƒ¨åˆ†ï¼Œæ·»åŠ æ—¶é—´éƒ¨åˆ†
                inboundTime = inboundTime + ' 00:00:00';
            }

            // è°ƒè¯•è¾“å‡ºï¼šæ£€æŸ¥å­—æ®µæ˜ å°„å’Œå®é™…æ•°æ®
            console.log(`ç¬¬${validRows.indexOf(row) + 1}è¡Œæ•°æ®æ˜ å°„:`, {
                'å…¥åº“æ—¶é—´(row[0])': row[0],
                'å…¥åº“è½¦ç‰Œ(row[1])': row[1],
                'å®¢æˆ·åç§°(row[2])': row[2],
                'æ¿æ•°(row[3])': row[3],
                'ä»¶æ•°(row[4])': row[4],
                'é‡é‡(row[5])': row[5],
                'ä½“ç§¯(row[6])': row[6],
                'å‡ºå¢ƒæ¨¡å¼(row[7])': row[7],
                'è®¢å•ç±»å‹(row[8])': row[8],
                'æŠ¥å…³è¡Œ(row[9])': row[9],
                'åº“ä½(row[10])': row[10],
                'å•æ®(row[11])': row[11],
                'è·Ÿå•å®¢æœ(row[12])': row[12]
            });

            // é¢å¤–è°ƒè¯•ï¼šæ˜¾ç¤ºå®Œæ•´è¡Œæ•°æ®
            console.log(`ç¬¬${validRows.indexOf(row) + 1}è¡Œå®Œæ•´æ•°æ®:`, row);

            return {
                    inbound_time: inboundTime, // å…¥åº“æ—¶é—´ - row[0]
                    delivery_plate_number: '', // é€è´§å¹²çº¿è½¦ï¼ˆå‰ç«¯ä»“æ²¡æœ‰æ­¤å­—æ®µï¼‰
                    plate_number: row[1] || '', // å…¥åº“è½¦ç‰Œ - row[1]
                    customer_name: row[2] || '', // å®¢æˆ·åç§° - row[2]
                    pallet_count: palletCount, // æ¿æ•° - row[3]
                    package_count: packageCount, // ä»¶æ•° - row[4]
                    weight: weight, // é‡é‡ - row[5]
                    volume: volume, // ä½“ç§¯ - row[6]
                    export_mode: row[7] || '', // å‡ºå¢ƒæ¨¡å¼ - row[7]
                    order_type: row[8] || '', // è®¢å•ç±»å‹ - row[8]
                    customs_broker: row[9] || '', // æŠ¥å…³è¡Œ - row[9]
                    location: row[10] || '', // åº“ä½ - row[10]
                    documents: row[11] || '', // å•æ® - row[11]
                    service_staff: row[12] || '' // è·Ÿå•å®¢æœ - row[12]
                };
        });
        
        // æ˜¾ç¤ºä¿å­˜ä¸­æ¶ˆæ¯
        showCustomSuccess('æ•°æ®ä¿å­˜ä¸­ï¼Œè¯·ç¨å€™...');
        
        // è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        console.log('å‘é€åˆ°åç«¯çš„æ•°æ®:', JSON.stringify(records, null, 2));
        
        // å‘é€APIè¯·æ±‚åˆ°åç«¯
        sendSaveRequest(records);
    }
    
    // å‘é€ä¿å­˜è¯·æ±‚å‡½æ•°ï¼Œæ”¯æŒé‡è¯•
    function sendSaveRequest(data, retryCount = 0) {
        const maxRetries = 3;
        
        fetch('/api/inbound/batch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            // æ£€æŸ¥HTTPçŠ¶æ€ç 
            if (!response.ok) {
                console.error('HTTPé”™è¯¯:', response.status, response.statusText);
                // å¦‚æœæ˜¯500é”™è¯¯ï¼Œå¯èƒ½æ˜¯ä¸´æ—¶é—®é¢˜ï¼Œå°è¯•é‡è¯•
                if (response.status === 500 && retryCount < maxRetries) {
                    console.log(`å°è¯•ç¬¬${retryCount + 1}æ¬¡é‡è¯•...`);
                    setTimeout(() => {
                        sendSaveRequest(data, retryCount + 1);
                    }, 1000); // ç­‰å¾…1ç§’åé‡è¯•
                    return null;
                }
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // å¦‚æœæ˜¯nullï¼ˆæ­£åœ¨é‡è¯•ï¼‰ï¼Œç›´æ¥è¿”å›

            console.log('APIå“åº”æ•°æ®:', data);
            console.log('APIçŠ¶æ€:', data.status);

            if (data.status === 'success' || data.status === 'partial_success') {
                console.log('ä¿å­˜æˆåŠŸ:', data);

                // ç¡®ä¿éšè—é”™è¯¯å¼¹çª—
                hideCustomError();

                // ä½¿ç”¨å…¨å±€æ¶ˆæ¯ç³»ç»Ÿæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                if (typeof showSuccess === 'function') {
                    showSuccess(`${data.message}`);
                    console.log('ä½¿ç”¨å…¨å±€showSuccessæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯');
                } else {
                    showCustomSuccess(`${data.message}`);
                    console.log('ä½¿ç”¨è‡ªå®šä¹‰showCustomSuccessæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯');
                }
                
                // è§¦å‘ä¿å­˜å®Œæˆäº‹ä»¶
                const saveEvent = new CustomEvent('batch-save-complete', {
                    detail: { 
                        rowCount: data.success_count,
                        data: data
                    }
                });
                document.dispatchEvent(saveEvent);
                
                // æ·»åŠ æŸ¥çœ‹è®°å½•æŒ‰é’®
                const viewRecordsBtn = document.createElement('button');
                viewRecordsBtn.className = 'btn btn-info me-2';
                viewRecordsBtn.innerHTML = '<i class="fas fa-list"></i> æŸ¥çœ‹å…¥åº“è®°å½•';
                viewRecordsBtn.onclick = function() {
                    window.location.href = '/inbound/list';
                };
                
                // æ·»åŠ åˆ°æˆåŠŸæ¶ˆæ¯ä¸‹æ–¹
                const successModal = document.getElementById('successModal');
                const modalFooter = successModal.querySelector('.modal-footer');
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ äº†æŸ¥çœ‹è®°å½•æŒ‰é’®
                const existingBtn = modalFooter.querySelector('.btn-info');
                if (!existingBtn) {
                    // å°†æŸ¥çœ‹æŒ‰é’®æ·»åŠ åˆ°ç¡®å®šæŒ‰é’®ä¹‹å‰
                    const confirmBtn = modalFooter.querySelector('button');
                    modalFooter.insertBefore(viewRecordsBtn, confirmBtn);
                }
                
                // ä¿å­˜æˆåŠŸåï¼Œé‡ç½®ç•Œé¢
                setTimeout(function() {
                    // é‡ç½®è¡¨æ ¼æ•°æ®
                    const initialData = createInitialData(10);
                    window.spreadsheet.setData(initialData);
                    
                    // è®¾ç½®å½“å‰æ—¥æœŸä¸ºé»˜è®¤å€¼
                    setDefaultTime();
                }, 500);
            } else {
                console.error('ä¿å­˜å¤±è´¥:', data);

                // ç¡®ä¿éšè—æˆåŠŸå¼¹çª—
                hideCustomSuccess();

                let errorMessage = `ä¿å­˜å¤±è´¥: ${data.message}`;
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                if (data.errors && data.errors.length > 0) {
                    const errorDetails = data.errors.join('<br>');
                    
                    errorMessage += `<br><br>é”™è¯¯è¯¦æƒ…:<br>${errorDetails}`;
                    console.error('ä¿å­˜é”™è¯¯è¯¦æƒ…:', data.errors);
                }
                
                showCustomError(errorMessage, true);
            }
        })
        .catch(error => {
            console.error('ä¿å­˜æ•°æ®æ—¶å‡ºé”™:', error);
            
            // å¦‚æœæ˜¯ç½‘ç»œé”™è¯¯ï¼Œå°è¯•é‡è¯•
            if (retryCount < maxRetries) {
                console.log(`ç½‘ç»œé”™è¯¯ï¼Œå°è¯•ç¬¬${retryCount + 1}æ¬¡é‡è¯•...`);
                setTimeout(() => {
                    sendSaveRequest(data, retryCount + 1);
                }, 1000); // ç­‰å¾…1ç§’åé‡è¯•
                return;
            }
            
            showCustomError(`ä¿å­˜æ•°æ®æ—¶å‡ºé”™ï¼Œè¯·ç¨åé‡è¯•<br><br>é”™è¯¯ä¿¡æ¯: ${error.message}<br><br>å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚`, true);
        });
    }
    
    // ä¸‹è½½æ¨¡æ¿
    function downloadTemplate() {
        // ä½¿ç”¨åç«¯APIåˆ›å»ºExcelæ¨¡æ¿
        fetch('/api/export/inbound_template', {
            method: 'GET',
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('å¯¼å‡ºæ¨¡æ¿å¤±è´¥');
            }
            return response.blob();
        })
        .then(blob => {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = 'å…¥åº“æ•°æ®å¯¼å…¥æ¨¡æ¿.xlsx';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            console.log('æ¨¡æ¿å·²æˆåŠŸå¯¼å‡º');
            showCustomSuccess('æ¨¡æ¿å·²æˆåŠŸå¯¼å‡ºï¼Œè¯·åœ¨ä¸‹è½½æ–‡ä»¶å¤¹ä¸­æŸ¥çœ‹');
        })
        .catch(error => {
            console.error('å¯¼å‡ºæ¨¡æ¿æ—¶å‡ºé”™:', error);
            showCustomError('å¯¼å‡ºæ¨¡æ¿æ—¶å‡ºé”™: ' + error.message);
        });
    }
    
    // æ˜¾ç¤º/éšè—æ¶ˆæ¯å‡½æ•°
    function showCustomError(message, isHTML = false) {
        console.log('æ˜¾ç¤ºè‡ªå®šä¹‰é”™è¯¯æ¶ˆæ¯:', message);

        // ç¡®ä¿éšè—æˆåŠŸå¼¹çª—
        hideCustomSuccess();

        // ç¡®ä¿è¡¨æ ¼å·²æ¢å¤æ˜¾ç¤º
        const spreadsheetEl = document.getElementById('spreadsheet');
        if (spreadsheetEl) {
            spreadsheetEl.style.display = 'block';
        }

        const errorModal = document.getElementById('errorModal');
        const errorMessage = document.getElementById('errorMessage');

        if (isHTML) {
            errorMessage.innerHTML = message;
        } else {
            errorMessage.textContent = message;
        }

        // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜
        errorModal.offsetHeight;
        errorModal.style.display = 'flex';

        console.log('è‡ªå®šä¹‰é”™è¯¯å¼¹çª—å·²æ˜¾ç¤º');

        // ç¡®ä¿æ¨¡æ€æ¡†å¯è§
        setTimeout(() => {
            if (errorModal.style.display !== 'flex') {
                errorModal.style.display = 'flex';
                console.log('è‡ªå®šä¹‰é”™è¯¯å¼¹çª—é‡æ–°æ˜¾ç¤º');
            }
        }, 100);
    }

    function hideCustomError() {
        document.getElementById('errorModal').style.display = 'none';
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    function showCustomSuccess(message) {
        console.log('æ˜¾ç¤ºè‡ªå®šä¹‰æˆåŠŸæ¶ˆæ¯:', message);

        // ç¡®ä¿éšè—é”™è¯¯å¼¹çª—
        hideCustomError();

        // æ˜¾ç¤ºæˆåŠŸå¼¹çª—
        const successModal = document.getElementById('successModal');
        const successMessage = document.getElementById('successMessage');

        if (successMessage) {
            successMessage.textContent = message;
        }

        // å¼ºåˆ¶æµè§ˆå™¨é‡ç»˜
        if (successModal) {
            successModal.offsetHeight;
            successModal.style.display = 'flex';

            console.log('è‡ªå®šä¹‰æˆåŠŸå¼¹çª—å·²æ˜¾ç¤º');

            // ç¡®ä¿æ¨¡æ€æ¡†å¯è§
            setTimeout(() => {
                if (successModal.style.display !== 'flex') {
                    successModal.style.display = 'flex';
                    console.log('è‡ªå®šä¹‰æˆåŠŸå¼¹çª—é‡æ–°æ˜¾ç¤º');
                }
            }, 100);
        }
    }

    function hideCustomSuccess() {
        document.getElementById('successModal').style.display = 'none';
    }
    
    function hideMessages() {
        hideCustomError();
        hideCustomSuccess();
    }
</script>

<!-- åµŒå…¥refresh_script.htmlçš„å†…å®¹ -->
<script>
// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ
window.addEventListener('load', function() {
    // ç¬¬ä¸€æ¬¡åˆ·æ–°
    setTimeout(function() { 
        if(window.refreshSimpleTable) {
            console.log('æ­£åœ¨åˆ·æ–°è¡¨æ ¼...');
            window.refreshSimpleTable();
        }
    }, 500);
    
    // ç¬¬äºŒæ¬¡åˆ·æ–°ï¼Œç¡®ä¿è®¾ç½®è¢«åº”ç”¨
    setTimeout(function() {
        if(window.refreshSimpleTable) window.refreshSimpleTable();
    }, 1500);
});
</script>

<!-- ä¿®æ”¹å¼ºåˆ¶è®¾ç½®åˆ—å®½çš„è„šæœ¬ï¼Œå°†å®½åº¦ä»500pxæ”¹ä¸º200pxï¼Œå¹¶æ·»åŠ å¯¹è·Ÿå•å®¢æœåˆ—çš„å®½åº¦è®¾ç½® -->
<script>
// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ
window.addEventListener('load', function() {
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿è¡¨æ ¼å·²å®Œå…¨åŠ è½½
    setTimeout(function() {
        console.log('æ­£åœ¨å¼ºåˆ¶è®¾ç½®åˆ—å®½...');
        
        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†jexcel
        if (window.spreadsheet && typeof window.spreadsheet.setWidth === 'function') {
            // ä½¿ç”¨jexcelçš„APIè®¾ç½®åˆ—å®½
            window.spreadsheet.setWidth(1, 150); // å…¥åº“è½¦ç‰Œ
            window.spreadsheet.setWidth(2, 150); // å®¢æˆ·åç§°
            window.spreadsheet.setWidth(7, 100); // å‡ºå¢ƒæ¨¡å¼
            window.spreadsheet.setWidth(8, 100); // æŠ¥å…³è¡Œ
            window.spreadsheet.setWidth(9, 100); // åº“ä½
            window.spreadsheet.setWidth(10, 80); // å•æ®
            window.spreadsheet.setWidth(11, 80); // è·Ÿå•å®¢æœ
            console.log('å·²é€šè¿‡jexcel APIè®¾ç½®åˆ—å®½');
        } else if (document.querySelector('.simple-table')) {
            // å¦‚æœä½¿ç”¨SimpleTableï¼Œç›´æ¥æ“ä½œDOM
            const table = document.querySelector('.simple-table');
            
            // è®¾ç½®colgroupåˆ—å®½
            const cols = table.querySelectorAll('colgroup col');
            [1, 2].forEach(index => {
                if (cols[index]) {
                    cols[index].style.width = '150px';
                    cols[index].setAttribute('width', '150');
                }
            });
            
            [7, 8].forEach(index => {
                if (cols[index]) {
                    cols[index].style.width = '100px';
                    cols[index].setAttribute('width', '100');
                }
            });
            
            if (cols[9]) {
                cols[9].style.width = '100px';
                cols[9].setAttribute('width', '100');
            }
            
            if (cols[10]) {
                cols[10].style.width = '80px';
                cols[10].setAttribute('width', '80');
            }
            
            if (cols[11]) {
                cols[11].style.width = '80px';
                cols[11].setAttribute('width', '80');
            }
            
            // è®¾ç½®è¡¨å¤´åˆ—å®½
            const ths = table.querySelectorAll('th');
            [1, 2].forEach(index => {
                if (ths[index]) {
                    ths[index].style.width = '150px';
                    ths[index].style.minWidth = '150px';
                    ths[index].style.maxWidth = '150px';
                }
            });
            
            [7, 8].forEach(index => {
                if (ths[index]) {
                    ths[index].style.width = '100px';
                    ths[index].style.minWidth = '100px';
                    ths[index].style.maxWidth = '100px';
                }
            });
            
            if (ths[9]) {
                ths[9].style.width = '100px';
                ths[9].style.minWidth = '100px';
                ths[9].style.maxWidth = '100px';
            }
            
            if (ths[10]) {
                ths[10].style.width = '80px';
                ths[10].style.minWidth = '80px';
                ths[10].style.maxWidth = '80px';
            }
            
            if (ths[11]) {
                ths[11].style.width = '80px';
                ths[11].style.minWidth = '80px';
                ths[11].style.maxWidth = '80px';
            }
            
            // è®¾ç½®å•å…ƒæ ¼åˆ—å®½
            [1, 2].forEach(index => {
                const cells = table.querySelectorAll(`td[data-col="${index}"]`);
                cells.forEach(cell => {
                    cell.style.width = '150px';
                    cell.style.minWidth = '150px';
                    cell.style.maxWidth = '150px';
                });
            });
            
            [7, 8].forEach(index => {
                const cells = table.querySelectorAll(`td[data-col="${index}"]`);
                cells.forEach(cell => {
                    cell.style.width = '100px';
                    cell.style.minWidth = '100px';
                    cell.style.maxWidth = '100px';
                });
            });
            
            const locationCells = table.querySelectorAll(`td[data-col="9"]`);
            locationCells.forEach(cell => {
                cell.style.width = '100px';
                cell.style.minWidth = '100px';
                cell.style.maxWidth = '100px';
            });
            
            const documentCells = table.querySelectorAll(`td[data-col="10"]`);
            documentCells.forEach(cell => {
                cell.style.width = '80px';
                cell.style.minWidth = '80px';
                cell.style.maxWidth = '80px';
            });
            
            const customerServiceCells = table.querySelectorAll(`td[data-col="11"]`);
            customerServiceCells.forEach(cell => {
                cell.style.width = '80px';
                cell.style.minWidth = '80px';
                cell.style.maxWidth = '80px';
            });
            
            console.log('å·²é€šè¿‡DOMæ“ä½œè®¾ç½®åˆ—å®½');
        }
    }, 2000);
});
</script>

<!-- æ·»åŠ ä¸€ä¸ªè„šæœ¬ï¼Œä½¿æ‰€æœ‰å¸¦*å·çš„è¡¨å¤´æ–‡å­—æ˜¾ç¤ºä¸ºçº¢è‰² -->
<script>
// ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½åæ‰§è¡Œ
window.addEventListener('load', function() {
    // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿è¡¨æ ¼å·²å®Œå…¨åŠ è½½
    setTimeout(function() {
        console.log('æ­£åœ¨è®¾ç½®å¿…å¡«é¡¹ä¸ºçº¢è‰²...');
        
        // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†jexcel
        if (document.querySelector('.jexcel')) {
            // è·å–æ‰€æœ‰è¡¨å¤´å•å…ƒæ ¼
            const headers = document.querySelectorAll('.jexcel > thead > tr > td');
            
            // éå†æ‰€æœ‰è¡¨å¤´
            headers.forEach(header => {
                const text = header.textContent || header.innerText;
                
                // å¦‚æœåŒ…å«æ˜Ÿå·ï¼Œå°†æ˜Ÿå·åŠå…¶å‰é¢çš„æ–‡å­—è®¾ä¸ºçº¢è‰²
                if (text.includes('*')) {
                    // æ›¿æ¢HTMLå†…å®¹ï¼Œå°†æ˜Ÿå·æ ‡çº¢
                    const parts = text.split('*');
                    header.innerHTML = `<span style="color: #ff0000; font-weight: bold;">${parts[0]}*</span>${parts[1] || ''}`;
                }
            });
            
            console.log('å·²è®¾ç½®jexcelè¡¨å¤´å¿…å¡«é¡¹ä¸ºçº¢è‰²');
        } else if (document.querySelector('.simple-table')) {
            // å¦‚æœä½¿ç”¨SimpleTableï¼Œç›´æ¥æ“ä½œDOM
            const headers = document.querySelectorAll('.simple-table th');
            
            // éå†æ‰€æœ‰è¡¨å¤´
            headers.forEach(header => {
                const text = header.textContent || header.innerText;
                
                // å¦‚æœåŒ…å«æ˜Ÿå·ï¼Œå°†æ˜Ÿå·åŠå…¶å‰é¢çš„æ–‡å­—è®¾ä¸ºçº¢è‰²
                if (text.includes('*')) {
                    // æ›¿æ¢HTMLå†…å®¹ï¼Œå°†æ˜Ÿå·æ ‡çº¢
                    const parts = text.split('*');
                    header.innerHTML = `<span style="color: #ff0000; font-weight: bold;">${parts[0]}*</span>${parts[1] || ''}`;
                }
            });
            
            console.log('å·²è®¾ç½®simple-tableè¡¨å¤´å¿…å¡«é¡¹ä¸ºçº¢è‰²');
        }
    }, 2500);
});
</script>

<!-- å…¨å±€å˜é‡è·Ÿè¸ªExcelå¯¼å…¥çŠ¶æ€ -->
<script>
let excelImportInProgress = false;
let importOperationId = null;

// å¼ºåˆ¶é‡ç½®å¯¼å…¥çŠ¶æ€çš„å‡½æ•°
function forceResetImportState() {
    console.log('å¼ºåˆ¶é‡ç½®å¯¼å…¥çŠ¶æ€');

    // æ¸…é™¤æ‰€æœ‰è¶…æ—¶è®¡æ—¶å™¨
    clearAllTimeouts();

    // é‡ç½®çŠ¶æ€å˜é‡
    excelImportInProgress = false;
    importOperationId = null;

    // æ›´æ–°UIçŠ¶æ€
    updateImportUIState();

    // æ¸…é™¤ä»»ä½•é”™è¯¯æˆ–æˆåŠŸæ¶ˆæ¯
    hideMessages();

    // é‡æ–°åˆå§‹åŒ–è¡¨æ ¼
    try {
        initSpreadsheet();
        console.log('è¡¨æ ¼å·²é‡æ–°åˆå§‹åŒ–');
    } catch (error) {
        console.error('é‡æ–°åˆå§‹åŒ–è¡¨æ ¼æ—¶å‡ºé”™:', error);
    }

    // æ¸…é™¤æ–‡ä»¶è¾“å…¥
    const fileInput = document.getElementById('fileUpload');
    if (fileInput) {
        fileInput.value = '';
    }

    showCustomSuccess('å¯¼å…¥çŠ¶æ€å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¯¼å…¥æ–‡ä»¶');
}

// æ›´æ–°UIçŠ¶æ€æ˜¾ç¤º
function updateImportUIState() {
    const importBtn = document.getElementById('importExcelBtn');
    const resetBtn = document.getElementById('resetImportBtn');

    if (excelImportInProgress) {
        if (importBtn) {
            importBtn.disabled = true;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> å¯¼å…¥ä¸­...';
        }
        if (resetBtn) {
            resetBtn.style.display = 'inline-block';
        }
    } else {
        if (importBtn) {
            importBtn.disabled = false;
            importBtn.innerHTML = '<i class="fas fa-file-excel me-1"></i> Excelå¯¼å…¥';
        }
        if (resetBtn) {
            resetBtn.style.display = 'none';
        }
    }
}

// æ·»åŠ æ‰‹åŠ¨é‡ç½®æŒ‰é’®çš„äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('DOMContentLoaded', function() {
    // é‡ç½®æŒ‰é’®äº‹ä»¶
    const resetBtn = document.getElementById('resetImportBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            const shouldReset = confirm('ç¡®å®šè¦é‡ç½®å¯¼å…¥çŠ¶æ€å—ï¼Ÿè¿™å°†æ¸…é™¤å½“å‰çš„å¯¼å…¥è¿›åº¦ã€‚');
            if (shouldReset) {
                forceResetImportState();
            }
        });
    }

    // ä¸ºå¯¼å…¥æŒ‰é’®æ·»åŠ å³é”®èœå•ï¼Œæä¾›é‡ç½®é€‰é¡¹
    const importBtn = document.getElementById('importExcelBtn');
    if (importBtn) {
        importBtn.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            if (excelImportInProgress) {
                const shouldReset = confirm('æ£€æµ‹åˆ°å¯¼å…¥æ“ä½œå¯èƒ½å¡ä½äº†ã€‚æ˜¯å¦è¦é‡ç½®å¯¼å…¥çŠ¶æ€ï¼Ÿ');
                if (shouldReset) {
                    forceResetImportState();
                }
            } else {
                alert('å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„å¯¼å…¥æ“ä½œ');
            }
        });
    }

    // åˆå§‹åŒ–UIçŠ¶æ€
    updateImportUIState();
});
</script>

<!-- å¤„ç†å¤§æ•°æ®é›†çš„å‡½æ•° -->
<script>
function handleLargeDataset(data) {
    console.log(`å¤„ç†å¤§æ•°æ®é›†: ${data.length} è¡Œ`);
    
    // æ˜¾ç¤ºå¤„ç†æç¤º
    showCustomSuccess(`æ­£åœ¨å¤„ç† ${data.length} è¡Œæ•°æ®ï¼Œè¯·ç¨å€™...`);
    
    // æ‰¹é‡è®¾ç½®æ•°æ®ï¼Œåˆ†æ‰¹å¤„ç†ä»¥æé«˜æ€§èƒ½
    if (data.length > 100) {
        return new Promise((resolve) => {
            // åˆ†æ‰¹å¤„ç†æ•°æ®
            const batchSize = 100;
            const batches = Math.ceil(data.length / batchSize);
            console.log(`æ•°æ®åˆ†ä¸º ${batches} æ‰¹å¤„ç†`);
            
            let currentBatch = 0;
            
            function processNextBatch() {
                if (currentBatch >= batches) {
                    console.log('æ‰€æœ‰æ‰¹æ¬¡å¤„ç†å®Œæ¯•');
                    resolve(true);
                    return;
                }
                
                const start = currentBatch * batchSize;
                const end = Math.min(start + batchSize, data.length);
                const batchData = data.slice(start, end);
                
                console.log(`å¤„ç†ç¬¬ ${currentBatch + 1}/${batches} æ‰¹, è¡Œ ${start+1}-${end}`);
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ‰¹ï¼Œä½¿ç”¨setDataæ–¹æ³•
                if (currentBatch === 0) {
                    window.spreadsheet.setData(batchData);
                } else {
                    // è¿½åŠ æ•°æ®åˆ°è¡¨æ ¼åº•éƒ¨
                    for (let i = 0; i < batchData.length; i++) {
                        window.spreadsheet.insertRow(1, window.spreadsheet.getData().length);
                        const row = batchData[i];
                        for (let j = 0; j < row.length; j++) {
                            window.spreadsheet.setValueFromCoords(j, start + i, row[j]);
                        }
                    }
                }
                
                // æ˜¾ç¤ºè¿›åº¦
                showCustomSuccess(`æ­£åœ¨å¤„ç†æ•°æ®... ${Math.round((currentBatch + 1) * 100 / batches)}%`);
                
                currentBatch++;
                setTimeout(processNextBatch, 10); // çŸ­æš‚å»¶è¿Ÿï¼Œè®©UIæœ‰æœºä¼šåˆ·æ–°
            }
            
            processNextBatch();
        });
    } else {
        // å¯¹äºè¾ƒå°çš„æ•°æ®é›†ï¼Œç›´æ¥è®¾ç½®
        window.spreadsheet.setData(data);
        return Promise.resolve(true);
    }
}
</script>
{% endblock %}