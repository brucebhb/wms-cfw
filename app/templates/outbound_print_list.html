{% extends "base.html" %}

{% block styles %}
{{ super() }}
<style>
    /* é¡µé¢æ•´ä½“ç¾åŒ– */
    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
    }

    /* é¡µé¢æ ‡é¢˜å’Œæœç´¢åŒºåŸŸå›ºå®šæ ·å¼ */
    .page-header-fixed {
        position: sticky;
        top: 56px;
        z-index: 1020;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 20px 0;
        border-bottom: none;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        backdrop-filter: blur(10px);
        border-radius: 0 0 20px 20px;
        margin-bottom: 20px;
    }

    .page-header-fixed h2 {
        color: white;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        margin: 0;
    }

    /* æ‰¹æ¬¡æ ‡é¢˜æ ·å¼ - æ¸å˜ç¾åŒ– */
    .batch-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px 15px 0 0;
        position: relative;
        overflow: hidden;
    }

    .batch-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        pointer-events: none;
    }

    /* æ‰¹æ¬¡å¡ç‰‡æ ·å¼ - ç»ç’ƒæ€æ•ˆæœ */
    .batch-card {
        margin-bottom: 2rem;
        border: none;
        border-radius: 20px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .batch-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 45px rgba(0,0,0,0.15);
    }

    /* æœç´¢å¡ç‰‡ç¾åŒ– */
    .search-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    /* è¾“å…¥æ¡†ç¾åŒ– */
    .form-control {
        border-radius: 12px;
        border: 2px solid #e3f2fd;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.9);
    }

    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        background: white;
    }

    /* æŒ‰é’®ç¾åŒ– */
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        border: none;
        border-radius: 12px;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
    }

    .btn-secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(108, 117, 125, 0.4);
    }

    /* åŠ è½½æŒ‡ç¤ºå™¨æ ·å¼ - ç°ä»£åŒ–è®¾è®¡ */
    .loading-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(15px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 15px 45px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .loading-overlay .spinner-border {
        width: 3rem;
        height: 3rem;
        border-width: 0.3em;
    }

    /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– - ç°ä»£åŒ–è®¾è®¡ */
    .table {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    .table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        font-weight: 600;
        color: #495057;
        border: none;
        padding: 12px 8px;
        font-size: 13px;
        text-align: center;
    }

    .table td {
        font-size: 12px;
        padding: 10px 8px;
        vertical-align: middle;
        word-wrap: break-word;
        word-break: break-all;
        border: none;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .table tbody tr:hover {
        background: rgba(102, 126, 234, 0.05);
        transition: all 0.2s ease;
    }

    /* å¯¹äºæŸäº›åˆ—å…è®¸æ¢è¡Œ */
    .table td:nth-child(5), /* å®¢æˆ·åç§° */
    .table td:nth-child(6), /* è¯†åˆ«ç¼–ç  */
    .table td:nth-child(17) { /* å¤‡æ³¨ */
        white-space: normal;
        max-width: 150px;
    }

    /* å…¶ä»–åˆ—ä¿æŒä¸æ¢è¡Œ */
    .table th,
    .table td:not(:nth-child(5)):not(:nth-child(6)):not(:nth-child(17)):not(:nth-child(18)) {
        white-space: nowrap;
    }

    .table-responsive {
        overflow-x: auto;
    }

    /* æ‰¹æ¬¡ç»Ÿè®¡ä¿¡æ¯æ ·å¼ - å½©è‰²å¾½ç«  */
    .batch-stats {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
    }

    .batch-stats .badge {
        font-size: 11px;
        padding: 6px 12px;
        white-space: nowrap;
        border-radius: 20px;
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
    }

    .batch-stats .badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .bg-light {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%) !important;
        color: #495057 !important;
    }

    .bg-info {
        background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
    }

    .bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    }

    .bg-warning {
        background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
        color: #212529 !important;
    }

    /* å†…å®¹åŒºåŸŸæ ·å¼ */
    .content-wrapper {
        padding-top: 20px;
    }

    /* æœç´¢æŒ‰é’®æ ·å¼ */
    .search-buttons {
        text-align: center;
        margin-top: 20px;
    }

    /* æ‰“å°æŒ‰é’®æ ·å¼ */
    .print-btn {
        margin-left: 15px;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        border-radius: 12px;
        padding: 10px 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .print-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
    }

    /* æ‰¹æ¬¡ä¿¡æ¯åŒºåŸŸç¾åŒ– */
    .batch-info-area {
        background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        border-radius: 0 0 15px 15px;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* å¤é€‰æ¡†ç¾åŒ– */
    .form-check-input {
        width: 1.2em;
        height: 1.2em;
        border-radius: 6px;
        border: 2px solid #667eea;
        transition: all 0.2s ease;
    }

    .form-check-input:checked {
        background-color: #667eea;
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    /* åˆ†é¡µç¾åŒ– */
    .pagination .page-link {
        border-radius: 8px;
        margin: 0 2px;
        border: none;
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
        transition: all 0.2s ease;
    }

    .pagination .page-link:hover {
        background: #667eea;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    /* è­¦å‘Šæ¡†ç¾åŒ– */
    .alert-warning {
        background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(253, 126, 20, 0.1) 100%);
        border: 1px solid rgba(255, 193, 7, 0.3);
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }

    .alert-info {
        background: linear-gradient(135deg, rgba(23, 162, 184, 0.1) 0%, rgba(19, 132, 150, 0.1) 100%);
        border: 1px solid rgba(23, 162, 184, 0.3);
        border-radius: 15px;
        backdrop-filter: blur(10px);
    }
</style>
{% endblock %}

{% block content %}
<!-- å›ºå®šçš„é¡µé¢æ ‡é¢˜å’Œæœç´¢åŒºåŸŸ -->
<div class="page-header-fixed">
    <div class="container-fluid">
        <!-- é¡µé¢æ ‡é¢˜å’Œæ‰“å°æŒ‰é’® -->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>å‡ºåº“å•æ‰“å°</h2>
            <div>
                <button class="btn btn-primary print-btn" onclick="printSelected()">
                    <i class="fas fa-print"></i> æ‰“å°é€‰ä¸­
                </button>
            </div>
        </div>

        <!-- æœç´¢åŒºåŸŸ -->
        <div class="card shadow-sm search-card">
            <div class="card-body">
                <form id="searchForm" method="GET" action="{{ url_for('main.outbound_print') }}">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>æ—¥æœŸèŒƒå›´</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>
                                    </div>
                                    <input type="text" class="form-control" id="dateRange" name="dateRange">
                                </div>
                                <input type="hidden" id="date_start" name="date_start" value="{{ search_params.date_start }}">
                                <input type="hidden" id="date_end" name="date_end" value="{{ search_params.date_end }}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>å‡ºåº“è½¦ç‰Œ</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-truck"></i></span>
                                    </div>
                                    <input type="text" class="form-control" name="plate_number" value="{{ search_params.plate_number }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>æ‰¹æ¬¡å·</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                                    </div>
                                    <input type="text" class="form-control" name="batch_no" value="{{ search_params.batch_no }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>å®¢æˆ·åç§°</label>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                                    </div>
                                    <input type="text" class="form-control" name="customer_name" value="{{ search_params.customer_name }}">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="search-buttons">
                        <button type="submit" class="btn btn-primary px-4" id="search-btn">
                            <i class="fas fa-search"></i> æŸ¥è¯¢
                        </button>
                        <button type="button" class="btn btn-secondary ml-2" id="reset-btn">
                            <i class="fas fa-redo"></i> é‡ç½®
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ åŠ è½½æŒ‡ç¤ºå™¨ -->
<div class="loading-overlay" id="loading-indicator" style="display:none;">
    <div class="spinner-border text-primary" role="status">
        <span class="sr-only">åŠ è½½ä¸­...</span>
    </div>
    <div class="mt-2">æ­£åœ¨åŠ è½½æ•°æ®ï¼Œè¯·ç¨å€™...</div>
</div>

<!-- æ•°æ®å±•ç¤ºåŒº -->
<div class="container-fluid content-wrapper">
    <form id="printForm" method="POST" action="{{ url_for('main.print_selected_records') }}">
        <!-- æ·»åŠ CSRFä»¤ç‰Œ -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        {% if batch_stats %}
            <div class="mb-3">
                <span class="font-weight-bold">å…±æ‰¾åˆ° {{ batch_stats|length }} ä¸ªæ‰¹æ¬¡ï¼Œ{{ batch_records|length }} æ¡è®°å½•</span>
                <button type="button" class="btn btn-sm btn-outline-primary ml-2" onclick="selectAll()">å…¨é€‰</button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">å–æ¶ˆå…¨é€‰</button>
            </div>

            <!-- æ·»åŠ è®°å½•æ•°é™åˆ¶çš„è­¦å‘Š -->
            {% if show_warning %}
            <div class="alert alert-warning alert-dismissible fade show" role="alert">
                <strong>æ³¨æ„!</strong> ä¸ºäº†æé«˜æ€§èƒ½ï¼Œå½“å‰åªæ˜¾ç¤ºäº† {{ max_records }} æ¡è®°å½•ã€‚è¯·æ·»åŠ æ›´å¤šç­›é€‰æ¡ä»¶è·å–æ›´ç²¾ç¡®çš„ç»“æœã€‚
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endif %}

            {% for batch_no, stats in batch_stats.items() %}
                <div class="card mb-4 batch-card shadow-sm">
                    <div class="card-header py-2 batch-header">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input batch-checkbox" id="batch-{{ batch_no }}" data-batch="{{ batch_no }}">
                                    <label class="form-check-label" for="batch-{{ batch_no }}"></label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h5 class="mb-0">æ‰¹æ¬¡å·: {{ batch_no }}</h5>
                            </div>
                            <div class="col-md-8 text-md-right">
                                <div class="batch-stats">
                                    <span class="badge bg-light text-dark">è®°å½•æ•°: {{ batch_rowspans[batch_no] }}</span>
                                    <span class="badge bg-info text-white">å¤§å±‚æ¿: {{ stats.big_pallet }}</span>
                                    <span class="badge bg-success text-white">å°å±‚æ¿: {{ stats.small_pallet }}</span>
                                    <span class="badge bg-warning text-dark">å¡æ¿: {{ stats.card_pallet }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ·»åŠ æ‰¹æ¬¡å…¬å…±ä¿¡æ¯å±•ç¤ºåŒºåŸŸ -->
                    {% set first_record = batch_records|selectattr('batch_no', 'equalto', batch_no)|first %}
                    {% if first_record %}
                    <div class="card-body py-3 batch-info-area border-bottom">
                        <div class="row small">
                            <div class="col-md-3">
                                <i class="fas fa-truck"></i> è½¦å‹: 
                                <span class="badge bg-secondary">{{ first_record.vehicle_type or 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-3">
                                <i class="fas fa-user"></i> å¸æœº: 
                                <span class="badge bg-secondary">{{ first_record.driver_name or 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-3">
                                <i class="fas fa-phone"></i> ç”µè¯: 
                                <span class="badge bg-secondary">{{ first_record.driver_phone or 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-3">
                                <i class="fas fa-map-marker-alt"></i> ç›®çš„åœ°: 
                                <span class="badge bg-secondary">{{ first_record.destination or 'æœªè®¾ç½®' }}</span>
                            </div>
                        </div>
                        <div class="row small mt-2">
                            <div class="col-md-3">
                                <i class="fas fa-clock"></i> åˆ°ä»“æ—¶é—´: 
                                <span class="badge bg-secondary">{{ first_record.arrival_time.strftime('%m-%d %H:%M') if first_record.arrival_time else 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-3">
                                <i class="fas fa-clock"></i> è£…è½¦å¼€å§‹: 
                                <span class="badge bg-secondary">{{ first_record.loading_start_time.strftime('%m-%d %H:%M') if first_record.loading_start_time else 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-3">
                                <i class="fas fa-clock"></i> è£…è½¦ç»“æŸ: 
                                <span class="badge bg-secondary">{{ first_record.loading_end_time.strftime('%m-%d %H:%M') if first_record.loading_end_time else 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-3">
                                <i class="fas fa-clock"></i> å‘è¿æ—¶é—´: 
                                <span class="badge bg-secondary">{{ first_record.departure_time.strftime('%m-%d %H:%M') if first_record.departure_time else 'æœªè®¾ç½®' }}</span>
                            </div>
                        </div>
                        <div class="row small mt-2">
                            <div class="col-md-6">
                                <i class="fas fa-home"></i> è¯¦ç»†åœ°å€: 
                                <span class="badge bg-secondary">{{ first_record.detailed_address or 'æœªè®¾ç½®' }}</span>
                            </div>
                            <div class="col-md-6">
                                <i class="fas fa-user-friends"></i> è”ç»œçª—å£: 
                                <span class="badge bg-secondary">{{ first_record.contact_window or 'æœªè®¾ç½®' }}</span>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th width="40px"></th>
                                        <th width="90px">å‡ºåº“æ—¥æœŸ</th>
                                        <th width="90px">å‡ºåº“è½¦ç‰Œ</th>
                                        <th width="70px">æ‰¹æ¬¡åºå·</th>
                                        <th width="120px">å®¢æˆ·åç§°</th>
                                        <th width="180px">è¯†åˆ«ç¼–ç </th>
                                        <th width="90px">å…¥åº“è½¦ç‰Œ</th>
                                        <th width="80px">è®¢å•ç±»å‹</th>
                                        <th width="50px">æ¿æ•°</th>
                                        <th width="50px">ä»¶æ•°</th>
                                        <th width="60px">é‡é‡</th>
                                        <th width="60px">ä½“ç§¯</th>
                                        <th width="80px">å‡ºå¢ƒæ¨¡å¼</th>
                                        <th width="100px">æŠ¥å…³è¡Œ</th>
                                        <th width="70px">å•æ®ä»½æ•°</th>
                                        <th width="80px">è·Ÿå•å®¢æœ</th>
                                        <th width="120px">å¤‡æ³¨1</th>
                                        <th width="120px">å¤‡æ³¨2</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for record in batch_records if record.batch_no == batch_no %}
                                    <tr>
                                        <td class="text-center align-middle">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input record-checkbox batch-item-{{ batch_no }}" 
                                                       id="record-{{ record.id }}" name="record_ids[]" value="{{ record.id }}">
                                                <label class="form-check-label" for="record-{{ record.id }}"></label>
                                            </div>
                                        </td>
                                        <td>{{ record.outbound_time.strftime('%Y-%m-%d') if record.outbound_time else '-' }}</td>
                                        <td>{{ record.plate_number or '-' }}</td>
                                        <td class="text-center">{{ record.batch_sequence or '-' }}/{{ record.batch_total or '-' }}</td>
                                        <td>{{ record.customer_name or '-' }}</td>
                                        <td>{{ record.identification_code or '-' }}</td>
                                        <td>{{ record.inbound_plate or '-' }}</td>
                                        <td>{{ record.order_type or '-' }}</td>
                                        <td class="text-right">{{ record.pallet_count or 0 }}</td>
                                        <td class="text-right">{{ record.package_count or 0 }}</td>
                                        <td class="text-right">{{ record.weight|default(0)|round(2) }}</td>
                                        <td class="text-right">{{ record.volume|default(0)|round(3) }}</td>
                                        <td>{{ record.export_mode or '-' }}</td>
                                        <td>{{ record.customs_broker or '-' }}</td>
                                        <td class="text-right">{{ record.document_count or '-' }}</td>
                                        <td>{{ record.service_staff or '-' }}</td>
                                        <td>{{ record.remark1 or '-' }}</td>
                                        <td>{{ record.remark2 or '-' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% endfor %}

            <!-- åˆ†é¡µæ§ä»¶ -->
            {% if batch_pagination and batch_pagination.pages > 1 %}
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div>
                    <span class="text-muted">
                        æ˜¾ç¤ºç¬¬ {{ (batch_pagination.page - 1) * batch_pagination.per_page + 1 }} -
                        {{ batch_pagination.page * batch_pagination.per_page if batch_pagination.page * batch_pagination.per_page <= batch_pagination.total else batch_pagination.total }}
                        æ‰¹æ¬¡ï¼Œå…± {{ batch_pagination.total }} ä¸ªæ‰¹æ¬¡
                    </span>
                </div>
                <nav aria-label="æ‰¹æ¬¡åˆ†é¡µ">
                    <ul class="pagination pagination-sm mb-0">
                        {% if batch_pagination.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.outbound_print', page=batch_pagination.prev_num, **search_params) }}">
                                    <i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fas fa-chevron-left"></i> ä¸Šä¸€é¡µ</span>
                            </li>
                        {% endif %}

                        {% for page_num in range(1, batch_pagination.pages + 1) %}
                            {% if page_num == batch_pagination.page %}
                                <li class="page-item active">
                                    <span class="page-link">{{ page_num }}</span>
                                </li>
                            {% elif page_num <= 3 or page_num > batch_pagination.pages - 3 or (page_num >= batch_pagination.page - 2 and page_num <= batch_pagination.page + 2) %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('main.outbound_print', page=page_num, **search_params) }}">{{ page_num }}</a>
                                </li>
                            {% elif page_num == 4 and batch_pagination.page > 6 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% elif page_num == batch_pagination.pages - 3 and batch_pagination.page < batch_pagination.pages - 5 %}
                                <li class="page-item disabled">
                                    <span class="page-link">...</span>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if batch_pagination.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.outbound_print', page=batch_pagination.next_num, **search_params) }}">
                                    ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">ä¸‹ä¸€é¡µ <i class="fas fa-chevron-right"></i></span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•ï¼Œè¯·ä¿®æ”¹æœç´¢æ¡ä»¶é‡è¯•ã€‚
            </div>
        {% endif %}
    </form>
</div>

{% block scripts %}
{{ super() }}
<script>
    // ç¡®ä¿jQueryå·²åŠ è½½
    if (typeof $ === 'undefined') {
        console.error('jQueryæœªåŠ è½½ï¼Œæ­£åœ¨å°è¯•åŠ è½½å¤‡ç”¨ç‰ˆæœ¬...');
        var script = document.createElement('script');
        script.src = 'https://code.jquery.com/jquery-3.6.0.min.js';
        script.onload = function() {
            console.log('jQueryå¤‡ç”¨ç‰ˆæœ¬åŠ è½½æˆåŠŸ');
            initializePage();
        };
        document.head.appendChild(script);
    } else {
        initializePage();
    }

    function initializePage() {
        console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–é¡µé¢...');

        // ç¡®ä¿DOMå·²å°±ç»ª
        $(document).ready(function() {
            try {
                // éšè—åŠ è½½æŒ‡ç¤ºå™¨
                $('#loading-indicator').hide();

                // æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–
                if (typeof $.fn.daterangepicker !== 'undefined') {
                    $('#dateRange').daterangepicker({
                        locale: {
                            format: 'YYYY/MM/DD',
                            applyLabel: 'ç¡®è®¤',
                            cancelLabel: 'å–æ¶ˆ',
                            fromLabel: 'ä»',
                            toLabel: 'åˆ°',
                            customRangeLabel: 'è‡ªå®šä¹‰',
                            weekLabel: 'W',
                            daysOfWeek: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'],
                            monthNames: ['ä¸€æœˆ', 'äºŒæœˆ', 'ä¸‰æœˆ', 'å››æœˆ', 'äº”æœˆ', 'å…­æœˆ', 'ä¸ƒæœˆ', 'å…«æœˆ', 'ä¹æœˆ', 'åæœˆ', 'åä¸€æœˆ', 'åäºŒæœˆ'],
                            firstDay: 1
                        },
                        startDate: '{{ search_params.date_start }}',
                        endDate: '{{ search_params.date_end }}'
                    }, function(start, end) {
                        $('#date_start').val(start.format('YYYY-MM-DD'));
                        $('#date_end').val(end.format('YYYY-MM-DD'));
                    });
                }

                // è®¾ç½®åˆå§‹æ—¥æœŸå€¼
                $('#date_start').val('{{ search_params.date_start }}');
                $('#date_end').val('{{ search_params.date_end }}');

                console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('âŒ é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                $('#loading-indicator').hide(); // å³ä½¿å‡ºé”™ä¹Ÿè¦éšè—åŠ è½½æŒ‡ç¤ºå™¨
            }
        });

        // æ‰¹æ¬¡é€‰æ‹©åŠŸèƒ½
        $(document).on('change', '.batch-checkbox', function() {
            var batchId = $(this).data('batch');
            $('.batch-item-' + batchId).prop('checked', $(this).prop('checked'));
        });

        // ç›‘å¬æœç´¢è¡¨å•æäº¤
        $('#searchForm').on('submit', function() {
            $('#loading-indicator').show();
        });

        // é‡ç½®æŒ‰é’®åŠŸèƒ½
        $('#reset-btn').on('click', function() {
            // æ¸…ç©ºæ‰€æœ‰æœç´¢å­—æ®µ
            $('input[name="plate_number"]').val('');
            $('input[name="batch_no"]').val('');
            $('input[name="customer_name"]').val('');

            // è®¾ç½®æ—¥æœŸèŒƒå›´ä¸ºæ˜¨å¤©åˆ°ä»Šå¤©
            var today = moment();
            var yesterday = moment().subtract(1, 'days');

            // æ›´æ–°æ—¥æœŸé€‰æ‹©å™¨
            $('#dateRange').data('daterangepicker').setStartDate(yesterday);
            $('#dateRange').data('daterangepicker').setEndDate(today);

            // æ›´æ–°éšè—å­—æ®µ
            $('#date_start').val(yesterday.format('YYYY-MM-DD'));
            $('#date_end').val(today.format('YYYY-MM-DD'));

            // æäº¤è¡¨å•ä»¥åˆ·æ–°é¡µé¢
            $('#searchForm').submit();
        });
    }

    // å…¨é€‰åŠŸèƒ½
    function selectAll() {
        if (typeof $ !== 'undefined') {
            $('.record-checkbox').prop('checked', true);
            $('.batch-checkbox').prop('checked', true);
        }
    }

    // å–æ¶ˆå…¨é€‰åŠŸèƒ½
    function deselectAll() {
        if (typeof $ !== 'undefined') {
            $('.record-checkbox').prop('checked', false);
            $('.batch-checkbox').prop('checked', false);
        }
    }

    // æ‰“å°é€‰ä¸­è®°å½•
    function printSelected() {
        if (typeof $ === 'undefined') {
            alert('é¡µé¢å°šæœªå®Œå…¨åŠ è½½ï¼Œè¯·ç¨åå†è¯•');
            return false;
        }

        var checkedRecords = $('.record-checkbox:checked').length;
        if (checkedRecords === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€æ¡è®°å½•è¿›è¡Œæ‰“å°');
            return false;
        }

        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        $('#loading-indicator').show();

        // æäº¤è¡¨å•
        $('#printForm').submit();

        return true;
    }

    // é¡µé¢å®Œå…¨åŠ è½½åçš„æœ€ç»ˆæ£€æŸ¥
    $(window).on('load', function() {
        // ç¡®ä¿åŠ è½½æŒ‡ç¤ºå™¨è¢«éšè—
        $('#loading-indicator').hide();
        console.log('ğŸš€ é¡µé¢å®Œå…¨åŠ è½½å®Œæˆ');

        // æ·»åŠ é¡µé¢å°±ç»ªæ ‡è¯†
        $('body').addClass('page-ready');
        console.log('âœ… é¡µé¢å·²å°±ç»ªï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨');
    });

    // é¡µé¢å¸è½½æ—¶æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
    $(window).on('beforeunload', function() {
        $('#loading-indicator').show();
    });
</script>
{% endblock %}
{% endblock %}
