{% extends "base.html" %}
{% set title = "è´§é‡æŠ¥è¡¨ä»ªè¡¨æ¿" %}

{% block content %}
<style>
/* ç®€åŒ–çš„å¸ƒå±€æ ·å¼ */
.dashboard-container {
    background: #f8f9fa;
    min-height: calc(100vh - 60px);
    padding: 20px;
}

.dashboard-header {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.warehouse-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.charts-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

/* å“åº”å¼å¸ƒå±€ä¼˜åŒ– */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .warehouse-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .dashboard-container {
        padding: 15px;
    }
}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* æ—¶é—´é€‰æ‹©å™¨æ ·å¼ */
.time-selector {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

.time-selector .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 4px;
}

.time-selector .form-control-sm,
.time-selector .form-select-sm {
    border-radius: 6px;
    border: 1px solid #ced4da;
}

.time-selector .form-control-sm:focus,
.time-selector .form-select-sm:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* æ—¶é—´å‘¨æœŸé€‰æ‹©æŒ‰é’®ç»„ */
#timePeriodSelector .btn-outline-primary {
    border-color: #007bff;
    color: #007bff;
    font-size: 0.85rem;
    padding: 0.375rem 0.75rem;
}

#timePeriodSelector .btn-outline-primary:hover {
    background-color: #007bff;
    color: white;
}

#timePeriodSelector .btn-check:checked + .btn-outline-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

/* å¯¹æ¯”ç»“æœåŒºåŸŸ */
#comparisonResultArea {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ä»“åº“é¢œè‰²åŒºåˆ†æ ·å¼ */
.warehouse-grouped-table {
    border-collapse: separate;
    border-spacing: 0;
}

/* å¹³æ¹–ä»“ - è“è‰²ç³» */
.warehouse-header-ph {
    background-color: #007bff !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-ph {
    background-color: #e3f2fd !important;
    border-left: 3px solid #007bff;
}

.warehouse-group-ph.group-start {
    border-left: 3px solid #007bff;
}

.warehouse-group-ph.group-end {
    border-right: 3px solid #007bff;
}

/* æ˜†å±±ä»“ - ç»¿è‰²ç³» */
.warehouse-header-ks {
    background-color: #28a745 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-ks {
    background-color: #e8f5e8 !important;
    border-left: 3px solid #28a745;
}

.warehouse-group-ks.group-start {
    border-left: 3px solid #28a745;
}

.warehouse-group-ks.group-end {
    border-right: 3px solid #28a745;
}

/* æˆéƒ½ä»“ - æ©™è‰²ç³» */
.warehouse-header-cd {
    background-color: #fd7e14 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-cd {
    background-color: #fff3e0 !important;
    border-left: 3px solid #fd7e14;
}

.warehouse-group-cd.group-start {
    border-left: 3px solid #fd7e14;
}

.warehouse-group-cd.group-end {
    border-right: 3px solid #fd7e14;
}

/* å‡­ç¥¥åŒ—æŠ•ä»“ - ç´«è‰²ç³» */
.warehouse-header-px {
    background-color: #6f42c1 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-px {
    background-color: #f3e5f5 !important;
    border-left: 3px solid #6f42c1;
}

.warehouse-group-px.group-start {
    border-left: 3px solid #6f42c1;
}

.warehouse-group-px.group-end {
    border-right: 3px solid #6f42c1;
}

/* åˆè®¡ - æ·±ç°è‰²ç³» */
.warehouse-header-total {
    background-color: #495057 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-total {
    background-color: #f8f9fa !important;
    border-left: 3px solid #495057;
    font-weight: bold;
}

.warehouse-group-total.group-start {
    border-left: 3px solid #495057;
}

.warehouse-group-total.group-end {
    border-right: 3px solid #495057;
}

/* è¡¨æ ¼æ•´ä½“æ ·å¼ä¼˜åŒ– */
.query-result-table {
    margin-bottom: 0;
    font-size: 0.9rem;
}

.query-result-table th {
    border-top: none;
    border-bottom: 2px solid #dee2e6;
    padding: 8px 6px;
    font-size: 0.85rem;
    white-space: nowrap;
}

.query-result-table td {
    padding: 6px;
    border-top: 1px solid #dee2e6;
    vertical-align: middle;
}

.date-column {
    background-color: #f8f9fa !important;
    font-weight: bold;
    border-right: 2px solid #dee2e6;
    min-width: 100px;
}

/* ä»“åº“å›¾æ ‡ */
.warehouse-icon::before {
    content: "ğŸ¢ ";
    margin-right: 4px;
}

.total-icon::before {
    content: "ğŸ“Š ";
    margin-right: 4px;
}

/* è¡¨æ ¼å­—æ®µæ ‡é¢˜æ ·å¼ */
.warehouse-grouped-table th.small {
    color: black !important;
}

/* å“åº”å¼ä¼˜åŒ– */
@media (max-width: 768px) {
    .warehouse-grouped-table {
        font-size: 0.8rem;
    }

    .warehouse-grouped-table th,
    .warehouse-grouped-table td {
        padding: 4px 2px;
    }
}
</style>

<div class="dashboard-container">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-1">
                    <i class="fas fa-chart-line me-2 text-primary"></i>è´§é‡æŠ¥è¡¨ä»ªè¡¨æ¿
                </h3>
                <p class="text-muted mb-0">å®æ—¶æ•°æ®åˆ†æä¸ç›‘æ§</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <!-- æ—¶é—´å¯¹æ¯”é€‰æ‹©å™¨ -->
                <div class="btn-group btn-group-sm me-3" role="group" id="timePeriodSelector">
                    <input type="radio" class="btn-check" name="timePeriod" id="dayPeriod" value="day" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="dayPeriod">
                        <i class="fas fa-calendar-day"></i> æ—¥å¯¹æ¯”
                    </label>
                    <input type="radio" class="btn-check" name="timePeriod" id="weekPeriod" value="week" autocomplete="off">
                    <label class="btn btn-outline-primary" for="weekPeriod">
                        <i class="fas fa-calendar-week"></i> å‘¨å¯¹æ¯”
                    </label>
                    <input type="radio" class="btn-check" name="timePeriod" id="monthPeriod" value="month" autocomplete="off">
                    <label class="btn btn-outline-primary" for="monthPeriod">
                        <i class="fas fa-calendar-alt"></i> æœˆå¯¹æ¯”
                    </label>
                    <input type="radio" class="btn-check" name="timePeriod" id="yearPeriod" value="year" autocomplete="off">
                    <label class="btn btn-outline-primary" for="yearPeriod">
                        <i class="fas fa-calendar"></i> å¹´å¯¹æ¯”
                    </label>
                </div>

                <button class="btn btn-primary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> åˆ·æ–°æ•°æ®
                </button>
                <span class="badge bg-success">å®æ—¶</span>
                <span id="lastUpdateTime" class="text-muted small"></span>
            </div>
        </div>
    </div>

    <!-- æ—¶é—´é€‰æ‹©åŒºåŸŸ -->
    <div class="charts-section mb-3" id="timeSelectionArea">
        <div class="row align-items-end">
            <!-- æ—¥å¯¹æ¯”é€‰æ‹©å™¨ -->
            <div id="daySelection" class="time-selector col-12">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">å¼€å§‹æ—¥æœŸ</label>
                        <input type="date" class="form-control form-control-sm" id="dayStartDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">ç»“æŸæ—¥æœŸ</label>
                        <input type="date" class="form-control form-control-sm" id="dayEndDate">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="dayQueryBtn">
                            <i class="fas fa-search"></i> æŸ¥è¯¢å¯¹æ¯”
                        </button>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">é€‰æ‹©æ—¥æœŸèŒƒå›´è¿›è¡Œå¯¹æ¯”åˆ†æï¼ˆæœ€å¤š7å¤©ï¼‰</small>
                    </div>
                </div>
            </div>

            <!-- å‘¨å¯¹æ¯”é€‰æ‹©å™¨ -->
            <div id="weekSelection" class="time-selector col-12" style="display: none;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">å¹´ä»½</label>
                        <select class="form-select form-select-sm" id="weekYear">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">ç¬¬ä¸€å‘¨ <span class="text-muted">(å‘¨ä¸€è‡³å‘¨æ—¥)</span></label>
                        <select class="form-select form-select-sm" id="weekFirst">
                            <!-- åŠ¨æ€ç”Ÿæˆï¼Œæ˜¾ç¤ºæ—¥æœŸèŒƒå›´ -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">ç¬¬äºŒå‘¨ <span class="text-muted">(å‘¨ä¸€è‡³å‘¨æ—¥)</span></label>
                        <select class="form-select form-select-sm" id="weekSecond">
                            <!-- åŠ¨æ€ç”Ÿæˆï¼Œæ˜¾ç¤ºæ—¥æœŸèŒƒå›´ -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="weekQueryBtn">
                            <i class="fas fa-search"></i> æŸ¥è¯¢å¯¹æ¯”
                        </button>
                        <small class="text-muted mt-1 d-block text-center">é€‰æ‹©ä¸¤å‘¨å¯¹æ¯”</small>
                    </div>
                </div>

                <!-- å‘¨é€‰æ‹©é¢„è§ˆ -->
                <div class="row mt-2" id="weekPreview" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info py-2 mb-0">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                <strong>å¯¹æ¯”é¢„è§ˆï¼š</strong>
                                <span id="weekPreviewText">è¯·é€‰æ‹©è¦å¯¹æ¯”çš„ä¸¤å‘¨</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœˆå¯¹æ¯”é€‰æ‹©å™¨ -->
            <div id="monthSelection" class="time-selector col-12" style="display: none;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">å¹´ä»½</label>
                        <select class="form-select form-select-sm" id="monthYear">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">ç¬¬ä¸€ä¸ªæœˆ</label>
                        <select class="form-select form-select-sm" id="monthFirst">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">ç¬¬äºŒä¸ªæœˆ</label>
                        <select class="form-select form-select-sm" id="monthSecond">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="monthQueryBtn">
                            <i class="fas fa-search"></i> æŸ¥è¯¢å¯¹æ¯”
                        </button>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">é€‰æ‹©ä¸¤ä¸ªæœˆè¿›è¡Œå¯¹æ¯”</small>
                    </div>
                </div>
            </div>

            <!-- å¹´å¯¹æ¯”é€‰æ‹©å™¨ -->
            <div id="yearSelection" class="time-selector col-12" style="display: none;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">ç¬¬ä¸€å¹´</label>
                        <select class="form-select form-select-sm" id="yearFirst">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">ç¬¬äºŒå¹´</label>
                        <select class="form-select form-select-sm" id="yearSecond">
                            <!-- åŠ¨æ€ç”Ÿæˆ -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="yearQueryBtn">
                            <i class="fas fa-search"></i> æŸ¥è¯¢å¯¹æ¯”
                        </button>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">é€‰æ‹©ä¸¤å¹´è¿›è¡Œå¯¹æ¯”åˆ†æ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¹æ¯”ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
    <div class="charts-section mb-3" id="comparisonResultArea" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2 text-success"></i>å¯¹æ¯”åˆ†æç»“æœ
            </h5>
            <span class="badge bg-info" id="comparisonPeriodBadge">æ—¥å¯¹æ¯”</span>
        </div>
        <div id="comparisonContent">
            <!-- åŠ¨æ€ç”Ÿæˆå¯¹æ¯”å†…å®¹ -->
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="stats-grid" id="overviewCards">
        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-primary text-white rounded p-2 me-3">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">ä»Šæ—¥è¿›è´§</h6>
                    <h4 class="mb-0" id="todayInboundCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="todayInboundPallets">-</span>æ¿ Â· <span id="todayInboundPackages">-</span>ä»¶
            </small>
        </div>

        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-success text-white rounded p-2 me-3">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">ä»Šæ—¥å‡ºè´§</h6>
                    <h4 class="mb-0" id="todayOutboundCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="todayOutboundPallets">-</span>æ¿ Â· <span id="todayOutboundPackages">-</span>ä»¶
            </small>
        </div>

        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-info text-white rounded p-2 me-3">
                    <i class="fas fa-boxes"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">åº“å­˜æ€»é‡</h6>
                    <h4 class="mb-0" id="inventoryCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="inventoryPallets">-</span>æ¿ Â· <span id="inventoryPackages">-</span>ä»¶
            </small>
        </div>

        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-warning text-white rounded p-2 me-3">
                    <i class="fas fa-truck"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">åœ¨é€”è´§ç‰©</h6>
                    <h4 class="mb-0" id="transitCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="transitPallets">-</span>æ¿ Â· <span id="transitPackages">-</span>ä»¶
            </small>
        </div>
    </div>

    <!-- ä»“åº“æ•°æ®æ¦‚è§ˆ -->
    <div class="charts-section">
        <h5 class="mb-3">
            <i class="fas fa-warehouse me-2 text-primary"></i>ä»“åº“æ•°æ®æ¦‚è§ˆ
        </h5>
        <div class="warehouse-grid" id="warehouseCardsGrid">
            <!-- å¹³æ¹–ä»“ -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">å¹³æ¹–ä»“ (PH)</h6>
                        <small class="text-muted">å‰ç«¯ä»“åº“</small>
                    </div>
                </div>
                <div id="warehouse-1-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥è¿›è´§</div>
                            <div class="fw-bold" id="ph-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥å‡ºè´§</div>
                            <div class="fw-bold" id="ph-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">åº“å­˜</div>
                            <div class="fw-bold" id="ph-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ˜†å±±ä»“ -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">æ˜†å±±ä»“ (KS)</h6>
                        <small class="text-muted">å‰ç«¯ä»“åº“</small>
                    </div>
                </div>
                <div id="warehouse-2-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥è¿›è´§</div>
                            <div class="fw-bold" id="ks-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥å‡ºè´§</div>
                            <div class="fw-bold" id="ks-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">åº“å­˜</div>
                            <div class="fw-bold" id="ks-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æˆéƒ½ä»“ -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-warning text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">æˆéƒ½ä»“ (CD)</h6>
                        <small class="text-muted">å‰ç«¯ä»“åº“</small>
                    </div>
                </div>
                <div id="warehouse-3-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥è¿›è´§</div>
                            <div class="fw-bold" id="cd-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥å‡ºè´§</div>
                            <div class="fw-bold" id="cd-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">åº“å­˜</div>
                            <div class="fw-bold" id="cd-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å‡­ç¥¥åŒ—æŠ•ä»“ -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-danger text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">å‡­ç¥¥åŒ—æŠ•ä»“ (PX)</h6>
                        <small class="text-muted">åç«¯ä»“åº“</small>
                    </div>
                </div>
                <div id="warehouse-4-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥è¿›è´§</div>
                            <div class="fw-bold" id="px-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">ä»Šæ—¥å‡ºè´§</div>
                            <div class="fw-bold" id="px-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">åº“å­˜</div>
                            <div class="fw-bold" id="px-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="charts-section">
        <h5 class="mb-3">
            <i class="fas fa-chart-line me-2 text-primary"></i>æ•°æ®å›¾è¡¨
        </h5>
        <div class="row">
            <div class="col-md-8">
                <div class="bg-white p-3 rounded border">
                    <h6 class="mb-3">è´§é‡è¶‹åŠ¿å¯¹æ¯”</h6>
                    <div id="comparisonChart" style="height: 300px;">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="fas fa-chart-line fa-3x mb-3"></i>
                                <p>å›¾è¡¨åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="bg-white p-3 rounded border">
                    <h6 class="mb-3">ä»“åº“åˆ†å¸ƒ</h6>
                    <div id="distributionChart" style="height: 300px;">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                <p>å›¾è¡¨åŠ è½½ä¸­...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- EChartså›¾è¡¨åº“ -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- è´§é‡ä»ªè¡¨æ¿è„šæœ¬ -->
<script src="{{ url_for('static', filename='js/cargo_volume_dashboard.js') }}?v={{ moment().format('YYYYMMDDHHmmss') }}"></script>
<script>
// æ—¶é—´å¯¹æ¯”ç®¡ç†å™¨
class TimeComparisonManager {
    constructor() {
        this.currentPeriod = 'day';
        this.init();
    }

    init() {
        this.initTimeSelectors();
        this.bindEvents();
        this.setDefaultDates();
    }

    initTimeSelectors() {
        // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 5; i <= currentYear + 1; i++) {
            years.push(i);
        }

        ['weekYear', 'monthYear', 'yearFirst', 'yearSecond'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 'å¹´';
                    if (year === currentYear) option.selected = true;
                    select.appendChild(option);
                });
            }
        });

        // åˆå§‹åŒ–å‘¨é€‰æ‹©å™¨
        this.initWeekSelectors();
    }

    initWeekSelectors() {
        const currentYear = new Date().getFullYear();
        this.updateWeekOptions(currentYear);

        // ç›‘å¬å¹´ä»½å˜åŒ–
        const yearSelect = document.getElementById('weekYear');
        if (yearSelect) {
            yearSelect.addEventListener('change', (e) => {
                this.updateWeekOptions(parseInt(e.target.value));
            });
        }

        // ç›‘å¬å‘¨é€‰æ‹©å˜åŒ–ï¼Œæ›´æ–°é¢„è§ˆ
        ['weekFirst', 'weekSecond'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => {
                    this.updateWeekPreview();
                });
            }
        });
    }

    updateWeekOptions(year) {
        const weeks = this.generateWeekOptions(year);

        ['weekFirst', 'weekSecond'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '';

                weeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.weekNumber;
                    option.textContent = `ç¬¬${week.weekNumber}å‘¨ (${week.startDate} ~ ${week.endDate})`;
                    option.setAttribute('data-start-date', week.fullStartDate);
                    option.setAttribute('data-end-date', week.fullEndDate);
                    select.appendChild(option);
                });

                // æ¢å¤ä¹‹å‰çš„é€‰æ‹©
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            }
        });

        this.updateWeekPreview();
    }

    generateWeekOptions(year) {
        const weeks = [];
        const startOfYear = new Date(year, 0, 1);

        // æ‰¾åˆ°ç¬¬ä¸€å‘¨çš„å‘¨ä¸€
        let firstMonday = new Date(startOfYear);
        const dayOfWeek = startOfYear.getDay();
        const daysToMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
        firstMonday.setDate(startOfYear.getDate() + daysToMonday);

        // å¦‚æœç¬¬ä¸€å‘¨çš„å‘¨ä¸€åœ¨1æœˆ4æ—¥ä¹‹åï¼Œåˆ™ä»ä¸Šä¸€å¹´çš„æœ€åä¸€å‘¨å¼€å§‹
        if (firstMonday.getDate() > 4) {
            firstMonday.setDate(firstMonday.getDate() - 7);
        }

        let currentMonday = new Date(firstMonday);
        let weekNumber = 1;

        // ç”Ÿæˆä¸€å¹´çš„æ‰€æœ‰å‘¨
        while (weekNumber <= 53 && currentMonday.getFullYear() <= year) {
            const sunday = new Date(currentMonday);
            sunday.setDate(currentMonday.getDate() + 6);

            // å¦‚æœè¿™ä¸€å‘¨ä¸»è¦å±äºç›®æ ‡å¹´ä»½ï¼Œåˆ™åŒ…å«å®ƒ
            if (currentMonday.getFullYear() === year || sunday.getFullYear() === year) {
                weeks.push({
                    weekNumber: weekNumber,
                    startDate: this.formatDateShort(currentMonday),
                    endDate: this.formatDateShort(sunday),
                    fullStartDate: this.formatDateFull(currentMonday),
                    fullEndDate: this.formatDateFull(sunday)
                });
            }

            currentMonday.setDate(currentMonday.getDate() + 7);
            weekNumber++;

            // é˜²æ­¢æ— é™å¾ªç¯
            if (weekNumber > 54) break;
        }

        return weeks;
    }

    formatDateShort(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}/${day}`;
    }

    formatDateFull(date) {
        return date.toISOString().split('T')[0];
    }

    updateWeekPreview() {
        const yearSelect = document.getElementById('weekYear');
        const firstSelect = document.getElementById('weekFirst');
        const secondSelect = document.getElementById('weekSecond');
        const previewDiv = document.getElementById('weekPreview');
        const previewText = document.getElementById('weekPreviewText');

        if (!yearSelect || !firstSelect || !secondSelect || !previewDiv || !previewText) {
            return;
        }

        const year = yearSelect.value;
        const firstWeek = firstSelect.value;
        const secondWeek = secondSelect.value;

        if (year && firstWeek && secondWeek) {
            const firstOption = firstSelect.querySelector(`option[value="${firstWeek}"]`);
            const secondOption = secondSelect.querySelector(`option[value="${secondWeek}"]`);

            if (firstOption && secondOption) {
                const firstText = firstOption.textContent;
                const secondText = secondOption.textContent;

                previewText.innerHTML = `
                    <strong>${year}å¹´</strong>
                    <span class="text-primary">${firstText}</span>
                    <strong>vs</strong>
                    <span class="text-success">${secondText}</span>
                `;
                previewDiv.style.display = 'block';
            }
        } else {
            previewDiv.style.display = 'none';
        }
    }

    setDefaultDates() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const todayStr = today.toISOString().split('T')[0];
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        document.getElementById('dayStartDate').value = yesterdayStr;
        document.getElementById('dayEndDate').value = todayStr;

        // è®¾ç½®é»˜è®¤æœˆä»½
        const currentMonth = today.getMonth() + 1;
        const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;

        document.getElementById('monthFirst').value = lastMonth;
        document.getElementById('monthSecond').value = currentMonth;

        // è®¾ç½®é»˜è®¤å‘¨ï¼ˆå½“å‰å‘¨å’Œä¸Šä¸€å‘¨ï¼‰
        setTimeout(() => {
            const currentWeek = this.getISOWeekNumber(today);
            const lastWeek = currentWeek === 1 ? 52 : currentWeek - 1;

            const weekFirstSelect = document.getElementById('weekFirst');
            const weekSecondSelect = document.getElementById('weekSecond');

            if (weekFirstSelect && weekSecondSelect) {
                // è®¾ç½®ä¸Šä¸€å‘¨ä¸ºç¬¬ä¸€å‘¨
                if (weekFirstSelect.querySelector(`option[value="${lastWeek}"]`)) {
                    weekFirstSelect.value = lastWeek;
                }
                // è®¾ç½®å½“å‰å‘¨ä¸ºç¬¬äºŒå‘¨
                if (weekSecondSelect.querySelector(`option[value="${currentWeek}"]`)) {
                    weekSecondSelect.value = currentWeek;
                }

                this.updateWeekPreview();
            }
        }, 100); // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é€‰é¡¹å·²ç”Ÿæˆ
    }

    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    getISOWeekNumber(date) {
        // ISO 8601 å‘¨æ•°è®¡ç®—
        const target = new Date(date.valueOf());
        const dayNr = (date.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        const firstThursday = target.valueOf();
        target.setMonth(0, 1);
        if (target.getDay() !== 4) {
            target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
        }
        return 1 + Math.ceil((firstThursday - target) / 604800000);
    }

    bindEvents() {
        // æ—¶é—´å‘¨æœŸåˆ‡æ¢
        document.querySelectorAll('input[name="timePeriod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.switchTimePeriod(e.target.value);
            });
        });

        // æŸ¥è¯¢æŒ‰é’®äº‹ä»¶
        document.getElementById('dayQueryBtn').addEventListener('click', () => this.performComparison('day'));
        document.getElementById('weekQueryBtn').addEventListener('click', () => this.performComparison('week'));
        document.getElementById('monthQueryBtn').addEventListener('click', () => this.performComparison('month'));
        document.getElementById('yearQueryBtn').addEventListener('click', () => this.performComparison('year'));
    }

    switchTimePeriod(period) {
        this.currentPeriod = period;

        // éšè—æ‰€æœ‰é€‰æ‹©å™¨
        document.querySelectorAll('.time-selector').forEach(selector => {
            selector.style.display = 'none';
        });

        // æ˜¾ç¤ºå¯¹åº”çš„é€‰æ‹©å™¨
        document.getElementById(period + 'Selection').style.display = 'block';

        // æ›´æ–°å¾½ç« 
        const badges = {
            'day': 'æ—¥å¯¹æ¯”',
            'week': 'å‘¨å¯¹æ¯”',
            'month': 'æœˆå¯¹æ¯”',
            'year': 'å¹´å¯¹æ¯”'
        };
        document.getElementById('comparisonPeriodBadge').textContent = badges[period];
    }

    async performComparison(period) {
        const params = this.getComparisonParams(period);
        if (!params) return;

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.showLoading();

            // è°ƒç”¨APIè·å–å¯¹æ¯”æ•°æ®
            const response = await fetch('/reports/api/cargo_volume_comparison', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({
                    period: period,
                    ...params
                })
            });

            if (!response.ok) {
                throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            this.displayComparisonResult(data, period);

        } catch (error) {
            console.error('å¯¹æ¯”æŸ¥è¯¢å¤±è´¥:', error);
            this.showError('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    }

    getComparisonParams(period) {
        switch (period) {
            case 'day':
                const startDate = document.getElementById('dayStartDate').value;
                const endDate = document.getElementById('dayEndDate').value;
                if (!startDate || !endDate) {
                    alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                    return null;
                }
                return { startDate, endDate };

            case 'week':
                const weekYear = document.getElementById('weekYear').value;
                const weekFirst = document.getElementById('weekFirst').value;
                const weekSecond = document.getElementById('weekSecond').value;

                if (!weekYear || !weekFirst || !weekSecond) {
                    alert('è¯·é€‰æ‹©å¹´ä»½å’Œä¸¤ä¸ªå¯¹æ¯”å‘¨');
                    return null;
                }

                // è·å–å‘¨çš„å®é™…æ—¥æœŸèŒƒå›´
                const firstOption = document.getElementById('weekFirst').querySelector(`option[value="${weekFirst}"]`);
                const secondOption = document.getElementById('weekSecond').querySelector(`option[value="${weekSecond}"]`);

                return {
                    year: weekYear,
                    week1: weekFirst,
                    week2: weekSecond,
                    week1_start: firstOption?.getAttribute('data-start-date'),
                    week1_end: firstOption?.getAttribute('data-end-date'),
                    week2_start: secondOption?.getAttribute('data-start-date'),
                    week2_end: secondOption?.getAttribute('data-end-date')
                };

            case 'month':
                const monthYear = document.getElementById('monthYear').value;
                const monthFirst = document.getElementById('monthFirst').value;
                const monthSecond = document.getElementById('monthSecond').value;
                return { year: monthYear, month1: monthFirst, month2: monthSecond };

            case 'year':
                const yearFirst = document.getElementById('yearFirst').value;
                const yearSecond = document.getElementById('yearSecond').value;
                return { year1: yearFirst, year2: yearSecond };

            default:
                return null;
        }
    }

    showLoading() {
        const resultArea = document.getElementById('comparisonResultArea');
        const content = document.getElementById('comparisonContent');

        content.innerHTML = `
            <div class="text-center py-4">
                <div class="loading-spinner"></div>
                <span>æ­£åœ¨æŸ¥è¯¢å¯¹æ¯”æ•°æ®...</span>
            </div>
        `;

        resultArea.style.display = 'block';
    }

    showError(message) {
        const content = document.getElementById('comparisonContent');
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
        `;
    }

    displayComparisonResult(data, period) {
        const content = document.getElementById('comparisonContent');

        // ç”Ÿæˆå¯¹æ¯”ç»“æœHTML
        const html = this.generateComparisonHTML(data, period);
        content.innerHTML = html;

        // å¦‚æœæœ‰å›¾è¡¨æ•°æ®ï¼Œæ¸²æŸ“å›¾è¡¨
        if (data.chartData) {
            this.renderComparisonChart(data.chartData);
        }
    }

    generateComparisonHTML(data, period) {
        const { period1, period2, comparison } = data;

        return `
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">${period1.label}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="small text-muted">è¿›è´§</div>
                                    <div class="fw-bold">${period1.inbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">å‡ºè´§</div>
                                    <div class="fw-bold">${period1.outbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">æ¿æ•°</div>
                                    <div class="fw-bold">${period1.pallets || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">ä»¶æ•°</div>
                                    <div class="fw-bold">${period1.packages || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">${period2.label}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="small text-muted">è¿›è´§</div>
                                    <div class="fw-bold">${period2.inbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">å‡ºè´§</div>
                                    <div class="fw-bold">${period2.outbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">æ¿æ•°</div>
                                    <div class="fw-bold">${period2.pallets || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">ä»¶æ•°</div>
                                    <div class="fw-bold">${period2.packages || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">å¯¹æ¯”åˆ†æ</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="small text-muted">è¿›è´§å˜åŒ–</div>
                                    <div class="fw-bold ${comparison.inbound_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.inbound_change >= 0 ? '+' : ''}${comparison.inbound_change}
                                        <small>(${comparison.inbound_percent >= 0 ? '+' : ''}${comparison.inbound_percent}%)</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">å‡ºè´§å˜åŒ–</div>
                                    <div class="fw-bold ${comparison.outbound_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.outbound_change >= 0 ? '+' : ''}${comparison.outbound_change}
                                        <small>(${comparison.outbound_percent >= 0 ? '+' : ''}${comparison.outbound_percent}%)</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">æ¿æ•°å˜åŒ–</div>
                                    <div class="fw-bold ${comparison.pallets_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.pallets_change >= 0 ? '+' : ''}${comparison.pallets_change}
                                        <small>(${comparison.pallets_percent >= 0 ? '+' : ''}${comparison.pallets_percent}%)</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">ä»¶æ•°å˜åŒ–</div>
                                    <div class="fw-bold ${comparison.packages_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.packages_change >= 0 ? '+' : ''}${comparison.packages_change}
                                        <small>(${comparison.packages_percent >= 0 ? '+' : ''}${comparison.packages_percent}%)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="bg-white p-3 rounded border">
                        <h6 class="mb-3">å¯¹æ¯”è¶‹åŠ¿å›¾</h6>
                        <div id="comparisonTrendChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        `;
    }

    renderComparisonChart(chartData) {
        if (typeof echarts === 'undefined') {
            console.error('EChartsæœªåŠ è½½');
            return;
        }

        const chartDom = document.getElementById('comparisonTrendChart');
        const myChart = echarts.init(chartDom);

        const option = {
            title: {
                text: 'è´§é‡å¯¹æ¯”è¶‹åŠ¿',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['è¿›è´§é‡', 'å‡ºè´§é‡'],
                top: 30
            },
            xAxis: {
                type: 'category',
                data: chartData.categories
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    name: 'è¿›è´§é‡',
                    type: 'bar',
                    data: chartData.inbound,
                    itemStyle: { color: '#007bff' }
                },
                {
                    name: 'å‡ºè´§é‡',
                    type: 'bar',
                    data: chartData.outbound,
                    itemStyle: { color: '#28a745' }
                }
            ]
        };

        myChart.setOption(option);
    }
}

// åˆå§‹åŒ–ä»ªè¡¨æ¿
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æ—¶é—´å¯¹æ¯”ç®¡ç†å™¨
    window.timeComparison = new TimeComparisonManager();

    // æ£€æŸ¥å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
    const requiredElements = [
        'overviewCards',
        'warehouseCardsGrid',
        'refreshBtn'
    ];

    let missingElements = [];
    requiredElements.forEach(id => {
        if (!document.getElementById(id)) {
            missingElements.push(id);
        }
    });

    if (missingElements.length > 0) {
        console.error('âŒ ç¼ºå°‘å¿…è¦çš„é¡µé¢å…ƒç´ :', missingElements);
        return;
    }

    // åˆå§‹åŒ–ä»ªè¡¨æ¿
    try {
        if (typeof CargoVolumeDashboard !== 'undefined') {
            window.dashboard = new CargoVolumeDashboard();
        }
    } catch (error) {
        console.error('âŒ ä»ªè¡¨æ¿åˆå§‹åŒ–å¤±è´¥:', error);

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.innerHTML = `
            <h6><i class="fas fa-exclamation-triangle"></i> ä»ªè¡¨æ¿åŠ è½½å¤±è´¥</h6>
            <p class="mb-0">è¯·åˆ·æ–°é¡µé¢é‡è¯•ï¼Œæˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜ã€‚</p>
        `;
        document.querySelector('.dashboard-container').prepend(errorDiv);
    }
});
</script>
{% endblock %}
