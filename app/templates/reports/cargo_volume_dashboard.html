{% extends "base.html" %}
{% set title = "货量报表仪表板" %}

{% block content %}
<style>
/* 简化的布局样式 */
.dashboard-container {
    background: #f8f9fa;
    min-height: calc(100vh - 60px);
    padding: 20px;
}

.dashboard-header {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
    transition: transform 0.2s ease;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.warehouse-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.charts-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 20px;
}

/* 响应式布局优化 */
@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .warehouse-grid {
        grid-template-columns: 1fr;
        gap: 15px;
    }
    
    .dashboard-container {
        padding: 15px;
    }
}

/* 加载动画 */
.loading-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid #f3f3f3;
    border-top: 2px solid #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
    margin-right: 10px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* 时间选择器样式 */
.time-selector {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #e9ecef;
}

.time-selector .form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 4px;
}

.time-selector .form-control-sm,
.time-selector .form-select-sm {
    border-radius: 6px;
    border: 1px solid #ced4da;
}

.time-selector .form-control-sm:focus,
.time-selector .form-select-sm:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

/* 时间周期选择按钮组 */
#timePeriodSelector .btn-outline-primary {
    border-color: #007bff;
    color: #007bff;
    font-size: 0.85rem;
    padding: 0.375rem 0.75rem;
}

#timePeriodSelector .btn-outline-primary:hover {
    background-color: #007bff;
    color: white;
}

#timePeriodSelector .btn-check:checked + .btn-outline-primary {
    background-color: #007bff;
    border-color: #007bff;
    color: white;
}

/* 对比结果区域 */
#comparisonResultArea {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 仓库颜色区分样式 */
.warehouse-grouped-table {
    border-collapse: separate;
    border-spacing: 0;
}

/* 平湖仓 - 蓝色系 */
.warehouse-header-ph {
    background-color: #007bff !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-ph {
    background-color: #e3f2fd !important;
    border-left: 3px solid #007bff;
}

.warehouse-group-ph.group-start {
    border-left: 3px solid #007bff;
}

.warehouse-group-ph.group-end {
    border-right: 3px solid #007bff;
}

/* 昆山仓 - 绿色系 */
.warehouse-header-ks {
    background-color: #28a745 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-ks {
    background-color: #e8f5e8 !important;
    border-left: 3px solid #28a745;
}

.warehouse-group-ks.group-start {
    border-left: 3px solid #28a745;
}

.warehouse-group-ks.group-end {
    border-right: 3px solid #28a745;
}

/* 成都仓 - 橙色系 */
.warehouse-header-cd {
    background-color: #fd7e14 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-cd {
    background-color: #fff3e0 !important;
    border-left: 3px solid #fd7e14;
}

.warehouse-group-cd.group-start {
    border-left: 3px solid #fd7e14;
}

.warehouse-group-cd.group-end {
    border-right: 3px solid #fd7e14;
}

/* 凭祥北投仓 - 紫色系 */
.warehouse-header-px {
    background-color: #6f42c1 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-px {
    background-color: #f3e5f5 !important;
    border-left: 3px solid #6f42c1;
}

.warehouse-group-px.group-start {
    border-left: 3px solid #6f42c1;
}

.warehouse-group-px.group-end {
    border-right: 3px solid #6f42c1;
}

/* 合计 - 深灰色系 */
.warehouse-header-total {
    background-color: #495057 !important;
    color: white !important;
    font-weight: bold;
}

.warehouse-group-total {
    background-color: #f8f9fa !important;
    border-left: 3px solid #495057;
    font-weight: bold;
}

.warehouse-group-total.group-start {
    border-left: 3px solid #495057;
}

.warehouse-group-total.group-end {
    border-right: 3px solid #495057;
}

/* 表格整体样式优化 */
.query-result-table {
    margin-bottom: 0;
    font-size: 0.9rem;
}

.query-result-table th {
    border-top: none;
    border-bottom: 2px solid #dee2e6;
    padding: 8px 6px;
    font-size: 0.85rem;
    white-space: nowrap;
}

.query-result-table td {
    padding: 6px;
    border-top: 1px solid #dee2e6;
    vertical-align: middle;
}

.date-column {
    background-color: #f8f9fa !important;
    font-weight: bold;
    border-right: 2px solid #dee2e6;
    min-width: 100px;
}

/* 仓库图标 */
.warehouse-icon::before {
    content: "🏢 ";
    margin-right: 4px;
}

.total-icon::before {
    content: "📊 ";
    margin-right: 4px;
}

/* 表格字段标题样式 */
.warehouse-grouped-table th.small {
    color: black !important;
}

/* 响应式优化 */
@media (max-width: 768px) {
    .warehouse-grouped-table {
        font-size: 0.8rem;
    }

    .warehouse-grouped-table th,
    .warehouse-grouped-table td {
        padding: 4px 2px;
    }
}
</style>

<div class="dashboard-container">
    <!-- 页面标题 -->
    <div class="dashboard-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h3 class="mb-1">
                    <i class="fas fa-chart-line me-2 text-primary"></i>货量报表仪表板
                </h3>
                <p class="text-muted mb-0">实时数据分析与监控</p>
            </div>
            <div class="d-flex align-items-center gap-2">
                <!-- 时间对比选择器 -->
                <div class="btn-group btn-group-sm me-3" role="group" id="timePeriodSelector">
                    <input type="radio" class="btn-check" name="timePeriod" id="dayPeriod" value="day" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="dayPeriod">
                        <i class="fas fa-calendar-day"></i> 日对比
                    </label>
                    <input type="radio" class="btn-check" name="timePeriod" id="weekPeriod" value="week" autocomplete="off">
                    <label class="btn btn-outline-primary" for="weekPeriod">
                        <i class="fas fa-calendar-week"></i> 周对比
                    </label>
                    <input type="radio" class="btn-check" name="timePeriod" id="monthPeriod" value="month" autocomplete="off">
                    <label class="btn btn-outline-primary" for="monthPeriod">
                        <i class="fas fa-calendar-alt"></i> 月对比
                    </label>
                    <input type="radio" class="btn-check" name="timePeriod" id="yearPeriod" value="year" autocomplete="off">
                    <label class="btn btn-outline-primary" for="yearPeriod">
                        <i class="fas fa-calendar"></i> 年对比
                    </label>
                </div>

                <button class="btn btn-primary btn-sm" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
                <span class="badge bg-success">实时</span>
                <span id="lastUpdateTime" class="text-muted small"></span>
            </div>
        </div>
    </div>

    <!-- 时间选择区域 -->
    <div class="charts-section mb-3" id="timeSelectionArea">
        <div class="row align-items-end">
            <!-- 日对比选择器 -->
            <div id="daySelection" class="time-selector col-12">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">开始日期</label>
                        <input type="date" class="form-control form-control-sm" id="dayStartDate">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">结束日期</label>
                        <input type="date" class="form-control form-control-sm" id="dayEndDate">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="dayQueryBtn">
                            <i class="fas fa-search"></i> 查询对比
                        </button>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">选择日期范围进行对比分析（最多7天）</small>
                    </div>
                </div>
            </div>

            <!-- 周对比选择器 -->
            <div id="weekSelection" class="time-selector col-12" style="display: none;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">年份</label>
                        <select class="form-select form-select-sm" id="weekYear">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">第一周 <span class="text-muted">(周一至周日)</span></label>
                        <select class="form-select form-select-sm" id="weekFirst">
                            <!-- 动态生成，显示日期范围 -->
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label small fw-bold">第二周 <span class="text-muted">(周一至周日)</span></label>
                        <select class="form-select form-select-sm" id="weekSecond">
                            <!-- 动态生成，显示日期范围 -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="weekQueryBtn">
                            <i class="fas fa-search"></i> 查询对比
                        </button>
                        <small class="text-muted mt-1 d-block text-center">选择两周对比</small>
                    </div>
                </div>

                <!-- 周选择预览 -->
                <div class="row mt-2" id="weekPreview" style="display: none;">
                    <div class="col-12">
                        <div class="alert alert-info py-2 mb-0">
                            <small>
                                <i class="fas fa-info-circle"></i>
                                <strong>对比预览：</strong>
                                <span id="weekPreviewText">请选择要对比的两周</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 月对比选择器 -->
            <div id="monthSelection" class="time-selector col-12" style="display: none;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-2">
                        <label class="form-label small fw-bold">年份</label>
                        <select class="form-select form-select-sm" id="monthYear">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">第一个月</label>
                        <select class="form-select form-select-sm" id="monthFirst">
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">第二个月</label>
                        <select class="form-select form-select-sm" id="monthSecond">
                            <option value="1">1月</option>
                            <option value="2">2月</option>
                            <option value="3">3月</option>
                            <option value="4">4月</option>
                            <option value="5">5月</option>
                            <option value="6">6月</option>
                            <option value="7">7月</option>
                            <option value="8">8月</option>
                            <option value="9">9月</option>
                            <option value="10">10月</option>
                            <option value="11">11月</option>
                            <option value="12">12月</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="monthQueryBtn">
                            <i class="fas fa-search"></i> 查询对比
                        </button>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">选择两个月进行对比</small>
                    </div>
                </div>
            </div>

            <!-- 年对比选择器 -->
            <div id="yearSelection" class="time-selector col-12" style="display: none;">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">第一年</label>
                        <select class="form-select form-select-sm" id="yearFirst">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small fw-bold">第二年</label>
                        <select class="form-select form-select-sm" id="yearSecond">
                            <!-- 动态生成 -->
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success btn-sm w-100" id="yearQueryBtn">
                            <i class="fas fa-search"></i> 查询对比
                        </button>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">选择两年进行对比分析</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 对比结果显示区域 -->
    <div class="charts-section mb-3" id="comparisonResultArea" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="mb-0">
                <i class="fas fa-chart-bar me-2 text-success"></i>对比分析结果
            </h5>
            <span class="badge bg-info" id="comparisonPeriodBadge">日对比</span>
        </div>
        <div id="comparisonContent">
            <!-- 动态生成对比内容 -->
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="stats-grid" id="overviewCards">
        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-primary text-white rounded p-2 me-3">
                    <i class="fas fa-arrow-down"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">今日进货</h6>
                    <h4 class="mb-0" id="todayInboundCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="todayInboundPallets">-</span>板 · <span id="todayInboundPackages">-</span>件
            </small>
        </div>

        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-success text-white rounded p-2 me-3">
                    <i class="fas fa-arrow-up"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">今日出货</h6>
                    <h4 class="mb-0" id="todayOutboundCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="todayOutboundPallets">-</span>板 · <span id="todayOutboundPackages">-</span>件
            </small>
        </div>

        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-info text-white rounded p-2 me-3">
                    <i class="fas fa-boxes"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">库存总量</h6>
                    <h4 class="mb-0" id="inventoryCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="inventoryPallets">-</span>板 · <span id="inventoryPackages">-</span>件
            </small>
        </div>

        <div class="stat-card">
            <div class="d-flex align-items-center mb-2">
                <div class="bg-warning text-white rounded p-2 me-3">
                    <i class="fas fa-truck"></i>
                </div>
                <div>
                    <h6 class="mb-0 text-muted">在途货物</h6>
                    <h4 class="mb-0" id="transitCount">-</h4>
                </div>
            </div>
            <small class="text-muted">
                <span id="transitPallets">-</span>板 · <span id="transitPackages">-</span>件
            </small>
        </div>
    </div>

    <!-- 仓库数据概览 -->
    <div class="charts-section">
        <h5 class="mb-3">
            <i class="fas fa-warehouse me-2 text-primary"></i>仓库数据概览
        </h5>
        <div class="warehouse-grid" id="warehouseCardsGrid">
            <!-- 平湖仓 -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">平湖仓 (PH)</h6>
                        <small class="text-muted">前端仓库</small>
                    </div>
                </div>
                <div id="warehouse-1-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">今日进货</div>
                            <div class="fw-bold" id="ph-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">今日出货</div>
                            <div class="fw-bold" id="ph-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">库存</div>
                            <div class="fw-bold" id="ph-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 昆山仓 -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-success text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">昆山仓 (KS)</h6>
                        <small class="text-muted">前端仓库</small>
                    </div>
                </div>
                <div id="warehouse-2-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">今日进货</div>
                            <div class="fw-bold" id="ks-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">今日出货</div>
                            <div class="fw-bold" id="ks-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">库存</div>
                            <div class="fw-bold" id="ks-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 成都仓 -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-warning text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">成都仓 (CD)</h6>
                        <small class="text-muted">前端仓库</small>
                    </div>
                </div>
                <div id="warehouse-3-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">今日进货</div>
                            <div class="fw-bold" id="cd-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">今日出货</div>
                            <div class="fw-bold" id="cd-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">库存</div>
                            <div class="fw-bold" id="cd-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 凭祥北投仓 -->
            <div class="stat-card">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-danger text-white rounded p-2 me-3">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div>
                        <h6 class="mb-0">凭祥北投仓 (PX)</h6>
                        <small class="text-muted">后端仓库</small>
                    </div>
                </div>
                <div id="warehouse-4-data">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">今日进货</div>
                            <div class="fw-bold" id="px-inbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">今日出货</div>
                            <div class="fw-bold" id="px-outbound">-</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">库存</div>
                            <div class="fw-bold" id="px-inventory">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 图表区域 -->
    <div class="charts-section">
        <h5 class="mb-3">
            <i class="fas fa-chart-line me-2 text-primary"></i>数据图表
        </h5>
        <div class="row">
            <div class="col-md-8">
                <div class="bg-white p-3 rounded border">
                    <h6 class="mb-3">货量趋势对比</h6>
                    <div id="comparisonChart" style="height: 300px;">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="fas fa-chart-line fa-3x mb-3"></i>
                                <p>图表加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="bg-white p-3 rounded border">
                    <h6 class="mb-3">仓库分布</h6>
                    <div id="distributionChart" style="height: 300px;">
                        <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                            <div class="text-center">
                                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                <p>图表加载中...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- ECharts图表库 -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
<!-- 货量仪表板脚本 -->
<script src="{{ url_for('static', filename='js/cargo_volume_dashboard.js') }}?v={{ moment().format('YYYYMMDDHHmmss') }}"></script>
<script>
// 时间对比管理器
class TimeComparisonManager {
    constructor() {
        this.currentPeriod = 'day';
        this.init();
    }

    init() {
        this.initTimeSelectors();
        this.bindEvents();
        this.setDefaultDates();
    }

    initTimeSelectors() {
        // 初始化年份选择器
        const currentYear = new Date().getFullYear();
        const years = [];
        for (let i = currentYear - 5; i <= currentYear + 1; i++) {
            years.push(i);
        }

        ['weekYear', 'monthYear', 'yearFirst', 'yearSecond'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.innerHTML = '';
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + '年';
                    if (year === currentYear) option.selected = true;
                    select.appendChild(option);
                });
            }
        });

        // 初始化周选择器
        this.initWeekSelectors();
    }

    initWeekSelectors() {
        const currentYear = new Date().getFullYear();
        this.updateWeekOptions(currentYear);

        // 监听年份变化
        const yearSelect = document.getElementById('weekYear');
        if (yearSelect) {
            yearSelect.addEventListener('change', (e) => {
                this.updateWeekOptions(parseInt(e.target.value));
            });
        }

        // 监听周选择变化，更新预览
        ['weekFirst', 'weekSecond'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                select.addEventListener('change', () => {
                    this.updateWeekPreview();
                });
            }
        });
    }

    updateWeekOptions(year) {
        const weeks = this.generateWeekOptions(year);

        ['weekFirst', 'weekSecond'].forEach(id => {
            const select = document.getElementById(id);
            if (select) {
                const currentValue = select.value;
                select.innerHTML = '';

                weeks.forEach(week => {
                    const option = document.createElement('option');
                    option.value = week.weekNumber;
                    option.textContent = `第${week.weekNumber}周 (${week.startDate} ~ ${week.endDate})`;
                    option.setAttribute('data-start-date', week.fullStartDate);
                    option.setAttribute('data-end-date', week.fullEndDate);
                    select.appendChild(option);
                });

                // 恢复之前的选择
                if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                    select.value = currentValue;
                }
            }
        });

        this.updateWeekPreview();
    }

    generateWeekOptions(year) {
        const weeks = [];
        const startOfYear = new Date(year, 0, 1);

        // 找到第一周的周一
        let firstMonday = new Date(startOfYear);
        const dayOfWeek = startOfYear.getDay();
        const daysToMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek;
        firstMonday.setDate(startOfYear.getDate() + daysToMonday);

        // 如果第一周的周一在1月4日之后，则从上一年的最后一周开始
        if (firstMonday.getDate() > 4) {
            firstMonday.setDate(firstMonday.getDate() - 7);
        }

        let currentMonday = new Date(firstMonday);
        let weekNumber = 1;

        // 生成一年的所有周
        while (weekNumber <= 53 && currentMonday.getFullYear() <= year) {
            const sunday = new Date(currentMonday);
            sunday.setDate(currentMonday.getDate() + 6);

            // 如果这一周主要属于目标年份，则包含它
            if (currentMonday.getFullYear() === year || sunday.getFullYear() === year) {
                weeks.push({
                    weekNumber: weekNumber,
                    startDate: this.formatDateShort(currentMonday),
                    endDate: this.formatDateShort(sunday),
                    fullStartDate: this.formatDateFull(currentMonday),
                    fullEndDate: this.formatDateFull(sunday)
                });
            }

            currentMonday.setDate(currentMonday.getDate() + 7);
            weekNumber++;

            // 防止无限循环
            if (weekNumber > 54) break;
        }

        return weeks;
    }

    formatDateShort(date) {
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${month}/${day}`;
    }

    formatDateFull(date) {
        return date.toISOString().split('T')[0];
    }

    updateWeekPreview() {
        const yearSelect = document.getElementById('weekYear');
        const firstSelect = document.getElementById('weekFirst');
        const secondSelect = document.getElementById('weekSecond');
        const previewDiv = document.getElementById('weekPreview');
        const previewText = document.getElementById('weekPreviewText');

        if (!yearSelect || !firstSelect || !secondSelect || !previewDiv || !previewText) {
            return;
        }

        const year = yearSelect.value;
        const firstWeek = firstSelect.value;
        const secondWeek = secondSelect.value;

        if (year && firstWeek && secondWeek) {
            const firstOption = firstSelect.querySelector(`option[value="${firstWeek}"]`);
            const secondOption = secondSelect.querySelector(`option[value="${secondWeek}"]`);

            if (firstOption && secondOption) {
                const firstText = firstOption.textContent;
                const secondText = secondOption.textContent;

                previewText.innerHTML = `
                    <strong>${year}年</strong>
                    <span class="text-primary">${firstText}</span>
                    <strong>vs</strong>
                    <span class="text-success">${secondText}</span>
                `;
                previewDiv.style.display = 'block';
            }
        } else {
            previewDiv.style.display = 'none';
        }
    }

    setDefaultDates() {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const todayStr = today.toISOString().split('T')[0];
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        document.getElementById('dayStartDate').value = yesterdayStr;
        document.getElementById('dayEndDate').value = todayStr;

        // 设置默认月份
        const currentMonth = today.getMonth() + 1;
        const lastMonth = currentMonth === 1 ? 12 : currentMonth - 1;

        document.getElementById('monthFirst').value = lastMonth;
        document.getElementById('monthSecond').value = currentMonth;

        // 设置默认周（当前周和上一周）
        setTimeout(() => {
            const currentWeek = this.getISOWeekNumber(today);
            const lastWeek = currentWeek === 1 ? 52 : currentWeek - 1;

            const weekFirstSelect = document.getElementById('weekFirst');
            const weekSecondSelect = document.getElementById('weekSecond');

            if (weekFirstSelect && weekSecondSelect) {
                // 设置上一周为第一周
                if (weekFirstSelect.querySelector(`option[value="${lastWeek}"]`)) {
                    weekFirstSelect.value = lastWeek;
                }
                // 设置当前周为第二周
                if (weekSecondSelect.querySelector(`option[value="${currentWeek}"]`)) {
                    weekSecondSelect.value = currentWeek;
                }

                this.updateWeekPreview();
            }
        }, 100); // 延迟执行，确保选项已生成
    }

    getWeekNumber(date) {
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    getISOWeekNumber(date) {
        // ISO 8601 周数计算
        const target = new Date(date.valueOf());
        const dayNr = (date.getDay() + 6) % 7;
        target.setDate(target.getDate() - dayNr + 3);
        const firstThursday = target.valueOf();
        target.setMonth(0, 1);
        if (target.getDay() !== 4) {
            target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
        }
        return 1 + Math.ceil((firstThursday - target) / 604800000);
    }

    bindEvents() {
        // 时间周期切换
        document.querySelectorAll('input[name="timePeriod"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                this.switchTimePeriod(e.target.value);
            });
        });

        // 查询按钮事件
        document.getElementById('dayQueryBtn').addEventListener('click', () => this.performComparison('day'));
        document.getElementById('weekQueryBtn').addEventListener('click', () => this.performComparison('week'));
        document.getElementById('monthQueryBtn').addEventListener('click', () => this.performComparison('month'));
        document.getElementById('yearQueryBtn').addEventListener('click', () => this.performComparison('year'));
    }

    switchTimePeriod(period) {
        this.currentPeriod = period;

        // 隐藏所有选择器
        document.querySelectorAll('.time-selector').forEach(selector => {
            selector.style.display = 'none';
        });

        // 显示对应的选择器
        document.getElementById(period + 'Selection').style.display = 'block';

        // 更新徽章
        const badges = {
            'day': '日对比',
            'week': '周对比',
            'month': '月对比',
            'year': '年对比'
        };
        document.getElementById('comparisonPeriodBadge').textContent = badges[period];
    }

    async performComparison(period) {
        const params = this.getComparisonParams(period);
        if (!params) return;

        try {
            // 显示加载状态
            this.showLoading();

            // 调用API获取对比数据
            const response = await fetch('/reports/api/cargo_volume_comparison', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').getAttribute('content')
                },
                body: JSON.stringify({
                    period: period,
                    ...params
                })
            });

            if (!response.ok) {
                throw new Error('网络请求失败');
            }

            const data = await response.json();
            this.displayComparisonResult(data, period);

        } catch (error) {
            console.error('对比查询失败:', error);
            this.showError('查询失败，请重试');
        }
    }

    getComparisonParams(period) {
        switch (period) {
            case 'day':
                const startDate = document.getElementById('dayStartDate').value;
                const endDate = document.getElementById('dayEndDate').value;
                if (!startDate || !endDate) {
                    alert('请选择开始和结束日期');
                    return null;
                }
                return { startDate, endDate };

            case 'week':
                const weekYear = document.getElementById('weekYear').value;
                const weekFirst = document.getElementById('weekFirst').value;
                const weekSecond = document.getElementById('weekSecond').value;

                if (!weekYear || !weekFirst || !weekSecond) {
                    alert('请选择年份和两个对比周');
                    return null;
                }

                // 获取周的实际日期范围
                const firstOption = document.getElementById('weekFirst').querySelector(`option[value="${weekFirst}"]`);
                const secondOption = document.getElementById('weekSecond').querySelector(`option[value="${weekSecond}"]`);

                return {
                    year: weekYear,
                    week1: weekFirst,
                    week2: weekSecond,
                    week1_start: firstOption?.getAttribute('data-start-date'),
                    week1_end: firstOption?.getAttribute('data-end-date'),
                    week2_start: secondOption?.getAttribute('data-start-date'),
                    week2_end: secondOption?.getAttribute('data-end-date')
                };

            case 'month':
                const monthYear = document.getElementById('monthYear').value;
                const monthFirst = document.getElementById('monthFirst').value;
                const monthSecond = document.getElementById('monthSecond').value;
                return { year: monthYear, month1: monthFirst, month2: monthSecond };

            case 'year':
                const yearFirst = document.getElementById('yearFirst').value;
                const yearSecond = document.getElementById('yearSecond').value;
                return { year1: yearFirst, year2: yearSecond };

            default:
                return null;
        }
    }

    showLoading() {
        const resultArea = document.getElementById('comparisonResultArea');
        const content = document.getElementById('comparisonContent');

        content.innerHTML = `
            <div class="text-center py-4">
                <div class="loading-spinner"></div>
                <span>正在查询对比数据...</span>
            </div>
        `;

        resultArea.style.display = 'block';
    }

    showError(message) {
        const content = document.getElementById('comparisonContent');
        content.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${message}
            </div>
        `;
    }

    displayComparisonResult(data, period) {
        const content = document.getElementById('comparisonContent');

        // 生成对比结果HTML
        const html = this.generateComparisonHTML(data, period);
        content.innerHTML = html;

        // 如果有图表数据，渲染图表
        if (data.chartData) {
            this.renderComparisonChart(data.chartData);
        }
    }

    generateComparisonHTML(data, period) {
        const { period1, period2, comparison } = data;

        return `
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0">${period1.label}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="small text-muted">进货</div>
                                    <div class="fw-bold">${period1.inbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">出货</div>
                                    <div class="fw-bold">${period1.outbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">板数</div>
                                    <div class="fw-bold">${period1.pallets || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">件数</div>
                                    <div class="fw-bold">${period1.packages || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">${period2.label}</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="small text-muted">进货</div>
                                    <div class="fw-bold">${period2.inbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">出货</div>
                                    <div class="fw-bold">${period2.outbound || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">板数</div>
                                    <div class="fw-bold">${period2.pallets || 0}</div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">件数</div>
                                    <div class="fw-bold">${period2.packages || 0}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0">对比分析</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="small text-muted">进货变化</div>
                                    <div class="fw-bold ${comparison.inbound_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.inbound_change >= 0 ? '+' : ''}${comparison.inbound_change}
                                        <small>(${comparison.inbound_percent >= 0 ? '+' : ''}${comparison.inbound_percent}%)</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">出货变化</div>
                                    <div class="fw-bold ${comparison.outbound_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.outbound_change >= 0 ? '+' : ''}${comparison.outbound_change}
                                        <small>(${comparison.outbound_percent >= 0 ? '+' : ''}${comparison.outbound_percent}%)</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">板数变化</div>
                                    <div class="fw-bold ${comparison.pallets_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.pallets_change >= 0 ? '+' : ''}${comparison.pallets_change}
                                        <small>(${comparison.pallets_percent >= 0 ? '+' : ''}${comparison.pallets_percent}%)</small>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="small text-muted">件数变化</div>
                                    <div class="fw-bold ${comparison.packages_change >= 0 ? 'text-success' : 'text-danger'}">
                                        ${comparison.packages_change >= 0 ? '+' : ''}${comparison.packages_change}
                                        <small>(${comparison.packages_percent >= 0 ? '+' : ''}${comparison.packages_percent}%)</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-3">
                <div class="col-12">
                    <div class="bg-white p-3 rounded border">
                        <h6 class="mb-3">对比趋势图</h6>
                        <div id="comparisonTrendChart" style="height: 300px;"></div>
                    </div>
                </div>
            </div>
        `;
    }

    renderComparisonChart(chartData) {
        if (typeof echarts === 'undefined') {
            console.error('ECharts未加载');
            return;
        }

        const chartDom = document.getElementById('comparisonTrendChart');
        const myChart = echarts.init(chartDom);

        const option = {
            title: {
                text: '货量对比趋势',
                left: 'center'
            },
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['进货量', '出货量'],
                top: 30
            },
            xAxis: {
                type: 'category',
                data: chartData.categories
            },
            yAxis: {
                type: 'value'
            },
            series: [
                {
                    name: '进货量',
                    type: 'bar',
                    data: chartData.inbound,
                    itemStyle: { color: '#007bff' }
                },
                {
                    name: '出货量',
                    type: 'bar',
                    data: chartData.outbound,
                    itemStyle: { color: '#28a745' }
                }
            ]
        };

        myChart.setOption(option);
    }
}

// 初始化仪表板
document.addEventListener('DOMContentLoaded', function() {
    // 初始化时间对比管理器
    window.timeComparison = new TimeComparisonManager();

    // 检查必要的元素是否存在
    const requiredElements = [
        'overviewCards',
        'warehouseCardsGrid',
        'refreshBtn'
    ];

    let missingElements = [];
    requiredElements.forEach(id => {
        if (!document.getElementById(id)) {
            missingElements.push(id);
        }
    });

    if (missingElements.length > 0) {
        console.error('❌ 缺少必要的页面元素:', missingElements);
        return;
    }

    // 初始化仪表板
    try {
        if (typeof CargoVolumeDashboard !== 'undefined') {
            window.dashboard = new CargoVolumeDashboard();
        }
    } catch (error) {
        console.error('❌ 仪表板初始化失败:', error);

        // 显示错误信息
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger mt-3';
        errorDiv.innerHTML = `
            <h6><i class="fas fa-exclamation-triangle"></i> 仪表板加载失败</h6>
            <p class="mb-0">请刷新页面重试，或联系系统管理员。</p>
        `;
        document.querySelector('.dashboard-container').prepend(errorDiv);
    }
});
</script>
{% endblock %}
