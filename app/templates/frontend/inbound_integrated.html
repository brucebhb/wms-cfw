{% extends "base.html" %}

{% block title %}前端仓入库操作{% endblock %}

{% block head %}

<style>
/* 确保表头显示 */
#pendingReceiveTable thead {
    position: sticky;
    top: 0;
    z-index: 10;
}

#pendingReceiveTable thead th {
    background-color: #198754 !important;
    color: white !important;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    white-space: nowrap;
    padding: 12px 8px;
    vertical-align: middle;
    text-align: center;
}

#pendingReceiveTable tbody td {
    padding: 8px;
    vertical-align: middle;
    white-space: nowrap;
    text-align: center;
}

/* 表格容器样式 */
.table-responsive {
    max-height: 70vh;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

/* 确保表格宽度 */
#pendingReceiveTable {
    min-width: 1000px;
    margin-bottom: 0;
}

/* 列宽设置 */
#pendingReceiveTable th:nth-child(1) { width: 50px; }   /* 选择框 */
#pendingReceiveTable th:nth-child(2) { width: 150px; }  /* 批次号 */
#pendingReceiveTable th:nth-child(3) { width: 120px; }  /* 送货干线车 */
#pendingReceiveTable th:nth-child(4) { width: 120px; }  /* 发货时间 */
#pendingReceiveTable th:nth-child(5) { width: 120px; }  /* 发货仓 */
#pendingReceiveTable th:nth-child(6) { width: 120px; }  /* 接收仓 */
#pendingReceiveTable th:nth-child(7) { width: 80px; }   /* 总票数 */
#pendingReceiveTable th:nth-child(8) { width: 150px; }  /* 操作 */

/* 批次接收模态框样式 */
.custom-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 10001;
    justify-content: center;
    align-items: center;
}

.custom-modal .modal-content {
    background-color: white;
    min-width: 80%;
    max-height: 90vh;
    position: relative;
    z-index: 10002;
    border-radius: 5px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.modal-header-fixed {
    position: sticky;
    top: 0;
    background: white;
    z-index: 1030;
    padding: 15px 15px 0;
    border-bottom: 1px solid #dee2e6;
    border-top-left-radius: 4px;
    border-top-right-radius: 4px;
}

.modal-footer-fixed {
    position: sticky;
    bottom: 0;
    background: white;
    z-index: 1030;
    padding: 15px;
    border-top: 1px solid #dee2e6;
    border-bottom-left-radius: 4px;
    border-bottom-right-radius: 4px;
    text-align: right;
}

.modal-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1040;
    color: #555;
    transition: color 0.2s;
}

.modal-close:hover {
    color: #000;
}

.modal-header {
    padding-right: 30px;
    font-size: 1.2em;
    font-weight: bold;
    color: #28a745;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.modal-header i {
    font-size: 1.5em;
    margin-right: 10px;
}

/* 确保模态框内的按钮可点击 */
#batchReceiveModal button {
    position: relative;
    z-index: 10003;
    pointer-events: auto;
    cursor: pointer;
}
#pendingReceiveTable th:nth-child(5) { width: 80px; }   /* 板数 */
#pendingReceiveTable th:nth-child(6) { width: 80px; }   /* 件数 */
#pendingReceiveTable th:nth-child(7) { width: 100px; }  /* 重量 */
#pendingReceiveTable th:nth-child(8) { width: 100px; }  /* 体积 */
#pendingReceiveTable th:nth-child(9) { width: 120px; }  /* 发货时间 */
#pendingReceiveTable th:nth-child(10) { width: 80px; }  /* 单据份数 */
#pendingReceiveTable th:nth-child(11) { width: 100px; } /* 跟单客服 */
#pendingReceiveTable th:nth-child(12) { width: 80px; }  /* 批次序号 */
#pendingReceiveTable th:nth-child(13) { width: 120px; } /* 备注1 */
#pendingReceiveTable th:nth-child(14) { width: 120px; } /* 备注2 */
#pendingReceiveTable th:nth-child(15) { width: 120px; } /* 操作 */

/* 新增入库表单样式 */
.inbound-form {
    background-color: #f8f9fa;
    border-radius: 0.375rem;
    padding: 20px;
    margin-bottom: 20px;
}

/* 标签页样式 */
.nav-tabs .nav-link {
    color: #198754;
    border-color: transparent;
}

.nav-tabs .nav-link.active {
    color: #fff;
    background-color: #198754;
    border-color: #198754;
}

.nav-tabs .nav-link:hover {
    border-color: #198754;
    color: #198754;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-warehouse me-2"></i>前端仓入库操作
                        <span class="badge bg-light text-success ms-2">Frontend Warehouse</span>
                    </h3>
                </div>
                <div class="card-body">
                    <p class="card-text mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        平湖仓、昆山仓、成都仓货物接收和新增入库操作
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 标签页导航 -->
    <div class="row mb-3">
        <div class="col-12">
            <ul class="nav nav-tabs" id="inboundTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="receive-tab" data-bs-toggle="tab" data-bs-target="#receive-pane" type="button" role="tab">
                        <i class="fas fa-download me-2"></i>接收货物
                        <span class="badge bg-warning text-dark ms-2" id="pendingCount">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inbound-tab" data-bs-toggle="tab" data-bs-target="#inbound-pane" type="button" role="tab">
                        <i class="fas fa-plus me-2"></i>新增入库
                    </button>
                </li>

            </ul>
        </div>
    </div>

    <!-- 标签页内容 -->
    <div class="tab-content" id="inboundTabContent">
        <!-- 接收货物标签页 -->
        <div class="tab-pane fade show active" id="receive-pane" role="tabpanel">
            <!-- 操作按钮栏 -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-success" id="receiveSelectedBtn" disabled>
                                        <i class="fas fa-check me-1"></i>接收选中
                                    </button>
                                    <button type="button" class="btn btn-primary" id="addNewBtn">
                                        <i class="fas fa-plus me-1"></i>新增入库
                                    </button>
                                    <a href="{{ url_for('main.inbound') }}" class="btn btn-warning">
                                        <i class="fas fa-upload me-1"></i>批量导入
                                    </a>
                                    <button type="button" class="btn btn-info" id="refreshBtn">
                                        <i class="fas fa-sync me-1"></i>刷新数据
                                    </button>

                                </div>
                                <div class="text-muted">
                                    <small><i class="fas fa-info-circle me-1"></i>选择北投仓发来的货物进行接收，或新增直接入库</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



            <!-- 待接收货物列表 -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-list me-2"></i>北投仓发货批次列表（待接收）
                                <span class="badge bg-secondary ms-2" id="dataCount">0</span>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover table-sm" id="pendingReceiveTable">
                                    <thead class="table-success" style="position: sticky; top: 0; z-index: 10;">
                                        <tr style="background-color: #198754;">
                                            <th scope="col" style="width: 50px; background-color: #198754; color: white;" class="text-center">
                                                <input type="checkbox" id="selectAll" class="form-check-input">
                                            </th>
                                            <th scope="col" style="width: 150px; background-color: #198754; color: white;" class="text-center">批次号</th>
                                            <th scope="col" style="width: 120px; background-color: #198754; color: white;" class="text-center">送货干线车</th>
                                            <th scope="col" style="width: 120px; background-color: #198754; color: white;" class="text-center">发货时间</th>
                                            <th scope="col" style="width: 120px; background-color: #198754; color: white;" class="text-center">发货仓</th>
                                            <th scope="col" style="width: 120px; background-color: #198754; color: white;" class="text-center">接收仓</th>
                                            <th scope="col" style="width: 80px; background-color: #198754; color: white;" class="text-center">总票数</th>
                                            <th scope="col" style="width: 150px; background-color: #198754; color: white;" class="text-center">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pendingReceiveTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-4">
                                                <i class="fas fa-spinner fa-spin me-2"></i>正在加载数据...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 新增入库标签页 -->
        <div class="tab-pane fade" id="inbound-pane" role="tabpanel">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-plus-circle me-2"></i>新增入库录入
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="newInboundForm" class="inbound-form">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="inbound_time" class="form-label">入库时间</label>
                                            <input type="datetime-local" class="form-control" id="inbound_time" name="inbound_time" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="plate_number" class="form-label">入库车牌</label>
                                            <input type="text" class="form-control" id="plate_number" name="plate_number" placeholder="请输入车牌号">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customer_name" class="form-label">客户名称 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="customer_name" name="customer_name" required placeholder="请输入客户名称">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="order_type" class="form-label">订单类型</label>
                                            <select class="form-select" id="order_type" name="order_type">
                                                <option value="">请选择订单类型</option>
                                                <option value="原车出境">原车出境</option>
                                                <option value="换车出境">换车出境</option>
                                                <option value="零担">零担</option>
                                                <option value="TP订单">TP订单</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="export_mode" class="form-label">出境模式</label>
                                            <select class="form-select" id="export_mode" name="export_mode">
                                                <option value="">请选择出境模式</option>
                                                <option value="保税">保税</option>
                                                <option value="清关">清关</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customs_broker" class="form-label">报关行 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="customs_broker" name="customs_broker" required placeholder="请输入报关行">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="service_staff" class="form-label">跟单客服 <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="service_staff" name="service_staff" required placeholder="请输入跟单客服">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="pallet_count" class="form-label">板数</label>
                                            <input type="number" step="1" min="0" class="form-control" id="pallet_count" name="pallet_count" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="package_count" class="form-label">件数</label>
                                            <input type="number" step="1" min="0" class="form-control" id="package_count" name="package_count" placeholder="0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="weight" class="form-label">重量(kg)</label>
                                            <input type="number" step="0.1" class="form-control" id="weight" name="weight" placeholder="0.0">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="volume" class="form-label">体积(m³)</label>
                                            <input type="number" step="0.01" class="form-control" id="volume" name="volume" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="documents" class="form-label">单据份数</label>
                                            <input type="number" class="form-control" id="documents" name="documents" placeholder="0">
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="remark1" class="form-label">备注1</label>
                                            <textarea class="form-control" id="remark1" name="remark1" rows="2" placeholder="请输入备注信息"></textarea>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="remark2" class="form-label">备注2</label>
                                            <textarea class="form-control" id="remark2" name="remark2" rows="2" placeholder="请输入备注信息"></textarea>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-secondary me-2" id="cancelNewBtn">
                                                <i class="fas fa-times me-1"></i>取消
                                            </button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save me-1"></i>保存入库
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 接收确认模态框 -->
<div class="modal fade" id="receiveModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>确认接收
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    您即将接收以下货物，请确认信息无误：
                </div>
                <div id="receiveDetails">
                    <!-- 动态加载接收详情 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-success" id="confirmReceiveBtn">
                    <i class="fas fa-check me-1"></i>确认接收
                </button>
            </div>
        </div>
    </div>
</div>





<!-- 批次接收模态框 -->
<div class="modal fade" id="batchReceiveModal" tabindex="-1" aria-labelledby="batchReceiveModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchReceiveModalLabel">
                    <i class="fas fa-check-circle text-success me-2"></i>批次接收操作
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="batchReceiveTime" class="form-label">接收时间 <span class="text-danger">*</span></label>
                        <input type="datetime-local" class="form-control" id="batchReceiveTime" required>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">批次信息</label>
                        <div class="p-2 bg-light rounded">
                            <span id="batchInfoDisplay">批次号: - | 送货干线车: - | 票数: -</span>
                        </div>
                    </div>
                </div>

                <div class="table-responsive" style="max-height: 75vh; overflow-y: auto;">
                    <table class="table table-striped table-hover table-sm" id="batchReceiveTable" style="min-width: 2400px;">
                        <thead class="table-success sticky-top">
                            <tr>
                                <th class="text-center" style="width: 60px; min-width: 60px;">选择</th>
                                <th class="text-center" style="width: 80px; min-width: 80px;">序号</th>
                                <th class="text-center" style="width: 120px; min-width: 120px;">发货时间</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">出库车牌</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">入库车牌</th>
                                <th class="text-center" style="width: 140px; min-width: 140px;">客户名称</th>
                                <th class="text-center" style="width: 140px; min-width: 140px;">识别编码</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">订单类型</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">目的地</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">报关行</th>
                                <th class="text-center" style="width: 90px; min-width: 90px;">送货板数</th>
                                <th class="text-center" style="width: 90px; min-width: 90px;">送货件数</th>
                                <th class="text-center" style="width: 90px; min-width: 90px;">接收板数</th>
                                <th class="text-center" style="width: 90px; min-width: 90px;">接收件数</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">重量(kg)</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">体积(m³)</th>
                                <th class="text-center" style="width: 90px; min-width: 90px;">单据份数</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">跟单客服</th>
                                <th class="text-center" style="width: 120px; min-width: 120px;">备注1</th>
                                <th class="text-center" style="width: 120px; min-width: 120px;">备注2</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">操作仓库</th>
                                <th class="text-center" style="width: 90px; min-width: 90px;">差异状态</th>
                                <th class="text-center" style="width: 160px; min-width: 160px;">接收备注</th>
                                <th class="text-center" style="width: 100px; min-width: 100px;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="batchReceiveTableBody">
                            <!-- 批次货物明细数据 -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-info me-2" id="selectAllBtn">
                    <i class="fas fa-check-square me-1"></i>全选
                </button>
                <button type="button" class="btn btn-warning me-2" id="receiveAllBtn">
                    <i class="fas fa-download me-1"></i>全收
                </button>
                <button type="button" class="btn btn-success" id="confirmBatchReceiveBtn">
                    <i class="fas fa-check me-1"></i>确认接收选中货物
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // 前端仓整合入库页面的JavaScript代码
    console.log('前端仓整合入库页面已加载');

    // 初始化页面
    initializePage();

    function initializePage() {
        // 设置默认入库时间为当前时间
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        $('#inbound_time').val(localDateTime);

        // 加载待接收批次数据
        loadPendingBatchData();
    }

    // 按批次号分组并汇总数据
    function groupAndSummarizeByBatch(rawData) {
        const batchGroups = {};

        // 按批次号分组
        rawData.forEach(item => {
            if (!batchGroups[item.batch_no]) {
                batchGroups[item.batch_no] = [];
            }
            batchGroups[item.batch_no].push(item);
        });

        // 汇总每个批次的数据
        const summarizedData = [];
        Object.keys(batchGroups).forEach(batchNo => {
            const items = batchGroups[batchNo];
            const firstItem = items[0];

            // 计算汇总数据
            const totalPalletCount = items.reduce((sum, item) => sum + item.pallet_count, 0);
            const totalPackageCount = items.reduce((sum, item) => sum + item.package_count, 0);
            const totalWeight = items.reduce((sum, item) => sum + item.weight, 0);
            const totalVolume = items.reduce((sum, item) => sum + item.volume, 0);
            const totalDocuments = items.reduce((sum, item) => sum + item.documents, 0);

            // 创建汇总记录
            summarizedData.push({
                id: firstItem.id, // 使用第一票的ID作为批次ID
                batch_no: batchNo,
                warehouse: firstItem.warehouse,
                customer_name: firstItem.customer_name,
                pallet_count: totalPalletCount,
                package_count: totalPackageCount,
                weight: totalWeight,
                volume: totalVolume,
                departure_time: firstItem.departure_time,
                documents: totalDocuments,
                service_staff: firstItem.service_staff,
                batch_sequence: `汇总(${items.length}票)`,
                remark1: firstItem.remark1,
                remark2: firstItem.remark2,
                ticket_count: items.length, // 票数
                items: items // 保存原始票据数据
            });
        });

        return summarizedData;
    }

    function loadPendingBatchData() {
        console.log('加载待接收批次数据...');

        // 显示加载状态
        $('#pendingReceiveTableBody').html(`
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>正在加载数据...
                </td>
            </tr>
        `);

        // 调用前端仓批次API
        fetch('/api/frontend/pending-receive-batches', {
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                console.log('待接收批次数据:', data);

                if (data.success) {
                    displayPendingBatchData(data.batches);
                } else {
                    console.error('加载数据失败:', data.message);
                    $('#pendingReceiveTableBody').html(`
                        <tr>
                            <td colspan="8" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>加载数据失败: ${data.message}
                            </td>
                        </tr>
                    `);
                }
            })
            .catch(error => {
                console.error('请求失败:', error);
                $('#pendingReceiveTableBody').html(`
                    <tr>
                        <td colspan="8" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>网络请求失败
                        </td>
                    </tr>
                `);
            });
    }

    // 显示待接收批次数据（分组显示）
    function displayPendingBatchData(data) {
        console.log('displayPendingBatchData被调用，数据:', data);
        console.log('数据类型:', typeof data, '数组长度:', data ? data.length : 'N/A');

        if (!data || data.length === 0) {
            console.log('数据为空，显示空状态');
            $('#pendingReceiveTableBody').html(`
                <tr>
                    <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-info-circle me-2"></i>暂无待接收批次
                    </td>
                </tr>
            `);
            $('#pendingCount').text('0');
            $('#dataCount').text('0');

            return;
        }

        console.log('开始生成HTML，批次数量:', data.length);
        let html = '';
        data.forEach((batch, index) => {
            console.log(`处理批次 ${index + 1}:`, batch);
            // 构建批次键用于标识唯一批次（使用仓库ID避免中文编码问题）
            const batchKey = `${batch.batch_no || 'NOBATCH'}_${batch.delivery_plate_number || 'NOPLATE'}_${batch.source_warehouse_id}_${batch.destination_warehouse_id}`;
            console.log(`生成的batchKey: ${batchKey}`);

            html += `
                <tr>
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input row-checkbox" value="${batchKey}" data-batch-key="${batchKey}">
                    </td>
                    <td class="text-center">
                        <strong class="text-primary">${batch.batch_no || '-'}</strong>
                    </td>
                    <td class="text-center">
                        <strong class="text-info">${batch.delivery_plate_number || '-'}</strong>
                    </td>
                    <td class="text-center">${batch.outbound_time || '-'}</td>
                    <td class="text-center">
                        <span class="badge bg-warning">${batch.source_warehouse || '-'}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-success">${batch.destination_warehouse || '-'}</span>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info">${batch.item_count || 0}</span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-info me-1" onclick="showBatchDetail('${batchKey}')">
                            <i class="fas fa-eye"></i> 查看明细
                        </button>
                        <button class="btn btn-sm btn-success" onclick="receiveBatch('${batchKey}')">
                            <i class="fas fa-check"></i> 接收
                        </button>
                    </td>
                </tr>
            `;
        });

        console.log('生成的HTML长度:', html.length);
        console.log('HTML前200字符:', html.substring(0, 200));
        console.log('设置表格内容...');
        $('#pendingReceiveTableBody').html(html);
        console.log('设置计数器...');
        $('#pendingCount').text(data.length);
        $('#dataCount').text(data.length);

        console.log('displayPendingBatchData完成');

        // 绑定行选择事件
        $('.row-checkbox').on('change', function() {
            updateReceiveButton();
        });
    }

    // 接收单个货物
    window.receiveItem = function(itemId) {
        console.log('接收货物:', itemId);

        if (confirm('确认接收这个货物吗？')) {
            // 发送接收请求
            fetch('/api/frontend/receive-item', {
                method: 'POST',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    item_id: itemId,
                    receive_time: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (typeof showSuccess === 'function') {
                        showSuccess('货物接收成功！已生成入库记录和库存更新');
                    } else if (typeof showMessage === 'function') {
                        showMessage('货物接收成功！已生成入库记录和库存更新', MessageType.SUCCESS);
                    } else {
                        alert('货物接收成功！已生成入库记录和库存更新');
                    }
                    loadPendingBatchData(); // 刷新数据
                } else {
                    if (typeof showError === 'function') {
                        showError('接收失败: ' + data.message);
                    } else {
                        alert('接收失败: ' + data.message);
                    }
                }
            })
            .catch(error => {
                console.error('接收失败:', error);
                if (typeof showError === 'function') {
                    showError('接收失败');
                } else {
                    alert('接收失败');
                }
            });
        }
    };





    // 确认批次接收
    $(document).on('click', '#confirmBatchReceiveBtn', function() {
        const batchNo = $('#modalBatchNumber').text();
        const receiveTime = $('#receiveTime').val();

        if (!receiveTime) {
            alert('请选择接收时间');
            return;
        }

        // 收集所有货物的接收数据
        const items = [];
        $('#batchReceiveTableBody tr').each(function() {
            const row = $(this);
            const itemId = row.data('item-id');
            const actualPallet = parseFloat(row.find('.actual-pallet').val()) || 0;
            const actualPackage = parseFloat(row.find('.actual-package').val()) || 0;
            const actualWeight = parseFloat(row.find('.actual-weight').val()) || 0;
            const actualVolume = parseFloat(row.find('.actual-volume').val()) || 0;
            const receiveRemark = row.find('.receive-remark').val() || '';

            items.push({
                id: itemId,
                actual_pallet_count: actualPallet,
                actual_package_count: actualPackage,
                actual_weight: actualWeight,
                actual_volume: actualVolume,
                receive_remark: receiveRemark
            });
        });

        // 显示确认对话框
        if (!confirm(`确定要接收批次 ${batchNo} 的所有货物吗？共 ${items.length} 个货物。`)) {
            return;
        }

        // 禁用按钮，显示加载状态
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>处理中...');

        // 调用批次接收API
        fetch('/api/frontend/batch-receive', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                batch_no: batchNo,
                receive_time: receiveTime,
                items: items
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示成功消息
                if (typeof showSuccess === 'function') {
                    showSuccess('批次接收成功！已生成入库记录和库存更新');
                } else if (typeof showMessage === 'function') {
                    showMessage('批次接收成功！已生成入库记录和库存更新', MessageType.SUCCESS);
                } else {
                    alert('批次接收成功！已生成入库记录和库存更新');
                }

                const modal = bootstrap.Modal.getInstance(document.getElementById('batchReceiveModal'));
                if (modal) {
                    modal.hide();
                }
                loadPendingBatchData(); // 重新加载数据
            } else {
                if (typeof showError === 'function') {
                    showError('批次接收失败: ' + data.message);
                } else {
                    alert('批次接收失败: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('批次接收失败:', error);
            if (typeof showError === 'function') {
                showError('批次接收失败，请重试');
            } else {
                alert('批次接收失败，请重试');
            }
        })
        .finally(() => {
            // 恢复按钮状态
            btn.prop('disabled', false).html(originalText);
        });
    });

    // 刷新按钮事件
    $('#refreshBtn').click(function() {
        console.log('刷新数据');
        loadPendingBatchData();
    });

    // 查看批次明细
    window.showBatchDetail = function(batchKey) {
        console.log('查看批次明细:', batchKey);

        // 获取批次明细数据
        fetch(`/api/frontend/batch-details/${batchKey}`, {
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayBatchDetails(data.items, batchKey);
                } else {
                    alert('获取批次明细失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('获取批次明细失败:', error);
                alert('获取批次明细失败');
            });
    };

    // 接收批次
    window.receiveBatch = function(batchKey) {
        console.log('接收批次:', batchKey);

        // 获取批次明细数据用于接收
        fetch(`/api/frontend/batch-details/${batchKey}`, {
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showBatchReceiveModal(data.items, batchKey);
                } else {
                    alert('获取批次数据失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('获取批次数据失败:', error);
                alert('获取批次数据失败');
            });
    };

    // 显示批次明细（只读模态框）
    function displayBatchDetails(items, batchKey) {
        // 这里可以复用 receive_batch.html 中的明细显示逻辑
        // 为了简化，暂时使用alert显示
        let details = `批次明细 (${batchKey}):\n\n`;
        items.forEach((item, index) => {
            details += `${index + 1}. ${item.customer_name} (${item.batch_sequence_display})\n`;
            details += `   板数: ${item.pallet_count}, 件数: ${item.package_count}\n`;
            details += `   重量: ${item.weight}kg, 体积: ${item.volume}m³\n\n`;
        });
        alert(details);
    }

    // 显示批次接收模态框
    function showBatchReceiveModal(items, batchKey) {
        console.log('显示批次接收模态框:', batchKey, items);

        // 解析批次键获取批次信息
        const keyParts = batchKey.split('_');
        const batchNo = keyParts[0] || 'N/A';
        const deliveryPlate = keyParts[1] || 'N/A';

        // 设置批次信息显示
        $('#batchInfoDisplay').text(`批次号: ${batchNo} | 送货干线车: ${deliveryPlate} | 票数: ${items.length}`);

        // 设置默认接收时间为当前时间
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        $('#batchReceiveTime').val(localDateTime);

        // 填充表格数据
        let html = '';
        items.forEach((item, index) => {
            const originalPallet = item.pallet_count || 0;
            const originalPackage = item.package_count || 0;

            html += `
                <tr data-item-id="${item.id}" class="receive-item-row">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input receive-item-checkbox" checked>
                    </td>
                    <td class="text-center">
                        <span class="badge bg-info">${item.batch_sequence_display || (index + 1)}</span>
                    </td>
                    <td class="text-center">${item.outbound_time || '-'}</td>
                    <td class="text-center">${item.plate_number || '-'}</td>
                    <td class="text-center">${item.inbound_plate || '-'}</td>
                    <td class="text-center">${item.customer_name || '-'}</td>
                    <td class="text-center">${item.identification_code || '-'}</td>
                    <td class="text-center">${item.order_type || '-'}</td>
                    <td class="text-center">${item.destination || '-'}</td>
                    <td class="text-center">${item.customs_broker || '-'}</td>
                    <td class="text-center">
                        <strong>${originalPallet}</strong>
                    </td>
                    <td class="text-center">
                        <strong>${originalPackage}</strong>
                    </td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm received-pallet-input"
                               value="${originalPallet}" min="0" step="1"
                               data-original="${originalPallet}" style="width: 70px;">
                    </td>
                    <td class="text-center">
                        <input type="number" class="form-control form-control-sm received-package-input"
                               value="${originalPackage}" min="0" step="1"
                               data-original="${originalPackage}" style="width: 70px;">
                    </td>
                    <td class="text-center">${item.weight || 0}</td>
                    <td class="text-center">${item.volume || 0}</td>
                    <td class="text-center">${item.documents || '-'}</td>
                    <td class="text-center">${item.service_staff || '-'}</td>
                    <td class="text-center">${item.remark1 || '-'}</td>
                    <td class="text-center">${item.remark2 || '-'}</td>
                    <td class="text-center">${item.operated_warehouse || '-'}</td>
                    <td class="text-center">
                        <span class="badge bg-success discrepancy-status">正常</span>
                    </td>
                    <td class="text-center">
                        <input type="text" class="form-control form-control-sm receive-notes-input"
                               placeholder="异常说明" style="width: 140px;">
                    </td>
                    <td class="text-center">
                        <button type="button" class="btn btn-sm btn-warning full-receive-btn"
                                data-pallet="${originalPallet}" data-package="${originalPackage}">
                            <i class="fas fa-download"></i> 全收
                        </button>
                    </td>
                </tr>
            `;
        });

        $('#batchReceiveTableBody').html(html);

        // 绑定事件
        bindReceiveModalEvents();

        // 存储批次键和批次号供后续使用
        $('#batchReceiveModal').data('batchKey', batchKey);
        $('#batchReceiveModal').data('batchNo', batchNo);

        // 显示模态框 - 使用Bootstrap 5原生API
        console.log('准备显示模态框...');
        const modal = new bootstrap.Modal(document.getElementById('batchReceiveModal'));
        modal.show();
        console.log('模态框已显示');
    }

    // 更新差异状态
    function updateDiscrepancyStatus(row) {
        const palletInput = row.find('.received-pallet-input');
        const packageInput = row.find('.received-package-input');
        const statusBadge = row.find('.discrepancy-status');

        const originalPallet = parseInt(palletInput.data('original')) || 0;
        const originalPackage = parseInt(packageInput.data('original')) || 0;
        const receivedPallet = parseInt(palletInput.val()) || 0;
        const receivedPackage = parseInt(packageInput.val()) || 0;

        // 检查是否有差异
        if (receivedPallet !== originalPallet || receivedPackage !== originalPackage) {
            statusBadge.removeClass('bg-success').addClass('bg-warning').text('异常');
            row.addClass('table-warning');

            // 自动生成差异备注
            const notesInput = row.find('.receive-notes-input');
            let autoNotes = [];

            if (receivedPallet !== originalPallet) {
                autoNotes.push(`板数差异：发出${originalPallet}，接收${receivedPallet}`);
            }
            if (receivedPackage !== originalPackage) {
                autoNotes.push(`件数差异：发出${originalPackage}，接收${receivedPackage}`);
            }

            // 如果用户没有手动输入备注，则使用自动生成的备注
            if (!notesInput.val().trim()) {
                notesInput.val(autoNotes.join('；'));
            }
        } else {
            statusBadge.removeClass('bg-warning').addClass('bg-success').text('正常');
            row.removeClass('table-warning');

            // 如果数量一致，清空自动生成的差异备注（保留用户手动输入的备注）
            const notesInput = row.find('.receive-notes-input');
            const currentNotes = notesInput.val();
            if (currentNotes.includes('差异：')) {
                notesInput.val('');
            }
        }
    }

    // 绑定接收模态框事件
    function bindReceiveModalEvents() {
        // 数量变化事件
        $('.received-pallet-input, .received-package-input').on('input', function() {
            updateDiscrepancyStatus($(this).closest('tr'));
        });

        // 单个货物全收按钮
        $('.full-receive-btn').on('click', function() {
            const button = $(this);
            const row = button.closest('tr');
            const palletCount = parseInt(button.attr('data-pallet')) || 0;
            const packageCount = parseInt(button.attr('data-package')) || 0;

            // 填入全部数量
            row.find('.received-pallet-input').val(palletCount);
            row.find('.received-package-input').val(packageCount);
            row.find('.receive-item-checkbox').prop('checked', true);

            // 更新差异状态
            updateDiscrepancyStatus(row);

            console.log(`单个全收操作: 板数=${palletCount}, 件数=${packageCount}`);
        });
    }

    // 关闭批次接收模态框
    function closeBatchReceiveModal() {
        console.log('关闭模态框');
        const modal = bootstrap.Modal.getInstance(document.getElementById('batchReceiveModal'));
        if (modal) {
            modal.hide();
        }
        console.log('模态框已关闭');
    }

    // 全选按钮事件
    $('#selectAllBtn').click(function() {
        const isChecked = $('.receive-item-checkbox:checked').length < $('.receive-item-checkbox').length;
        $('.receive-item-checkbox').prop('checked', isChecked);

        const text = isChecked ? '取消全选' : '全选';
        $(this).html(`<i class="fas fa-${isChecked ? 'square' : 'check-square'} me-1"></i>${text}`);
    });

    // 全收按钮事件
    $('#receiveAllBtn').click(function() {
        $('.receive-item-row').each(function() {
            const row = $(this);
            const fullReceiveBtn = row.find('.full-receive-btn');
            const palletCount = parseInt(fullReceiveBtn.attr('data-pallet')) || 0;
            const packageCount = parseInt(fullReceiveBtn.attr('data-package')) || 0;

            // 填入全部数量
            row.find('.received-pallet-input').val(palletCount);
            row.find('.received-package-input').val(packageCount);
            row.find('.receive-item-checkbox').prop('checked', true);

            // 更新差异状态
            updateDiscrepancyStatus(row);
        });

        console.log('批量全收操作完成');
    });

    // 确认批次接收按钮事件
    $('#confirmBatchReceiveBtn').click(function() {
        const batchKey = $('#batchReceiveModal').data('batchKey');
        const batchNo = $('#batchReceiveModal').data('batchNo');
        const receiveTime = $('#batchReceiveTime').val();

        if (!receiveTime) {
            alert('请选择接收时间');
            return;
        }

        // 收集选中货物的接收数据
        const items = [];
        let hasError = false;
        let selectedCount = 0;

        $('#batchReceiveTableBody tr').each(function() {
            const row = $(this);
            const checkbox = row.find('.receive-item-checkbox');

            // 只处理选中的货物
            if (checkbox.is(':checked')) {
                selectedCount++;
                const itemId = row.data('item-id');
                const receivedPallet = parseInt(row.find('.received-pallet-input').val()) || 0;
                const receivedPackage = parseInt(row.find('.received-package-input').val()) || 0;
                const receiveNotes = row.find('.receive-notes-input').val().trim();

                // 验证必填字段
                if (receivedPallet < 0 || receivedPackage < 0) {
                    alert('接收数量不能为负数');
                    hasError = true;
                    return false;
                }

                items.push({
                    id: itemId,
                    received_pallet_count: receivedPallet,
                    received_package_count: receivedPackage,
                    receive_notes: receiveNotes
                });
            }
        });

        if (hasError) {
            return;
        }

        if (selectedCount === 0) {
            alert('请至少选择一个货物进行接收');
            return;
        }

        // 确认接收
        if (!confirm(`确认接收选中的 ${selectedCount} 个货物吗？`)) {
            return;
        }

        // 构建接收数据
        const receiveData = {
            batch_no: batchNo,
            receive_time: receiveTime,
            items: items
        };

        console.log('提交批次接收数据:', receiveData);

        // 禁用按钮，显示加载状态
        const btn = $(this);
        const originalText = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>处理中...');

        // 发送接收请求
        fetch('/api/frontend/batch-receive', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(receiveData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (typeof showSuccess === 'function') {
                    showSuccess(`成功接收 ${selectedCount} 个货物！`);
                } else if (typeof showMessage === 'function') {
                    showMessage(`成功接收 ${selectedCount} 个货物！`, MessageType.SUCCESS);
                } else {
                    alert(`成功接收 ${selectedCount} 个货物！`);
                }
                const modal = bootstrap.Modal.getInstance(document.getElementById('batchReceiveModal'));
                if (modal) {
                    modal.hide();
                }
                loadPendingBatchData(); // 重新加载数据
            } else {
                if (typeof showError === 'function') {
                    showError('批次接收失败: ' + data.message);
                } else {
                    alert('批次接收失败: ' + data.message);
                }
            }
        })
        .catch(error => {
            console.error('批次接收失败:', error);
            if (typeof showError === 'function') {
                showError('批次接收失败');
            } else {
                alert('批次接收失败');
            }
        })
        .finally(() => {
            // 恢复按钮状态
            btn.prop('disabled', false).html(originalText);
        });
    });

















    // 新增入库表单提交处理
    $('#newInboundForm').on('submit', function(e) {
        e.preventDefault();

        // 获取表单数据
        const formData = new FormData(this);
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }

        console.log('提交新增入库数据:', data);

        // 基本验证
        if (!data.customer_name || !data.customs_broker || !data.service_staff) {
            showError('请填写必填字段：客户名称、报关行、跟单客服');
            return;
        }

        // 验证板数和件数至少有一个不为空
        const palletCount = parseInt(data.pallet_count) || 0;
        const packageCount = parseInt(data.package_count) || 0;

        if (palletCount === 0 && packageCount === 0) {
            showError('板数和件数至少需要填写一个');
            return;
        }

        // 显示加载状态
        const submitBtn = $(this).find('button[type="submit"]');
        const originalText = submitBtn.html();
        submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>保存中...');

        // 提交数据
        fetch('/api/frontend/add-inbound', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': data.csrf_token
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            console.log('API响应数据:', result);
            console.log('API状态:', result.status || result.success ? 'success' : 'error');

            if (result.success || result.status === 'success') {
                console.log('保存成功:', result);

                // 显示自定义成功消息
                const message = result.message || '入库记录保存成功';
                console.log('显示自定义成功消息:', message);

                // 确保使用正确的成功类型
                if (typeof showSuccess === 'function') {
                    showSuccess(message);
                    console.log('使用showSuccess显示成功消息');
                } else if (typeof showMessage === 'function') {
                    showMessage(message, MessageType.SUCCESS);
                    console.log('使用showMessage显示成功消息');
                } else {
                    alert(message);
                    console.log('使用alert显示成功消息');
                }

                // 重置表单
                this.reset();

                // 设置默认时间
                const now = new Date();
                const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                $('#inbound_time').val(localDateTime);

                // 刷新待接收数据
                loadPendingBatchData();

                // 切换到接收货物标签页
                $('#receive-tab').tab('show');

            } else {
                console.error('保存失败:', result);
                const errorMessage = result.message || '保存失败，请重试';

                if (typeof showError === 'function') {
                    showError(errorMessage);
                } else {
                    alert('错误: ' + errorMessage);
                }
            }
        })
        .catch(error => {
            console.error('请求失败:', error);
            if (typeof showError === 'function') {
                showError('网络请求失败，请重试');
            } else {
                alert('网络请求失败，请重试');
            }
        })
        .finally(() => {
            // 恢复按钮状态
            submitBtn.prop('disabled', false).html(originalText);
        });
    });

    // 取消按钮处理
    $('#cancelNewBtn').on('click', function() {
        $('#newInboundForm')[0].reset();

        // 设置默认时间
        const now = new Date();
        const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
        $('#inbound_time').val(localDateTime);

        // 切换到接收货物标签页
        $('#receive-tab').tab('show');
    });

    // 新增入库按钮处理
    $('#addNewBtn').on('click', function() {
        $('#inbound-tab').tab('show');
    });

    // 重写消息函数以确保正确显示
    console.log('前端仓入库页面已加载');

    // 保存原始函数
    if (typeof window.showMessage === 'function') {
        window.originalShowMessage = window.showMessage;

        window.showMessage = function(message, type, options) {
            console.log('自定义showMessage被调用:', message, type);

            // 确保成功消息使用正确的类型
            if (message && (message.includes('成功') || message.includes('添加')) && type !== 'success') {
                console.log('修正消息类型从', type, '到 success');
                type = 'success';
            }

            // 调用原始函数
            return window.originalShowMessage(message, type, options);
        };

        console.log('消息函数已重写');
    }
});
</script>




{% endblock %}
