{% extends "base.html" %}

{% block title %}å‰ç«¯ä»“ç›´æ¥é…é€å®¢æˆ·{% endblock %}

{% block styles %}
<!-- ä¼˜åŒ–ç¼“å­˜ç­–ç•¥ - å…è®¸åˆç†ç¼“å­˜ä»¥æå‡æ€§èƒ½ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.css">
<link rel="stylesheet" href="{{ url_for('static', filename='css/simple-table.css') }}" type="text/css" />
<style>
    .batch-options {
        margin-bottom: 1rem;
    }
    #hot-container {
        height: 500px;
        overflow: visible;
        margin-bottom: 20px;
        margin-left: auto;
        margin-right: auto;
        position: relative;
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #fff;
    }

    /* ç¡®ä¿Handsontableæ­£ç¡®æ˜¾ç¤º */
    .handsontable .wtHolder {
        overflow: visible !important;
    }

    .handsontable .wtHider {
        width: 100% !important;
    }

    .handsontable .wtTable {
        table-layout: fixed !important;
        width: 100% !important;
    }

    .handsontable .wtTable td,
    .handsontable .wtTable th {
        border: 1px solid #ddd !important;
        box-sizing: border-box !important;
    }
    .handsontable {
        font-family: "Microsoft YaHei", Arial, sans-serif;
    }
    .handsontable td {
        height: 32px;
        padding: 4px 6px;
        font-size: 14px;
        text-align: center;
    }
    .handsontable th {
        height: 36px;
        padding: 6px;
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        background-color: #f8f9fa;
    }
    .handsontable .required {
        color: #ff0000;
    }
    .required {
        color: #dc3545 !important;
        font-weight: bold;
    }
    .btn-action {
        margin-right: 8px;
    }
    .card-body {
        text-align: left;
    }
    .destination-info {
        background-color: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .common-fields {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .form-row {
        margin-bottom: 15px;
    }
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    .form-control {
        border-radius: 4px;
        border: 1px solid #ced4da;
    }
    .form-control:focus {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }
    /* ä½¿ç”¨æœ€å¼ºçš„é€‰æ‹©å™¨ä¼˜å…ˆçº§å’Œå†…è”æ ·å¼çº§åˆ«çš„å¼ºåˆ¶è®¾ç½® */
    #inventoryModal.modal.fade .modal-dialog,
    #inventoryModal.modal.show .modal-dialog,
    #inventoryModal .modal-dialog {
        max-width: 95vw !important;
        width: 95vw !important;
        height: 90vh !important;
        max-height: 90vh !important;
        margin: 1rem auto !important;
        transform: none !important;
        left: 0 !important;
        right: 0 !important;
        position: relative !important;
    }

    #inventoryModal.modal.fade .modal-content,
    #inventoryModal.modal.show .modal-content,
    #inventoryModal .modal-content {
        height: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        border: none !important;
        border-radius: 0.5rem !important;
        width: 100% !important;
        max-width: none !important;
    }

    #inventoryModal.modal.fade .modal-body,
    #inventoryModal.modal.show .modal-body,
    #inventoryModal .modal-body {
        flex: 1 !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        padding: 1rem !important;
        min-height: 0 !important;
        width: 100% !important;
    }

    #inventoryModal.modal.fade .table-responsive,
    #inventoryModal.modal.show .table-responsive,
    #inventoryModal .table-responsive {
        flex: 1 !important;
        overflow-y: auto !important;
        max-height: calc(90vh - 200px) !important;
        border: 1px solid #dee2e6 !important;
        border-radius: 0.375rem !important;
        min-height: 400px !important;
        width: 100% !important;
    }

    /* å¼ºåˆ¶è¦†ç›–Bootstrapçš„æ‰€æœ‰å¯èƒ½é™åˆ¶ */
    .modal-dialog {
        max-width: none !important;
    }

    /* ç¡®ä¿æ¨¡æ€æ¡†å®Œå…¨å¡«å…… */
    #inventoryModal {
        padding: 0 !important;
    }
    .inventory-table {
        font-size: 14px;
        table-layout: fixed;  /* å›ºå®šè¡¨æ ¼å¸ƒå±€ */
        width: 100%;
    }
    .inventory-table th {
        background: #f8f9fa;
        font-weight: bold;
        text-align: center;
        vertical-align: middle;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    /* åº“å­˜è¡¨æ ¼å•å…ƒæ ¼æ ·å¼ */
    .inventory-table td {
        text-align: center;
        vertical-align: middle;
        padding: 8px 4px;
        word-wrap: break-word;
        word-break: break-all;
    }

    /* è®¾ç½®å„åˆ—çš„å®½åº¦ */
    .inventory-table th:nth-child(1), .inventory-table td:nth-child(1) { width: 8%; }  /* æ“ä½œ */
    .inventory-table th:nth-child(2), .inventory-table td:nth-child(2) { width: 12%; } /* å®¢æˆ·åç§° */
    .inventory-table th:nth-child(3), .inventory-table td:nth-child(3) {
        width: 20%; /* è¯†åˆ«ç¼–ç  - æ›´å®½ */
        word-wrap: break-word !important;
        word-break: break-all !important;
        white-space: normal !important;
        font-size: 12px;
        line-height: 1.3;
        text-align: left !important; /* è¯†åˆ«ç¼–ç å·¦å¯¹é½ */
        padding: 6px 8px !important;
    }
    .inventory-table th:nth-child(4), .inventory-table td:nth-child(4) { width: 6%; }  /* æ¿æ•° */
    .inventory-table th:nth-child(5), .inventory-table td:nth-child(5) { width: 6%; }  /* ä»¶æ•° */
    .inventory-table th:nth-child(6), .inventory-table td:nth-child(6) { width: 6%; }  /* å…¨å‡º */
    .inventory-table th:nth-child(7), .inventory-table td:nth-child(7) { width: 8%; }  /* å‡ºåº“æ¿æ•° */
    .inventory-table th:nth-child(8), .inventory-table td:nth-child(8) { width: 8%; }  /* å‡ºåº“ä»¶æ•° */
    .inventory-table th:nth-child(9), .inventory-table td:nth-child(9) { width: 6%; }  /* é‡é‡ */
    .inventory-table th:nth-child(10), .inventory-table td:nth-child(10) { width: 6%; } /* ä½“ç§¯ */
    .inventory-table th:nth-child(11), .inventory-table td:nth-child(11) { width: 8%; } /* åº“ä½ */
    .inventory-table th:nth-child(12), .inventory-table td:nth-child(12) { width: 6%; } /* å‡ºå¢ƒæ¨¡å¼ */
    .inventory-table th:nth-child(13), .inventory-table td:nth-child(13) { width: 6%; } /* è®¢å•ç±»å‹ */
    .inventory-table th:nth-child(14), .inventory-table td:nth-child(14) { width: 8%; } /* æŠ¥å…³è¡Œ */
    .inventory-table th:nth-child(15), .inventory-table td:nth-child(15) { width: 8%; } /* å…¥åº“æ—¶é—´ */

    /* åº“å­˜è¡¨æ ¼ä¸­çš„è¾“å…¥æ¡†æ ·å¼ */
    .outbound-pallet-input,
    .outbound-package-input {
        width: 80px !important;
        text-align: center !important;
        font-size: 12px !important;
        padding: 2px 4px !important;
    }

    /* å…¨å‡ºæŒ‰é’®æ ·å¼ */
    .btn-full-out {
        font-size: 11px !important;
        padding: 2px 6px !important;
        white-space: nowrap !important;
    }

    /* åº“å­˜è¡¨æ ¼è¡Œé«˜äº®æ•ˆæœ */
    .inventory-table tr.table-success {
        background-color: #d1edff !important;
        transition: background-color 0.3s ease !important;
    }

    /* å·²é€‰æ‹©é¡¹ç›®çš„æ ·å¼ */
    .inventory-table tr.table-secondary {
        background-color: #f8f9fa !important;
        opacity: 0.7 !important;
    }

    .inventory-table tr.table-secondary td {
        color: #6c757d !important;
    }

    /* ç¦ç”¨çŠ¶æ€çš„æŒ‰é’®å’Œè¾“å…¥æ¡† */
    .btn.disabled,
    .btn:disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }

    .form-control.disabled,
    .form-control:disabled {
        background-color: #e9ecef !important;
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }

    /* å·²é€‰æ‹©çš„å¤é€‰æ¡†æ ·å¼ */
    .inventory-checkbox:disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }

    /* åº“å­˜è¡¨æ ¼åˆ—å®½ä¼˜åŒ– */
    .inventory-table th:nth-child(1),
    .inventory-table td:nth-child(1) { width: 120px; } /* æ“ä½œ - å¢åŠ å®½åº¦ä»¥å®¹çº³å•é€‰æ¡†å’ŒæŒ‰é’® */
    .inventory-table th:nth-child(4),
    .inventory-table td:nth-child(4) { width: 60px; } /* æ¿æ•° */
    .inventory-table th:nth-child(5),
    .inventory-table td:nth-child(5) { width: 60px; } /* ä»¶æ•° */
    .inventory-table th:nth-child(6),
    .inventory-table td:nth-child(6) { width: 70px; } /* å…¨å‡º */
    .inventory-table th:nth-child(7),
    .inventory-table td:nth-child(7) { width: 90px; } /* å‡ºåº“æ¿æ•° */
    .inventory-table th:nth-child(8),
    .inventory-table td:nth-child(8) { width: 90px; } /* å‡ºåº“ä»¶æ•° */
    .inventory-table td {
        text-align: center;
        vertical-align: middle;
    }
    .btn-select-inventory {
        padding: 2px 8px;
        font-size: 12px;
    }

    /* å¤é€‰æ¡†æ ·å¼ */
    .inventory-checkbox {
        margin-right: 8px;
        transform: scale(1.2);
    }

    /* æ“ä½œåˆ—çš„flexå¸ƒå±€ */
    .inventory-table td:nth-child(1) .d-flex {
        justify-content: flex-start;
        align-items: center;
    }

    /* æ¨¡æ€æ¡†footeræ ·å¼ */
    .modal-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* ç¡®è®¤é€‰æ‹©æŒ‰é’®æ ·å¼ */
    #confirmSelectionBtn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-truck me-2"></i>å‰ç«¯ä»“ç›´æ¥é…é€å®¢æˆ·
                        <span class="badge bg-success text-white ms-2">Direct to Customer</span>
                    </h3>
                    <div class="mt-2">
                        <a href="{{ url_for('main.frontend_outbound') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-arrow-left me-1"></i>è¿”å›é€‰æ‹©é¡µé¢
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="destination-info">
                        <h5 class="text-success mb-2">
                            <i class="fas fa-map-marker-alt me-1"></i>é…é€ç±»å‹ï¼šç›´æ¥é…é€å®¢æˆ·å·¥å‚
                        </h5>
                        <p class="mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            è´§ç‰©å°†ç›´æ¥ä»å‰ç«¯ä»“é…é€åˆ°å®¢æˆ·æŒ‡å®šåœ°å€ï¼Œé€‚ç”¨äºæ€¥ä»¶æˆ–å°±è¿‘é…é€
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¬å…±åŒºåŸŸå­—æ®µ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>å…¬å…±ä¿¡æ¯
                    </h5>
                </div>
                <div class="card-body">
                    <div class="common-fields">
                        <div class="row">
                            <!-- ç¬¬ä¸€è¡Œ -->
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label required">å‡ºåº“è½¦ç‰Œ *</label>
                                    <input type="text" class="form-control" id="commonPlateNumber" placeholder="è¯·è¾“å…¥å‡ºåº“è½¦ç‰Œ">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label required">å¸æœºå§“å *</label>
                                    <input type="text" class="form-control" id="commonDriverName" placeholder="è¯·è¾“å…¥å¸æœºå§“å">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label required">è”ç³»æ–¹å¼ *</label>
                                    <input type="text" class="form-control" id="commonDriverPhone" placeholder="è¯·è¾“å…¥è”ç³»æ–¹å¼">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label required">å‡ºåº“æ—¥æœŸ *</label>
                                    <input type="date" class="form-control" id="commonOutboundDate" value="{{ moment().format('YYYY-MM-DD') }}">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!-- ç¬¬äºŒè¡Œ -->
                            <div class="col-md-2">
                                <div class="form-row">
                                    <label class="form-label">å§‹å‘ä»“</label>
                                    {% if current_user.is_super_admin() %}
                                    <!-- ç®¡ç†å‘˜ç”¨æˆ·æ˜¾ç¤ºä¸‹æ‹‰æ¡† -->
                                    <select class="form-control" id="commonSourceWarehouse">
                                        <option value="">è¯·é€‰æ‹©å§‹å‘ä»“</option>
                                        {% for warehouse in warehouses %}
                                        <option value="{{ warehouse.warehouse_name }}"
                                                data-address="{{ warehouse.address or 'åœ°å€å¾…å®Œå–„' }}"
                                                data-contact="{{ warehouse.contact_person or 'è”ç³»äººå¾…å®Œå–„' }}">
                                            {{ warehouse.warehouse_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    {% else %}
                                    <!-- æ™®é€šç”¨æˆ·æ˜¾ç¤ºåªè¯»è¾“å…¥æ¡† -->
                                    <input type="text" class="form-control" id="commonSourceWarehouse" readonly
                                           value="{{ current_user.warehouse.warehouse_name if current_user.warehouse else 'æœªåˆ†é…ä»“åº“' }}">
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label">å§‹å‘ä»“åœ°å€</label>
                                    <input type="text" class="form-control" id="commonSourceAddress" readonly
                                           value="{% if current_user.is_super_admin() %}è¯·å…ˆé€‰æ‹©å§‹å‘ä»“{% elif current_user.warehouse %}{{ current_user.warehouse.address or 'åœ°å€å¾…å®Œå–„' }}{% else %}æœªåˆ†é…ä»“åº“{% endif %}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label">å§‹å‘ä»“è”ç³»äºº</label>
                                    <input type="text" class="form-control" id="commonSourceContact" readonly
                                           value="{% if current_user.is_super_admin() %}è¯·å…ˆé€‰æ‹©å§‹å‘ä»“{% elif current_user.warehouse %}{{ current_user.warehouse.contact_person or 'è”ç³»äººå¾…å®Œå–„' }}{% else %}æœªåˆ†é…ä»“åº“{% endif %}">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-row">
                                    <label class="form-label required">ç›®çš„åœ° *</label>
                                    <input type="text" class="form-control" id="commonDestination" placeholder="è¯·è¾“å…¥ç›®çš„åœ°">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <!-- ç¬¬ä¸‰è¡Œ -->
                            <div class="col-md-6">
                                <div class="form-row">
                                    <label class="form-label required">ç›®çš„åœ°åœ°å€ *</label>
                                    <input type="text" class="form-control" id="commonDestinationAddress" placeholder="è¯·è¾“å…¥è¯¦ç»†çš„ç›®çš„åœ°åœ°å€">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-row">
                                    <label class="form-label required">ç›®çš„åœ°è”ç³»äºº *</label>
                                    <input type="text" class="form-control" id="commonDestinationContact" placeholder="è¯·è¾“å…¥ç›®çš„åœ°è”ç³»äººä¿¡æ¯">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ‰¹é‡æ“ä½œå·¥å…·æ  -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="batch-options d-flex flex-wrap align-items-center justify-content-between">
                        <div class="d-flex flex-wrap align-items-center">
                            <button type="button" class="btn btn-success btn-action" id="addRowBtn">
                                <i class="fas fa-plus"></i> æ·»åŠ è¡Œ
                            </button>
                            <button type="button" class="btn btn-danger btn-action" id="deleteRowBtn">
                                <i class="fas fa-trash"></i> åˆ é™¤è¡Œ
                            </button>
                            <button type="button" class="btn btn-info btn-action" id="selectInventoryBtn">
                                <i class="fas fa-boxes"></i> åº“å­˜é€‰æ‹©
                            </button>

                        </div>
                        <div class="d-flex flex-wrap align-items-center">
                            <button type="button" class="btn btn-primary btn-action" id="saveAllBtn">
                                <i class="fas fa-save"></i> ä¿å­˜å…¨éƒ¨
                            </button>
                            <button type="button" class="btn btn-secondary btn-action" id="clearAllBtn">
                                <i class="fas fa-eraser"></i> æ¸…ç©º
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <i class="fas fa-table me-2"></i>ç›´æ¥é…é€æ•°æ®å½•å…¥
                        <small class="text-muted">ï¼ˆæ ‡æœ‰ <span class="required">*</span> çš„å­—æ®µä¸ºå¿…å¡«é¡¹ï¼‰</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="hot-container"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº“å­˜é€‰æ‹©æ¨¡æ€æ¡† -->
    <div class="modal fade inventory-modal" id="inventoryModal" tabindex="-1" aria-labelledby="inventoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="inventoryModalLabel">
                        <i class="fas fa-boxes me-2"></i>åº“å­˜é€‰æ‹©
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">å®¢æˆ·åç§°</label>
                            <input type="text" class="form-control" id="inventorySearchCustomer" placeholder="è¾“å…¥å®¢æˆ·åç§°æœç´¢">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">è¯†åˆ«ç¼–ç </label>
                            <input type="text" class="form-control" id="inventorySearchCode" placeholder="è¾“å…¥è¯†åˆ«ç¼–ç æœç´¢">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-primary" id="searchInventoryBtn">
                                    <i class="fas fa-search"></i> æœç´¢
                                </button>
                                <button type="button" class="btn btn-secondary" id="resetInventorySearchBtn">
                                    <i class="fas fa-undo"></i> é‡ç½®
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover inventory-table" id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>æ“ä½œ</th>
                                    <th>å®¢æˆ·åç§°</th>
                                    <th>è¯†åˆ«ç¼–ç </th>
                                    <th>æ¿æ•°</th>
                                    <th>ä»¶æ•°</th>
                                    <th>å…¨å‡º</th>
                                    <th>å‡ºåº“æ¿æ•°</th>
                                    <th>å‡ºåº“ä»¶æ•°</th>
                                    <th>é‡é‡(kg)</th>
                                    <th>ä½“ç§¯(mÂ³)</th>
                                    <th>åº“ä½</th>
                                    <th>å‡ºå¢ƒæ¨¡å¼</th>
                                    <th>è®¢å•ç±»å‹</th>
                                    <th>æŠ¥å…³è¡Œ</th>
                                    <th>å…¥åº“æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <tr>
                                    <td colspan="15" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨åŠ è½½åº“å­˜æ•°æ®...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="me-auto">
                        <span class="text-muted small">å·²é€‰æ‹© <span id="selectedCount">0</span> é¡¹</span>
                    </div>
                    <button type="button" class="btn btn-success me-2" id="confirmSelectionBtn">
                        <i class="fas fa-check"></i> ç¡®è®¤é€‰æ‹©
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> å…³é—­
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ“ä½œè¯´æ˜ -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-question-circle me-1"></i>æ“ä½œè¯´æ˜
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">å¿…å¡«å­—æ®µ</h6>
                            <ul class="small">
                                <li><span class="required" style="font-size: 16px; font-weight: bold;">å‡ºåº“æ—¶é—´*</span>ï¼šè´§ç‰©å‡ºåº“çš„æ—¶é—´</li>
                                <li><span class="required">é…é€è½¦ç‰Œ*</span>ï¼šé…é€è½¦è¾†è½¦ç‰Œå·</li>
                                <li><span class="required">å®¢æˆ·åç§°*</span>ï¼šè´§ç‰©æ‰€å±å®¢æˆ·</li>
                                <li><span class="required">é…é€åœ°å€*</span>ï¼šå®¢æˆ·å·¥å‚è¯¦ç»†åœ°å€</li>
                                <li><span class="required">è”ç³»äºº*</span>ï¼šå®¢æˆ·è”ç³»äººä¿¡æ¯</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">é…é€æç¤º</h6>
                            <ul class="small">
                                <li>è¯·ç¡®ä¿é…é€åœ°å€å‡†ç¡®æ— è¯¯</li>
                                <li>è”ç³»äººç”µè¯å¿…é¡»å¡«å†™ï¼Œä¾¿äºé…é€ç¡®è®¤</li>
                                <li>ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆé…é€å•æ®</li>
                                <li>é…é€å®Œæˆåè¯·åŠæ—¶æ›´æ–°é…é€çŠ¶æ€</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/handsontable@12.4.0/dist/handsontable.full.min.js"></script>
<script>
// ä¼˜åŒ–çš„èµ„æºåŠ è½½æ£€æŸ¥
let initializationAttempts = 0;
const MAX_ATTEMPTS = 20; // å‡å°‘åˆ°2ç§’
let initStartTime; // å…¨å±€å˜é‡ç”¨äºæ€§èƒ½ç›‘æ§

// æ›´æ–°é€‰æ‹©è®¡æ•°ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('.inventory-checkbox:checked');
    const count = selectedCheckboxes.length;
    const selectedCountElement = document.getElementById('selectedCount');

    console.log('ğŸ” updateSelectedCount è¢«è°ƒç”¨ï¼Œé€‰ä¸­æ•°é‡:', count);
    console.log('ğŸ” æ‰¾åˆ°çš„å¤é€‰æ¡†:', selectedCheckboxes);

    if (selectedCountElement) {
        selectedCountElement.textContent = count;
    }

    // æ›´æ–°ç¡®è®¤æŒ‰é’®çŠ¶æ€
    const confirmBtn = document.getElementById('confirmSelectionBtn');
    if (confirmBtn) {
        confirmBtn.disabled = count === 0;
        if (count === 0) {
            confirmBtn.innerHTML = '<i class="fas fa-check"></i> ç¡®è®¤é€‰æ‹©';
            console.log('ğŸ” æŒ‰é’®è¢«ç¦ç”¨ï¼Œå› ä¸ºæ²¡æœ‰é€‰ä¸­é¡¹ç›®');
        } else {
            confirmBtn.innerHTML = `<i class="fas fa-check"></i> ç¡®è®¤é€‰æ‹© (${count}é¡¹)`;
            console.log('ğŸ” æŒ‰é’®å·²å¯ç”¨ï¼Œé€‰ä¸­', count, 'é¡¹');
        }
    }
}

// å…¨å±€å˜é‡ç”¨äºå­˜å‚¨ Handsontable å®ä¾‹
let hot;

// é€‰æ‹©åº“å­˜é¡¹ç›®ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function selectInventoryItem(inventoryItem) {
    console.log('ğŸ” selectInventoryItem è¢«è°ƒç”¨');
    console.log('ğŸ” hot å˜é‡çŠ¶æ€:', hot);
    console.log('ğŸ” hot ç±»å‹:', typeof hot);

    if (!hot) {
        console.log('âŒ hot å˜é‡ä¸å­˜åœ¨');
        showMessage('error', 'è¡¨æ ¼æœªåˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•');
        return;
    }

    // æ£€æŸ¥ Handsontable æ–¹æ³•æ˜¯å¦å¯ç”¨
    if (typeof hot.populateFromArray !== 'function') {
        console.log('âŒ populateFromArray æ–¹æ³•ä¸å­˜åœ¨ï¼Œæ£€æŸ¥å¯ç”¨æ–¹æ³•...');
        console.log('ğŸ” hot å¯¹è±¡çš„æ–¹æ³•:', Object.getOwnPropertyNames(hot));
        console.log('ğŸ” hot åŸå‹çš„æ–¹æ³•:', Object.getOwnPropertyNames(Object.getPrototypeOf(hot)));
        showMessage('error', 'Handsontable æ–¹æ³•ä¸å¯ç”¨');
        return;
    }

    console.log('âœ… Handsontable æ–¹æ³•æ£€æŸ¥é€šè¿‡');

    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç›¸åŒçš„è¯†åˆ«ç¼–ç 
    const currentSourceData = hot.getSourceData() || [];
    const existingItem = currentSourceData.find(item =>
        item.identification_code === inventoryItem.identification_code
    );

    if (existingItem) {
        console.log('âš ï¸ è¯†åˆ«ç¼–ç å·²å­˜åœ¨:', inventoryItem.identification_code);
        showMessage('warning', `è¯†åˆ«ç¼–ç  "${inventoryItem.identification_code}" å·²ç»åœ¨è¡¨æ ¼ä¸­ï¼Œä¸èƒ½é‡å¤æ·»åŠ `);
        return;
    }

    // æ·»åŠ åˆ°è¡¨æ ¼
    const currentData = hot.getData();
    console.log('ğŸ” å½“å‰è¡¨æ ¼æ•°æ®è¡Œæ•°:', currentData.length);
    console.log('ğŸ” å½“å‰è¡¨æ ¼æ•°æ®:', currentData);

    const newRow = {
        customer_name: inventoryItem.customer_name,
        identification_code: inventoryItem.identification_code,
        pallet_count: inventoryItem.pallet_count,
        package_count: inventoryItem.package_count,
        weight: inventoryItem.weight,
        volume: inventoryItem.volume,
        export_mode: inventoryItem.export_mode,
        order_type: inventoryItem.order_type,
        customs_broker: inventoryItem.customs_broker,
        location: inventoryItem.location,
        documents: inventoryItem.documents,
        remarks: ''
    };

    console.log('ğŸ” å‡†å¤‡æ·»åŠ çš„æ–°è¡Œæ•°æ®:', newRow);
    console.log('ğŸ” æ–°è¡Œæ•°æ®å€¼æ•°ç»„:', Object.values(newRow));

    // æ£€æŸ¥ç¬¬ä¸€è¡Œæ˜¯å¦ä¸ºç©ºï¼ˆåªåœ¨è¡¨æ ¼åªæœ‰ä¸€è¡Œä¸”ä¸ºç©ºæ—¶ä½¿ç”¨ï¼‰
    let useFirstRow = false;
    if (currentData.length === 1) {
        const firstRow = currentData[0];
        const isEmpty = !firstRow[0] && !firstRow[1]; // å®¢æˆ·åç§°å’Œè¯†åˆ«ç¼–ç éƒ½ä¸ºç©º
        if (isEmpty) {
            useFirstRow = true;
            console.log('ğŸ” ä½¿ç”¨ç¬¬ä¸€è¡Œç©ºè¡Œï¼Œè¡Œç´¢å¼•: 0');
        }
    }

    console.log('ğŸ” å½“å‰æºæ•°æ®:', currentSourceData);

    if (useFirstRow && currentSourceData.length === 1 && (!currentSourceData[0].customer_name && !currentSourceData[0].identification_code)) {
        // æ›¿æ¢ç¬¬ä¸€è¡Œç©ºæ•°æ®
        currentSourceData[0] = newRow;
        console.log('ğŸ” æ›¿æ¢ç¬¬ä¸€è¡Œç©ºæ•°æ®');
    } else {
        // æ·»åŠ æ–°è¡Œ
        currentSourceData.push(newRow);
        console.log('ğŸ” æ·»åŠ æ–°è¡Œåˆ°æºæ•°æ®');
    }

    // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
    hot.loadData(currentSourceData);
    console.log('ğŸ” é‡æ–°åŠ è½½è¡¨æ ¼æ•°æ®å®Œæˆï¼Œæ–°çš„è¡Œæ•°:', hot.countRows());

    console.log('ğŸ” æ·»åŠ åè¡¨æ ¼è¡Œæ•°:', hot.countRows());
    console.log('ğŸ” æ·»åŠ åè¡¨æ ¼æ•°æ®:', hot.getData());

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    showMessage('success', `åº“å­˜é¡¹ç›® "${inventoryItem.identification_code}" å·²æ·»åŠ åˆ°è¡¨æ ¼`);

    // å¦‚æœåº“å­˜é€‰æ‹©æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œåˆ·æ–°å…¶çŠ¶æ€
    if ($('#inventoryModal').hasClass('show')) {
        refreshInventoryModalState();
    }
}

// å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæ¶ˆæ¯ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function showMessage(type, message) {
    // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
    const existingAlerts = document.querySelectorAll('.alert');
    existingAlerts.forEach(alert => alert.remove());

    // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' :
                      type === 'warning' ? 'alert-warning' : 'alert-info';

    const iconClass = type === 'success' ? 'check-circle' :
                     type === 'error' ? 'exclamation-circle' : 'info-circle';

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.innerHTML = `
        <i class="fas fa-${iconClass}"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    // æ·»åŠ æ–°æ¶ˆæ¯åˆ°é¡µé¢é¡¶éƒ¨
    document.body.insertBefore(alertDiv, document.body.firstChild);

    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.style.opacity = '0';
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 300);
        }
    }, 3000);
}

// è°ƒè¯•å‡½æ•°ï¼šæ£€æŸ¥é¡µé¢å…ƒç´ å’Œäº‹ä»¶ç»‘å®š
function debugPageElements() {
    console.log('ğŸ” è°ƒè¯•é¡µé¢å…ƒç´ çŠ¶æ€:');
    console.log('  - ä¿å­˜æŒ‰é’®:', document.getElementById('saveAllBtn'));
    console.log('  - è½¦ç‰Œè¾“å…¥æ¡†:', document.getElementById('commonPlateNumber'));
    console.log('  - å¸æœºå§“åè¾“å…¥æ¡†:', document.getElementById('commonDriverName'));
    console.log('  - å¸æœºç”µè¯è¾“å…¥æ¡†:', document.getElementById('commonDriverPhone'));
    console.log('  - å‡ºåº“æ—¥æœŸè¾“å…¥æ¡†:', document.getElementById('commonOutboundDate'));
    console.log('  - ç›®çš„åœ°è¾“å…¥æ¡†:', document.getElementById('commonDestination'));
    console.log('  - ç›®çš„åœ°å€è¾“å…¥æ¡†:', document.getElementById('commonDestinationAddress'));
    console.log('  - ç›®çš„è”ç³»äººè¾“å…¥æ¡†:', document.getElementById('commonDestinationContact'));
    console.log('  - hotè¡¨æ ¼å®ä¾‹:', hot);

    // æ£€æŸ¥è¡¨æ ¼æ•°æ®
    if (hot) {
        console.log('  - è¡¨æ ¼æ•°æ®:', hot.getData());
        console.log('  - è¡¨æ ¼æºæ•°æ®:', hot.getSourceData());
    }
}

// æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿åœ¨æ§åˆ¶å°è°ƒç”¨
window.debugPageElements = debugPageElements;

// åˆ·æ–°åº“å­˜é€‰æ‹©æ¨¡æ€æ¡†çš„çŠ¶æ€ï¼ˆå…¨å±€å‡½æ•°ï¼‰
function refreshInventoryModalState() {
    // é‡æ–°è·å–å½“å‰æ˜¾ç¤ºçš„åº“å­˜æ•°æ®å¹¶åˆ·æ–°æ˜¾ç¤º
    const tbody = document.getElementById('inventoryTableBody');
    const rows = tbody.querySelectorAll('tr');

    if (rows.length > 0) {
        // è·å–å½“å‰è¡¨æ ¼ä¸­å·²é€‰æ‹©çš„è¯†åˆ«ç¼–ç 
        const selectedCodes = new Set();
        if (hot) {
            const currentSourceData = hot.getSourceData() || [];
            currentSourceData.forEach(item => {
                if (item.identification_code) {
                    selectedCodes.add(item.identification_code);
                }
            });
        }

        // æ›´æ–°æ¯ä¸€è¡Œçš„çŠ¶æ€
        rows.forEach(row => {
            const checkbox = row.querySelector('.inventory-checkbox');
            const selectBtn = row.querySelector('.btn-select-inventory');
            const fullOutBtn = row.querySelector('.btn-full-out');
            const palletInput = row.querySelector('.outbound-pallet-input');
            const packageInput = row.querySelector('.outbound-package-input');

            if (checkbox && selectBtn) {
                const identificationCode = checkbox.dataset.code;
                const isSelected = selectedCodes.has(identificationCode);

                // æ›´æ–°è¡Œæ ·å¼
                if (isSelected) {
                    row.classList.add('table-secondary');
                } else {
                    row.classList.remove('table-secondary');
                }

                // æ›´æ–°æ§ä»¶çŠ¶æ€
                checkbox.disabled = isSelected;
                selectBtn.disabled = isSelected;
                if (fullOutBtn) fullOutBtn.disabled = isSelected;
                if (palletInput) palletInput.disabled = isSelected;
                if (packageInput) packageInput.disabled = isSelected;

                // æ›´æ–°æŒ‰é’®æ–‡æœ¬å’Œæ ·å¼
                if (isSelected) {
                    selectBtn.innerHTML = '<i class="fas fa-check-circle"></i> å·²é€‰æ‹©';
                    selectBtn.className = 'btn btn-sm btn-secondary btn-select-inventory disabled';
                } else {
                    selectBtn.innerHTML = '<i class="fas fa-check"></i> é€‰æ‹©';
                    selectBtn.className = 'btn btn-sm btn-primary btn-select-inventory';
                }
            }
        });
    }
}

// ç¡®è®¤é€‰æ‹©æŒ‰é’®äº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œç¡®ä¿åœ¨æŒ‰é’®åˆ›å»ºåä¹Ÿèƒ½å·¥ä½œï¼‰
$(document).on('click', '#confirmSelectionBtn', function(e) {
    e.preventDefault();
    e.stopPropagation();
    console.log('ğŸ” ç¡®è®¤é€‰æ‹©æŒ‰é’®è¢«ç‚¹å‡»');
    console.log('ğŸ” æŒ‰é’®å…ƒç´ :', this);
    console.log('ğŸ” äº‹ä»¶å¯¹è±¡:', e);

    const selectedCheckboxes = document.querySelectorAll('.inventory-checkbox:checked');

    if (selectedCheckboxes.length === 0) {
        showMessage('warning', 'è¯·å…ˆé€‰æ‹©è¦å‡ºåº“çš„åº“å­˜é¡¹ç›®');
        return;
    }

    // æ‰¹é‡æ·»åŠ é€‰ä¸­çš„åº“å­˜é¡¹ç›®åˆ°è¡¨æ ¼
    selectedCheckboxes.forEach(checkbox => {
        const row = checkbox.closest('tr');
        const palletInput = row.querySelector('.outbound-pallet-input');
        const packageInput = row.querySelector('.outbound-package-input');

        const inventoryItem = {
            customer_name: checkbox.dataset.customer,
            identification_code: checkbox.dataset.code,
            pallet_count: parseInt(palletInput.value) || 0,
            package_count: parseInt(packageInput.value) || 0,
            weight: parseFloat(checkbox.dataset.weight) || 0,
            volume: parseFloat(checkbox.dataset.volume) || 0,
            export_mode: checkbox.dataset.exportMode || '',
            order_type: checkbox.dataset.orderType || '',
            customs_broker: checkbox.dataset.customsBroker || '',
            location: checkbox.dataset.location || '',
            documents: checkbox.dataset.documents || ''
        };

        // éªŒè¯å‡ºåº“æ•°é‡
        if (inventoryItem.pallet_count === 0 && inventoryItem.package_count === 0) {
            showMessage('warning', `${inventoryItem.identification_code} è¯·å…ˆè®¾ç½®å‡ºåº“æ¿æ•°æˆ–ä»¶æ•°`);
            return;
        }

        selectInventoryItem(inventoryItem);
    });

    showMessage('success', `å·²æ·»åŠ  ${selectedCheckboxes.length} ä¸ªåº“å­˜é¡¹ç›®åˆ°è¡¨æ ¼`);
    const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryModal'));
    if (modal) {
        modal.hide();
    }
});

// å¤‡ç”¨çš„ç¡®è®¤é€‰æ‹©å¤„ç†å‡½æ•°ï¼ˆç›´æ¥ç»‘å®šåˆ°onclickï¼‰
function handleConfirmSelection() {
    console.log('ğŸ” handleConfirmSelection å‡½æ•°è¢«è°ƒç”¨');

    const selectedCheckboxes = document.querySelectorAll('.inventory-checkbox:checked');
    console.log('ğŸ” æ‰¾åˆ°çš„é€‰ä¸­å¤é€‰æ¡†æ•°é‡:', selectedCheckboxes.length);

    if (selectedCheckboxes.length === 0) {
        showMessage('warning', 'è¯·å…ˆé€‰æ‹©è¦å‡ºåº“çš„åº“å­˜é¡¹ç›®');
        return;
    }

    // æ‰¹é‡æ·»åŠ é€‰ä¸­çš„åº“å­˜é¡¹ç›®åˆ°è¡¨æ ¼
    let addedCount = 0;
    console.log(`ğŸ” å¼€å§‹å¤„ç† ${selectedCheckboxes.length} ä¸ªé€‰ä¸­é¡¹ç›®...`);

    selectedCheckboxes.forEach((checkbox, index) => {
        console.log(`ğŸ” å¤„ç†ç¬¬ ${index + 1} ä¸ªé¡¹ç›®...`);
        const row = checkbox.closest('tr');
        const palletInput = row.querySelector('.outbound-pallet-input');
        const packageInput = row.querySelector('.outbound-package-input');

        console.log(`ğŸ” æ‰¾åˆ°è¾“å…¥æ¡† - æ¿æ•°è¾“å…¥æ¡†:`, palletInput, `ä»¶æ•°è¾“å…¥æ¡†:`, packageInput);

        const inventoryItem = {
            customer_name: checkbox.dataset.customer,
            identification_code: checkbox.dataset.code,
            pallet_count: parseInt(palletInput.value) || 0,
            package_count: parseInt(packageInput.value) || 0,
            weight: parseFloat(checkbox.dataset.weight) || 0,
            volume: parseFloat(checkbox.dataset.volume) || 0,
            export_mode: checkbox.dataset.exportMode || '',
            order_type: checkbox.dataset.orderType || '',
            customs_broker: checkbox.dataset.customsBroker || '',
            location: checkbox.dataset.location || '',
            documents: checkbox.dataset.documents || ''
        };

        // éªŒè¯å‡ºåº“æ•°é‡ - æ¿æ•°å’Œä»¶æ•°è‡³å°‘æœ‰ä¸€ä¸ªå¤§äº0
        if (inventoryItem.pallet_count === 0 && inventoryItem.package_count === 0) {
            console.log(`âš ï¸ è·³è¿‡é¡¹ç›® ${inventoryItem.identification_code}: å‡ºåº“æ•°é‡ä¸º0`);
            showMessage('warning', `${inventoryItem.identification_code} è¯·å…ˆè®¾ç½®å‡ºåº“æ¿æ•°æˆ–ä»¶æ•°`);
            return; // è·³è¿‡å½“å‰é¡¹ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€é¡¹
        }

        console.log(`ğŸ” å¤„ç†åº“å­˜é¡¹ç›®: ${inventoryItem.identification_code}, æ¿æ•°: ${inventoryItem.pallet_count}, ä»¶æ•°: ${inventoryItem.package_count}`);

        try {
            selectInventoryItem(inventoryItem);
            addedCount++;
            console.log(`âœ… æˆåŠŸæ·»åŠ åº“å­˜é¡¹ç›®: ${inventoryItem.identification_code}`);
        } catch (error) {
            console.error(`âŒ æ·»åŠ åº“å­˜é¡¹ç›®å¤±è´¥: ${inventoryItem.identification_code}`, error);
            showMessage('error', `æ·»åŠ  ${inventoryItem.identification_code} å¤±è´¥: ${error.message}`);
        }
    });

    console.log(`ğŸ” å¤„ç†å®Œæˆï¼ŒæˆåŠŸæ·»åŠ  ${addedCount} ä¸ªé¡¹ç›®`);

    if (addedCount > 0) {
        showMessage('success', `å·²æ·»åŠ  ${addedCount} ä¸ªåº“å­˜é¡¹ç›®åˆ°è¡¨æ ¼`);
        const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryModal'));
        if (modal) {
            modal.hide();
        }
    } else {
        showMessage('warning', 'æ²¡æœ‰æˆåŠŸæ·»åŠ ä»»ä½•åº“å­˜é¡¹ç›®');
    }
}

// å…¨å±€å¤é€‰æ¡†äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
$(document).on('change', '.inventory-checkbox', function() {
    console.log('ğŸ” å…¨å±€å¤é€‰æ¡†äº‹ä»¶è¢«è§¦å‘');
    console.log('ğŸ” å¤é€‰æ¡†çŠ¶æ€:', this.checked);
    updateSelectedCount();
});

// ç›´æ¥ç»‘å®šçš„å¤é€‰æ¡†å¤„ç†å‡½æ•°
function handleCheckboxChange(checkbox) {
    console.log('ğŸ” handleCheckboxChange è¢«è°ƒç”¨');
    console.log('ğŸ” å¤é€‰æ¡†çŠ¶æ€:', checkbox.checked);
    console.log('ğŸ” å¤é€‰æ¡†å…ƒç´ :', checkbox);
    updateSelectedCount();
}

// æµ‹è¯•å¤é€‰æ¡†å‡½æ•°
function testCheckboxes() {
    console.log('ğŸ” å¼€å§‹æµ‹è¯•å¤é€‰æ¡†...');

    const checkboxes = document.querySelectorAll('.inventory-checkbox');
    console.log('ğŸ” æ‰¾åˆ°å¤é€‰æ¡†æ•°é‡:', checkboxes.length);

    if (checkboxes.length > 0) {
        console.log('ğŸ” ç¬¬ä¸€ä¸ªå¤é€‰æ¡†:', checkboxes[0]);
        console.log('ğŸ” ç¬¬ä¸€ä¸ªå¤é€‰æ¡†ç±»å:', checkboxes[0].className);
        console.log('ğŸ” ç¬¬ä¸€ä¸ªå¤é€‰æ¡†çŠ¶æ€:', checkboxes[0].checked);

        // æ‰‹åŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªå¤é€‰æ¡†
        checkboxes[0].checked = true;
        console.log('ğŸ” æ‰‹åŠ¨é€‰ä¸­ç¬¬ä¸€ä¸ªå¤é€‰æ¡†');

        // æ‰‹åŠ¨è°ƒç”¨æ›´æ–°å‡½æ•°
        updateSelectedCount();
    } else {
        console.log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•å¤é€‰æ¡†');
    }
}

// å¼ºåˆ¶å¤é€‰æ¡†ç›‘æ§å™¨
let checkboxMonitor = null;

function startCheckboxMonitor() {
    console.log('ğŸ” å¯åŠ¨å¤é€‰æ¡†ç›‘æ§å™¨...');

    if (checkboxMonitor) {
        clearInterval(checkboxMonitor);
    }

    checkboxMonitor = setInterval(() => {
        const modal = document.querySelector('#inventoryModal.show');
        if (!modal) return; // æ¨¡æ€æ¡†æœªæ‰“å¼€æ—¶ä¸ç›‘æ§

        const checkboxes = document.querySelectorAll('.inventory-checkbox');
        const checkedCount = document.querySelectorAll('.inventory-checkbox:checked').length;
        const confirmButton = document.getElementById('confirmSelectionBtn');

        if (checkboxes.length > 0 && confirmButton) {
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰ä¸­çš„å¤é€‰æ¡†
            if (checkedCount > 0 && confirmButton.disabled) {
                console.log('ğŸ” ç›‘æ§å™¨æ£€æµ‹åˆ°é€‰ä¸­é¡¹ç›®ï¼Œå¯ç”¨æŒ‰é’®');
                confirmButton.disabled = false;

                // æ›´æ–°é€‰ä¸­è®¡æ•°æ˜¾ç¤º
                const countSpan = document.getElementById('selectedCount');
                if (countSpan) {
                    countSpan.textContent = checkedCount;
                }
            } else if (checkedCount === 0 && !confirmButton.disabled) {
                console.log('ğŸ” ç›‘æ§å™¨æ£€æµ‹åˆ°æ— é€‰ä¸­é¡¹ç›®ï¼Œç¦ç”¨æŒ‰é’®');
                confirmButton.disabled = true;

                // æ›´æ–°é€‰ä¸­è®¡æ•°æ˜¾ç¤º
                const countSpan = document.getElementById('selectedCount');
                if (countSpan) {
                    countSpan.textContent = '0';
                }
            }
        }
    }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡
}

function stopCheckboxMonitor() {
    if (checkboxMonitor) {
        clearInterval(checkboxMonitor);
        checkboxMonitor = null;
        console.log('ğŸ” å¤é€‰æ¡†ç›‘æ§å™¨å·²åœæ­¢');
    }
}

function checkResourcesLoaded() {
    const handsontableLoaded = typeof Handsontable !== 'undefined';
    if (initializationAttempts % 5 === 0) { // å‡å°‘æ—¥å¿—é¢‘ç‡
        console.log('èµ„æºæ£€æŸ¥:', {
            handsontableLoaded,
            attempt: initializationAttempts
        });
    }
    return handsontableLoaded;
}

// ç¡®ä¿æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåå†åˆå§‹åŒ–
function initializePage() {
    initializationAttempts++;

    // æ£€æŸ¥èµ„æºæ˜¯å¦å®Œå…¨åŠ è½½
    if (!checkResourcesLoaded()) {
        if (initializationAttempts < MAX_ATTEMPTS) {
            // ä½¿ç”¨é€’å¢å»¶è¿Ÿï¼Œå‡å°‘CPUå ç”¨
            const delay = Math.min(50 + initializationAttempts * 10, 200);
            setTimeout(initializePage, delay);
            return;
        } else {
            console.error('âŒ Handsontable åŠ è½½å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°');
            showMessage('error', 'Handsontable åº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
    }

    console.log('âœ… æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–é¡µé¢');
    initStartTime = performance.now();

    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // åˆå§‹åŒ–Handsontable
    const container = document.getElementById('hot-container');
    if (!container) {
        console.error('âŒ æ‰¾ä¸åˆ°è¡¨æ ¼å®¹å™¨å…ƒç´ ');
        showMessage('error', 'é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼šæ‰¾ä¸åˆ°è¡¨æ ¼å®¹å™¨');
        return;
    }

    if (typeof Handsontable === 'undefined') {
        console.error('âŒ Handsontable æœªå®šä¹‰');
        showMessage('error', 'Handsontable åº“æœªæ­£ç¡®åŠ è½½');
        return;
    }

    // ä½¿ç”¨å…¨å±€ hot å˜é‡
    
    // è¡¨æ ¼åˆ—å®šä¹‰ - ä¸“é—¨é’ˆå¯¹å‰ç«¯ä»“ç›´æ¥é…é€å®¢æˆ·
    const columns = [
        {
            data: 'customer_name',
            title: '<span class="required">å®¢æˆ·åç§°*</span>',
            type: 'text',
            width: 150
        },
        {
            data: 'identification_code',
            title: 'è¯†åˆ«ç¼–ç ',
            type: 'text',
            readOnly: true,
            width: 180
        },
        {
            data: 'pallet_count',
            title: 'æ¿æ•°',
            type: 'numeric',
            numericFormat: {
                pattern: '0'
            },
            width: 80
        },
        {
            data: 'package_count',
            title: 'ä»¶æ•°',
            type: 'numeric',
            numericFormat: {
                pattern: '0'
            },
            width: 80
        },
        {
            data: 'weight',
            title: 'é‡é‡(kg)',
            type: 'numeric',
            numericFormat: {
                pattern: '0.00'
            },
            width: 100
        },
        {
            data: 'volume',
            title: 'ä½“ç§¯(mÂ³)',
            type: 'numeric',
            numericFormat: {
                pattern: '0.00'
            },
            width: 100
        },
        {
            data: 'export_mode',
            title: 'å‡ºå¢ƒæ¨¡å¼',
            type: 'text',
            width: 100
        },
        {
            data: 'order_type',
            title: 'è®¢å•ç±»å‹',
            type: 'text',
            width: 100
        },
        {
            data: 'customs_broker',
            title: 'æŠ¥å…³è¡Œ',
            type: 'text',
            width: 120
        },
        {
            data: 'location',
            title: 'åº“ä½',
            type: 'text',
            width: 80
        },
        {
            data: 'documents',
            title: 'å•æ®',
            type: 'text',
            width: 80
        },
        {
            data: 'remarks',
            title: 'å¤‡æ³¨',
            type: 'text',
            width: 150
        }
    ];
    
    // è¡¨æ ¼åˆå§‹åŒ–é…ç½® - å¹³è¡¡æ€§èƒ½å’Œæ˜¾ç¤ºæ•ˆæœ
    try {
        hot = new Handsontable(container, {
            data: [{}],
            columns: columns,
            rowHeaders: true,
            colHeaders: true,
            contextMenu: ['row_above', 'row_below', 'remove_row'],
            manualRowResize: true, // æ¢å¤è¡Œè°ƒæ•´åŠŸèƒ½
            manualColumnResize: true, // æ¢å¤åˆ—è°ƒæ•´åŠŸèƒ½
            stretchH: 'all',
            autoWrapRow: false,
            autoWrapCol: false,
            licenseKey: 'non-commercial-and-evaluation',
            preventOverflow: 'horizontal',
            width: '100%',
            height: 480,
            // å¹³è¡¡æ€§èƒ½å’Œæ˜¾ç¤ºæ•ˆæœçš„é…ç½®
            renderAllRows: true, // ç¦ç”¨è™šæ‹Ÿæ»šåŠ¨ç¡®ä¿æ­£ç¡®æ˜¾ç¤º
            fixedColumnsLeft: 0, // ç¡®ä¿åˆ—å¯¹é½
            fixedRowsTop: 0, // ç¡®ä¿è¡Œå¯¹é½
            afterChange: function(changes, source) {
                if (source === 'edit' && changes) {
                    setTimeout(() => {
                        generateIdentificationCodes();
                    }, 150); // å¢åŠ å»¶è¿Ÿå‡å°‘é¢‘ç¹è°ƒç”¨
                }
            },
            afterInit: function() {
                console.log('âœ… Handsontable åˆå§‹åŒ–å®Œæˆ');
                // ç¡®ä¿è¡¨æ ¼æ­£ç¡®æ¸²æŸ“
                setTimeout(() => {
                    hot.render();
                    hot.refreshDimensions();
                }, 100);
            }
        });
        console.log('âœ… Handsontable åˆå§‹åŒ–æˆåŠŸ');
    } catch (error) {
        console.error('âŒ Handsontable åˆå§‹åŒ–å¤±è´¥:', error);
        showMessage('error', 'Handsontable åˆå§‹åŒ–å¤±è´¥: ' + error.message);
        return;
    }
    
    // æ·»åŠ è¡Œ
    $('#addRowBtn').click(function() {
        hot.alter('insert_row', hot.countRows());
    });
    
    // åˆ é™¤è¡Œ
    $('#deleteRowBtn').click(function() {
        const selected = hot.getSelected();
        if (selected && selected.length > 0) {
            hot.alter('remove_row', selected[0][0]);
        }
    });


    // ä¿å­˜å…¨éƒ¨ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
    $(document).off('click', '#saveAllBtn').on('click', '#saveAllBtn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log('ğŸ” ä¿å­˜æŒ‰é’®è¢«ç‚¹å‡»');
        console.log('ğŸ” æŒ‰é’®å…ƒç´ :', this);
        console.log('ğŸ” äº‹ä»¶å¯¹è±¡:', e);
        saveAllData();
    });

    // æ¸…ç©ºè¡¨æ ¼
    $('#clearAllBtn').click(function() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
            hot.loadData([{}]);
        }
    });

    // åº“å­˜é€‰æ‹©
    $('#selectInventoryBtn').click(function() {
        loadInventoryData();
    });



    // ç®¡ç†å‘˜ç”¨æˆ·é€‰æ‹©å§‹å‘ä»“æ—¶è‡ªåŠ¨æ›´æ–°åœ°å€å’Œè”ç³»äºº
    {% if current_user.is_super_admin() %}
    $('#commonSourceWarehouse').change(function() {
        const selectedOption = $(this).find('option:selected');
        const address = selectedOption.data('address') || 'åœ°å€å¾…å®Œå–„';
        const contact = selectedOption.data('contact') || 'è”ç³»äººå¾…å®Œå–„';

        $('#commonSourceAddress').val(address);
        $('#commonSourceContact').val(contact);
    });
    {% endif %}
    
    // ç”Ÿæˆè¯†åˆ«ç¼–ç 
    function generateIdentificationCodes() {
        // å®ç°è¯†åˆ«ç¼–ç ç”Ÿæˆé€»è¾‘
        console.log('ç”Ÿæˆè¯†åˆ«ç¼–ç ');
    }
    

    // ä¿å­˜æ•°æ®
    function saveAllData() {
        console.log('ğŸ” saveAllData å‡½æ•°å¼€å§‹æ‰§è¡Œ');

        // è·å–å…¬å…±å­—æ®µ
        const commonFields = {
            plate_number: $('#commonPlateNumber').val(),
            driver_name: $('#commonDriverName').val(),
            driver_phone: $('#commonDriverPhone').val(),
            outbound_date: $('#commonOutboundDate').val(),
            source_warehouse: $('#commonSourceWarehouse').val(),
            source_address: $('#commonSourceAddress').val(),
            source_contact: $('#commonSourceContact').val(),
            destination: $('#commonDestination').val(),
            destination_address: $('#commonDestinationAddress').val(),
            destination_contact: $('#commonDestinationContact').val()
        };

        console.log('ğŸ” å…¬å…±å­—æ®µæ•°æ®:', commonFields);

        // éªŒè¯å…¬å…±å­—æ®µ
        if (!commonFields.plate_number || !commonFields.driver_name || !commonFields.driver_phone ||
            !commonFields.outbound_date || !commonFields.destination || !commonFields.destination_address ||
            !commonFields.destination_contact) {
            console.log('ğŸ” å…¬å…±å­—æ®µéªŒè¯å¤±è´¥');
            console.log('ğŸ” ç¼ºå¤±å­—æ®µæ£€æŸ¥:');
            console.log('  - plate_number:', commonFields.plate_number);
            console.log('  - driver_name:', commonFields.driver_name);
            console.log('  - driver_phone:', commonFields.driver_phone);
            console.log('  - outbound_date:', commonFields.outbound_date);
            console.log('  - destination:', commonFields.destination);
            console.log('  - destination_address:', commonFields.destination_address);
            console.log('  - destination_contact:', commonFields.destination_contact);
            showMessage('error', 'è¯·å¡«å†™å®Œæ•´çš„å…¬å…±å­—æ®µä¿¡æ¯');
            return;
        }

        console.log('ğŸ” å…¬å…±å­—æ®µéªŒè¯é€šè¿‡');

        // ç®¡ç†å‘˜ç”¨æˆ·éœ€è¦éªŒè¯æ˜¯å¦é€‰æ‹©äº†å§‹å‘ä»“
        {% if current_user.is_super_admin() %}
        if (!commonFields.source_warehouse) {
            showMessage('error', 'è¯·é€‰æ‹©å§‹å‘ä»“');
            return;
        }
        {% endif %}

        const data = hot.getData();
        console.log('ğŸ” è¡¨æ ¼æ•°æ®:', data);

        // éªŒè¯è¡¨æ ¼æ•°æ® - ä¿®å¤æ•°æ®æ ¼å¼é—®é¢˜
        const validRecords = [];
        for (let i = 0; i < data.length; i++) {
            const row = data[i];
            console.log(`ğŸ” æ£€æŸ¥ç¬¬${i}è¡Œæ•°æ®:`, row);

            // æ•°æ®å¯èƒ½æ˜¯æ•°ç»„æ ¼å¼ï¼Œéœ€è¦æŒ‰åˆ—ç´¢å¼•è®¿é—®
            let customer_name, identification_code, pallet_count, package_count, weight, volume;
            let export_mode, order_type, customs_broker, location, documents, remarks;

            if (Array.isArray(row)) {
                // æ•°ç»„æ ¼å¼ï¼šæŒ‰åˆ—ç´¢å¼•è®¿é—®ï¼ˆç§»é™¤æ‰¹æ¬¡å·åè°ƒæ•´ç´¢å¼•ï¼‰
                customer_name = row[0];
                identification_code = row[1];
                pallet_count = row[2];
                package_count = row[3];
                weight = row[4];
                volume = row[5];
                export_mode = row[6];
                order_type = row[7];
                customs_broker = row[8];
                location = row[9];
                documents = row[10];
                remarks = row[11]; // æ‰¹æ¬¡å·ç§»é™¤åï¼Œå¤‡æ³¨ç´¢å¼•ä»12å˜ä¸º11
            } else {
                // å¯¹è±¡æ ¼å¼ï¼šæŒ‰å±æ€§åè®¿é—®
                customer_name = row.customer_name;
                identification_code = row.identification_code;
                pallet_count = row.pallet_count;
                package_count = row.package_count;
                weight = row.weight;
                volume = row.volume;
                export_mode = row.export_mode;
                order_type = row.order_type;
                customs_broker = row.customs_broker;
                location = row.location;
                documents = row.documents;
                remarks = row.remarks;
            }

            console.log(`ğŸ” ç¬¬${i}è¡Œè§£æåæ•°æ®:`, {
                customer_name, identification_code, pallet_count, package_count
            });

            if (customer_name && identification_code) {
                console.log(`ğŸ” ç¬¬${i}è¡Œæ•°æ®æœ‰æ•ˆ`);
                // åˆå¹¶å…¬å…±å­—æ®µå’Œè¡Œæ•°æ®
                const record = {
                    ...commonFields,
                    customer_name: customer_name,
                    identification_code: identification_code,
                    pallet_count: pallet_count || 0,
                    package_count: package_count || 0,
                    weight: weight || 0,
                    volume: volume || 0,
                    export_mode: export_mode || '',
                    order_type: order_type || '',
                    customs_broker: customs_broker || '',
                    location: location || '',
                    documents: documents || '',
                    remarks: remarks || ''
                };
                validRecords.push(record);
            } else {
                console.log(`ğŸ” ç¬¬${i}è¡Œæ•°æ®æ— æ•ˆ - å®¢æˆ·åç§°: "${customer_name}", è¯†åˆ«ç¼–ç : "${identification_code}"`);
            }
        }

        console.log('ğŸ” æœ‰æ•ˆè®°å½•æ•°é‡:', validRecords.length);
        console.log('ğŸ” æœ‰æ•ˆè®°å½•:', validRecords);

        if (validRecords.length === 0) {
            console.log('ğŸ” æ²¡æœ‰æœ‰æ•ˆè®°å½•ï¼Œåœæ­¢ä¿å­˜');
            showMessage('error', 'è¯·è‡³å°‘æ·»åŠ ä¸€æ¡æœ‰æ•ˆçš„å‡ºåº“è®°å½•');
            return;
        }

        console.log('ğŸ” å¼€å§‹å‘é€ä¿å­˜è¯·æ±‚');
        console.log('ä¿å­˜å‰ç«¯ä»“ç›´æ¥é…é€å®¢æˆ·æ•°æ®:', validRecords);

        // å‘é€åˆ°ä¸“é—¨çš„APIç«¯ç‚¹
        console.log('ğŸ” å‘é€AJAXè¯·æ±‚åˆ°:', '/api/frontend/outbound/to_customer');
        $.ajax({
            url: '/api/frontend/outbound/to_customer',
            method: 'POST',
            data: JSON.stringify({
                records: validRecords,
                destination: 'customer',
                warehouse_type: 'frontend'
            }),
            contentType: 'application/json',
            beforeSend: function() {
                console.log('ğŸ” AJAXè¯·æ±‚å¼€å§‹å‘é€');
            },
            success: function(response) {
                console.log('ğŸ” AJAXè¯·æ±‚æˆåŠŸï¼Œå“åº”:', response);
                if (response.success) {
                    showMessage('success', 'å‰ç«¯ä»“ç›´æ¥é…é€å®¢æˆ·æ•°æ®ä¿å­˜æˆåŠŸï¼');
                    // å¯ä»¥é€‰æ‹©æ¸…ç©ºè¡¨æ ¼æˆ–è·³è½¬åˆ°è®°å½•åˆ—è¡¨
                    if (confirm('ä¿å­˜æˆåŠŸï¼æ˜¯å¦æ¸…ç©ºè¡¨æ ¼ç»§ç»­å½•å…¥ï¼Ÿ')) {
                        hot.loadData([{}]);
                        // æ¸…ç©ºå…¬å…±å­—æ®µï¼ˆé™¤äº†æ—¥æœŸï¼‰
                        $('#commonPlateNumber').val('');
                        $('#commonDriverName').val('');
                        $('#commonDriverPhone').val('');
                        $('#commonDestination').val('');
                        $('#commonDestinationAddress').val('');
                        $('#commonDestinationContact').val('');
                    }
                } else {
                    showMessage('error', 'ä¿å­˜å¤±è´¥ï¼š' + response.message);
                }
            },
            error: function(xhr, status, error) {
                console.log('ğŸ” AJAXè¯·æ±‚å¤±è´¥');
                console.log('ğŸ” çŠ¶æ€ç :', xhr.status);
                console.log('ğŸ” çŠ¶æ€æ–‡æœ¬:', status);
                console.log('ğŸ” é”™è¯¯ä¿¡æ¯:', error);
                console.log('ğŸ” å“åº”æ–‡æœ¬:', xhr.responseText);
                showMessage('error', 'ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        });
    }

    // åŠ è½½åº“å­˜æ•°æ®
    function loadInventoryData() {
        console.log('ğŸ” è°ƒè¯•: loadInventoryData å‡½æ•°å¼€å§‹æ‰§è¡Œ');

        // æ˜¾ç¤ºæ¨¡æ€æ¡† - ä½¿ç”¨Bootstrap 5åŸç”ŸAPI
        const modal = new bootstrap.Modal(document.getElementById('inventoryModal'));
        modal.show();

        // å¯åŠ¨å¤é€‰æ¡†ç›‘æ§å™¨
        startCheckboxMonitor();

        // æ ¹æ®ç”¨æˆ·æƒé™é€‰æ‹©API
        const isAdmin = {% if current_user.is_super_admin() %}true{% else %}false{% endif %};
        const apiUrl = isAdmin ? '/api/inventory' : '/api/inventory/frontend';

        console.log('ğŸ” è°ƒè¯•: isAdmin =', isAdmin);
        console.log('ğŸ” è°ƒè¯•: apiUrl =', apiUrl);

        $.ajax({
            url: apiUrl,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const inventoryData = response.inventory || response.data || [];
                    displayInventoryData(inventoryData);
                } else {
                    showMessage('warning', 'å½“å‰æ²¡æœ‰å¯ç”¨çš„åº“å­˜æ•°æ®');
                    $('#inventoryTableBody').html('<tr><td colspan="15" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°åº“å­˜æ•°æ®</td></tr>');
                }
            },
            error: function() {
                showMessage('error', 'åŠ è½½åº“å­˜æ•°æ®å¤±è´¥');
                $('#inventoryTableBody').html('<tr><td colspan="15" class="text-center text-danger">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>');
            }
        });
    }

    // æ˜¾ç¤ºåº“å­˜æ•°æ®
    function displayInventoryData(inventoryData) {
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '';

        if (!inventoryData || inventoryData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="15" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°åº“å­˜æ•°æ®</td></tr>';
            return;
        }

        // è·å–å½“å‰è¡¨æ ¼ä¸­å·²é€‰æ‹©çš„è¯†åˆ«ç¼–ç 
        const selectedCodes = new Set();
        if (hot) {
            const currentSourceData = hot.getSourceData() || [];
            currentSourceData.forEach(item => {
                if (item.identification_code) {
                    selectedCodes.add(item.identification_code);
                }
            });
        }

        // ä½¿ç”¨æ–‡æ¡£ç‰‡æ®µæé«˜æ€§èƒ½
        const fragment = document.createDocumentFragment();

        inventoryData.forEach(function(item) {
            const tr = document.createElement('tr');
            const identificationCode = item.identification_code || '';
            const displayCode = identificationCode; // æ˜¾ç¤ºå®Œæ•´çš„è¯†åˆ«ç¼–ç 

            // æ£€æŸ¥æ˜¯å¦å·²ç»é€‰æ‹©
            const isSelected = selectedCodes.has(identificationCode);
            const disabledClass = isSelected ? 'disabled' : '';
            const disabledAttr = isSelected ? 'disabled' : '';
            const rowClass = isSelected ? 'table-secondary' : '';
            const buttonText = isSelected ? 'å·²é€‰æ‹©' : 'é€‰æ‹©';
            const buttonIcon = isSelected ? 'fas fa-check-circle' : 'fas fa-check';
            const buttonClass = isSelected ? 'btn-secondary' : 'btn-primary';

            if (isSelected) {
                tr.className = rowClass;
            }

            tr.innerHTML = `
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input inventory-checkbox ${disabledClass}"
                               value="${item.identification_code || ''}"
                               data-customer="${item.customer_name || ''}"
                               data-code="${item.identification_code || ''}"
                               data-pallet="${item.pallet_count || 0}"
                               data-package="${item.package_count || 0}"
                               data-weight="${item.weight || 0}"
                               data-volume="${item.volume || 0}"
                               data-export-mode="${item.export_mode || ''}"
                               data-order-type="${item.order_type || ''}"
                               data-customs-broker="${item.customs_broker || ''}"
                               data-location="${item.location || ''}"
                               data-documents="${item.documents || ''}"
                               ${disabledAttr}
                               onchange="handleCheckboxChange(this)">
                        <button type="button" class="btn btn-sm ${buttonClass} btn-select-inventory ${disabledClass}"
                                data-customer="${item.customer_name || ''}"
                                data-code="${item.identification_code || ''}"
                                data-pallet="${item.pallet_count || 0}"
                                data-package="${item.package_count || 0}"
                                data-weight="${item.weight || 0}"
                                data-volume="${item.volume || 0}"
                                data-export-mode="${item.export_mode || ''}"
                                data-order-type="${item.order_type || ''}"
                                data-customs-broker="${item.customs_broker || ''}"
                                data-location="${item.location || ''}"
                                data-documents="${item.documents || ''}"
                                ${disabledAttr}>
                            <i class="${buttonIcon}"></i> ${buttonText}
                        </button>
                    </div>
                </td>
                <td>${item.customer_name || ''}</td>
                <td title="${identificationCode}">${displayCode}</td>
                <td>${item.pallet_count || 0}</td>
                <td>${item.package_count || 0}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-success btn-full-out ${disabledClass}"
                            data-customer="${item.customer_name || ''}"
                            data-code="${item.identification_code || ''}"
                            data-pallet="${item.pallet_count || 0}"
                            data-package="${item.package_count || 0}"
                            data-weight="${item.weight || 0}"
                            data-volume="${item.volume || 0}"
                            data-export-mode="${item.export_mode || ''}"
                            data-order-type="${item.order_type || ''}"
                            data-customs-broker="${item.customs_broker || ''}"
                            data-location="${item.location || ''}"
                            data-documents="${item.documents || ''}"
                            ${disabledAttr}>
                        <i class="fas fa-arrow-up"></i> å…¨å‡º
                    </button>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm outbound-pallet-input ${disabledClass}"
                           min="0" max="${item.pallet_count || 0}" value="${item.pallet_count || 0}"
                           data-max="${item.pallet_count || 0}" ${disabledAttr}>
                </td>
                <td>
                    <input type="number" class="form-control form-control-sm outbound-package-input ${disabledClass}"
                           min="0" max="${item.package_count || 0}" value="${item.package_count || 0}"
                           data-max="${item.package_count || 0}" ${disabledAttr}>
                </td>
                <td>${item.weight || 0}</td>
                <td>${item.volume || 0}</td>
                <td>${item.location || ''}</td>
                <td>${item.export_mode || ''}</td>
                <td>${item.order_type || ''}</td>
                <td>${item.customs_broker || ''}</td>
                <td>${item.inbound_time || ''}</td>
            `;
            fragment.appendChild(tr);
        });

        tbody.appendChild(fragment);

        // åˆå§‹åŒ–é€‰æ‹©è®¡æ•°
        setTimeout(() => {
            updateSelectedCount();
        }, 50);

        // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç»‘å®šé€‰æ‹©æŒ‰é’®äº‹ä»¶
        $(tbody).off('click', '.btn-select-inventory').on('click', '.btn-select-inventory', function() {
            const btn = this;

            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨
            if (btn.disabled || btn.classList.contains('disabled')) {
                showMessage('warning', 'è¯¥åº“å­˜é¡¹ç›®å·²ç»åœ¨è¡¨æ ¼ä¸­ï¼Œä¸èƒ½é‡å¤é€‰æ‹©');
                return;
            }

            const row = btn.closest('tr');
            const palletInput = row.querySelector('.outbound-pallet-input');
            const packageInput = row.querySelector('.outbound-package-input');
            const checkboxInput = row.querySelector('.inventory-checkbox');

            // é€‰ä¸­å¯¹åº”çš„å¤é€‰æ¡†
            if (checkboxInput) {
                checkboxInput.dataset.programmatic = 'true'; // æ ‡è®°ä¸ºç¨‹åºè§¦å‘
                checkboxInput.checked = true;
            }

            const inventoryItem = {
                customer_name: btn.dataset.customer,
                identification_code: btn.dataset.code,
                pallet_count: parseInt(palletInput.value) || 0,
                package_count: parseInt(packageInput.value) || 0,
                weight: parseFloat(btn.dataset.weight) || 0,
                volume: parseFloat(btn.dataset.volume) || 0
            };

            // éªŒè¯å‡ºåº“æ•°é‡
            if (inventoryItem.pallet_count === 0 && inventoryItem.package_count === 0) {
                showMessage('warning', 'è¯·å…ˆè®¾ç½®å‡ºåº“æ¿æ•°æˆ–ä»¶æ•°');
                return;
            }

            selectInventoryItem(inventoryItem);
        });

        // ç»‘å®š"å…¨å‡º"æŒ‰é’®äº‹ä»¶
        $(tbody).off('click', '.btn-full-out').on('click', '.btn-full-out', function() {
            const btn = this;

            // æ£€æŸ¥æŒ‰é’®æ˜¯å¦è¢«ç¦ç”¨
            if (btn.disabled || btn.classList.contains('disabled')) {
                showMessage('warning', 'è¯¥åº“å­˜é¡¹ç›®å·²ç»åœ¨è¡¨æ ¼ä¸­ï¼Œä¸èƒ½é‡å¤é€‰æ‹©');
                return;
            }

            const row = btn.closest('tr');
            const palletInput = row.querySelector('.outbound-pallet-input');
            const packageInput = row.querySelector('.outbound-package-input');
            const checkboxInput = row.querySelector('.inventory-checkbox');

            // é€‰ä¸­å¯¹åº”çš„å¤é€‰æ¡†
            if (checkboxInput) {
                checkboxInput.dataset.programmatic = 'true'; // æ ‡è®°ä¸ºç¨‹åºè§¦å‘
                checkboxInput.checked = true;
            }

            // è®¾ç½®ä¸ºæœ€å¤§åº“å­˜æ•°é‡
            palletInput.value = btn.dataset.pallet || 0;
            packageInput.value = btn.dataset.package || 0;

            // é«˜äº®æ˜¾ç¤ºå·²è®¾ç½®å…¨å‡º
            $(row).addClass('table-success');
            setTimeout(() => {
                $(row).removeClass('table-success');
            }, 1000);

            showMessage('success', 'å·²è®¾ç½®ä¸ºå…¨å‡ºæ•°é‡');
        });

        // ç»‘å®šå¤é€‰æ¡†å˜åŒ–äº‹ä»¶
        $(tbody).off('change', '.inventory-checkbox').on('change', '.inventory-checkbox', function() {
            console.log('ğŸ” å¤é€‰æ¡†å˜åŒ–äº‹ä»¶è¢«è§¦å‘');
            console.log('ğŸ” å¤é€‰æ¡†çŠ¶æ€:', this.checked);
            console.log('ğŸ” æ˜¯å¦ç¨‹åºè§¦å‘:', this.dataset.programmatic);

            if (this.checked && !this.dataset.programmatic) {
                // é€‰ä¸­æ—¶ï¼šä¸ç«‹å³æ·»åŠ åˆ°è¡¨æ ¼ï¼Œåªæ›´æ–°é€‰æ‹©è®¡æ•°
                console.log('ğŸ” å¤é€‰æ¡†è¢«é€‰ä¸­ï¼Œè°ƒç”¨ updateSelectedCount');
                updateSelectedCount();
            } else if (!this.checked && !this.dataset.programmatic) {
                // å–æ¶ˆé€‰ä¸­æ—¶ï¼šä»è¡¨æ ¼ä¸­ç§»é™¤å¯¹åº”çš„è¡Œï¼ˆå¦‚æœå·²æ·»åŠ ï¼‰
                console.log('ğŸ” å¤é€‰æ¡†è¢«å–æ¶ˆé€‰ä¸­');
                const identificationCode = this.dataset.code;
                removeInventoryFromTable(identificationCode);
                updateSelectedCount();
            }
            // æ¸…é™¤æ ‡å¿—
            delete this.dataset.programmatic;
        });

        // ç»‘å®šæ•°é‡è¾“å…¥æ¡†å˜åŒ–äº‹ä»¶
        $(tbody).off('input', '.outbound-pallet-input, .outbound-package-input').on('input', '.outbound-pallet-input, .outbound-package-input', function() {
            const input = this;
            const max = parseInt(input.dataset.max) || 0;
            const value = parseInt(input.value) || 0;

            // éªŒè¯ä¸èƒ½è¶…è¿‡æœ€å¤§åº“å­˜
            if (value > max) {
                input.value = max;
                showMessage('warning', `æ•°é‡ä¸èƒ½è¶…è¿‡åº“å­˜æœ€å¤§å€¼ ${max}`);
            }

            // éªŒè¯ä¸èƒ½ä¸ºè´Ÿæ•°
            if (value < 0) {
                input.value = 0;
            }
        });
    }

    // ä»è¡¨æ ¼ä¸­ç§»é™¤åº“å­˜é¡¹ç›®
    function removeInventoryFromTable(identificationCode) {
        if (!hot) return;

        const currentSourceData = hot.getSourceData() || [];
        const newData = currentSourceData.filter(item =>
            item.identification_code !== identificationCode
        );

        // å¦‚æœåˆ é™¤åæ²¡æœ‰æ•°æ®ï¼Œä¿ç•™ä¸€ä¸ªç©ºè¡Œ
        if (newData.length === 0) {
            newData.push({});
        }

        hot.loadData(newData);
        showMessage('info', 'å·²ä»è¡¨æ ¼ä¸­ç§»é™¤è¯¥åº“å­˜é¡¹ç›®');

        // å¦‚æœåº“å­˜é€‰æ‹©æ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œåˆ·æ–°å…¶çŠ¶æ€
        if ($('#inventoryModal').hasClass('show')) {
            refreshInventoryModalState();
        }
    }

    // åº“å­˜æœç´¢åŠŸèƒ½ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    const searchInventory = debounce(function() {
        const customerName = $('#inventorySearchCustomer').val().trim();
        const identificationCode = $('#inventorySearchCode').val().trim();

        console.log('ğŸ” è°ƒè¯•: searchInventory å‡½æ•°å¼€å§‹æ‰§è¡Œ');

        // æ ¹æ®ç”¨æˆ·æƒé™é€‰æ‹©API
        const isAdmin = {% if current_user.is_super_admin() %}true{% else %}false{% endif %};
        const apiUrl = isAdmin ? '/api/inventory' : '/api/inventory/frontend';

        console.log('ğŸ” è°ƒè¯•: Search - isAdmin =', isAdmin);
        console.log('ğŸ” è°ƒè¯•: Search - apiUrl =', apiUrl);

        const params = new URLSearchParams();
        if (customerName) params.append('customer_name', customerName);
        if (identificationCode) params.append('identification_code', identificationCode);

        const searchUrl = params.toString() ? `${apiUrl}?${params.toString()}` : apiUrl;

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const tbody = document.getElementById('inventoryTableBody');
        tbody.innerHTML = '<tr><td colspan="15" class="text-center"><i class="fas fa-spinner fa-spin"></i> æœç´¢ä¸­...</td></tr>';

        fetch(searchUrl)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const inventoryData = data.inventory || data.data || [];
                    displayInventoryData(inventoryData);
                } else {
                    showMessage('warning', 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åº“å­˜æ•°æ®');
                    tbody.innerHTML = '<tr><td colspan="12" class="text-center text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åº“å­˜æ•°æ®</td></tr>';
                }
            })
            .catch(error => {
                console.error('æœç´¢åº“å­˜æ•°æ®å¤±è´¥:', error);
                showMessage('error', 'æœç´¢åº“å­˜æ•°æ®å¤±è´¥');
                tbody.innerHTML = '<tr><td colspan="12" class="text-center text-danger">æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
            });
    }, 300);

    $('#searchInventoryBtn').click(searchInventory);

    // é‡ç½®æœç´¢
    $('#resetInventorySearchBtn').click(function() {
        $('#inventorySearchCustomer').val('');
        $('#inventorySearchCode').val('');
        loadInventoryData();
    });

    // å·¥å…·å‡½æ•°ï¼šæ˜¾ç¤ºæ¶ˆæ¯ï¼ˆä¼˜åŒ–ç‰ˆæœ¬ï¼‰
    function showMessage(type, message) {
        // ç§»é™¤ç°æœ‰çš„æ¶ˆæ¯
        const existingAlerts = document.querySelectorAll('.alert');
        existingAlerts.forEach(alert => alert.remove());

        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        const alertClass = type === 'success' ? 'alert-success' :
                          type === 'error' ? 'alert-danger' :
                          type === 'warning' ? 'alert-warning' : 'alert-info';

        const iconClass = type === 'success' ? 'check-circle' :
                         type === 'error' ? 'exclamation-circle' : 'info-circle';

        const alertDiv = document.createElement('div');
        alertDiv.className = `alert ${alertClass} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            <i class="fas fa-${iconClass}"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // æ·»åŠ æ–°æ¶ˆæ¯åˆ°é¡µé¢é¡¶éƒ¨
        document.body.insertBefore(alertDiv, document.body.firstChild);

        // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.style.opacity = '0';
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
}

// é˜²æ­¢é‡å¤åˆå§‹åŒ–
let isInitialized = false;

function safeInitialize() {
    if (isInitialized) {
        return;
    }

    initializePage();
    isInitialized = true;
}

// ä¼˜åŒ–çš„åˆå§‹åŒ–å…¥å£ - ä½¿ç”¨æ›´é«˜æ•ˆçš„æ£€æµ‹
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', safeInitialize);
} else if (document.readyState === 'interactive' || document.readyState === 'complete') {
    // DOMå·²ç»åŠ è½½å®Œæˆï¼Œå»¶è¿Ÿä¸€ç‚¹ç¡®ä¿è„šæœ¬æ‰§è¡Œå®Œæ¯•
    setTimeout(safeInitialize, 10);
} else {
    // å¤‡ç”¨æ–¹æ¡ˆ
    safeInitialize();
}

// æ¨¡æ€æ¡†æ ·å¼è®¾ç½®
$(document).ready(function() {
    // æµ‹è¯•ç¡®è®¤é€‰æ‹©æŒ‰é’®æ˜¯å¦å¯ä»¥è¢«æ‰¾åˆ°
    console.log('ğŸ” é¡µé¢åŠ è½½å®Œæˆï¼Œæ£€æŸ¥ç¡®è®¤é€‰æ‹©æŒ‰é’®...');
    setTimeout(() => {
        const btn = document.getElementById('confirmSelectionBtn');
        console.log('ğŸ” ç¡®è®¤é€‰æ‹©æŒ‰é’®å…ƒç´ :', btn);
        if (btn) {
            console.log('âœ… ç¡®è®¤é€‰æ‹©æŒ‰é’®æ‰¾åˆ°äº†');
        } else {
            console.log('âŒ ç¡®è®¤é€‰æ‹©æŒ‰é’®æœªæ‰¾åˆ°');
        }
    }, 1000);

    $('#inventoryModal').on('show.bs.modal', function (e) {
        setTimeout(function() {
            const modal = $('#inventoryModal');
            const dialog = modal.find('.modal-dialog');
            const content = modal.find('.modal-content');
            const body = modal.find('.modal-body');

            // ä½¿ç”¨æœ€å¼ºåŠ›çš„æ ·å¼è®¾ç½®æ–¹æ³•
            const dialogElement = dialog[0];
            const contentElement = content[0];
            const bodyElement = body[0];

            // ç›´æ¥è®¾ç½®å†…è”æ ·å¼ï¼Œä¼˜å…ˆçº§æœ€é«˜
            dialogElement.style.setProperty('max-width', 'calc(100vw - 2rem)', 'important');
            dialogElement.style.setProperty('width', 'calc(100vw - 2rem)', 'important');
            dialogElement.style.setProperty('height', 'calc(100vh - 2rem)', 'important');
            dialogElement.style.setProperty('max-height', 'calc(100vh - 2rem)', 'important');
            dialogElement.style.setProperty('margin', '1rem auto', 'important');
            dialogElement.style.setProperty('left', '0', 'important');
            dialogElement.style.setProperty('right', '0', 'important');
            dialogElement.style.setProperty('transform', 'none', 'important');

            contentElement.style.setProperty('height', '100%', 'important');
            contentElement.style.setProperty('width', '100%', 'important');
            contentElement.style.setProperty('display', 'flex', 'important');
            contentElement.style.setProperty('flex-direction', 'column', 'important');

            bodyElement.style.setProperty('flex', '1', 'important');
            bodyElement.style.setProperty('overflow', 'hidden', 'important');
            bodyElement.style.setProperty('display', 'flex', 'important');
            bodyElement.style.setProperty('flex-direction', 'column', 'important');
            bodyElement.style.setProperty('min-height', '0', 'important');
            bodyElement.style.setProperty('width', '100%', 'important');

            console.log('âœ… æ ·å¼è®¾ç½®å®Œæˆï¼ŒéªŒè¯ç»“æœ:');
            console.log('- è®¾ç½®ådialogå®½åº¦:', dialog.width());
            console.log('- è®¾ç½®ådialogé«˜åº¦:', dialog.height());
            console.log('- è®¾ç½®åCSS width:', dialog.css('width'));
            console.log('- è®¾ç½®åCSS max-width:', dialog.css('max-width'));
            console.log('- è®¾ç½®åCSS height:', dialog.css('height'));

        }, 100);
    });

    $('#inventoryModal').on('shown.bs.modal', function (e) {
        const modal = $(this);
        const tableContainer = modal.find('.table-responsive');

        // å¯åŠ¨å¤é€‰æ¡†ç›‘æ§å™¨
        startCheckboxMonitor();

        // ç¡®ä¿è¡¨æ ¼åŒºåŸŸæ­£ç¡®æ˜¾ç¤º
        tableContainer.css({
            'flex': '1',
            'overflow-y': 'auto',
            'max-height': 'calc(90vh - 200px)',
            'min-height': '400px'
        });

        // åˆå§‹åŒ–é€‰æ‹©è®¡æ•°
        updateSelectedCount();
    });

    // æ€§èƒ½æŠ¥å‘Š
    if (typeof initStartTime !== 'undefined') {
        const initEndTime = performance.now();
        const initDuration = initEndTime - initStartTime;
        console.log(`ğŸš€ é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œè€—æ—¶: ${initDuration.toFixed(2)}ms`);

        if (initDuration > 1000) {
            console.warn('âš ï¸ é¡µé¢åˆå§‹åŒ–è¾ƒæ…¢ï¼Œå»ºè®®ä¼˜åŒ–');
        }
    } else {
        console.log('ğŸš€ é¡µé¢åˆå§‹åŒ–å®Œæˆ');
    }

    // æ¨¡æ€æ¡†éšè—æ—¶åœæ­¢ç›‘æ§å™¨
    $('#inventoryModal').on('hidden.bs.modal', function (e) {
        stopCheckboxMonitor();
    });

});
</script>
{% endblock %}
