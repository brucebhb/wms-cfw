#!/usr/bin/env python3
"""
è‡ªåŠ¨åŒ–ç»´æŠ¤è„šæœ¬
æ•´åˆæ‰€æœ‰ç»´æŠ¤ä»»åŠ¡ï¼Œå¯ä»¥å®šæœŸæ‰§è¡Œ
"""
import os
import sys
import subprocess
from datetime import datetime

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

class AutoMaintenance:
    def __init__(self):
        self.script_dir = os.path.dirname(os.path.abspath(__file__))
        self.project_root = os.path.dirname(self.script_dir)
        
    def run_script(self, script_name):
        """è¿è¡Œç»´æŠ¤è„šæœ¬"""
        script_path = os.path.join(self.script_dir, script_name)
        if not os.path.exists(script_path):
            return False, f"è„šæœ¬ä¸å­˜åœ¨: {script_path}"
            
        try:
            result = subprocess.run([sys.executable, script_path], 
                                  capture_output=True, text=True, 
                                  cwd=self.project_root)
            return result.returncode == 0, result.stdout + result.stderr
        except Exception as e:
            return False, str(e)
    
    def check_system_health(self):
        """æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€"""
        print("æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€...")
        success, output = self.run_script('performance_monitor.py')
        if success:
            print("âœ“ ç³»ç»Ÿç›‘æ§å®Œæˆ")
        else:
            print(f"âœ— ç³»ç»Ÿç›‘æ§å¤±è´¥: {output}")
        return success
    
    def clean_logs(self):
        """æ¸…ç†æ—¥å¿—"""
        print("æ¸…ç†æ—¥å¿—æ–‡ä»¶...")
        success, output = self.run_script('log_cleaner.py')
        if success:
            print("âœ“ æ—¥å¿—æ¸…ç†å®Œæˆ")
        else:
            print(f"âœ— æ—¥å¿—æ¸…ç†å¤±è´¥: {output}")
        return success
    
    def optimize_database(self):
        """ä¼˜åŒ–æ•°æ®åº“"""
        print("ä¼˜åŒ–æ•°æ®åº“...")
        success, output = self.run_script('db_optimizer.py')
        if success:
            print("âœ“ æ•°æ®åº“ä¼˜åŒ–å®Œæˆ")
        else:
            print(f"âœ— æ•°æ®åº“ä¼˜åŒ–å¤±è´¥: {output}")
        return success
    
    def restart_if_needed(self):
        """å¦‚æœéœ€è¦åˆ™é‡å¯æœåŠ¡"""
        # æ£€æŸ¥æ˜¯å¦æœ‰å¤šä¸ªPythonè¿›ç¨‹
        try:
            import psutil
            python_processes = []
            for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
                if 'python' in proc.info['name'].lower():
                    cmdline = ' '.join(proc.info['cmdline'] or [])
                    if 'run.py' in cmdline:
                        python_processes.append(proc.info['pid'])
            
            if len(python_processes) > 1:
                print(f"å‘ç°{len(python_processes)}ä¸ªåº”ç”¨è¿›ç¨‹ï¼Œå»ºè®®é‡å¯")
                return False
            else:
                print("âœ“ è¿›ç¨‹çŠ¶æ€æ­£å¸¸")
                return True
        except ImportError:
            print("æ— æ³•æ£€æŸ¥è¿›ç¨‹çŠ¶æ€ï¼ˆéœ€è¦psutilï¼‰")
            return True
        except Exception as e:
            print(f"æ£€æŸ¥è¿›ç¨‹çŠ¶æ€å¤±è´¥: {e}")
            return True
    
    def generate_maintenance_report(self):
        """ç”Ÿæˆç»´æŠ¤æŠ¥å‘Š"""
        report_file = os.path.join(self.project_root, 'logs', 'maintenance_report.txt')
        os.makedirs(os.path.dirname(report_file), exist_ok=True)
        
        with open(report_file, 'w', encoding='utf-8') as f:
            f.write(f"ç³»ç»Ÿç»´æŠ¤æŠ¥å‘Š\n")
            f.write(f"ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("=" * 50 + "\n\n")
            
            # è¿è¡Œå„ä¸ªæ£€æŸ¥è„šæœ¬å¹¶è®°å½•ç»“æœ
            scripts = [
                ('performance_monitor.py', 'æ€§èƒ½ç›‘æ§'),
                ('log_cleaner.py', 'æ—¥å¿—æ¸…ç†'),
                ('db_optimizer.py', 'æ•°æ®åº“ä¼˜åŒ–')
            ]
            
            for script, name in scripts:
                f.write(f"{name}:\n")
                success, output = self.run_script(script)
                f.write(f"çŠ¶æ€: {'æˆåŠŸ' if success else 'å¤±è´¥'}\n")
                f.write(f"è¾“å‡º:\n{output}\n")
                f.write("-" * 30 + "\n\n")
        
        print(f"ç»´æŠ¤æŠ¥å‘Šå·²ç”Ÿæˆ: {report_file}")
    
    def run_full_maintenance(self):
        """æ‰§è¡Œå®Œæ•´çš„ç»´æŠ¤æµç¨‹"""
        print(f"å¼€å§‹è‡ªåŠ¨ç»´æŠ¤ - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("=" * 60)
        
        maintenance_tasks = [
            ("ç³»ç»Ÿå¥åº·æ£€æŸ¥", self.check_system_health),
            ("æ—¥å¿—æ¸…ç†", self.clean_logs),
            ("æ•°æ®åº“ä¼˜åŒ–", self.optimize_database),
            ("è¿›ç¨‹çŠ¶æ€æ£€æŸ¥", self.restart_if_needed)
        ]
        
        results = []
        for task_name, task_func in maintenance_tasks:
            print(f"\næ‰§è¡Œ: {task_name}")
            try:
                success = task_func()
                results.append((task_name, success))
            except Exception as e:
                print(f"âœ— {task_name}å¤±è´¥: {e}")
                results.append((task_name, False))
        
        # ç”ŸæˆæŠ¥å‘Š
        print(f"\nç”Ÿæˆç»´æŠ¤æŠ¥å‘Š...")
        self.generate_maintenance_report()
        
        # æ€»ç»“
        print(f"\nç»´æŠ¤æ€»ç»“:")
        success_count = sum(1 for _, success in results if success)
        total_count = len(results)
        
        for task_name, success in results:
            status = "âœ“" if success else "âœ—"
            print(f"  {status} {task_name}")
        
        print(f"\nå®Œæˆç‡: {success_count}/{total_count}")
        
        if success_count == total_count:
            print("ğŸ‰ æ‰€æœ‰ç»´æŠ¤ä»»åŠ¡å®Œæˆï¼")
        else:
            print("âš ï¸  éƒ¨åˆ†ç»´æŠ¤ä»»åŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—")
        
        print("=" * 60)

def main():
    """ä¸»å‡½æ•°"""
    maintenance = AutoMaintenance()
    maintenance.run_full_maintenance()

if __name__ == '__main__':
    main()
